define(["jquery","underscore","utils","jquery.select2"],function($,_,Utils){function cloneInputToHiddenInput(e){var t=["name","class","id","style","data-events","data-url","data-select-value"],n="";_.each(t,function(t){var r=e.attr(t);r&&(n+=t+'="'+r+'" ')}),n='<input type="hidden" '+n+" />",e.after(n);var r=e.css("width"),i=e.next();e.remove(),r?i.css("width",r):i.css("width","98%");var s=i.attr("data-select-value");return s&&i.val(s),i}function setupEvents($element,events){var token,tokens,that=this;if(!_.isObject(events))throw"setupEvents() required events to be a valid object";_.each(events,function(value,key){var _func;_.isString(value)&&(token=value.match(/\(([^)]+)\)/ig),token?(token=token[0].replace(/(\(|\))/ig,""),tokens=token.split(","),token=value.match(/^\s*(\w+)/ig),token&&eval("_func = "+token[0]+";")):eval("_func = "+value+";"));if(typeof _func!="function")throw"setupEvents() require events to be a valid function.";$element.on(key,function(e){tokens?_func.apply(that,_.union([$element,e],tokens)):_func($element,e)})})}function parseNumberList(e,t){if(t.added){var n=t.added.text;if(n.indexOf("-")>=0){var r=n.match(/(\d+)(\s*)-(\s*)(\d+)/ig);if(r){var i=r.shift();i=i.split("-");var s=parseInt(i.shift(),10),o=parseInt(i.shift(),10),u;if(_.isNaN(s)||_.isNaN(o))return;u=o-s;if(u<1){var a=o.toString().length,f=s.toString().slice(-a);u=o-f;if(u<1)return}if(u>200){alert("Cannot have the range greater than 200. (from "+s+" to "+o+")");return}t.val=_.without(t.val,n);for(var l=0;l<=u;l++)t.val.push(s+l);e.select2("val",t.val)}}}}function addNumberFromField(e,t,n){if(t.added){if(t.val.length>1)return;var r=parseFloat(t.added.text);if(_.isNaN(r))return;var i=$("#"+n),s=parseFloat(i.val());if(_.isNaN(s))return;if(s>200){alert("Cannot have the range greater than 200.");return}t.val=[];while(s)t.val.push(r),r++,s--;e.select2("val",t.val)}}if(!$().select2)throw"Could not be abel to find select2";return{renderTags:function(e,t){var n=function(e){e=e||null;if(t._elementData&&t._elementData[i]&&t._elementData[i].value){var n=JSON.stringify(t._elementData[i].value).replace(/\[|\]|\"/ig,"");r.val(n)}var s={tags:e?e:[]};(!t||!t._isListFieldType)&&r.attr("name",r.attr("name")+"[]"),r.select2(s),t._elementData&&t._elementData[i]&&t._elementData[i].events&&setupEvents(r,t._elementData[i].events)};t=t||null;var r=cloneInputToHiddenInput(e),i=r.attr("name"),s=r.attr("data-url");s?$.ajax({url:s,type:"GET",cache:!1,success:function(e,t,r){n(e)},error:function(e,t,n){throw console&&console.error&&(console.error("Could not be able to Send Request to "+s),console.error(arguments)),new Error("Error when send Ajax Request!")}}):n()},render:function(e,t){var n=!1;n&&(console.log("[*] select2helper.js:render"),console.log(arguments));var r=function(e){var t=jQuery(e);if(!t.length)throw new Error('Could not be able to find "'+e+'"');if(t.length>1)throw new Error('Found more than one element for "'+e+'" ['+t.length+"]");var r=t.val();return n&&(console.log("- Query:"),console.log(arguments),console.log(t),console.log(r)),_.isString(r)&&(r=r.split(",")),r};if(e.is("select")){var i={},s=!1,o=e.attr("name"),u=e.attr("data-select-value");if(t&&t.children&&t.children.BaseField){var a=t.children.BaseField._getValueFrom;a&&a[o]&&(s=!0,i.query=function(e){var t={results:[]},i=r(a[o]);_.each(i,function(e,r){n&&console.log(arguments),t.results.push({id:e,text:e})}),e.callback(t)},i.allowClear=!0,i.placeholder="Please select a value",u&&(i.initSelection=function(e,t){n&&(console.log('- initSelection for "'+o+'"'),console.log(arguments)),t({id:u,text:u})}))}if(s){var f=cloneInputToHiddenInput(e);f.select2(i),f.on("change",function(e){var n=!1;n&&console.log('- Select 2: change "'+o+'"');if(t){var r=t.model;n&&console.log(r.get(o)),r&&r.has&&r.has(o)&&r.set(o,e.val),n&&console.log(r.get(o))}})}else e.select2(i)}}}});