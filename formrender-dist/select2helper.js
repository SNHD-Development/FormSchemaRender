define(["jquery","underscore","utils","jquery.select2"],function($,_,Utils){function cloneInputToHiddenInput(e){var t=["name","class","id","style","data-events","data-url","data-select-value"],n="";_.each(t,function(t){var a=e.attr(t);a&&(n+=t+'="'+a+'" ')}),n='<input type="hidden" '+n+" />",e.after(n);var a=e.css("width"),r=e.next();e.remove(),a?r.css("width",a):r.css("width","98%");var l=r.attr("data-select-value");return l&&r.val(l),r}function setupEvents($element,events){var token,tokens,that=this;if(!_.isObject(events))throw"setupEvents() required events to be a valid object";_.each(events,function(value,key){var _func;if(_.isString(value)&&(token=value.match(/\(([^)]+)\)/gi),token?(token=token[0].replace(/(\(|\))/gi,""),tokens=token.split(","),token=value.match(/^\s*(\w+)/gi),token&&eval("_func = "+token[0]+";")):eval("_func = "+value+";")),"function"!=typeof _func)throw"setupEvents() require events to be a valid function.";$element.on(key,function(e){tokens?_func.apply(that,_.union([$element,e],tokens)):_func($element,e)})})}function parseNumberList(e,t){if(t.added){var n=t.added.text;if(n.indexOf("-")>=0){var a=n.match(/(\d+)(\s*)-(\s*)(\d+)/gi);if(a){var r=a.shift();r=r.split("-");var l,o=parseInt(r.shift(),10),s=parseInt(r.shift(),10);if(_.isNaN(o)||_.isNaN(s))return;if(l=s-o,l<1){var i=s.toString().length,c=o.toString().slice(-i);if(l=s-c,l<1)return}if(l>200)return void alert("Cannot have the range greater than 200. (from "+o+" to "+s+")");t.val=_.without(t.val,n);for(var u=0;u<=l;u++)t.val.push(o+u);e.select2("val",t.val)}}}}function addNumberFromField(e,t,n){if(t.added){if(t.val.length>1)return;var a=parseFloat(t.added.text);if(_.isNaN(a))return;var r=$("#"+n),l=parseFloat(r.val());if(_.isNaN(l))return;if(l>200)return void alert("Cannot have the range greater than 200.");for(t.val=[];l;)t.val.push(a),a++,l--;e.select2("val",t.val)}}if(!$().select2)throw"Could not be abel to find select2";return{renderTags:function(e,t){var n=function(e){if(e=e||null,t._elementData&&t._elementData[r]&&t._elementData[r].value){var n=JSON.stringify(t._elementData[r].value).replace(/\[|\]|\"/gi,"");a.val(n)}var l={tags:e?e:[]};t&&t._isListFieldType||a.attr("name",a.attr("name")+"[]"),a.select2(l),t._elementData&&t._elementData[r]&&t._elementData[r].events&&setupEvents(a,t._elementData[r].events)};t=t||null;var a=cloneInputToHiddenInput(e),r=a.attr("name"),l=a.attr("data-url");l?$.ajax({url:l,type:"GET",cache:!1,success:function(e,t,a){n(e)},error:function(e,t,n){throw console&&console.error&&(console.error("Could not be able to Send Request to "+l),console.error(arguments)),new Error("Error when send Ajax Request!")}}):n()},render:function(e,t){var n=!1;n&&(console.log("[*] select2helper.js:render"),console.log(arguments));var a=function(e){var t=jQuery(e);if(!t.length)throw new Error('Could not be able to find "'+e+'"');if(t.length>1)throw new Error('Found more than one element for "'+e+'" ['+t.length+"]");var a=t.val();return n&&(console.log("- Query:"),console.log(arguments),console.log(t),console.log(a)),_.isString(a)&&(a=a.split(",")),a};if(e.is("select")){var r={},l=!1,o=e.attr("name"),s=e.attr("data-select-value");if(t&&t.children&&t.children.BaseField){var i=t.children.BaseField._getValueFrom;i&&i[o]&&(l=!0,r.query=function(e){var t={results:[]},r=a(i[o]);_.each(r,function(e,a){n&&console.log(arguments),t.results.push({id:e,text:e})}),e.callback(t)},r.allowClear=!0,r.placeholder="Please select a value",s&&(r.initSelection=function(e,t){n&&(console.log('- initSelection for "'+o+'"'),console.log(arguments)),t({id:s,text:s})}))}if(l){var c=cloneInputToHiddenInput(e);c.select2(r),c.on("change",function(e){var n=!1;if(n&&console.log('- Select 2: change "'+o+'"'),t){var a=t.model;n&&console.log(a.get(o)),a&&a.has&&a.has(o)&&a.set(o,e.val),n&&console.log(a.get(o))}})}else e.select2(r)}}}});