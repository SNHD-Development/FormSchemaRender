define(["jquery","lodash","backbone","models/model","modelbinder","validation","vm","utils","events","text!templates/file-upload/template-upload.html","text!templates/file-upload/template-download.html"],function(e,t,n,r,i,s,o,u,a,f,l){return n.View.extend({initialize:function(){this.el="#"+this.options.field.name+"_multifiles_wrapper",this.template=t.template(f),this.collection=new n.Collection([]),this._validation=t.clone(this.options.validation[this.options.field.name+"[]"])||!1,this._init=!1,this._ie7=!1,this.options.field.options.visibleon&&delete this.model.validation[this.options.field.name+"[]"];if(!e.isEmptyObject(this.options.field.options.visibleon))e(this.options.name).on("visibleOnRenderComplete",this.el,{view:this},this.addEvents);else{var r={data:{view:this}};this.addEvents(r)}},render:function(){var t=e("#"+this.options.field.name+"_multifiles_table .files",this.el);t.html(this.template({collection:this.collection.toJSON(),convertFileSize:this.convertFileSize})),this._init&&this.collection.length===0&&this._validation&&(this.model.validation[this.options.field.name+"[]"]=this._validation),this._init=!0},events:{},convertFileSize:function(e){var t;for(var n=["KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"],r=0,i=e/1024;i>1;i/=1024,r++)t=i.toFixed(3)+" "+n[r];return t},setupEvents:function(t,n){n.model.validation[n.options.field.name+"[]"]=n._validation,e(".delete",t).on("click",{view:this},function(t){var n=t.data.view||!1;n.collection.reset(),n._ie7?(e("#"+n.options.field.name+"_multifiles_wrapper :input.hidden-multi-files").remove(),e("#"+n.options.field.name+"_file_upload_inputs button.delete").remove()):e("#"+n.options.field.name+"_multifiles_wrapper :input.hidden-multi-files").remove(),n.render()}),e("#"+n.options.field.name+"_multifiles",t).on("change",{view:this},n.changeFileInput),e("body").hasClass("ie7")?(n._ie7=!0,e("#"+n.options.field.name+"_file_upload_inputs",t).on("click","button.cancel",{view:this},n.removeFile)):e("#"+n.options.field.name+"_multifiles_table",t).on("click","button.cancel",{view:this},n.removeFile)},addEvents:function(e){var t=e.data.view||!1;t.setupEvents(this.el,t)},clickFileUploadButton:function(t){var n=e(t.currentTarget),r=t.data.view||!1;e("#"+r.options.field.name+"_multifiles",n.parent()).focus().trigger("click")},changeFileInput:function(n){var r=n.data.view||!1,i=n.target.value,s=e(this);if(s.get(0).files)t.each(s.get(0).files,function(t){if(typeof r.collection.findWhere({name:t.name,size:t.size})=="undefined"){r.collection.add(t);var n=r.collection.at(r.collection.length-1),i=e("#"+r.options.field.name+"_multifiles").removeClass("not_sending").attr("id",r.options.field.name+"_"+n.cid).addClass("hidden-multi-files"),s='<input type="file" name="'+r.options.field.name+'[]" id="'+r.options.field.name+'_multifiles" class="not_sending">';i.parent().append(s),e("#"+r.options.field.name+"_multifiles").on("change",{view:r},r.changeFileInput),delete r.model.validation[r.options.field.name+"[]"]}});else if(typeof r.collection.findWhere({name:i})=="undefined"){r.collection.add({name:i});var o=e("body").hasClass("ie8")?" hideInputFile":e("body").hasClass("ie7")?" showInputFile":"",u=r.collection.at(r.collection.length-1),a=e("#"+r.options.field.name+"_multifiles").removeClass("not_sending hideInputFile").attr("id",r.options.field.name+"_"+u.cid).addClass("hidden-multi-files"),f='<input type="file" name="'+r.options.field.name+'[]" id="'+r.options.field.name+'_multifiles" class="not_sending'+o+'">';r._ie7&&(f=' <button class="btn btn-danger cancel" type="button" data-name="'+i+'"><i class="icon-trash icon-white"></i><span>Remove</span></button>'+f),a.parent().append(f),e("#"+r.options.field.name+"_multifiles").on("change",{view:r},r.changeFileInput),delete r.model.validation[r.options.field.name+"[]"]}r.render()},removeFile:function(t){var n=t.data.view||!1;if(n._ie7){var r=e(this);o=n.collection.findWhere({name:r.attr("data-name")}),n.collection.remove(o),r.prev().remove(),r.remove()}else{var i=e(this).parents(".template-upload"),s=i.find(".size"),o,u={name:i.find(".name").text()};s.length>0&&(u.size=parseInt(s.attr("data-size"))),o=n.collection.findWhere(u),n.collection.remove(o),e("#"+n.options.field.name+"_"+o.cid).remove(),n.render()}}})});