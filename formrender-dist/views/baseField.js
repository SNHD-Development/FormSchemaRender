define(["jquery","underscore","backbone","bootstrap","events","vm","utils","models/model","collections/collections","modelbinder","validation","views/fields/list","text!data/email.json","text!data/schooles.json","text!data/county.json","text!templates/fields/html.html","text!templates/fields/label.html","text!templates/fields/text.html","text!templates/fields/password.html","text!templates/fields/telephone.html","text!templates/fields/socialsecurity.html","text!templates/fields/hidden.html","text!templates/fields/timestamp.html","text!templates/fields/useraccount.html","text!templates/fields/fraction.html","text!templates/fields/booleaninput.html","text!templates/fields/radio.html","text!templates/fields/file.html","text!templates/fields/multifiles.html","text!templates/fields/filerepository.html","text!templates/fields/read-filerepository.html","text!templates/fields/state.html","text!templates/fields/county.html","text!templates/fields/zipcode.html","text!templates/fields/country.html","text!templates/fields/fullname.html","text!templates/fields/address.html","text!templates/fields/textarea.html","text!templates/fields/number.html","text!templates/fields/email.html","text!templates/fields/date.html","text!templates/fields/select.html","text!templates/fields/check.html","text!templates/fields/birthdate.html","text!templates/fields/button.html","text!templates/fields/buttongroup.html","text!templates/fields/list.html","text!templates/fields/uneditableinput.html","text!templates/fields/uneditablecheck.html","text!templates/fields/uneditabletag.html","text!templates/fields/uneditabletel.html","text!templates/fields/uneditablefile.html","text!templates/fields/uneditableimage.html","text!templates/fields/buttonclipboard.html","text!templates/subform-layouts/table.html","text!templates/update-on-read/default-input.html","text!templates/update-on-read/default-input-radio.html","text!templates/update-on-read/default-input-textarea.html","text!templates/update-on-read/default-input-date.html","jquery.expose","jquery.datepicker","jquery.birthdaypicker","bootstrap"],function(e,t,a,o,i,s,n,l,r,d,m,p,u,c,f,h,b,v,_,g,y,D,w,x,k,S,C,V,F,O,L,N,A,B,j,E,I,T,U,M,R,$,J,z,P,q,H,Y,G,K,Q,W,X,Z,ee,te,ae,oe,ie){function se(e){var t,a=!0;if(ne&&(console.log("[*] buildHtmlBasicFormMarkup"),console.log(arguments)),e.attributes||(e.attributes={}),!e.description)throw'Expected a "description" in buildHtmlBasicFormMarkup parameter.';if(!e.name)throw'Expected a "name" in buildHtmlBasicFormMarkup parameter.';if(!e.type)throw'Expected a "type" in buildHtmlBasicFormMarkup parameter.';var o=e.type.toLowerCase(),i="";switch(o){case"hidden":a=!1;var s=e.attributes.value;t='<input type="hidden" name="'+e.name+'" value="'+s+'"/>';break;case"textarea":t='<textarea name="'+e.name+'" class="'+i+'" id="'+e.name+'"></textarea>';break;case"textbox":t='<input name="'+e.name+'" type="text" class="'+i+'" id="'+e.name+'"/>';break;default:throw'Not implement "'+e.type+'" yet in buildHtmlBasicFormMarkup.'}return a&&(t='<label for="'+e.name+'">'+e.description+"</label>"+t),'<div class="form-markup-field">'+t+"</div>"}var ne=!1,le={"default-input":t.template(te),"default-input-radio":t.template(ae),"default-input-textarea":t.template(oe),"default-input-date":t.template(ie)};return a.View.extend({_modelBinder:void 0,clean:function(){a.Validation.unbind(this),"undefined"!=typeof this._modelBinder&&this._modelBinder.unbind()},initialize:function(){var a=this;this._div=0,this._hasUserId=!1,this._hasDate=!1,this._hasBDate=!1,this._DatePickerLogicArr={},this._hasEmailPicker=!1,this._hasBooleanInput=!1,this._hasRadioBtnGroup=!1,this._hasSelectAllCheckBox=!1,this._hasClearAllCheckBox=!1,this._hasOtherTextBox=!1,this._internalFields=[],this._visibleOn=[],this._multiFiles=[],this._buttonClipboards=[],this._buttonDecision=[],this._ajaxDataCall=[],this._javaUpload=[],this._elementData={},this._ajaxSubmit=!0,this._radioFieldName=[],this._lookupValues={},this._listSchema={},this._getValueFrom={},this._visibleonEventAttached={},this._stepDiv=0,this._currentStep=1,this._stepValidated=[],this._modelBinder=new d,this.options.formSchema.validation=this.options.formSchema.validation||{},this.model=new l(t.extend(this.options.formSchema,{is_internal:this.options.internal,render_mode:this.options.mode,status:"update"===this.options.mode&&this.options.formData&&this.options.formData.status?this.options.formData.status:null})),this.options.formData&&!t.isEmpty(this.options.formData)&&this.model.multiFilesDefaultValue&&!t.isEmpty(this.model.multiFilesDefaultValue)&&(this.model.multiFilesDefaultValue=t.reduce(this.model.multiFilesDefaultValue,function(e,t,o){var i=o.replace(/[\[\]]/gi,"");return a.options.formData&&a.options.formData.fields&&a.options.formData.fields[i]&&(e[o]=a.options.formData.fields[i]),e},{})),e.isEmptyObject(this.options.formData)||t.each(this.model.attributes,function(e,t){if("object"==typeof e);else{var o={};o[t]=a.options.formData.fields[t],a.model.set(o)}}),this.prefixedName={list:"subform_",listdisplayid:"_form_content",collectiondisplayid:"_form_collection"},this.notRenderLabel=["html","list","button","submit","clear","fieldset","fieldsetstart","fieldsetend","step","check","checkbox","timestamp","hidden"],this.notRenderLabelRead=["html","list","button","submit","clear","fieldset","fieldsetstart","fieldsetend","step","check","checkbox"],this.inputTemplate={html:t.template(h),label:t.template(b),text:t.template(v),password:t.template(_),telephone:t.template(g),socialsecurity:t.template(y),hidden:t.template(D),timestamp:t.template(w),useraccount:t.template(x),fraction:t.template(k),booleaninput:t.template(S),radio:t.template(C),file:t.template(V),multifiles:t.template(F),filerepository:t.template(O),"read-filerepository":t.template(L),state:t.template(N),county:t.template(A),zipcode:t.template(B),country:t.template(j),fullname:t.template(E),address:t.template(I),textarea:t.template(T),number:t.template(U),email:t.template(M),date:t.template(R),select:t.template($),check:t.template(J),birthdate:t.template(z),button:t.template(P),buttongroup:t.template(q),list:t.template(H),uneditableinput:t.template(Y),uneditablecheck:t.template(G),uneditabletag:t.template(K),uneditabletel:t.template(Q),uneditablefile:t.template(W),uneditableimage:t.template(X),buttonclipboard:t.template(Z),"subform-table":t.template(ee)};var o={submitbutton:"Submit",resetbutton:"Cancel"};this.options.formSchema.formoptions=t.extend(o,this.options.formSchema.formoptions)||o},getFormValidationData:function(e){return this.options.formSchema.validation=this.options.formSchema.validation||{},"undefined"==typeof this.options.formSchema.validation[e]?{}:this.options.formSchema.validation[e]},closeOpenDiv:function(e){e=e||"_div";for(var t="",a=0,o=this[e];a<o;++a)t+="</div>";return this._div=0,t},render:function(a,o){var i=this,l="",r=[a.name],d=a.type.toLowerCase(),m="";if(a.lang=this.options.lang,a.attributes=a.attributes||{},a.attributes.autocomplete||(a.attributes.autocomplete="off"),a.options=a.options||{},this.options.formSchema.validation=this.options.formSchema.validation||{},this.options.formData=this.options.formData||{},!this.options.internal&&a.options.internal)return"";if(("button"===d||"submit"===d)&&!a.options.internal&&this.options.internal)return"";if(a.options.renderas){switch(d){case"date":this.options.formData&&this.options.formData.fields&&this.options.formData.fields[a.name]&&this.options.formData.fields[a.name].$date&&(this.options.formData.fields[a.name]=n.formatDateAsString(this.options.formData.fields[a.name].$date));break;case"number":break;default:throw'Not Implement Options.RenderAs for "'+d+'" yet!'}d=a.options.renderas.toLowerCase()}switch(d){case"booleaninput":this._hasBooleanInput=!0;break;case"radio":this._radioFieldName.push(a.name),!this._hasRadioBtnGroup&&a.options.render&&(this._hasRadioBtnGroup=!0),this.options.formData.fields&&this.options.formData.fields[a.name]&&("read"===this.options.mode&&a.values&&t.isObject(a.values)&&(this._lookupValues[a.name]={value:this.options.formData.fields[a.name],text:a.values[this.options.formData.fields[a.name]]},t.isArray(a.values)||(this.options.formData.fields[a.name]=a.values[this.options.formData.fields[a.name]])),a._data=this.options.formData.fields[a.name]),a.options.orderby&&this.sortOrderBy(a);break;case"multifiles":this.options.internal&&"undefined"!=typeof a.options.internalcanupdate&&!a.options.internalcanupdate||e("form"+this.el).attr("enctype","multipart/form-data"),this._multiFiles.push(a);var p=this.getFormValidationData(a.name+"[]");"undefined"==typeof this._stepValidated[this._currentStep-2]||e.isEmptyObject(p)||this._stepValidated[this._currentStep-2].push(a.name+"[]"),"read"===this.options.mode&&(d="file");break;case"filerepository":if(!a.options.url)throw'Expected Url parameter in Options Key for "'+a.name+'".';break;case"image":a.attributes.accept="image/*";case"file":this.options.internal&&"undefined"!=typeof a.options.internalcanupdate&&!a.options.internalcanupdate||e("form"+this.el).attr("enctype","multipart/form-data");var p=this.getFormValidationData(a.name);if(p.accept&&(a.attributes.accept=p.accept),a.options.javaupload){var h={name:a.name,id:a.name,code:"com.elementit.JavaPowUpload.Manager",archive:"//public.southernnevadahealthdistrict.org/assets/jar/jupload/JavaPowUpload.jar, //public.southernnevadahealthdistrict.org/assets/jar/jupload/skinlf.jar, //public.southernnevadahealthdistrict.org/assets/jar/jupload/commons-httpclient.jar, //public.southernnevadahealthdistrict.org/assets/jar/jupload/commons-compress.jar",width:500,height:350,mayscript:"true",alt:"JavaPowUpload by www.element-it.com"};this._javaUpload.push(h)}if(a.options.markdownloaddatetimeof&&this.options.mode&&"read"===this.options.mode){var b=this.options.internal?"internal":"external",v=a.options.markdownloaddatetimeof.toLowerCase();"*"!==v&&v!==b||(a.attributes.class=(a.attributes.class?a.attributes.class:"")+" btn-auto-refresh ",a.attributes["data-refresh-delay"]||(a.attributes["data-refresh-delay"]="2000"))}break;case"userid":this._hasUserId=!0,a.options&&a.options.lookup&&a.options.lookup.url&&(a.options.url=a.options.lookup.url),a.options.url&&(a.attributes["data-url"]=a.options.url),a.options.data&&(a.attributes["data-url-data"]=JSON.stringify(a.options.data)),a.attributes.placeholder=a.attributes.placeholder||"Valid E-mail as Username",a.attributes.class=(a.attributes.class||"")+" userid-lookup",d=a.options.render?a.options.render.toLowerCase():"text","select"===d&&(a.values=[]),a.attributes.class=n.setupClassAttr(a.attributes.class,"span12");break;case"fraction":break;case"textbox":d="text";case"selectsingle":"selectsingle"===d&&(d="select");case"select":if("update"===this.options.mode&&this.options.formData.fields[a.name]&&(a.attributes["data-select-value"]=this.options.formData.fields[a.name]),a.options&&a.options.lookup&&a.options.lookup.url)a.options.url=a.options.lookup.url,a.options.lookup.value&&(a.attributes["data-select-key-value"]=a.options.lookup.value),a.options.lookup.text&&(a.attributes["data-select-key-text"]=a.options.lookup.text);else if(a.options){if(a.options.tags)a.attributes.class=(a.attributes.class?a.attributes.class:"")+" selecttwo-render tags value-as-array";else if(a.options.render){var _=a.options.render.toLowerCase();switch(_){case"select2":a.attributes.class=(a.attributes.class?a.attributes.class:"")+" selecttwo-render"}}a.options.events&&this.addDataToElementData(a.name,"events",a.options.events),a.options.orderby&&this.sortOrderBy(a),a.options.getvaluefrom&&a.name&&(this._getValueFrom[a.options.getvaluefrom]||(this._getValueFrom[a.name]=a.options.getvaluefrom))}a.options.url&&(a.attributes["data-url"]=a.options.url.replace(/'/gi,"&#39;")),a.options.data&&(a.attributes["data-url-data"]=JSON.stringify(a.options.data)),a.attributes.class=n.setupClassAttr(a.attributes.class,"span12"),this.options.formData&&this.options.formData.fields&&this.options.formData.fields[a.name]&&(t.isArray(this.options.formData.fields[a.name])&&this.options.formData.fields[a.name].sort(function(e,t){return e-t}),"read"===this.options.mode&&a.values&&t.isObject(a.values)&&(a._data=a.values[this.options.formData.fields[a.name]]),this.addDataToElementData(a.name,"value",this.options.formData.fields[a.name]));break;case"county":"string"==typeof f&&(f=e.parseJSON(f)),a._options=f,a.attributes.id||(a.attributes.id=a.name);var g="select2-county";a.options.filterbyid&&(g="select2-county-lookup"),a.attributes.class?a.attributes.class+=" "+g:a.attributes.class=g,this.options.formData&&this.options.formData.fields&&this.options.formData.fields[a.name]&&(a.attributes["data-countyvalue"]=this.options.formData.fields[a.name]);break;case"checkbox":case"check":if(a.options.numcolumns){if(!t.isNumber(a.options.numcolumns))throw"NumColumns must be a valid number for "+a.name;a.options.numcolumns>4?a.options.numcolumns=4:a.options.numcolumns<1&&(a.options.numcolumns=1)}else a.options.numcolumns=1;if(!this._hasSelectAllCheckBox&&a.options.addselectall&&(this._hasSelectAllCheckBox=!0),!this._hasClearAllCheckBox&&a.options.addclearall&&(this._hasClearAllCheckBox=!0),a.options.orderby&&this.sortOrderBy(a),a.options.othertextbox&&(this._hasOtherTextBox=!0),"update"===this.options.mode&&this.options.formData.fields&&this.options.formData.fields[a.name]&&(a._data=this.options.formData.fields[a.name]),this.options.formData.fields&&this.options.formData.fields[a.name+"_other"]&&(a._otherValue=this.options.formData.fields[a.name+"_other"]),"undefined"!=typeof this.options.formSchema.validation[a.name+"[]"]){a._required=!0,a.attributes||(a.attributes={}),a.attributes["data-check-required"]=!0;var p=this.getFormValidationData(a.name+"[]");"undefined"==typeof this._stepValidated[this._currentStep-2]||e.isEmptyObject(p)||this._stepValidated[this._currentStep-2].push(a.name+"[]")}else a._required=!1;if(d="check",!a.values)throw"In order to use CheckBox, please set Values.";break;case"password":a.attributes.class=n.setupClassAttr(a.attributes.class,"span12");break;case"telephone":a.attributes.class=n.setupClassAttr(a.attributes.class,"integer telephone span12"),this.options.formData.fields&&this.options.formData.fields[a.name+"_provider"]&&(a._providerValue=this.options.formData.fields[a.name+"_provider"]);break;case"socialsecurity":a.attributes.class=n.setupClassAttr(a.attributes.class,"integer socialsecurity span12");break;case"textarea":a.attributes.class=n.setupClassAttr(a.attributes.class,"span12");break;case"action":return this._div++,'<div class="form-actions">';case"fieldsetstart":return"<fieldset><legend>"+a.description+"</legend>";case"fieldsetend":return"</fieldset>";case"hr":return"<hr>";case"dateinput":d="date";case"date":if(this.options.formData&&this.options.formData.fields)if("object"==typeof this.options.formData.fields[a.name]){var y=new Date(this.options.formData.fields[a.name].$date),D=y.getMonth()+1;D<10&&(D="0"+D),D+="/";var w=y.getDate();if(w<10&&(w="0"+w),w+="/",this.options.formData.fields[a.name]=D+w+y.getFullYear(),a.options.render&&"read"===this.options.mode)switch(a.options.render.toLowerCase()){case"datetime":this.options.formData.fields[a.name]+=" "+n.formatAMPM(y)}a.attributes.value=this.options.formData.fields[a.name]}else"create"===this.options.mode&&"undefined"==typeof this.options.formData.fields[a.name]&&(a._noDefaultValue=!0);if(a.attributes&&!a.attributes.placeholder&&(a.attributes.placeholder="mm/dd/yyyy"),a.options.render&&"select"===a.options.render.toLowerCase()){d="birthdate",this._hasBDate=!0,a.attributes.class=n.setupClassAttr(a.attributes.class,"birthdaypicker");var p=this.getFormValidationData(a.name),x={id:a.name};"en"!==a.lang&&(x.lang=a.lang),"undefined"!=typeof this.options.formData.fields&&(x.defaultdate=this.options.formData.fields[a.name]),a._noDefaultValue&&(x.nodefaultvalue=!0),a.attributes["data-options"]=JSON.stringify(t.extend(x,p)),"undefined"==typeof this._stepValidated[this._currentStep-2]||e.isEmptyObject(p)||(this._stepValidated[this._currentStep-2].push(a.name+"_birth[month]"),this._stepValidated[this._currentStep-2].push(a.name+"_birth[day]"),this._stepValidated[this._currentStep-2].push(a.name+"_birth[year]"))}else{this._hasDate=!0,a.attributes.class=n.setupClassAttr(a.attributes.class,"datepicker");var p=this.getFormValidationData(a.name);t.each(p,function(e,t){delete p[t],p[t.toLowerCase()]=e}),p.maxdate&&(a.attributes["data-maxdate"]=p.maxdate),p.mindate&&(a.attributes["data-mindate"]=p.mindate),a.options&&a.options.datepickeroptions&&(this._DatePickerLogicArr[a.name]=a.options.datepickeroptions,a.attributes["data-has-datepicker-options"]=!0)}break;case"email":a.attributes.class=n.setupClassAttr(a.attributes.class,"tolowercase span12"),"undefined"!=typeof a.options.autocomplete&&a.options.autocomplete&&(this._hasEmailPicker=!0,a.attributes={},a.attributes["data-provide"]="typeahead",a.attributes.autocomplete="off",a.attributes.style="width:45%;",a.attributes.class="not_sending emailpicker_server tolowercase",a.attributes["data-source"]=u.replace(/\n/g,"").replace(/'/g,"&#39"),"undefined"!=typeof a.options.default&&(a.attributes["data-value"]=a.options.default),r.push(a.name+"_username"),r.push(a.name+"_server"));break;case"address":if(delete a.attributes.class,delete a.attributes.placeholder,r=[],r.push(a.name+"_address_street"),r.push(a.name+"_address_city"),r.push(a.name+"_address_state"),r.push(a.name+"_address_zip"),r.push(a.name+"_address_country"),a.options.showstreetnumber&&r.push(a.name+"_address_street_number"),a.options.showunitnumber&&r.push(a.name+"_address_unit_number"),"undefined"!=typeof o&&"undefined"!=typeof this.options.formData?(this.options.formData.fields[a.name+"_address_country"]=s.getCountry(this.options.formData.fields[a.name+"_address_country"]),this.options.formData.fields[a.name+"_address_street"]&&"."!==this.options.formData.fields[a.name+"_address_street"].charAt(this.options.formData.fields[a.name+"_address_street"].length-1)&&(this.options.formData.fields[a.name+"_address_street"]+="."),this.options.formData.fields[a.name+"_address_street"]+="<br>",this.options.formData.fields[a.name+"_address_city"]+=",",this.options.formData.fields[a.name+"_address_state"]+="<br>",this.options.formData.fields[a.name+"_address_zip"]+="<br>"):"update"===this.options.mode&&"US"!==this.options.formData.fields[a.name+"_address_country"]?a.default_value_state=this.options.formData.fields[a.name+"_address_state"]:"create"===this.options.mode&&(this.model.set(a.name+"_address_state","NV"),this.model.set(a.name+"_address_country","US")),a.options.zipcodeformat){var k=a.options.zipcodeformat.toLowerCase();switch(k){case"zip+4":a._zipmax=10}}break;case"number":var S;if(!a.options.numbertype||a.options.decimals)S=a.options.decimals?"number":"natural",a.options.decimals&&(a.attributes["data-decimal"]=a.options.decimals);else if(a.options.numbertype&&!a.options.limitinputvalue)switch(a.options.numbertype.toLowerCase()){case"currency":S="number";break;case"double":S="rational";break;default:S="natural"}else S="natural";if(a.options.limitinputvalue&&(S=a.options.limitinputvalue),!S||"string"!=typeof S)throw new Error('Could not be able to find matching class name for "'+a.name+'" for a number input type.');if(a.attributes.class=n.setupClassAttr(a.attributes.class,S+" span12"),a.options.decimals&&this.options.formData.fields&&this.options.formData.fields[a.name]){var C=parseFloat(this.options.formData.fields[a.name]/Math.pow(10,parseInt(a.options.decimals,10)));isNaN(C)||(this.options.formData.fields[a.name]=C.toFixed(a.options.decimals),a.attributes.value=this.options.formData.fields[a.name],this.model.has(a.name)&&this.model.set(a.name,this.options.formData.fields[a.name]))}"undefined"!=typeof a.options.spinner&&a.options.spinner&&(a.attributes.class=a.attributes.class.replace(/ span12/,"","gi"),a.attributes.class=n.setupClassAttr(a.attributes.class,"spinner-input"),"update"===this.options.mode&&this.options.formData.fields[a.name]&&(a.attributes["data-value"]=this.options.formData.fields[a.name]));break;case"fullname":if(delete a.attributes.class,delete a.attributes.placeholder,r=[],r.push(a.name+"_fullname_first_name"),("undefined"==typeof a.options.middlename||a.options.middlename)&&r.push(a.name+"_fullname_middle_name"),r.push(a.name+"_fullname_last_name"),a.options.url&&this._ajaxDataCall.push(a),"read"===this.options.mode&&a.options&&a.options.highlight){var V=a.options.highlight.toLowerCase().split(",");t.each(V,function(e){var t=a.name+"_fullname_"+e;i.options.formData.fields[t]&&(i.options.formData.fields[t]="<u>"+i.options.formData.fields[t]+"</u>")})}break;case"clear":d="button",a.attributes.class=n.setupClassAttr(a.attributes.class,"btn btn-clear-form");break;case"submit":a.attributes.class=n.setupClassAttr(a.attributes.class,"btn"),d="button",a._submit=!0,"undefined"==typeof a.url&&(a.url=""),a.options.appendid&&this.options.formData._id&&this.options.formData._id.$oid&&(a.url=(a.url?a.url:"")+(a.url.indexOf("?")>-1?"&id=":"/")+this.options.formData._id.$oid),e(this.el).attr("action",a.url),"undefined"!=typeof a.options.ajaxsubmit&&(this._ajaxSubmit=a.options.ajaxsubmit);break;case"buttonclipboard":a.attributes.class=n.setupClassAttr(a.attributes.class,"btn btn-primary"),this._buttonClipboards.push({name:a.name,values:a.values});break;case"buttondecision":o||(a.attributes.class=n.setupClassAttr(a.attributes.class,"btn btn-primary"),d="button",this._buttonDecision.push(a));break;case"button":if(!n.shouldRenderShowOnUser(a))return"";if(a.attributes.class=n.setupClassAttr(a.attributes.class,"btn"),this.options&&this.options.formData&&this.options.formData._id&&this.options.formData._id.$oid&&(a.options.appendid?a.url=(a.url?a.url:"")+(a.url.indexOf("?")>-1?"&id=":"/")+this.options.formData._id.$oid:a.url&&a.url.search(/{\w+}/gi)>-1&&(a.url=n.formatUriSegment(a.url,this.options.formData))),a.url&&(a.url=n.changeURLGetTemplateString(a.url)),this.options.internal&&"read"===this.options.mode&&"BtnMarkAsUnacceptable"===a.name&&e.fn.remodal){var F=t.find(this.options.formSchema.fields,function(e){if(e&&e.name&&e.type)return"UnacceptableReason"===e.name?e:void 0});if(F){var O=this.options.formData&&this.options.formData.fields&&this.options.formData.fields.UnacceptableReason?this.options.formData.fields.UnacceptableReason:null;O&&O.replace&&(O=O.replace(/'/gi,"\\'"));var L=(new Date).getTime();switch(a.options["data-remodal-target"]="btnmarkasunacceptable_"+L,a.options["data-remodal-current-value"]=O,a.options["data-current-form-id"]=this.options.formData._id.$oid,a.options["data-url-mark-as-unacceptable"]=a.url,F.type.toLowerCase()){case"radio":if(!F.values)throw new Error("Expected a values key!");a._customHtml=t.reduce(F.values,function(e,a,o,i){var s="UnacceptableReason_"+o,n=t.isArray(i)?a:o,l=O&&O===n?'checked="true"':"";n&&n.replace&&(n=n.replace(/"/gi,"&quot;"));var r='<label class="radio"><input '+l+' name="UnacceptableReason" id="'+s+'" value="'+n+'" type="radio">'+a+"</label>";return e+r},"");break;case"textarea":a._customHtml='<textarea autocomplete="off" name="UnacceptableReason" id="UnacceptableReason"></textarea>';break;default:throw new Error("Not implement "+F.type+" yet!")}a.options.confirmed=null}}if(a.options.confirmed){var N=a.options.confirmedtext?a.options.confirmedtext:"Please confirm your selection.",A={html:!0,placement:"top",title:'<span class="text-info">'+N+"</span>",content:'<a class="btn btn-success btn-confirmed" data-href="'+a.url+'">Yes</button><a class="btn btn-danger btn-confirmed">No</button>'};a.attributes["data-popover-confirm"]=JSON.stringify(A)}else if(a.options.subbuttons)a.name||(a.name="subbuttons_"+a.description.replace(/ /g,"").toLowerCase(),a.attributes.id||(a.attributes.id=a.name)),require(["views/subform-layouts/subbuttons"],function(t){var o=a.attributes.id?a.attributes.id:a.name;s.create(this,o,t,{subbuttons:a.options.subbuttons,internal:!!i.options.internal&&i.options.internal,mode:i.options.mode,status:i.options.formData&&i.options.formData.status?i.options.formData.status:null,_id:o,button:e(".form-render #"+o),_oid:i.options.formData&&i.options.formData._id&&i.options.formData._id.$oid?i.options.formData._id.$oid:null})});else if(a.options.subform){if("read"!==this.options.mode)return"";if(!a.name)throw"Expected a valid Name for SubForm Button.";var B=this.options.formData&&this.options.formData._id&&this.options.formData._id.$oid?this.options.formData._id.$oid:null;if(!B)throw"Expected a valid ID for SubForm Button.";var j=a.options.subform;if(!j.url||"string"!=typeof j.url)throw"Please pass in URL key as a string in SubForm options.";if(!j.fields||!t.isArray(j.fields))throw"Please pass in URL key as an array in SubForm options.";var E="",I=a.options.subform.validation;t.each(j.fields,function(e){E+=se(e)}),E='<div class="subform-button-wrapper">'+E+'<div class="text-center"><a class="btn btn-primary subform-btn-submit" data-button-name="'+a.name+'">Submit</a></div></div>',e("div#app").on(this.options.formSchema.name+".renderCompleted",function(o,i){var s=e(this).find("button#"+a.name);if(1!==s.length)throw"Invalid SubForm Button, please make sure that the name is unique.";s.popover({html:!0,placement:"top",trigger:"manual",title:'<span class="text-info">Please complete this form.</span>',content:E}),s.on("click",function(e){return!s.hasClass("submitted")&&void(s.hasClass("shown")?s.removeClass("shown").popover("hide"):s.addClass("shown").popover("show"))}),s.parent().on("click",".subform-btn-submit",function(o){o.preventDefault(),o.stopPropagation();var i=e(o.target).attr("data-button-name");if(i!==s.attr("data-button-name")&&s.next(".popover").find(".subform-btn-submit").attr("data-button-name")!==i)return!1;var n=s.next(".popover").find(".subform-button-wrapper"),l=n.find(":input"),r={},d=!1;if(l.each(function(){var t=e(this),a=t.attr("name"),o=t.val();if(!a||""===a)throw"expect valid input name!";I&&I[a]&&(I[a].required&&""===o?(t.addClass("invalid"),d=!0):t.removeClass("invalid")),r[a]=o}),!d){var m="subform-btn-"+(new Date).getTime().toString(),p="",u=t.extend({},j.get);t.each(r,function(e,t){var a=t.toLowerCase();u.hasOwnProperty(a)?(delete u[a],u[t]=e):p+='<input type="hidden" name="'+t+'" value="'+e+'"/>'}),"/"!==a.options.subform.url[a.options.subform.url.length-1]&&(a.options.subform.url+="/");var c=a.options.subform.url+B;u&&(c+="?"+e.param(u)),e("body").append('<form id="'+m+'" action="'+c+'" method="POST">'+p+"</form>"),s.removeClass("shown").popover("destroy"),s.popover({html:!0,placement:"top",trigger:"manual",title:'<span class="text-info">Sending Information</span>',content:'<div class="text-center subform-button-wrapper"><i class="icon-spinner icon-spin icon-large"></i> Sending</div>'}).addClass("submitted").popover("show"),s.closest(".form-actions").find(":button").attr("disabled",!0),window.setTimeout(function(){e("body").find("#"+m).submit()},1e3)}return!1})})}break;case"schooles":d="text",a.attributes.class=n.setupClassAttr(a.attributes.class,"span12"),a.attributes["data-provide"]="typeahead",a.attributes.autocomplete="off",a.attributes["data-source"]=c.replace(/\n/g,"").replace(/'/g,"&#39");break;case"step":if(!("view"in this.options.formSchema&&"wizard"===this.options.formSchema.view))return"";0!==this._stepDiv&&(l+="</div>",this._stepDiv--),"undefined"==typeof this._stepValidated[this._currentStep-1]&&(this._stepValidated[this._currentStep-1]=[]);var T="step-pane"+(1===this._currentStep?" active":"");l+='<div class="'+T+'" id="wizard_step'+this._currentStep+'">',this._stepDiv++,this._currentStep++;break;case"useraccount":a.data_value="",a.options.getvaluefromid&&(a.data_value=e("#"+a.options.getvaluefromid).text());break;case"list":a.attributes.id=this.prefixedName.list+("undefined"!=typeof a.attributes.id?a.attributes.id:a.name),a.attributes.class=n.setupClassAttr(a.attributes.class,"subform-container");var U="undefined"!=typeof this.options.formSchema.validation[a.name]?this.options.formSchema.validation[a.name]:{};this.attachSubFormEvent(a.attributes.id,a,U),this._listSchema[a.name]=a;break;case"hidden":var M=["update","create"];t.indexOf(M,this.options.mode)>-1&&this.options.formData&&this.options.formData.fields&&this.options.formData.fields[a.name]&&(a.attributes||(a.attributes={}),a.attributes.value=this.options.formData.fields[a.name])}if("button"===d&&a.options.visibleon){var R=function(t){"change"===t.type&&a.options.visibleon.values.indexOf(e(this).val())>-1?e("#"+a.name,i.el).show("slow"):e("#"+a.name,i.el).hide("slow")};e(this.el).on("change",':input[name="'+a.options.visibleon.name+'"]',R).on("removeVisibleOn",':input[name="'+a.options.visibleon.name+'"]',R)}if("undefined"!=typeof this._stepValidated[this._currentStep-2]&&"step"!==d&&"list"!==d&&n.checkRequireFields(a,this.options.formSchema.validation)&&t.each(r,function(e){i._stepValidated[i._currentStep-2].push(e)}),"undefined"!=typeof o&&o&&"undefined"!=typeof r[0]&&"button"!==d&&"buttonclipboard"!==d){var $="",J="";if(t.each(r,function(e){"object"!=typeof i.options.formData.fields[e]?$+=("undefined"!=typeof i.options.formData.fields[e]?i.options.formData.fields[e]:"")+" ":$=i.options.formData.fields[e]}),"string"==typeof $&&($=e.trim($)),"file"===d||"image"===d){if("image"===d)"deleted"===i.options.formData.fields[a.name]?J=null:(a.attributes.src=("undefined"!=typeof a.attributes.src?a.attributes.src:"/form/getFile/")+i.options.formData.fields[a.name],J=a.attributes.src);else if(a.attributes.target="_blank",a.attributes.class=n.setupClassAttr(a.attributes.class,"btn btn-primary"),a.attributes.href=("undefined"!=typeof a.attributes.href?a.attributes.href:"/form/getFile/")+i.options.formData.fields[a.name],a.attributes.id||(a.attributes.id=a.name),a.options.markdownloaddatetimeof&&this.options.formData._id&&this.options.formData._id.$oid){var z=a.options.markdownloaddatetimeof.toLowerCase();("*"===z||this.options.internal&&"internal"===z||!this.options.internal&&"external"===z)&&(a.attributes.href+="?formid="+this.options.formData._id.$oid)}else a.options.appendid&&this.options.formData._id&&this.options.formData._id.$oid&&(a.attributes.href+="?formid="+this.options.formData._id.$oid);delete a.attributes.accept,t.each(a.attributes,function(e,t){e.search("'")&&(e=e.replace(/\'/gi,'"')),m+=" "+t+"='"+e+"'"}),l+=i.inputTemplate["uneditable"+d]({value:$,text:a.description,_attr:m,id:a.name,href:J})}else if("list"===d)if("undefined"!=typeof this.options.formData.fields[a.name]&&(this.options.formData.fields[a.name].length>0||t.size(this.options.formData.fields[a.name])>0)){var P=[],q=[],H=[],Y={},G=0,K=new Array(this.options.formData.fields[a.name].length||t.size(this.options.formData.fields[a.name]));t.each(a.fields,function(o,s){o.options=o.options||{};var l;o.options.tabletitle?(l=o.options.tabletitle,l='<a data-content="'+e("<p>"+o.description+"</p>").text()+'" data-original-title="'+l+'" data-placement="top" data-toggle="popover" data-trigger="hover" data-html="true">'+l+"</a>"):l=o.description,P.push(l),o.options.sortby&&"date"===o.options.sortby.toLowerCase()?q.push('data-sort="int"'):q.push(o.options.sortby?'data-sort="'+o.options.sortby+'"':'data-sort="string"'),t.each(i.options.formData.fields[a.name],function(e,a){var i;if(t.isNumber(a)||(Y[o.name]?(G++,a=G):(G=0,Y[o.name]=!0,a=G)),"undefined"==typeof K[a]&&(K[a]=[],H[a]=[]),o.options.sortby&&"date"===o.options.sortby.toLowerCase()){var s=Date.parseString(e[o.name],"M/d/yyyy h:mm:ss a");H[a].push('data-sort-value="'+s.getTime()+'"')}else H[a].push(null);switch(o.type.toLowerCase()){case"timestamp":var l;l=o.options&&o.options.tabletitle?o.options.tabletitle:"Timestamps",P[P.length-1]=l,K[a].push(n.getHumanTime(e[o.name]));break;case"useraccount":P[P.length-1]="User",K[a].push(e[o.name]);break;case"fullname":i=e[o.name+"_fullname_first_name"],"undefined"!=typeof e[o.name+"_fullname_middle_name"]&&(i+=" "+e[o.name+"_fullname_middle_name"]),i+=" "+e[o.name+"_fullname_last_name"],
K[a].push(i);break;case"booleaninput":K[a].push(e[o.name]?"Yes":"No");break;case"date":var r=e[o.name];if(r&&r.$date){if(r=moment(r.$date),!r.isValid())throw new Error('Invalid Date Value for "'+o.name+'" with "'+e[o.name]+'"');r=r.format("MM/DD/YYYY")}K[a].push(r);break;case"number":o.options&&o.options.decimals&&e[o.name]&&(e[o.name]=(e[o.name]/Math.pow(10,o.options.decimals)).toFixed(o.options.decimals));default:if("undefined"==typeof e[o.name])return void delete P[P.length-1];K[a].push(e[o.name])}})}),l+=i.inputTemplate["subform-table"]({labels:P,values:K,mode:o,sortBy:q,sortByVal:H,heading:"undefined"==typeof a.options.readmodedescription?a.description:a.options.readmodedescription})}else l+="";else if("telephone"===d&&a._providerValue)l+=i.inputTemplate.uneditabletel({value:$,label:a.description,id:a.name,providerValue:a._providerValue});else if("check"===d)l+=i.inputTemplate.uneditablecheck({value:$,label:a.description,id:a.name,otherValue:a._otherValue?a._otherValue:""});else if("select"===d&&a.options&&a.options.tags)t.isArray($)&&$.sort(function(e,t){return e-t}),l+=i.inputTemplate.uneditabletag({value:$,id:a.name});else if("filerepository"===d)l+=i.inputTemplate["read-filerepository"](t.extend({data:this.options.formData.fields[a.name],formId:this.options.formData._id.$oid,Utils:n},a));else{var Q="";switch(d){case"textarea":case"address":Q=" uneditable-input-textarea";break;case"timestamp":$=n.getHumanTime($);break;case"select":a._data&&($=a._data);break;case"booleaninput":$="true"===$||$===!0?"Yes":"No"}var W=["ParentFormId","FormRecordId"];if(a.name&&this.options.internal&&t.indexOf(W,a.name)>-1){var X=n.config.internalViewUrl,Z=[];i.options.formData.fields.MultipleFormRecordId?Z=i.options.formData.fields.MultipleFormRecordId.split(","):Z.push($),t.each(Z,function(e){l+='<a class="btn btn-primary" title="View FormId = '+e+'" href="'+X+"/"+e+'" style="margin-right:20px;">View</a>'})}else l+=i.inputTemplate.uneditableinput({value:$,css_class:Q,id:a.name})}}else if("image"===d&&"undefined"!=typeof a.options.internalcanupdate&&this.options.internal&&a.options.internalcanupdate===!1){var $="",J="";t.each(r,function(e){"object"!=typeof i.options.formData.fields[e]?$+=("undefined"!=typeof i.options.formData.fields[e]?i.options.formData.fields[e]:"")+" ":$=i.options.formData.fields[e]}),"string"==typeof $&&($=e.trim($)),"deleted"===i.options.formData.fields[a.name]?J=null:(a.attributes.src=("undefined"!=typeof a.attributes.src?a.attributes.src:"/form/getFile/")+i.options.formData.fields[a.name],J=a.attributes.src),delete a.attributes.accept,t.each(a.attributes,function(e,t){e.search("'")&&(e=e.replace(/\'/gi,'"')),m+=" "+t+"='"+e+"'"}),l+=i.inputTemplate["uneditable"+d]({value:$,text:a.description,_attr:m,id:a.name,href:J})}else{if(this.options.internal&&"undefined"!=typeof a.options.internalcanupdate&&!a.options.internalcanupdate?d="hidden":t.each(a.attributes,function(e,t){m+=" "+t+"='"+e+"'"}),"image"===d&&(d="file"),ne&&(console.log(""),console.log("[*] Render HTML Field"),console.log(a),console.log(m)),ne&&"undefined"==typeof this.inputTemplate[d])throw'Template of "'+d+'" not found!';l+="undefined"!=typeof this.inputTemplate[d]?this.inputTemplate[d](t.extend({_attr:m,_lang:this.options.lang,_renderMode:this.options.mode},a)):""}if(a.options.visibleon){if(!a.options.visibleon.name||!e.isArray(a.options.visibleon.values))throw a.name+".Options.VisibleOn need Name and Values!";this._visibleOn.push(a)}return a&&a.type&&!this.inputTemplate[d]&&console&&console.warn&&console.warn('[x] Template for "'+a.type+'" does not existed.'),a.options.updateonreadmode&&(l='<div class="update-on-read-mode" data-field-name="'+a.name+'">'+l+this.generateMarkUpForUpdateOnReadMode(a)+"</div>"),l},renderLabel:function(e,a,o){a=a||!1,e.attributes=e.attributes||{},e.options=e.options||{};var i=e.type.toLowerCase(),s="undefined"!=typeof o&&o?' class="'+o+'"':"";switch(e.options.renderas&&(i=e.options.renderas.toLowerCase()),i){case"hidden":if("create"===this.options.mode)return"";break;case"buttondecision":return""}return this.inputTemplate.label(t.extend({_cssClass:s,_required:a},e))},renderButton:function(e){var t="";return(e.submitbutton||e.resetbutton)&&(t+='<div class="form-actions">'),t+=e.submitbutton&&!e.subForm?'<button type="submit" class="btn btn-primary btn-submit">'+e.submitbutton+"</button>":'<button type="button" class="btn btn-primary btn-submit">'+e.submitbutton+"</button>",e.resetbutton&&(t+='<button type="button" class="btn btn-cancel">'+e.resetbutton+"</button>"),t.length>0&&(t+="</div>"),t},checkShowOnMode:function(a,o,i){var s=!1,n="BillAnotherDept",l=0,r=a.type.toLowerCase();if(s&&a&&a.name&&(console.log("checkShowOnMode: ",a.name),console.log("")),void 0!=a.options.internal&&a.options.internal!==this.options.internal)return!1;if(a.options.internal===!0&&a.name&&"buttonclipboard"!==r){var d;switch(r){case"check":case"checkbox":d=a.name+"[]";break;default:d=a.name}this._internalFields.push(d)}if(s&&a.name===n&&(l++,console.log("Location: "+l)),this.options.hideButtons&&("button"===r||"submit"===r||"reset"===r||"action"===r))return!1;if(s&&a.name===n&&(l++,console.log("Location: "+l)),"read"===this.options.mode&&!e.isEmptyObject(a.options.visibleon)&&"undefined"==typeof this.options.formData.fields[a.name]&&"fullname"!==r&&"address"!==r&&"buttonclipboard"!==r)return s&&a.name===n&&(l++,console.log("Location: "+l," : ",this.options.formData.fields[a.name])),!1;if(s&&a.name===n&&(l++,console.log("Location: "+l)),o=o||!1,i=i||!1,"read"!==o&&"buttonclipboard"===a.type.toLowerCase())return s&&a.name===n&&(l++,console.log("Location: "+l)),!1;if("read"===o&&!this.options.internal&&a.options.hideonexternalread)return s&&a.name===n&&(l++,console.log("Location: "+l)),!1;if("undefined"!=typeof a.options.showonmode&&a.options.showonmode.indexOf(o)===-1)return s&&a.name===n&&(l++,console.log("Location: "+l)),!1;if("undefined"!=typeof a.options.showonstatus){s&&a.name===n&&(l++,console.log("Location: "+l));var m=t.map(a.options.showonstatus,function(e){return e.toLowerCase()});if("create"!==this.options.mode&&(i===!1||m.indexOf(i.toLowerCase())===-1))return!1}else if(this.options.internal&&"update"===o&&"undefined"!=typeof a.options.internalcanupdate&&!a.options.internalcanupdate&&"image"!==r)return!1;return!0},attachSubFormEvent:function(o,i,s){i=t.extend(i,{validation:s});var n=this,l={el:"#"+o+this.prefixedName.listdisplayid,formSchema:i,formId:o,options:this.options},r=t.extend({},a.Events);e(this.el).on("click","#"+o+"_add_btn",l,this.displaySubForm).on(o+".close",this.closeSubForm).on(o+".add",t.extend({formId:o},this),this.addSubformData),"update"===this.options.mode&&"undefined"!=typeof this.options.formData.fields[i.name]&&this.options.formData.fields[i.name].length>0?r.on(l.formId+".listViewCreated",function(t){console.log("- "+l.formId+".listViewCreated"),console.log(" - that.el:",n.el),console.log(" - id:",o),console.log(" - list:",t),console.log(" - that.options.formData.fields[field.name]:",n.options.formData.fields[i.name]),e(n.el).trigger(o+".add",[t,n.options.formData.fields[i.name]]),r.off()}):r.on(l.formId+".listViewCreated",function(t){var a=e("#"+l.formId,n.el),i=function(s,r){e(n.el).trigger(o+".add",[t,r,!0]),a.one(l.formId+".ajaxUpdate",i)};a.one(l.formId+".ajaxUpdate",i),r.off()}),r.on(l.formId+".listViewCreated",function(e){t.isEmpty(n._listSchema)||t.each(n._listSchema,function(t,a){n.setupSubFormListenValueEvent(n,t,a,l,r,o,e)})}),this.displaySubForm({data:l},{},!0,r)},displaySubForm:function(a,o,i,n,l){if(l=l||!1,a.data){ne&&(console.log("[*] baseField.displaySubForm"),o&&o.toJSON&&console.log(o.toJSON()),console.log(i),console.log(n),console.log(l)),o=o||{},i=i||!1,n=n||!1;var r,d=t.clone(a.data);e.isEmptyObject(o)?r="SubFormView"+a.data.formId:(d.model=o,r="SubFormViewEdit"+a.data.formId),e(this).parents("div.actions").fadeOut(),require(["views/fields/list"],function(t){ne&&(console.log("- displaySubForm: Render List!"),d.model&&console.log(JSON.stringify(d.model)));var o=s.create(this,r,t,d),m=e(o.el);i&&m.hide(),o.render(i,l),i||(m.show(),m.addClass("active"),m.expose({closeOnEsc:!1,closeOnClick:!1,color:"#000",zIndex:1025,renderBody:!1})),n&&n.trigger(a.data.formId+".listViewCreated",o)})}},setupSubFormListenValueEvent:function(o,i,s,n,l,r,d){var m=!1;if(i.options&&i.options.copyvaluesfrom){var p=i.options.copyvaluesfrom;if(p&&p.length){m&&(console.log("- Set Up setupSubFormListenValueEvent"),console.log(i),console.log(p));var u=e("div#app");t.each(p,function(i,n){m&&console.log(" - ",arguments),t.each(i,function(t,i){var l=':input[name="'+t+'"]';m&&console.log("- attached event _name:",l," listKey:",i),u.on("change",l,function(t){var p=e(t.target),u=p.val();if(u&&(u=e.trim(u)),m&&console.log("- on change fired! "+l),o.model.has(s)){var c=o.model.get(s);m&&console.log("  - currentListModel.length:",c.length);var f,h=a.Model.extend({});if(c.length){if(f=c.at(n),!f)throw new Error("Please look at List CopyValuesFrom logic!");if(f.get(i)===u)return;f.set(i,u)}else f=new h,f.set(i,u),c.push(f);m&&(console.log("  - currentListModel.length:",c.length),console.log("  - Fired: add event!")),e(o.el).trigger(r+".add",[d,c.toJSON(),!0])}})})})}}},closeSubForm:function(t,a){var o=!1;o&&console.log("[*] closeSubForm"),a.$el.fadeOut(),e.mask.close(),e(".actions",a.$el.parent(".subform-container")).fadeIn("slow"),s.remove("SubFormView"+a.options.formId,!0),s.remove("SubFormViewEdit"+a.options.formId,!0)},addSubformData:function(o,i,l,r){ne&&(console.log("[*] baseField.addSubformData"),console.log(arguments)),r=r||!1,l=l||!1;var d=i.options.formSchema.view?i.options.formSchema.view:"table",m=i.options.formSchema.name,p=o.data.model.get(m);if(ne&&(console.log("- addSubformData:currentModel"),console.log(m),console.log(p),console.log(p.toJSON())),"object"!=typeof p&&o.data.model._listFieldType[m]&&o.data.model.set(m,o.data.model._listFieldType[m]),r&&p.reset(),l){var u=a.Model.extend({});t.each(l,function(e){var t=new u;t.set(e),p.add(t)}),ne&&(console.log("- addSubformData:"),console.log(p.toJSON()))}else ne&&(console.log("- addSubformData:list.model.toJSON()"),console.log(i.model.toJSON())),p.add(i.model);var c=i.options.formSchema.options||{};if(c.copyvaluesfrom&&!l){var f=i.model.cid;if(t.isArray(c.copyvaluesfrom)){for(var h,b,v=0;v<p.length;v++){var _=p.at(v);if(ne&&console.log(" - cid:",_.cid," = _listModelCid:",f),_.cid===f){h=v,b=_;break}}if("undefined"!=typeof h&&"null"!=typeof h&&c.copyvaluesfrom[h]&&!t.isEmpty(c.copyvaluesfrom[h])){var g=e("#"+i.options.options.formSchema.name);t.each(c.copyvaluesfrom[h],function(t,a){var o,i=g.find(':input[name="'+t+'"]'),s=b.get(a);i.length>1?e(i).each(function(t){var a=e(this),o=a.val();if(o===s){if(!a.is(":radio"))throw new Error("Not implement Radio in List - CopyValuesFrom yet!");a.attr("checked",!0)}else if(!a.is(":radio"))throw new Error("Not implement Radio in List - CopyValuesFrom yet!")}):(o=i.val(),s!==o&&i.val(s).trigger("change"))})}}}require(["views/subform-layouts/"+d],function(t){ne&&(console.log('    in "views/subform-layouts/'+d+'"'),console.log(p.toJSON()));var a={el:"#"+i.options.formId+o.data.prefixedName.collectiondisplayid,formSchema:i.options.formSchema,collection:p,options:i.options.options},l=s.create(this,"CollectionView"+o.data.formId,t,a);if(l.render(),o.data.closeSubForm(o,i),i.options.formSchema.options&&i.options.formSchema.options.permission){var r=n.getUserIdFormHtml().replace("\\","\\\\"),m=new RegExp(r,"ig");switch(i.options.formSchema.options.permission.toLowerCase()){case"readwriteselfcreated":l.$el.find("table tr").each(function(){var t=e(this),a=!1;t.find("td").each(function(){var t=e(this);t.text().match(m)&&(a=!0)}),a||t.find("td.subform-actions button.btn").remove()});break;default:throw i.options.formSchema.options.permission+" not implement yet!"}}})},setupVisibleOn:function(a,o,i){i=i||!1;var s=this,l=a.type.toLowerCase();if(!a.name)throw"In order to use VisibleOn option, we need to pass in the Name";switch(i||(a.options.visibleon.parentcontainer?i=a.options.visibleon.parentcontainer:"booleaninput"===l?i=".form-render_booleaninput_wrapper":a.options.visibleon&&a.options.visibleon.name&&t.indexOf(this._radioFieldName,a.options.visibleon.name)>-1&&(i=".radio-container")),i&&a.options&&a.options.visibleon&&a.options.visibleon.parentcontainer&&a.options.visibleon.parentcontainer!==i&&(i=a.options.visibleon.parentcontainer),l){case"address":delete this.model.validation[a.name+"_address_street"],delete this.model.validation[a.name+"_address_city"],delete this.model.validation[a.name+"_address_state"],delete this.model.validation[a.name+"_address_zip"],delete this.model.validation[a.name+"_address_country"],delete this.model.validation[a.name+"_address_street_number"],delete this.model.validation[a.name+"_address_unit_number"];break;case"multifiles":delete this.model.validation[a.name+"[]"];break;default:delete this.model.validation[a.name]}var r=a.options.visibleon.name,d=!0;d&&(ne&&console.log('- Attached "'+a.options.visibleon.name+'"'),e(this.el).on("change",':input[name="'+r+'"]',function(r){var d=!1,m=!1;d&&console.log("*** Input ["+a.options.visibleon.name+"] changed ***");var p,u,c=e(r.currentTarget),f=i?c.parents(i):c,h=[],b=a.options.visibleon.name,v=c.val(),_=["","[]"];f.length||i!==a.options.visibleon.parentcontainer||(f=c.parents(".form-render").find(i)),d&&console.log("- _visibleOnName:",b),b.match(/\[\]$/gi)?(f.length||(f=c.closest(".checkbox-container")),b=b.substr(0,b.length-2),f=f.closest(".checkbox-container"),c.is(":checkbox")&&(v="",f.find(":checkbox:checked").each(function(){var o=e(this).val();t.indexOf(a.options.visibleon.values,o)>-1&&(v=o)}))):c.is(":radio")&&!i&&(f=c.closest(".radio-container")),d&&(console.log("- $container:",f),console.log("- field.options.visibleon:",a.options.visibleon),console.log("- _visibleVal:",v));var g=!0;if(a&&a.options&&a.options.visibleon&&a.options.visibleon.steps){if(!t.isArray(a.options.visibleon.steps)||!a.options.visibleon.steps.length)throw new Error(a.name+" must not contain an empty VisibleOn.Steps");var y=a.options.visibleon.steps;ne&&(console.log("[*] Debug: VisibleOn with Steps"),console.log(v),console.log(a.name),console.log(y));for(var D=0;D<y.length;D++){var w=y[D],x=w.values;if(!x||!t.isArray(x)){var k="undefined"!=typeof JSON&&JSON&&JSON.stringify?JSON.stringify(w):null;throw new Error('Expects an array for "Values" in "'+k+'"')}var S=e(':input[name="'+w.name+'"]'),C=e.trim(S.val()),V=t.indexOf(x,C),F=w.notin?V<0:V>-1;if(ne&&(console.log("[*] Step: "+D),console.log(S),console.log(w),console.log(C),console.log(x),console.log(V),console.log(F)),!F){g=!1;break}}}if(t.indexOf(a.options.visibleon.values,v)>-1&&g){if(d&&(console.log("[x] Match Value with VisibleOn, will render ["+a.name+"]."),console.log(c),console.log("- htmlTmpl"),console.log(o),console.log("- length:",e(".options-visible-on-"+a.name,s.el).length)),e(".options-visible-on-"+a.name,s.el).length<1){if(d&&console.log("- $container:",f),f.after(o),d&&console.log(f),p=f.next(".options-visible-on-"+a.name).fadeIn("slow",function(){var o=e(this).addClass("visible-parent-"+b).attr("data-parent",b);n.setupSelect2(o);var i=e(".options-visible-on-"+b,s.el);if(e('[class*="visible-parent-'+b+'"]',s.el).not(".visible-parent-"+b+",.options-visible-on-"+b+",.visible-parent-"+i.attr("data-parent")).remove(),"multifiles"===l?e("#"+a.name+"_multifiles_wrapper",this).trigger("visibleOnRenderComplete"):e(':input[name="'+a.name+'"]',this).trigger("visibleOnRenderComplete"),!s.model.bindings[a.name]&&t.indexOf(s.model.notBinding,a.name)<0){var r=a.name;t.each(_,function(t){r===a.name&&e(':input[name="'+r+t+'"]').length&&(r=a.name+t)}),e(':input[name="'+r+'"]').length&&"checkbox"!==l&&(s.model.bindModelBinder(r,a.type),s._modelBinder.bind(s.model,s.el,s.model.bindings))}}),u=f.next("div"),0===u.length&&(u=f.parent()),u.find(":input").not('input[type="hidden"]').placeholder(),"address"===l){var O=a.name+"_address_street";s.options.formSchema.validation[O]&&(s.model.validation[O]=s.options.formSchema.validation[O]),h.push(O),O=a.name+"_address_city",s.options.formSchema.validation[O]&&(s.model.validation[O]=s.options.formSchema.validation[O]),h.push(O),O=a.name+"_address_state",s.options.formSchema.validation[O]&&(s.model.validation[O]=s.options.formSchema.validation[O]),h.push(O),O=a.name+"_address_zip",s.options.formSchema.validation[O]&&(s.model.validation[O]=s.options.formSchema.validation[O]),h.push(O),O=a.name+"_address_country",s.options.formSchema.validation[O]&&(s.model.validation[O]=s.options.formSchema.validation[O]),h.push(O),O=a.name+"_address_street_number",s.options.formSchema.validation[O]&&(s.model.validation[O]=s.options.formSchema.validation[O]),h.push(O),O=a.name+"_address_unit_number",s.options.formSchema.validation[O]&&(s.model.validation[O]=s.options.formSchema.validation[O]),h.push(O),a.options.hidecountry&&s.model.set(O,"US")}else s.options.formSchema.validation[a.name]&&"html"!==l?(s.model.validation[a.name]=s.options.formSchema.validation[a.name],h.push(a.name)):s.options.formSchema.validation[a.name+"[]"]&&(s.model.validation[a.name+"[]"]=s.options.formSchema.validation[a.name+"[]"],h.push(a.name+"[]"));if("update"===s.options.mode&&h.length>0)t.each(h,function(t){if(s.options.formData.fields[t]){s.model.set(t,s.options.formData.fields[t]);var a=e(':input[name="'+t+'"]',p);switch(l){case"radio":case"check":case"checkbox":a.filter('[value="'+s.options.formData.fields[t]+'"]').prop("checked",!0);break;default:a.is(":radio")||a.is(":checkbox")||a.val(s.options.formData.fields[t])}}});else if("update"===s.options.mode)switch(ne&&(console.log("- Check for Field. "+a.name),console.log(a.name),console.log(s.options.formData.fields)),ne&&console.log("Current Type: ",l),l){case"fullname":t.each(["_fullname_first_name","_fullname_middle_name","_fullname_last_name"],function(t){var o=a.name+t,i=e(':input[name="'+o+'"]',p);i.length&&s.options.formData.fields[o]&&i.val(s.options.formData.fields[o])});break;default:if(s.options.formData.fields[a.name]){var L=e(':input[name="'+a.name+'"]',p);L.is(":radio")||L.is(":checkbox")||(L.val(s.options.formData.fields[a.name]),s.model.set(a.name,s.options.formData.fields[a.name]))}}if("userid"===l&&(n.setupUserIdAjaxCall(e("form.form-render")),s.model.validation[a.name].pattern||a.options.render&&"select"===a.options.render.toLowerCase()||(s.model.validation[a.name].pattern="email")),n.setupUrlAjaxCall(e("form.form-render"),e("#"+a.name)),s._hasDate&&(ne&&(console.log("[*] baseField.setupVisibleOn - _hasDate"),console.log(s.el),console.log(s.$el)),n.setupDateInput(s.el,s)),s._hasBDate&&a&&a.type&&a.options&&a.options.render&&"date"===a.type.toLowerCase()){var N=a.options.render;try{N=N.toLowerCase();var A=".options-visible-on-"+a.name;switch("string"==typeof s.el&&(A=s.el+" "+A),N){case"select":n.setupBDateInput(A,s.model)}}catch(e){console&&console.error&&console.error(e)}}}}else{if(e("#"+a.name,s.el).trigger("removeVisibleOn"),e(".options-visible-on-"+a.name,s.el).remove(),e(".visible-parent-"+a.name,s.el).remove(),"date"===l&&a.options&&a.options.render){var B=a.options.render;try{switch(B=B.toLowerCase()){case"select":var j=a.name+"_birth";"undefined"!=typeof t&&t?(t.map(["day","month","year"],function(e){var t=j+"["+e+"]";s.model.validation[t]&&delete s.model.validation[t]}),s.model.validation[a.name]&&delete s.model.validation[a.name]):console&&console.error&&console.error('Could not be able to locate "_".');break;default:throw new Error('Not implement delete for "'+B+'"')}}catch(e){console&&console.error&&console.error(e)}}else if("fullname"===l)t.map(["_fullname_first_name","_fullname_last_name"],function(e){var t=a.name+e;s.model.validation[t]&&delete s.model.validation[t]});else if("address"===l){var O=a.name+"_address_street";s.model.set(O,""),s.options.formSchema.validation[O]&&(s.model.validation[O]=s.options.formSchema.validation[O],delete s.model.validation[O]),O=a.name+"_address_city",s.model.set(O,""),s.options.formSchema.validation[O]&&(s.model.validation[O]=s.options.formSchema.validation[O],delete s.model.validation[O]),O=a.name+"_address_state",s.model.set(O,""),s.options.formSchema.validation[O]&&(s.model.validation[O]=s.options.formSchema.validation[O],delete s.model.validation[O]),O=a.name+"_address_zip",s.model.set(O,""),s.options.formSchema.validation[O]&&(s.model.validation[O]=s.options.formSchema.validation[O],delete s.model.validation[O]),O=a.name+"_address_country",s.model.set(O,""),s.options.formSchema.validation[O]&&(s.model.validation[O]=s.options.formSchema.validation[O],delete s.model.validation[O]),O=a.name+"_address_street_number",s.model.set(O,""),s.options.formSchema.validation[O]&&(s.model.validation[O]=s.options.formSchema.validation[O],delete s.model.validation[O]),O=a.name+"_address_unit_number",s.model.set(O,""),s.options.formSchema.validation[O]&&(s.model.validation[O]=s.options.formSchema.validation[O],delete s.model.validation[O])}else if("html"!==l){s.model.set(a.name,""),s.model.validation[a.name]?delete s.model.validation[a.name]:s.model.validation[a.name+"[]"]&&delete s.model.validation[a.name+"[]"];var E=a.name;t.each(_,function(e){if(s.model.bindings[E+e]){s.model.unbindModelBinder(E+e,a.type);for(var o=!0;o;)try{s._modelBinder.bind(s.model,s.el,s.model.bindings),o=!1}catch(e){o=!1;var i=e.match(/name="(\w+)"/i);if(i||console&&console.error&&console.error(e),2===i.length){var n=i[1];t.each(_,function(e){s.model.bindings[n+e]&&(s.model.unbindModelBinder(n+e,a.type),s.model.validation[n+e]&&delete s.model.validation[n+e],o=!0)})}}if(!c.is(":checkbox")){var l=c.attr("name");c.is(":radio")||c.val(v),s.model.get(l)!==v&&s.model.set(l,v)}}}),c.is(":radio")&&c.prop("checked",!0)}m&&(console.log("[*] Check for Validation"),console.log(s.model.validation))}}))},setupCopyValuesFrom:function(a){if("list"!==a.type.toLowerCase()){if(!a.options.copyvaluesfrom.name||!a.options.copyvaluesfrom.description)throw"In order to use CopyValuesFrom options, need to have Name and Description";var o=this,i="";return i+='<div class="copy-values-from '+a.options.copyvaluesfrom.name+'">'+this.inputTemplate.buttongroup({description:a.options.copyvaluesfrom.description})+"</div>",e(this.el).on("click",".copy-values-from."+a.options.copyvaluesfrom.name+" .btn-group button",function(i){var s,l,r=e(i.currentTarget),d=[];r.hasClass("btn-yes")&&(s=n.getSpecialFieldsName(a.options.copyvaluesfrom.name,a.type),t.each(s,function(t){d.push(e(':input[name="'+t+'"]',o.el).val())}),l=n.getSpecialFieldsName(a.name,a.type),n.setFieldsValues(o.el,o.model,l,d))}),i}},sortOrderBy:function(e){var t,a=e.options.orderby;if(a||e.values){switch(a=a.toLowerCase()){default:t=function(e,t){return e.localeCompare(t)}}e.values.sort&&e.values.sort(t)}},addDataToElementData:function(e,t,a){this._elementData[e]||(this._elementData[e]={}),this._elementData[e][t]=a},generateMarkUpForUpdateOnReadMode:function(e){if(!e.type)return console&&console.warn&&console.warn('[x] generateMarkUpForUpdateOnReadMode for "'+e.name+'" could not be able to find "Type".'),"";var a,o,i=!1,s=e.type.trim().toLowerCase(),n=this.options.formData.fields[e.name];switch(i&&(console.debug("[*] UpdateOnReadMode"),console.debug("     Name: "+e.name),console.debug("     Value: "+n)),s){case"file":throw"Not yet support!";default:o="text"}switch(s){case"radio":a=le["default-input-radio"](t.extend({data:n},e));break;case"textarea":a=le["default-input-textarea"](t.extend({data:n},e));break;case"date":a=le["default-input-date"](t.extend({data:n},e));break;default:a=le["default-input"](t.extend({inputType:o,data:n},e))}return i&&console.debug("     HTML: "+a),a}})});