define(["jquery","underscore","backbone","bootstrap","events","vm","utils","models/model","collections/collections","modelbinder","validation","views/fields/list","text!data/email.json","text!data/schooles.json","text!data/county.json","text!templates/fields/html.html","text!templates/fields/label.html","text!templates/fields/text.html","text!templates/fields/password.html","text!templates/fields/telephone.html","text!templates/fields/socialsecurity.html","text!templates/fields/hidden.html","text!templates/fields/timestamp.html","text!templates/fields/useraccount.html","text!templates/fields/fraction.html","text!templates/fields/booleaninput.html","text!templates/fields/radio.html","text!templates/fields/file.html","text!templates/fields/multifiles.html","text!templates/fields/filerepository.html","text!templates/fields/read-filerepository.html","text!templates/fields/state.html","text!templates/fields/county.html","text!templates/fields/zipcode.html","text!templates/fields/country.html","text!templates/fields/fullname.html","text!templates/fields/address.html","text!templates/fields/textarea.html","text!templates/fields/number.html","text!templates/fields/email.html","text!templates/fields/date.html","text!templates/fields/select.html","text!templates/fields/check.html","text!templates/fields/birthdate.html","text!templates/fields/button.html","text!templates/fields/buttongroup.html","text!templates/fields/list.html","text!templates/fields/uneditableinput.html","text!templates/fields/uneditablecheck.html","text!templates/fields/uneditabletag.html","text!templates/fields/uneditabletel.html","text!templates/fields/uneditablefile.html","text!templates/fields/uneditableimage.html","text!templates/fields/buttonclipboard.html","text!templates/subform-layouts/table.html","text!templates/update-on-read/default-input.html","text!templates/update-on-read/default-input-radio.html","text!templates/update-on-read/default-input-textarea.html","text!templates/update-on-read/default-input-date.html","jquery.expose","jquery.datepicker","jquery.birthdaypicker","bootstrap"],function(e,t,o,a,i,s,n,l,r,d,m,p,u,c,f,h,b,v,_,g,y,D,x,w,k,S,C,V,F,O,L,N,A,B,E,j,I,T,U,M,R,$,J,z,P,q,H,Y,G,K,Q,W,X,Z,ee,te,oe,ae,ie){function se(e){var t,o=!0;if(ne&&(console.log("[*] buildHtmlBasicFormMarkup"),console.log(arguments)),e.attributes||(e.attributes={}),!e.description)throw'Expected a "description" in buildHtmlBasicFormMarkup parameter.';if(!e.name)throw'Expected a "name" in buildHtmlBasicFormMarkup parameter.';if(!e.type)throw'Expected a "type" in buildHtmlBasicFormMarkup parameter.';var a=e.type.toLowerCase(),i="";switch(a){case"hidden":o=!1;var s=e.attributes.value;t='<input type="hidden" name="'+e.name+'" value="'+s+'"/>';break;case"textarea":t='<textarea name="'+e.name+'" class="'+i+'" id="'+e.name+'"></textarea>';break;case"textbox":t='<input name="'+e.name+'" type="text" class="'+i+'" id="'+e.name+'"/>';break;default:throw'Not implement "'+e.type+'" yet in buildHtmlBasicFormMarkup.'}return o&&(t='<label for="'+e.name+'">'+e.description+"</label>"+t),'<div class="form-markup-field">'+t+"</div>"}var ne=!1,le={"default-input":t.template(te),"default-input-radio":t.template(oe),"default-input-textarea":t.template(ae),"default-input-date":t.template(ie)};return o.View.extend({_modelBinder:void 0,clean:function(){o.Validation.unbind(this),"undefined"!=typeof this._modelBinder&&this._modelBinder.unbind()},initialize:function(){var o=this;this._div=0,this._hasUserId=!1,this._hasDate=!1,this._hasBDate=!1,this._DatePickerLogicArr={},this._hasEmailPicker=!1,this._hasBooleanInput=!1,this._hasRadioBtnGroup=!1,this._hasSelectAllCheckBox=!1,this._hasClearAllCheckBox=!1,this._hasOtherTextBox=!1,this._internalFields=[],this._visibleOn=[],this._multiFiles=[],this._buttonClipboards=[],this._buttonDecision=[],this._ajaxDataCall=[],this._javaUpload=[],this._elementData={},this._ajaxSubmit=!0,this._radioFieldName=[],this._lookupValues={},this._listSchema={},this._getValueFrom={},this._visibleonEventAttached={},this._stepDiv=0,this._currentStep=1,this._stepValidated=[],this._modelBinder=new d,this.options.formSchema.validation=this.options.formSchema.validation||{},this.model=new l(t.extend(this.options.formSchema,{is_internal:this.options.internal,render_mode:this.options.mode,status:"update"===this.options.mode&&this.options.formData&&this.options.formData.status?this.options.formData.status:null})),this.options.formData&&!t.isEmpty(this.options.formData)&&this.model.multiFilesDefaultValue&&!t.isEmpty(this.model.multiFilesDefaultValue)&&(this.model.multiFilesDefaultValue=t.reduce(this.model.multiFilesDefaultValue,function(e,t,a){var i=a.replace(/[\[\]]/gi,"");return o.options.formData&&o.options.formData.fields&&o.options.formData.fields[i]&&(e[a]=o.options.formData.fields[i]),e},{})),e.isEmptyObject(this.options.formData)||t.each(this.model.attributes,function(e,t){if("object"==typeof e);else{var a={};a[t]=o.options.formData.fields[t],o.model.set(a)}}),this.prefixedName={list:"subform_",listdisplayid:"_form_content",collectiondisplayid:"_form_collection"},this.notRenderLabel=["html","list","button","submit","clear","fieldset","fieldsetstart","fieldsetend","step","check","checkbox","timestamp","hidden"],this.notRenderLabelRead=["html","list","button","submit","clear","fieldset","fieldsetstart","fieldsetend","step","check","checkbox"],this.inputTemplate={html:t.template(h),label:t.template(b),text:t.template(v),password:t.template(_),telephone:t.template(g),socialsecurity:t.template(y),hidden:t.template(D),timestamp:t.template(x),useraccount:t.template(w),fraction:t.template(k),booleaninput:t.template(S),radio:t.template(C),file:t.template(V),multifiles:t.template(F),filerepository:t.template(O),"read-filerepository":t.template(L),state:t.template(N),county:t.template(A),zipcode:t.template(B),country:t.template(E),fullname:t.template(j),address:t.template(I),textarea:t.template(T),number:t.template(U),email:t.template(M),date:t.template(R),select:t.template($),check:t.template(J),birthdate:t.template(z),button:t.template(P),buttongroup:t.template(q),list:t.template(H),uneditableinput:t.template(Y),uneditablecheck:t.template(G),uneditabletag:t.template(K),uneditabletel:t.template(Q),uneditablefile:t.template(W),uneditableimage:t.template(X),buttonclipboard:t.template(Z),"subform-table":t.template(ee)};var a={submitbutton:"Submit",resetbutton:"Cancel"};this.options.formSchema.formoptions=t.extend(a,this.options.formSchema.formoptions)||a},getFormValidationData:function(e){return this.options.formSchema.validation=this.options.formSchema.validation||{},"undefined"==typeof this.options.formSchema.validation[e]?{}:this.options.formSchema.validation[e]},closeOpenDiv:function(e){e=e||"_div";for(var t="",o=0,a=this[e];o<a;++o)t+="</div>";return this._div=0,t},render:function(o,a){var i=this,l="",r=[o.name],d=o.type.toLowerCase(),m="";if(o.lang=this.options.lang,o.attributes=o.attributes||{},o.attributes.autocomplete||(o.attributes.autocomplete="off"),o.options=o.options||{},this.options.formSchema.validation=this.options.formSchema.validation||{},this.options.formData=this.options.formData||{},!this.options.internal&&o.options.internal)return"";if(("button"===d||"submit"===d)&&!o.options.internal&&this.options.internal)return"";if(o.options.renderas){switch(d){case"date":this.options.formData&&this.options.formData.fields&&this.options.formData.fields[o.name]&&this.options.formData.fields[o.name].$date&&(this.options.formData.fields[o.name]=n.formatDateAsString(this.options.formData.fields[o.name].$date));break;case"number":break;default:throw'Not Implement Options.RenderAs for "'+d+'" yet!'}d=o.options.renderas.toLowerCase()}switch(d){case"booleaninput":this._hasBooleanInput=!0;break;case"radio":this._radioFieldName.push(o.name),!this._hasRadioBtnGroup&&o.options.render&&(this._hasRadioBtnGroup=!0),this.options.formData.fields&&this.options.formData.fields[o.name]&&("read"===this.options.mode&&o.values&&t.isObject(o.values)&&(this._lookupValues[o.name]={value:this.options.formData.fields[o.name],text:o.values[this.options.formData.fields[o.name]]},t.isArray(o.values)||(this.options.formData.fields[o.name]=o.values[this.options.formData.fields[o.name]])),o._data=this.options.formData.fields[o.name]),o.options.orderby&&this.sortOrderBy(o);break;case"multifiles":this.options.internal&&"undefined"!=typeof o.options.internalcanupdate&&!o.options.internalcanupdate||e("form"+this.el).attr("enctype","multipart/form-data"),this._multiFiles.push(o);var p=this.getFormValidationData(o.name+"[]");"undefined"==typeof this._stepValidated[this._currentStep-2]||e.isEmptyObject(p)||this._stepValidated[this._currentStep-2].push(o.name+"[]"),"read"===this.options.mode&&(d="file");break;case"filerepository":if(!o.options.url)throw'Expected Url parameter in Options Key for "'+o.name+'".';break;case"image":o.attributes.accept="image/*";case"file":this.options.internal&&"undefined"!=typeof o.options.internalcanupdate&&!o.options.internalcanupdate||e("form"+this.el).attr("enctype","multipart/form-data");var p=this.getFormValidationData(o.name);if(p.accept&&(o.attributes.accept=p.accept),o.options.javaupload){var h={name:o.name,id:o.name,code:"com.elementit.JavaPowUpload.Manager",archive:"//public.southernnevadahealthdistrict.org/assets/jar/jupload/JavaPowUpload.jar, //public.southernnevadahealthdistrict.org/assets/jar/jupload/skinlf.jar, //public.southernnevadahealthdistrict.org/assets/jar/jupload/commons-httpclient.jar, //public.southernnevadahealthdistrict.org/assets/jar/jupload/commons-compress.jar",width:500,height:350,mayscript:"true",alt:"JavaPowUpload by www.element-it.com"};this._javaUpload.push(h)}if(o.options.markdownloaddatetimeof&&this.options.mode&&"read"===this.options.mode){var b=this.options.internal?"internal":"external",v=o.options.markdownloaddatetimeof.toLowerCase();"*"!==v&&v!==b||(o.attributes.class=(o.attributes.class?o.attributes.class:"")+" btn-auto-refresh ",o.attributes["data-refresh-delay"]||(o.attributes["data-refresh-delay"]="2000"))}break;case"userid":this._hasUserId=!0,o.options&&o.options.lookup&&o.options.lookup.url&&(o.options.url=o.options.lookup.url),o.options.url&&(o.attributes["data-url"]=o.options.url),o.options.data&&(o.attributes["data-url-data"]=JSON.stringify(o.options.data)),o.attributes.placeholder=o.attributes.placeholder||"Valid E-mail as Username",o.attributes.class=(o.attributes.class||"")+" userid-lookup",d=o.options.render?o.options.render.toLowerCase():"text","select"===d&&(o.values=[]),o.attributes.class=n.setupClassAttr(o.attributes.class,"span12");break;case"fraction":break;case"textbox":d="text";case"selectsingle":"selectsingle"===d&&(d="select");case"select":if("update"===this.options.mode&&this.options.formData.fields[o.name]&&(o.attributes["data-select-value"]=this.options.formData.fields[o.name]),o.options&&o.options.lookup&&o.options.lookup.url)o.options.url=o.options.lookup.url,o.options.lookup.value&&(o.attributes["data-select-key-value"]=o.options.lookup.value),o.options.lookup.text&&(o.attributes["data-select-key-text"]=o.options.lookup.text);else if(o.options){if(o.options.tags)o.attributes.class=(o.attributes.class?o.attributes.class:"")+" selecttwo-render tags value-as-array";else if(o.options.render){var _=o.options.render.toLowerCase();switch(_){case"select2":o.attributes.class=(o.attributes.class?o.attributes.class:"")+" selecttwo-render"}}o.options.events&&this.addDataToElementData(o.name,"events",o.options.events),o.options.orderby&&this.sortOrderBy(o),o.options.getvaluefrom&&o.name&&(this._getValueFrom[o.options.getvaluefrom]||(this._getValueFrom[o.name]=o.options.getvaluefrom))}o.options.url&&(o.attributes["data-url"]=o.options.url.replace(/'/gi,"&#39;")),o.options.data&&(o.attributes["data-url-data"]=JSON.stringify(o.options.data)),o.attributes.class=n.setupClassAttr(o.attributes.class,"span12"),this.options.formData&&this.options.formData.fields&&this.options.formData.fields[o.name]&&(t.isArray(this.options.formData.fields[o.name])&&this.options.formData.fields[o.name].sort(function(e,t){return e-t}),"read"===this.options.mode&&o.values&&t.isObject(o.values)&&(o._data=o.values[this.options.formData.fields[o.name]]),this.addDataToElementData(o.name,"value",this.options.formData.fields[o.name]));break;case"county":"string"==typeof f&&(f=e.parseJSON(f)),o._options=f,o.attributes.id||(o.attributes.id=o.name);var g="select2-county";o.options.filterbyid&&(g="select2-county-lookup"),o.attributes.class?o.attributes.class+=" "+g:o.attributes.class=g,this.options.formData&&this.options.formData.fields&&this.options.formData.fields[o.name]&&(o.attributes["data-countyvalue"]=this.options.formData.fields[o.name]);break;case"checkbox":case"check":if(o.options.numcolumns){if(!t.isNumber(o.options.numcolumns))throw"NumColumns must be a valid number for "+o.name;o.options.numcolumns>4?o.options.numcolumns=4:o.options.numcolumns<1&&(o.options.numcolumns=1)}else o.options.numcolumns=1;if(!this._hasSelectAllCheckBox&&o.options.addselectall&&(this._hasSelectAllCheckBox=!0),!this._hasClearAllCheckBox&&o.options.addclearall&&(this._hasClearAllCheckBox=!0),o.options.orderby&&this.sortOrderBy(o),o.options.othertextbox&&(this._hasOtherTextBox=!0),"update"===this.options.mode&&this.options.formData.fields&&this.options.formData.fields[o.name]&&(o._data=this.options.formData.fields[o.name]),this.options.formData.fields&&this.options.formData.fields[o.name+"_other"]&&(o._otherValue=this.options.formData.fields[o.name+"_other"]),"undefined"!=typeof this.options.formSchema.validation[o.name+"[]"]){o._required=!0,o.attributes||(o.attributes={}),o.attributes["data-check-required"]=!0;var p=this.getFormValidationData(o.name+"[]");"undefined"==typeof this._stepValidated[this._currentStep-2]||e.isEmptyObject(p)||this._stepValidated[this._currentStep-2].push(o.name+"[]")}else o._required=!1;if(d="check",!o.values)throw"In order to use CheckBox, please set Values.";break;case"password":o.attributes.class=n.setupClassAttr(o.attributes.class,"span12");break;case"telephone":o.attributes.class=n.setupClassAttr(o.attributes.class,"integer telephone span12"),this.options.formData.fields&&this.options.formData.fields[o.name+"_provider"]&&(o._providerValue=this.options.formData.fields[o.name+"_provider"]);break;case"socialsecurity":o.attributes.class=n.setupClassAttr(o.attributes.class,"integer socialsecurity span12");break;case"textarea":o.attributes.class=n.setupClassAttr(o.attributes.class,"span12");break;case"action":return this._div++,'<div class="form-actions">';case"fieldsetstart":return"<fieldset><legend>"+o.description+"</legend>";case"fieldsetend":return"</fieldset>";case"hr":return"<hr>";case"dateinput":d="date";case"date":if(this.options.formData&&this.options.formData.fields)if("object"==typeof this.options.formData.fields[o.name]){var y=new Date(this.options.formData.fields[o.name].$date),D=y.getMonth()+1;D<10&&(D="0"+D),D+="/";var x=y.getDate();if(x<10&&(x="0"+x),x+="/",this.options.formData.fields[o.name]=D+x+y.getFullYear(),o.options.render&&"read"===this.options.mode)switch(o.options.render.toLowerCase()){case"datetime":this.options.formData.fields[o.name]+=" "+n.formatAMPM(y)}o.attributes.value=this.options.formData.fields[o.name]}else"create"===this.options.mode&&"undefined"==typeof this.options.formData.fields[o.name]&&(o._noDefaultValue=!0);if(o.attributes&&!o.attributes.placeholder&&(o.attributes.placeholder="mm/dd/yyyy"),o.options.render&&"select"===o.options.render.toLowerCase()){d="birthdate",this._hasBDate=!0,o.attributes.class=n.setupClassAttr(o.attributes.class,"birthdaypicker");var p=this.getFormValidationData(o.name),w={id:o.name};"en"!==o.lang&&(w.lang=o.lang),"undefined"!=typeof this.options.formData.fields&&(w.defaultdate=this.options.formData.fields[o.name]),o._noDefaultValue&&(w.nodefaultvalue=!0),o.attributes["data-options"]=JSON.stringify(t.extend(w,p)),"undefined"==typeof this._stepValidated[this._currentStep-2]||e.isEmptyObject(p)||(this._stepValidated[this._currentStep-2].push(o.name+"_birth[month]"),this._stepValidated[this._currentStep-2].push(o.name+"_birth[day]"),this._stepValidated[this._currentStep-2].push(o.name+"_birth[year]"))}else{this._hasDate=!0,o.attributes.class=n.setupClassAttr(o.attributes.class,"datepicker");var p=this.getFormValidationData(o.name);t.each(p,function(e,t){delete p[t],p[t.toLowerCase()]=e}),p.maxdate&&(o.attributes["data-maxdate"]=p.maxdate),p.mindate&&(o.attributes["data-mindate"]=p.mindate),o.options&&o.options.datepickeroptions&&(this._DatePickerLogicArr[o.name]=o.options.datepickeroptions,o.attributes["data-has-datepicker-options"]=!0)}break;case"email":o.attributes.class=n.setupClassAttr(o.attributes.class,"tolowercase span12"),"undefined"!=typeof o.options.autocomplete&&o.options.autocomplete&&(this._hasEmailPicker=!0,o.attributes={},o.attributes["data-provide"]="typeahead",o.attributes.autocomplete="off",o.attributes.style="width:45%;",o.attributes.class="not_sending emailpicker_server tolowercase",o.attributes["data-source"]=u.replace(/\n/g,"").replace(/'/g,"&#39"),"undefined"!=typeof o.options.default&&(o.attributes["data-value"]=o.options.default),r.push(o.name+"_username"),r.push(o.name+"_server"));break;case"address":if(delete o.attributes.class,delete o.attributes.placeholder,r=[],r.push(o.name+"_address_street"),r.push(o.name+"_address_city"),r.push(o.name+"_address_state"),r.push(o.name+"_address_zip"),r.push(o.name+"_address_country"),o.options.showstreetnumber&&r.push(o.name+"_address_street_number"),o.options.showunitnumber&&r.push(o.name+"_address_unit_number"),"undefined"!=typeof a&&"undefined"!=typeof this.options.formData?(this.options.formData.fields[o.name+"_address_country"]=s.getCountry(this.options.formData.fields[o.name+"_address_country"]),this.options.formData.fields[o.name+"_address_street"]&&"."!==this.options.formData.fields[o.name+"_address_street"].charAt(this.options.formData.fields[o.name+"_address_street"].length-1)&&(this.options.formData.fields[o.name+"_address_street"]+="."),this.options.formData.fields[o.name+"_address_street"]+="<br>",this.options.formData.fields[o.name+"_address_city"]+=",",this.options.formData.fields[o.name+"_address_state"]+="<br>",this.options.formData.fields[o.name+"_address_zip"]+="<br>"):"update"===this.options.mode&&"US"!==this.options.formData.fields[o.name+"_address_country"]?o.default_value_state=this.options.formData.fields[o.name+"_address_state"]:"create"===this.options.mode&&(this.model.set(o.name+"_address_state","NV"),this.model.set(o.name+"_address_country","US")),o.options.zipcodeformat){var k=o.options.zipcodeformat.toLowerCase();switch(k){case"zip+4":o._zipmax=10}}break;case"number":var S;if(!o.options.numbertype||o.options.decimals)S=o.options.decimals?"number":"natural",o.options.decimals&&(o.attributes["data-decimal"]=o.options.decimals);else if(o.options.numbertype&&!o.options.limitinputvalue)switch(o.options.numbertype.toLowerCase()){case"currency":S="number";break;case"double":S="rational";break;default:S="natural"}else S="natural";if(o.options.limitinputvalue&&(S=o.options.limitinputvalue),!S||"string"!=typeof S)throw new Error('Could not be able to find matching class name for "'+o.name+'" for a number input type.');if(o.attributes.class=n.setupClassAttr(o.attributes.class,S+" span12"),o.options.decimals&&this.options.formData.fields&&this.options.formData.fields[o.name]){var C=parseFloat(this.options.formData.fields[o.name]/Math.pow(10,parseInt(o.options.decimals,10)));isNaN(C)||(this.options.formData.fields[o.name]=C.toFixed(o.options.decimals),o.attributes.value=this.options.formData.fields[o.name],this.model.has(o.name)&&this.model.set(o.name,this.options.formData.fields[o.name]))}"undefined"!=typeof o.options.spinner&&o.options.spinner&&(o.attributes.class=o.attributes.class.replace(/ span12/,"","gi"),o.attributes.class=n.setupClassAttr(o.attributes.class,"spinner-input"),"update"===this.options.mode&&this.options.formData.fields[o.name]&&(o.attributes["data-value"]=this.options.formData.fields[o.name]));break;case"fullname":if(delete o.attributes.class,delete o.attributes.placeholder,r=[],r.push(o.name+"_fullname_first_name"),("undefined"==typeof o.options.middlename||o.options.middlename)&&r.push(o.name+"_fullname_middle_name"),r.push(o.name+"_fullname_last_name"),o.options.url&&this._ajaxDataCall.push(o),"read"===this.options.mode&&o.options&&o.options.highlight){var V=o.options.highlight.toLowerCase().split(",");t.each(V,function(e){var t=o.name+"_fullname_"+e;i.options.formData.fields[t]&&(i.options.formData.fields[t]="<u>"+i.options.formData.fields[t]+"</u>")})}break;case"clear":d="button",o.attributes.class=n.setupClassAttr(o.attributes.class,"btn btn-clear-form");break;case"submit":o.attributes.class=n.setupClassAttr(o.attributes.class,"btn"),d="button",o._submit=!0,"undefined"==typeof o.url&&(o.url=""),o.options.appendid&&this.options.formData._id&&this.options.formData._id.$oid&&(o.url=(o.url?o.url:"")+(o.url.indexOf("?")>-1?"&id=":"/")+this.options.formData._id.$oid),e(this.el).attr("action",o.url),"undefined"!=typeof o.options.ajaxsubmit&&(this._ajaxSubmit=o.options.ajaxsubmit);break;case"buttonclipboard":o.attributes.class=n.setupClassAttr(o.attributes.class,"btn btn-primary"),this._buttonClipboards.push({name:o.name,values:o.values});break;case"buttondecision":a||(o.attributes.class=n.setupClassAttr(o.attributes.class,"btn btn-primary"),d="button",this._buttonDecision.push(o));break;case"button":if(!n.shouldRenderShowOnUser(o))return"";if(o.attributes.class=n.setupClassAttr(o.attributes.class,"btn"),this.options&&this.options.formData&&this.options.formData._id&&this.options.formData._id.$oid&&(o.options.appendid?o.url=(o.url?o.url:"")+(o.url.indexOf("?")>-1?"&id=":"/")+this.options.formData._id.$oid:o.url&&o.url.search(/{\w+}/gi)>-1&&(o.url=n.formatUriSegment(o.url,this.options.formData))),o.url&&(o.url=n.changeURLGetTemplateString(o.url)),this.options.internal&&"read"===this.options.mode&&"BtnMarkAsUnacceptable"===o.name&&e.fn.remodal){var F=t.find(this.options.formSchema.fields,function(e){if(e&&e.name&&e.type)return"UnacceptableReason"===e.name?e:void 0});if(F){var O=this.options.formData&&this.options.formData.fields&&this.options.formData.fields.UnacceptableReason?this.options.formData.fields.UnacceptableReason:null;O&&O.replace&&(O=O.replace(/'/gi,"\\'"));var L=(new Date).getTime();switch(o.options["data-remodal-target"]="btnmarkasunacceptable_"+L,o.options["data-remodal-current-value"]=O,o.options["data-current-form-id"]=this.options.formData._id.$oid,o.options["data-url-mark-as-unacceptable"]=o.url,F.type.toLowerCase()){case"radio":if(!F.values)throw new Error("Expected a values key!");o._customHtml=t.reduce(F.values,function(e,o,a,i){var s="UnacceptableReason_"+a,n=t.isArray(i)?o:a,l=O&&O===n?'checked="true"':"";n&&n.replace&&(n=n.replace(/"/gi,"&quot;"));var r='<label class="radio"><input '+l+' name="UnacceptableReason" id="'+s+'" value="'+n+'" type="radio">'+o+"</label>";return e+r},"");break;case"textarea":o._customHtml='<textarea autocomplete="off" name="UnacceptableReason" id="UnacceptableReason"></textarea>';break;default:throw new Error("Not implement "+F.type+" yet!")}o.options.confirmed=null}}if(o.options.confirmed){var N=o.options.confirmedtext?o.options.confirmedtext:"Please confirm your selection.",A={html:!0,placement:"top",title:'<span class="text-info">'+N+"</span>",content:'<a class="btn btn-success btn-confirmed" data-href="'+o.url+'">Yes</button><a class="btn btn-danger btn-confirmed">No</button>'};o.attributes["data-popover-confirm"]=JSON.stringify(A)}else if(o.options.subbuttons)o.name||(o.name="subbuttons_"+o.description.replace(/ /g,"").toLowerCase(),o.attributes.id||(o.attributes.id=o.name)),require(["views/subform-layouts/subbuttons"],function(t){var a=o.attributes.id?o.attributes.id:o.name;s.create(this,a,t,{subbuttons:o.options.subbuttons,internal:!!i.options.internal&&i.options.internal,mode:i.options.mode,status:i.options.formData&&i.options.formData.status?i.options.formData.status:null,_id:a,button:e(".form-render #"+a),_oid:i.options.formData&&i.options.formData._id&&i.options.formData._id.$oid?i.options.formData._id.$oid:null})});else if(o.options.subform){if("read"!==this.options.mode)return"";if(!o.name)throw"Expected a valid Name for SubForm Button.";var B=this.options.formData&&this.options.formData._id&&this.options.formData._id.$oid?this.options.formData._id.$oid:null;if(!B)throw"Expected a valid ID for SubForm Button.";var E=o.options.subform;if(!E.url||"string"!=typeof E.url)throw"Please pass in URL key as a string in SubForm options.";if(!E.fields||!t.isArray(E.fields))throw"Please pass in URL key as an array in SubForm options.";var j="",I=o.options.subform.validation;t.each(E.fields,function(e){j+=se(e)}),j='<div class="subform-button-wrapper">'+j+'<div class="text-center"><a class="btn btn-primary subform-btn-submit" data-button-name="'+o.name+'">Submit</a></div></div>',e("div#app").on(this.options.formSchema.name+".renderCompleted",function(a,i){var s=e(this).find("button#"+o.name);if(1!==s.length)throw"Invalid SubForm Button, please make sure that the name is unique.";s.popover({html:!0,placement:"top",trigger:"manual",title:'<span class="text-info">Please complete this form.</span>',content:j}),s.on("click",function(e){return!s.hasClass("submitted")&&void(s.hasClass("shown")?s.removeClass("shown").popover("hide"):s.addClass("shown").popover("show"))}),s.parent().on("click",".subform-btn-submit",function(a){a.preventDefault(),a.stopPropagation();var i=e(a.target).attr("data-button-name");if(i!==s.attr("data-button-name")&&s.next(".popover").find(".subform-btn-submit").attr("data-button-name")!==i)return!1;var n=s.next(".popover").find(".subform-button-wrapper"),l=n.find(":input"),r={},d=!1;if(l.each(function(){var t=e(this),o=t.attr("name"),a=t.val();if(!o||""===o)throw"expect valid input name!";I&&I[o]&&(I[o].required&&""===a?(t.addClass("invalid"),d=!0):t.removeClass("invalid")),r[o]=a}),!d){var m="subform-btn-"+(new Date).getTime().toString(),p="",u=t.extend({},E.get);t.each(r,function(e,t){var o=t.toLowerCase();u.hasOwnProperty(o)?(delete u[o],u[t]=e):p+='<input type="hidden" name="'+t+'" value="'+e+'"/>'}),"/"!==o.options.subform.url[o.options.subform.url.length-1]&&(o.options.subform.url+="/");var c=o.options.subform.url+B;u&&(c+="?"+e.param(u)),e("body").append('<form id="'+m+'" action="'+c+'" method="POST">'+p+"</form>"),s.removeClass("shown").popover("destroy"),s.popover({html:!0,placement:"top",trigger:"manual",title:'<span class="text-info">Sending Information</span>',content:'<div class="text-center subform-button-wrapper"><i class="icon-spinner icon-spin icon-large"></i> Sending</div>'}).addClass("submitted").popover("show"),s.closest(".form-actions").find(":button").attr("disabled",!0),window.setTimeout(function(){e("body").find("#"+m).submit()},1e3)}return!1})})}break;case"schooles":d="text",o.attributes.class=n.setupClassAttr(o.attributes.class,"span12"),o.attributes["data-provide"]="typeahead",o.attributes.autocomplete="off",o.attributes["data-source"]=c.replace(/\n/g,"").replace(/'/g,"&#39");break;case"step":if(!("view"in this.options.formSchema&&"wizard"===this.options.formSchema.view))return"";0!==this._stepDiv&&(l+="</div>",this._stepDiv--),"undefined"==typeof this._stepValidated[this._currentStep-1]&&(this._stepValidated[this._currentStep-1]=[]);var T="step-pane"+(1===this._currentStep?" active":"");l+='<div class="'+T+'" id="wizard_step'+this._currentStep+'">',this._stepDiv++,this._currentStep++;break;case"useraccount":o.data_value="",o.options.getvaluefromid&&(o.data_value=e("#"+o.options.getvaluefromid).text());break;case"list":o.attributes.id=this.prefixedName.list+("undefined"!=typeof o.attributes.id?o.attributes.id:o.name),o.attributes.class=n.setupClassAttr(o.attributes.class,"subform-container");var U="undefined"!=typeof this.options.formSchema.validation[o.name]?this.options.formSchema.validation[o.name]:{};this.attachSubFormEvent(o.attributes.id,o,U),this._listSchema[o.name]=o;break;case"hidden":var M=["update","create"];t.indexOf(M,this.options.mode)>-1&&this.options.formData&&this.options.formData.fields&&this.options.formData.fields[o.name]&&(o.attributes||(o.attributes={}),o.attributes.value=this.options.formData.fields[o.name])}if("button"===d&&o.options.visibleon){var R=function(t){"change"===t.type&&o.options.visibleon.values.indexOf(e(this).val())>-1?e("#"+o.name,i.el).show("slow"):e("#"+o.name,i.el).hide("slow")};e(this.el).on("change",':input[name="'+o.options.visibleon.name+'"]',R).on("removeVisibleOn",':input[name="'+o.options.visibleon.name+'"]',R)}if("undefined"!=typeof this._stepValidated[this._currentStep-2]&&"step"!==d&&"list"!==d&&n.checkRequireFields(o,this.options.formSchema.validation)&&t.each(r,function(e){i._stepValidated[i._currentStep-2].push(e)}),"undefined"!=typeof a&&a&&"undefined"!=typeof r[0]&&"button"!==d&&"buttonclipboard"!==d){var $="",J="";if(t.each(r,function(e){"object"!=typeof i.options.formData.fields[e]?$+=("undefined"!=typeof i.options.formData.fields[e]?i.options.formData.fields[e]:"")+" ":$=i.options.formData.fields[e]}),"string"==typeof $&&($=e.trim($)),"file"===d||"image"===d){if("image"===d)"deleted"===i.options.formData.fields[o.name]?J=null:(o.attributes.src=("undefined"!=typeof o.attributes.src?o.attributes.src:"/form/getFile/")+i.options.formData.fields[o.name],J=o.attributes.src);else if(o.attributes.target="_blank",o.attributes.class=n.setupClassAttr(o.attributes.class,"btn btn-primary"),o.attributes.href=("undefined"!=typeof o.attributes.href?o.attributes.href:"/form/getFile/")+i.options.formData.fields[o.name],o.attributes.id||(o.attributes.id=o.name),o.options.markdownloaddatetimeof&&this.options.formData._id&&this.options.formData._id.$oid){var z=o.options.markdownloaddatetimeof.toLowerCase();("*"===z||this.options.internal&&"internal"===z||!this.options.internal&&"external"===z)&&(o.attributes.href+="?formid="+this.options.formData._id.$oid)}else o.options.appendid&&this.options.formData._id&&this.options.formData._id.$oid&&(o.attributes.href+="?formid="+this.options.formData._id.$oid);delete o.attributes.accept,t.each(o.attributes,function(e,t){e.search("'")&&(e=e.replace(/\'/gi,'"')),m+=" "+t+"='"+e+"'"}),l+=i.inputTemplate["uneditable"+d]({value:$,text:o.description,_attr:m,id:o.name,href:J})}else if("list"===d)if("undefined"!=typeof this.options.formData.fields[o.name]&&(this.options.formData.fields[o.name].length>0||t.size(this.options.formData.fields[o.name])>0)){var P=[],q=[],H=[],Y={},G=0,K=new Array(this.options.formData.fields[o.name].length||t.size(this.options.formData.fields[o.name]));t.each(o.fields,function(a,s){a.options=a.options||{};var l;a.options.tabletitle?(l=a.options.tabletitle,l='<a data-content="'+e("<p>"+a.description+"</p>").text()+'" data-original-title="'+l+'" data-placement="top" data-toggle="popover" data-trigger="hover" data-html="true">'+l+"</a>"):l=a.description,P.push(l),a.options.sortby&&"date"===a.options.sortby.toLowerCase()?q.push('data-sort="int"'):q.push(a.options.sortby?'data-sort="'+a.options.sortby+'"':'data-sort="string"'),t.each(i.options.formData.fields[o.name],function(e,o){var i;if(t.isNumber(o)||(Y[a.name]?(G++,o=G):(G=0,Y[a.name]=!0,o=G)),"undefined"==typeof K[o]&&(K[o]=[],H[o]=[]),a.options.sortby&&"date"===a.options.sortby.toLowerCase()){var s=Date.parseString(e[a.name],"M/d/yyyy h:mm:ss a");H[o].push('data-sort-value="'+s.getTime()+'"')}else H[o].push(null);switch(a.type.toLowerCase()){case"timestamp":var l;l=a.options&&a.options.tabletitle?a.options.tabletitle:"Timestamps",P[P.length-1]=l,K[o].push(n.getHumanTime(e[a.name]));break;case"useraccount":P[P.length-1]="User",K[o].push(e[a.name]);break;case"fullname":i=e[a.name+"_fullname_first_name"],"undefined"!=typeof e[a.name+"_fullname_middle_name"]&&(i+=" "+e[a.name+"_fullname_middle_name"]),i+=" "+e[a.name+"_fullname_last_name"],
K[o].push(i);break;case"booleaninput":K[o].push(e[a.name]?"Yes":"No");break;case"date":var r=e[a.name];if(r&&r.$date){if(r=moment(r.$date),!r.isValid())throw new Error('Invalid Date Value for "'+a.name+'" with "'+e[a.name]+'"');r=r.format("MM/DD/YYYY")}K[o].push(r);break;case"number":a.options&&a.options.decimals&&e[a.name]&&(e[a.name]=(e[a.name]/Math.pow(10,a.options.decimals)).toFixed(a.options.decimals));default:if("undefined"==typeof e[a.name])return void delete P[P.length-1];K[o].push(e[a.name])}})}),l+=i.inputTemplate["subform-table"]({labels:P,values:K,mode:a,sortBy:q,sortByVal:H,heading:"undefined"==typeof o.options.readmodedescription?o.description:o.options.readmodedescription})}else l+="";else if("telephone"===d&&o._providerValue)l+=i.inputTemplate.uneditabletel({value:$,label:o.description,id:o.name,providerValue:o._providerValue});else if("check"===d)l+=i.inputTemplate.uneditablecheck({value:$,label:o.description,id:o.name,otherValue:o._otherValue?o._otherValue:""});else if("select"===d&&o.options&&o.options.tags)t.isArray($)&&$.sort(function(e,t){return e-t}),l+=i.inputTemplate.uneditabletag({value:$,id:o.name});else if("filerepository"===d)l+=i.inputTemplate["read-filerepository"](t.extend({data:this.options.formData.fields[o.name],formId:this.options.formData._id.$oid,Utils:n},o));else{var Q="";switch(d){case"textarea":case"address":Q=" uneditable-input-textarea";break;case"timestamp":$=n.getHumanTime($);break;case"select":o._data&&($=o._data);break;case"booleaninput":$="true"===$||$===!0?"Yes":"No"}var W=["ParentFormId","FormRecordId"];if(o.name&&this.options.internal&&t.indexOf(W,o.name)>-1){var X=n.config.internalViewUrl,Z=[];i.options.formData.fields.MultipleFormRecordId?Z=i.options.formData.fields.MultipleFormRecordId.split(","):Z.push($),t.each(Z,function(e){l+='<a class="btn btn-primary" title="View FormId = '+e+'" href="'+X+"/"+e+'" style="margin-right:20px;">View</a>'})}else l+="html"===d?o.description:i.inputTemplate.uneditableinput({value:$,css_class:Q,id:o.name})}}else if("image"===d&&"undefined"!=typeof o.options.internalcanupdate&&this.options.internal&&o.options.internalcanupdate===!1){var $="",J="";t.each(r,function(e){"object"!=typeof i.options.formData.fields[e]?$+=("undefined"!=typeof i.options.formData.fields[e]?i.options.formData.fields[e]:"")+" ":$=i.options.formData.fields[e]}),"string"==typeof $&&($=e.trim($)),"deleted"===i.options.formData.fields[o.name]?J=null:(o.attributes.src=("undefined"!=typeof o.attributes.src?o.attributes.src:"/form/getFile/")+i.options.formData.fields[o.name],J=o.attributes.src),delete o.attributes.accept,t.each(o.attributes,function(e,t){e.search("'")&&(e=e.replace(/\'/gi,'"')),m+=" "+t+"='"+e+"'"}),l+=i.inputTemplate["uneditable"+d]({value:$,text:o.description,_attr:m,id:o.name,href:J})}else{if(this.options.internal&&"undefined"!=typeof o.options.internalcanupdate&&!o.options.internalcanupdate?d="hidden":t.each(o.attributes,function(e,t){m+=" "+t+"='"+e+"'"}),"image"===d&&(d="file"),ne&&(console.log(""),console.log("[*] Render HTML Field"),console.log(o),console.log(m)),ne&&"undefined"==typeof this.inputTemplate[d])throw'Template of "'+d+'" not found!';l+="undefined"!=typeof this.inputTemplate[d]?this.inputTemplate[d](t.extend({_attr:m,_lang:this.options.lang,_renderMode:this.options.mode},o)):""}if(o.options.visibleon){if(!o.options.visibleon.name||!e.isArray(o.options.visibleon.values))throw o.name+".Options.VisibleOn need Name and Values!";this._visibleOn.push(o)}return o&&o.type&&!this.inputTemplate[d]&&console&&console.warn&&console.warn('[x] Template for "'+o.type+'" does not existed.'),o.options.updateonreadmode&&(l='<div class="update-on-read-mode" data-field-name="'+o.name+'">'+l+this.generateMarkUpForUpdateOnReadMode(o)+"</div>"),l},renderLabel:function(e,o,a){o=o||!1,e.attributes=e.attributes||{},e.options=e.options||{};var i=e.type.toLowerCase(),s="undefined"!=typeof a&&a?' class="'+a+'"':"";switch(e.options.renderas&&(i=e.options.renderas.toLowerCase()),i){case"hidden":if("create"===this.options.mode)return"";break;case"buttondecision":return""}return this.inputTemplate.label(t.extend({_cssClass:s,_required:o},e))},renderButton:function(e){var t="";return(e.submitbutton||e.resetbutton)&&(t+='<div class="form-actions">'),t+=e.submitbutton&&!e.subForm?'<button type="submit" class="btn btn-primary btn-submit">'+e.submitbutton+"</button>":'<button type="button" class="btn btn-primary btn-submit">'+e.submitbutton+"</button>",e.resetbutton&&(t+='<button type="button" class="btn btn-cancel">'+e.resetbutton+"</button>"),t.length>0&&(t+="</div>"),t},checkShowOnMode:function(o,a,i){var s=!1,n="BillAnotherDept",l=0,r=o.type.toLowerCase();if(s&&o&&o.name&&(console.log("checkShowOnMode: ",o.name),console.log("")),void 0!=o.options.internal&&o.options.internal!==this.options.internal)return!1;if(o.options.internal===!0&&o.name&&"buttonclipboard"!==r){var d;switch(r){case"check":case"checkbox":d=o.name+"[]";break;default:d=o.name}this._internalFields.push(d)}if(s&&o.name===n&&(l++,console.log("Location: "+l)),this.options.hideButtons&&("button"===r||"submit"===r||"reset"===r||"action"===r))return!1;if(s&&o.name===n&&(l++,console.log("Location: "+l)),"read"===this.options.mode&&!e.isEmptyObject(o.options.visibleon)&&"undefined"==typeof this.options.formData.fields[o.name]&&"fullname"!==r&&"address"!==r&&"buttonclipboard"!==r)return s&&o.name===n&&(l++,console.log("Location: "+l," : ",this.options.formData.fields[o.name])),!1;if(s&&o.name===n&&(l++,console.log("Location: "+l)),a=a||!1,i=i||!1,"read"!==a&&"buttonclipboard"===o.type.toLowerCase())return s&&o.name===n&&(l++,console.log("Location: "+l)),!1;if("read"===a&&!this.options.internal&&o.options.hideonexternalread)return s&&o.name===n&&(l++,console.log("Location: "+l)),!1;if("undefined"!=typeof o.options.showonmode&&o.options.showonmode.indexOf(a)===-1)return s&&o.name===n&&(l++,console.log("Location: "+l)),!1;if("undefined"!=typeof o.options.showonstatus){s&&o.name===n&&(l++,console.log("Location: "+l));var m=t.map(o.options.showonstatus,function(e){return e.toLowerCase()});if("create"!==this.options.mode&&(i===!1||m.indexOf(i.toLowerCase())===-1))return!1}else if(this.options.internal&&"update"===a&&"undefined"!=typeof o.options.internalcanupdate&&!o.options.internalcanupdate&&"image"!==r)return!1;return!0},attachSubFormEvent:function(a,i,s){i=t.extend(i,{validation:s});var n=this,l={el:"#"+a+this.prefixedName.listdisplayid,formSchema:i,formId:a,options:this.options},r=t.extend({},o.Events);e(this.el).on("click","#"+a+"_add_btn",l,this.displaySubForm).on(a+".close",this.closeSubForm).on(a+".add",t.extend({formId:a},this),this.addSubformData),"update"===this.options.mode&&"undefined"!=typeof this.options.formData.fields[i.name]&&this.options.formData.fields[i.name].length>0?r.on(l.formId+".listViewCreated",function(t){console.log("- "+l.formId+".listViewCreated"),console.log(" - that.el:",n.el),console.log(" - id:",a),console.log(" - list:",t),console.log(" - that.options.formData.fields[field.name]:",n.options.formData.fields[i.name]),e(n.el).trigger(a+".add",[t,n.options.formData.fields[i.name]]),r.off()}):r.on(l.formId+".listViewCreated",function(t){var o=e("#"+l.formId,n.el),i=function(s,r){e(n.el).trigger(a+".add",[t,r,!0]),o.one(l.formId+".ajaxUpdate",i)};o.one(l.formId+".ajaxUpdate",i),r.off()}),r.on(l.formId+".listViewCreated",function(e){t.isEmpty(n._listSchema)||t.each(n._listSchema,function(t,o){n.setupSubFormListenValueEvent(n,t,o,l,r,a,e)})}),this.displaySubForm({data:l},{},!0,r)},displaySubForm:function(o,a,i,n,l){if(l=l||!1,o.data){ne&&(console.log("[*] baseField.displaySubForm"),a&&a.toJSON&&console.log(a.toJSON()),console.log(i),console.log(n),console.log(l)),a=a||{},i=i||!1,n=n||!1;var r,d=t.clone(o.data);e.isEmptyObject(a)?r="SubFormView"+o.data.formId:(d.model=a,r="SubFormViewEdit"+o.data.formId),e(this).parents("div.actions").fadeOut(),require(["views/fields/list"],function(t){ne&&(console.log("- displaySubForm: Render List!"),d.model&&console.log(JSON.stringify(d.model)));var a=s.create(this,r,t,d),m=e(a.el);i&&m.hide(),a.render(i,l),i||(m.show(),m.addClass("active"),m.expose({closeOnEsc:!1,closeOnClick:!1,color:"#000",zIndex:1025,renderBody:!1})),n&&n.trigger(o.data.formId+".listViewCreated",a)})}},setupSubFormListenValueEvent:function(a,i,s,n,l,r,d){var m=!1;if(i.options&&i.options.copyvaluesfrom){var p=i.options.copyvaluesfrom;if(p&&p.length){m&&(console.log("- Set Up setupSubFormListenValueEvent"),console.log(i),console.log(p));var u=e("div#app");t.each(p,function(i,n){m&&console.log(" - ",arguments),t.each(i,function(t,i){var l=':input[name="'+t+'"]';m&&console.log("- attached event _name:",l," listKey:",i),u.on("change",l,function(t){var p=e(t.target),u=p.val();if(u&&(u=e.trim(u)),m&&console.log("- on change fired! "+l),a.model.has(s)){var c=a.model.get(s);m&&console.log("  - currentListModel.length:",c.length);var f,h=o.Model.extend({});if(c.length){if(f=c.at(n),!f)throw new Error("Please look at List CopyValuesFrom logic!");if(f.get(i)===u)return;f.set(i,u)}else f=new h,f.set(i,u),c.push(f);m&&(console.log("  - currentListModel.length:",c.length),console.log("  - Fired: add event!")),e(a.el).trigger(r+".add",[d,c.toJSON(),!0])}})})})}}},closeSubForm:function(t,o){var a=!1;a&&console.log("[*] closeSubForm"),o.$el.fadeOut(),e.mask.close(),e(".actions",o.$el.parent(".subform-container")).fadeIn("slow"),s.remove("SubFormView"+o.options.formId,!0),s.remove("SubFormViewEdit"+o.options.formId,!0)},addSubformData:function(a,i,l,r){ne&&(console.log("[*] baseField.addSubformData"),console.log(arguments)),r=r||!1,l=l||!1;var d=i.options.formSchema.view?i.options.formSchema.view:"table",m=i.options.formSchema.name,p=a.data.model.get(m);if(ne&&(console.log("- addSubformData:currentModel"),console.log(m),console.log(p),console.log(p.toJSON())),"object"!=typeof p&&a.data.model._listFieldType[m]&&a.data.model.set(m,a.data.model._listFieldType[m]),r&&p.reset(),l){var u=o.Model.extend({});t.each(l,function(e){var t=new u;t.set(e),p.add(t)}),ne&&(console.log("- addSubformData:"),console.log(p.toJSON()))}else ne&&(console.log("- addSubformData:list.model.toJSON()"),console.log(i.model.toJSON())),p.add(i.model);var c=i.options.formSchema.options||{};if(c.copyvaluesfrom&&!l){var f=i.model.cid;if(t.isArray(c.copyvaluesfrom)){for(var h,b,v=0;v<p.length;v++){var _=p.at(v);if(ne&&console.log(" - cid:",_.cid," = _listModelCid:",f),_.cid===f){h=v,b=_;break}}if("undefined"!=typeof h&&"null"!=typeof h&&c.copyvaluesfrom[h]&&!t.isEmpty(c.copyvaluesfrom[h])){var g=e("#"+i.options.options.formSchema.name);t.each(c.copyvaluesfrom[h],function(t,o){var a,i=g.find(':input[name="'+t+'"]'),s=b.get(o);i.length>1?e(i).each(function(t){var o=e(this),a=o.val();if(a===s){if(!o.is(":radio"))throw new Error("Not implement Radio in List - CopyValuesFrom yet!");o.attr("checked",!0)}else if(!o.is(":radio"))throw new Error("Not implement Radio in List - CopyValuesFrom yet!")}):(a=i.val(),s!==a&&i.val(s).trigger("change"))})}}}require(["views/subform-layouts/"+d],function(t){ne&&(console.log('    in "views/subform-layouts/'+d+'"'),console.log(p.toJSON()));var o={el:"#"+i.options.formId+a.data.prefixedName.collectiondisplayid,formSchema:i.options.formSchema,collection:p,options:i.options.options},l=s.create(this,"CollectionView"+a.data.formId,t,o);if(l.render(),a.data.closeSubForm(a,i),i.options.formSchema.options&&i.options.formSchema.options.permission){var r=n.getUserIdFormHtml().replace("\\","\\\\"),m=new RegExp(r,"ig");switch(i.options.formSchema.options.permission.toLowerCase()){case"readwriteselfcreated":l.$el.find("table tr").each(function(){var t=e(this),o=!1;t.find("td").each(function(){var t=e(this);t.text().match(m)&&(o=!0)}),o||t.find("td.subform-actions button.btn").remove()});break;default:throw i.options.formSchema.options.permission+" not implement yet!"}}})},setupVisibleOn:function(o,a,i,s){var l=!1;i=i||!1;var r=this,d=o.type.toLowerCase();if(!o.name)throw"In order to use VisibleOn option, we need to pass in the Name";switch(i||(o.options.visibleon.parentcontainer?i=o.options.visibleon.parentcontainer:"booleaninput"===d?i=".form-render_booleaninput_wrapper":o.options.visibleon&&o.options.visibleon.name&&t.indexOf(this._radioFieldName,o.options.visibleon.name)>-1&&(i=".radio-container")),i&&o.options&&o.options.visibleon&&o.options.visibleon.parentcontainer&&o.options.visibleon.parentcontainer!==i&&(i=o.options.visibleon.parentcontainer),d){case"address":delete this.model.validation[o.name+"_address_street"],delete this.model.validation[o.name+"_address_city"],delete this.model.validation[o.name+"_address_state"],delete this.model.validation[o.name+"_address_zip"],delete this.model.validation[o.name+"_address_country"],delete this.model.validation[o.name+"_address_street_number"],delete this.model.validation[o.name+"_address_unit_number"];break;case"multifiles":delete this.model.validation[o.name+"[]"];break;default:delete this.model.validation[o.name]}var m=o.options.visibleon.name,p=!0;if(p){l&&console.log('- Attached "'+o.options.visibleon.name+'", _vsbName = ',m),l&&console.log("- fieldsType:",s);var u=s&&s[m]&&"checkbox"===s[m]?':input[name="'+m+'[]"]':':input[name="'+m+'"]';l&&console.log("- _inputNameQ:",u),e(this.el).on("change",u,function(s){var m=!1,p=!1;m&&console.log("*** Input ["+o.options.visibleon.name+"] changed ***");var u,c,f=e(s.currentTarget),h=i?f.parents(i):f,b=[],v=o.options.visibleon.name,_=f.val(),g=["","[]"];h.length||i!==o.options.visibleon.parentcontainer||(h=f.parents(".form-render").find(i));var y=f.attr("name"),D=y.match(/\w+\[\]$/gi),x=o.options.visibleon.values===_;if(t.isArray(o.options.visibleon.values)&&(x=t.find(o.options.visibleon.values,function(e){return m&&console.log("- value:",e,", _visibleVal:",_,", result = ",e===_),e===_})),D&&D.length&&(D=!0),m&&(console.log(""),console.log("- _visibleOnName:",v),console.log("- $currentTarget:",f),console.log("- _currentInputName:",y),console.log("- _hasBracket:",D),console.log("- _visibleVal:",_),console.log("- field.options.visibleon.values:",o.options.visibleon.values),console.log("- _visibleValInArray:",x),console.log("")),D){var w=f.is(":checked");f.closest(".checkbox-container").find(":checkbox:checked").each(function(a){var i=e(this).val();return m&&console.log("- _checkedVal:",i),w||_!==i?void(_!==i&&t.indexOf(o.options.visibleon.values,i)>-1&&(_=i)):(_=null,void(m&&console.log("- Set _visibleVal to :",_)))}),w||_!==f.val()||(_=null),m&&console.log("- _visibleVal:",_)}else v.match(/\[\]$/gi)?(h.length||(h=f.closest(".checkbox-container")),v=v.substr(0,v.length-2),h=h.closest(".checkbox-container"),m&&console.log("- this is checkbox?",f.is(":checkbox")),f.is(":checkbox")&&(_="",h.find(":checkbox:checked").each(function(){var a=e(this).val();t.indexOf(o.options.visibleon.values,a)>-1&&(_=a)}))):f.is(":radio")&&!i&&(h=f.closest(".radio-container"));m&&(console.log("- $container:",h),console.log("- field.options.visibleon:",o.options.visibleon),console.log("- _visibleVal:",_));var k=!0;if(o&&o.options&&o.options.visibleon&&o.options.visibleon.steps){if(!t.isArray(o.options.visibleon.steps)||!o.options.visibleon.steps.length)throw new Error(o.name+" must not contain an empty VisibleOn.Steps");var S=o.options.visibleon.steps;l&&(console.log("[*] Debug: VisibleOn with Steps"),console.log(_),console.log(o.name),console.log(S));for(var C=0;C<S.length;C++){var V=S[C],F=V.values;if(!F||!t.isArray(F)){var O="undefined"!=typeof JSON&&JSON&&JSON.stringify?JSON.stringify(V):null;throw new Error('Expects an array for "Values" in "'+O+'"')}var L=e(':input[name="'+V.name+'"]'),N=e.trim(L.val()),A=t.indexOf(F,N),B=V.notin?A<0:A>-1;if(l&&(console.log("[*] Step: "+C),console.log(L),console.log(V),console.log(N),console.log(F),console.log(A),console.log(B)),!B){k=!1;break}}}if(m&&(console.log("- field.options.visibleon.values:",o.options.visibleon.values),console.log("- _visibleVal:",_),console.log("- isValidSteps:",k)),t.indexOf(o.options.visibleon.values,_)>-1&&k){if(m&&(console.log("[x] Match Value with VisibleOn, will render ["+o.name+"]."),console.log(f),console.log("- htmlTmpl"),console.log(a),console.log("- length:",e(".options-visible-on-"+o.name,r.el).length)),e(".options-visible-on-"+o.name,r.el).length<1){if(m&&console.log("- $container:",h),h.after(a),m&&console.log(h),u=h.next(".options-visible-on-"+o.name).fadeIn("slow",function(){var a=e(this).addClass("visible-parent-"+v).attr("data-parent",v);n.setupSelect2(a);var i=e(".options-visible-on-"+v,r.el);if(e('[class*="visible-parent-'+v+'"]',r.el).not(".visible-parent-"+v+",.options-visible-on-"+v+",.visible-parent-"+i.attr("data-parent")).remove(),"multifiles"===d?e("#"+o.name+"_multifiles_wrapper",this).trigger("visibleOnRenderComplete"):e(':input[name="'+o.name+'"]',this).trigger("visibleOnRenderComplete"),!r.model.bindings[o.name]&&t.indexOf(r.model.notBinding,o.name)<0){var s=o.name;t.each(g,function(t){s===o.name&&e(':input[name="'+s+t+'"]').length&&(s=o.name+t)}),e(':input[name="'+s+'"]').length&&"checkbox"!==d&&(r.model.bindModelBinder(s,o.type),r._modelBinder.bind(r.model,r.el,r.model.bindings))}}),c=h.next("div"),0===c.length&&(c=h.parent()),c.find(":input").not('input[type="hidden"]').placeholder(),"address"===d){var E=o.name+"_address_street";r.options.formSchema.validation[E]&&(r.model.validation[E]=r.options.formSchema.validation[E]),b.push(E),E=o.name+"_address_city",r.options.formSchema.validation[E]&&(r.model.validation[E]=r.options.formSchema.validation[E]),b.push(E),E=o.name+"_address_state",r.options.formSchema.validation[E]&&(r.model.validation[E]=r.options.formSchema.validation[E]),b.push(E),E=o.name+"_address_zip",r.options.formSchema.validation[E]&&(r.model.validation[E]=r.options.formSchema.validation[E]),b.push(E),E=o.name+"_address_country",r.options.formSchema.validation[E]&&(r.model.validation[E]=r.options.formSchema.validation[E]),b.push(E),E=o.name+"_address_street_number",r.options.formSchema.validation[E]&&(r.model.validation[E]=r.options.formSchema.validation[E]),b.push(E),E=o.name+"_address_unit_number",r.options.formSchema.validation[E]&&(r.model.validation[E]=r.options.formSchema.validation[E]),b.push(E),o.options.hidecountry&&r.model.set(E,"US")}else r.options.formSchema.validation[o.name]&&"html"!==d?(r.model.validation[o.name]=r.options.formSchema.validation[o.name],b.push(o.name)):r.options.formSchema.validation[o.name+"[]"]&&(r.model.validation[o.name+"[]"]=r.options.formSchema.validation[o.name+"[]"],b.push(o.name+"[]"));if("update"===r.options.mode&&b.length>0)t.each(b,function(t){if(r.options.formData.fields[t]){r.model.set(t,r.options.formData.fields[t]);var o=e(':input[name="'+t+'"]',u);switch(d){case"radio":case"check":case"checkbox":o.filter('[value="'+r.options.formData.fields[t]+'"]').prop("checked",!0);break;default:o.is(":radio")||o.is(":checkbox")||o.val(r.options.formData.fields[t])}}});else if("update"===r.options.mode)switch(l&&(console.log("- Check for Field. "+o.name),console.log(o.name),console.log(r.options.formData.fields)),l&&console.log("Current Type: ",d),d){case"fullname":t.each(["_fullname_first_name","_fullname_middle_name","_fullname_last_name"],function(t){var a=o.name+t,i=e(':input[name="'+a+'"]',u);i.length&&r.options.formData.fields[a]&&i.val(r.options.formData.fields[a])});break;default:if(r.options.formData.fields[o.name]){var j=e(':input[name="'+o.name+'"]',u);j.is(":radio")||j.is(":checkbox")||(j.val(r.options.formData.fields[o.name]),r.model.set(o.name,r.options.formData.fields[o.name]))}}if("userid"===d&&(n.setupUserIdAjaxCall(e("form.form-render")),r.model.validation[o.name].pattern||o.options.render&&"select"===o.options.render.toLowerCase()||(r.model.validation[o.name].pattern="email")),n.setupUrlAjaxCall(e("form.form-render"),e("#"+o.name)),r._hasDate&&(l&&(console.log("[*] baseField.setupVisibleOn - _hasDate"),console.log(r.el),console.log(r.$el)),n.setupDateInput(r.el,r)),r._hasBDate&&o&&o.type&&o.options&&o.options.render&&"date"===o.type.toLowerCase()){var I=o.options.render;try{I=I.toLowerCase();var T=".options-visible-on-"+o.name;switch("string"==typeof r.el&&(T=r.el+" "+T),I){case"select":n.setupBDateInput(T,r.model)}}catch(e){console&&console.error&&console.error(e)}}}}else{if(e("#"+o.name,r.el).trigger("removeVisibleOn"),e(".options-visible-on-"+o.name,r.el).remove(),e(".visible-parent-"+o.name,r.el).remove(),"date"===d&&o.options&&o.options.render){var U=o.options.render;try{switch(U=U.toLowerCase()){case"select":var M=o.name+"_birth";"undefined"!=typeof t&&t?(t.map(["day","month","year"],function(e){var t=M+"["+e+"]";r.model.validation[t]&&delete r.model.validation[t]}),r.model.validation[o.name]&&delete r.model.validation[o.name]):console&&console.error&&console.error('Could not be able to locate "_".');break;default:throw new Error('Not implement delete for "'+U+'"')}}catch(e){console&&console.error&&console.error(e)}}else if("fullname"===d)t.map(["_fullname_first_name","_fullname_last_name"],function(e){var t=o.name+e;r.model.validation[t]&&delete r.model.validation[t]});else if("address"===d){var E=o.name+"_address_street";r.model.set(E,""),r.options.formSchema.validation[E]&&(r.model.validation[E]=r.options.formSchema.validation[E],delete r.model.validation[E]),E=o.name+"_address_city",r.model.set(E,""),r.options.formSchema.validation[E]&&(r.model.validation[E]=r.options.formSchema.validation[E],delete r.model.validation[E]),E=o.name+"_address_state",r.model.set(E,""),r.options.formSchema.validation[E]&&(r.model.validation[E]=r.options.formSchema.validation[E],delete r.model.validation[E]),E=o.name+"_address_zip",r.model.set(E,""),r.options.formSchema.validation[E]&&(r.model.validation[E]=r.options.formSchema.validation[E],delete r.model.validation[E]),E=o.name+"_address_country",r.model.set(E,""),r.options.formSchema.validation[E]&&(r.model.validation[E]=r.options.formSchema.validation[E],delete r.model.validation[E]),E=o.name+"_address_street_number",r.model.set(E,""),r.options.formSchema.validation[E]&&(r.model.validation[E]=r.options.formSchema.validation[E],delete r.model.validation[E]),E=o.name+"_address_unit_number",r.model.set(E,""),r.options.formSchema.validation[E]&&(r.model.validation[E]=r.options.formSchema.validation[E],delete r.model.validation[E])}else if("html"!==d){r.model.set(o.name,""),r.model.validation[o.name]?delete r.model.validation[o.name]:r.model.validation[o.name+"[]"]&&delete r.model.validation[o.name+"[]"];var R=o.name;t.each(g,function(e){if(r.model.bindings[R+e]){r.model.unbindModelBinder(R+e,o.type);for(var a=!0;a;)try{r._modelBinder.bind(r.model,r.el,r.model.bindings),a=!1}catch(e){a=!1;var i=e.match(/name="(\w+)"/i);if(i||console&&console.error&&console.error(e),2===i.length){var s=i[1];t.each(g,function(e){r.model.bindings[s+e]&&(r.model.unbindModelBinder(s+e,o.type),r.model.validation[s+e]&&delete r.model.validation[s+e],a=!0)})}}if(!f.is(":checkbox")){var n=f.attr("name");f.is(":radio")||f.val(_),r.model.get(n)!==_&&r.model.set(n,_)}}}),f.is(":radio")&&f.prop("checked",!0)}p&&(console.log("[*] Check for Validation"),console.log(r.model.validation))}}),this&&this.options&&"update"===this.options.mode&&e("#"+this.options.formSchema.name).on(this.options.formSchema.name+".renderCompleted",function(){o&&o.options&&o.options.visibleon&&t.forEach(o.options.visibleon.values,function(t){var o=e(u).filter(":checkbox:checked");o.each(function(){var o=e(this),a=o.val();t===a&&o.trigger("change")})})})}},setupCopyValuesFrom:function(o){if("list"!==o.type.toLowerCase()){if(!o.options.copyvaluesfrom.name||!o.options.copyvaluesfrom.description)throw"In order to use CopyValuesFrom options, need to have Name and Description";var a=this,i="";return i+='<div class="copy-values-from '+o.options.copyvaluesfrom.name+'">'+this.inputTemplate.buttongroup({description:o.options.copyvaluesfrom.description})+"</div>",e(this.el).on("click",".copy-values-from."+o.options.copyvaluesfrom.name+" .btn-group button",function(i){var s,l,r=e(i.currentTarget),d=[];r.hasClass("btn-yes")&&(s=n.getSpecialFieldsName(o.options.copyvaluesfrom.name,o.type),t.each(s,function(t){d.push(e(':input[name="'+t+'"]',a.el).val())}),l=n.getSpecialFieldsName(o.name,o.type),n.setFieldsValues(a.el,a.model,l,d))}),i}},sortOrderBy:function(e){var t,o=e.options.orderby;if(o||e.values){switch(o=o.toLowerCase()){default:t=function(e,t){return e.localeCompare(t)}}e.values.sort&&e.values.sort(t)}},addDataToElementData:function(e,t,o){this._elementData[e]||(this._elementData[e]={}),this._elementData[e][t]=o},generateMarkUpForUpdateOnReadMode:function(e){if(!e.type)return console&&console.warn&&console.warn('[x] generateMarkUpForUpdateOnReadMode for "'+e.name+'" could not be able to find "Type".'),"";var o,a,i=!1,s=e.type.trim().toLowerCase(),n=this.options.formData.fields[e.name];switch(i&&(console.debug("[*] UpdateOnReadMode"),console.debug("     Name: "+e.name),console.debug("     Value: "+n)),s){case"file":throw"Not yet support!";default:a="text"}switch(s){case"radio":o=le["default-input-radio"](t.extend({data:n},e));break;case"textarea":o=le["default-input-textarea"](t.extend({data:n},e));break;case"date":o=le["default-input-date"](t.extend({data:n},e));break;default:o=le["default-input"](t.extend({inputType:a,data:n},e))}return i&&console.debug("     HTML: "+o),o}})});