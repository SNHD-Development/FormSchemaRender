define(["jquery","underscore","backbone","bootstrap","events","vm","utils","models/model","collections/collections","modelbinder","validation","views/fields/list","text!data/email.json","text!data/schooles.json","text!data/schoolclarkcounty.json","text!data/county.json","text!data/country.json","text!templates/fields/html.html","text!templates/fields/label.html","text!templates/fields/text.html","text!templates/fields/password.html","text!templates/fields/telephone.html","text!templates/fields/socialsecurity.html","text!templates/fields/hidden.html","text!templates/fields/timestamp.html","text!templates/fields/useraccount.html","text!templates/fields/fraction.html","text!templates/fields/booleaninput.html","text!templates/fields/radio.html","text!templates/fields/file.html","text!templates/fields/multifiles.html","text!templates/fields/filerepository.html","text!templates/fields/read-filerepository.html","text!templates/fields/state.html","text!templates/fields/county.html","text!templates/fields/zipcode.html","text!templates/fields/country.html","text!templates/fields/fullname.html","text!templates/fields/address.html","text!templates/fields/textarea.html","text!templates/fields/number.html","text!templates/fields/email.html","text!templates/fields/date.html","text!templates/fields/select.html","text!templates/fields/check.html","text!templates/fields/birthdate.html","text!templates/fields/button.html","text!templates/fields/buttongroup.html","text!templates/fields/list.html","text!templates/fields/uneditableinput.html","text!templates/fields/uneditablecheck.html","text!templates/fields/uneditabletag.html","text!templates/fields/uneditabletel.html","text!templates/fields/uneditablefile.html","text!templates/fields/uneditableimage.html","text!templates/fields/buttonclipboard.html","text!templates/subform-layouts/table.html","text!templates/subform-layouts/card.html","text!templates/update-on-read/default-input.html","text!templates/update-on-read/default-input-radio.html","text!templates/update-on-read/default-input-textarea.html","text!templates/update-on-read/default-input-date.html","jquery.expose","jquery.datepicker","jquery.birthdaypicker","bootstrap","jquery.timepicker"],function(t,e,a,o,i,s,n,l,r,d,m,p,u,c,f,h,b,v,_,g,y,w,D,x,k,S,V,C,F,O,L,E,N,T,I,A,j,B,M,U,$,R,J,z,P,q,H,Y,G,K,Q,W,X,Z,tt,et,at,ot,it,st,nt,lt){function rt(t,a){var o,i=!0;if(mt&&(console.log("[*] buildHtmlBasicFormMarkup"),console.log(arguments)),t.attributes||(t.attributes={}),!t.description)throw'Expected a "description" in buildHtmlBasicFormMarkup parameter.';if(!t.name)throw'Expected a "name" in buildHtmlBasicFormMarkup parameter.';if(!t.type)throw'Expected a "type" in buildHtmlBasicFormMarkup parameter.';var s=t.type.toLowerCase();switch(t.options=t.options||{},t._required=!0,s){case"hidden":i=!1;var n=t.attributes.value;o='<input type="hidden" name="'+t.name+'" value="'+n+'"/>';break;case"textarea":o='<textarea name="'+t.name+'" class="" id="'+t.name+'"></textarea>';break;case"textbox":o='<input name="'+t.name+'" type="text" class="" id="'+t.name+'"/>';break;case"checkbox":case"check":if(t.options.numcolumns){if(!e.isNumber(t.options.numcolumns))throw"NumColumns must be a valid number for "+t.name;t.options.numcolumns>4?t.options.numcolumns=4:t.options.numcolumns<1&&(t.options.numcolumns=1)}else t.options.numcolumns=1;o=a.check(e.extend({_attr:{},_lang:"en",_renderMode:"edit"},t));break;default:throw'Not implement "'+t.type+'" yet in buildHtmlBasicFormMarkup.'}return i&&(o='<label for="'+t.name+'">'+t.description+"</label>"+o),'<div class="form-markup-field">'+o+"</div>"}function dt(e,a,o,i,l,r,d){require(["views/fields/list"],function(m){mt&&(console.log("*** displaySubForm: Render List ***"),console.log("hidden:",d),i.model&&console.log(JSON.stringify(i.model)));var p=s.create(a,o,m,i),u=t(p.el);ut[o]=p,d&&u.hide(),mt&&console.log("subFormView:",p),p.render(d,r),mt&&(console.log("After: subFormView.render",p.cid),console.log("subFormView:",p)),d||(u.show({complete:function(){mt&&model&&model.toJSON&&(console.log("[*] complete <----------"),console.log("model.toJSON:",model.toJSON()),console.log("subFormView:",p),console.log("subFormView.$el:",p.$el),console.log("$(subFormView.el):",t(p.el))),n.finalSetup(p)},done:function(){mt&&model&&model.toJSON&&(console.log("[*] done <----------"),console.log("model.toJSON:",model.toJSON()),console.log("subFormView:",p),console.log("subFormView.$el:",p.$el),console.log("$(subFormView.el):",t(p.el)))}}),u.addClass("active"),u.expose({closeOnEsc:!1,closeOnClick:!1,color:"#000",zIndex:1025,renderBody:!1})),l&&l.trigger(e.data.formId+".listViewCreated",p)})}var mt=!1,pt={"default-input":e.template(it),"default-input-radio":e.template(st),"default-input-textarea":e.template(nt),"default-input-date":e.template(lt)},ut={};return a.View.extend({_modelBinder:void 0,clean:function(){a.Validation.unbind(this),void 0!==this._modelBinder&&this._modelBinder.unbind()},initialize:function(){var a=this;this._div=0,this._hasUserId=!1,this._hasDate=!1,this._hasTime=!1,this._hasBDate=!1,this._DatePickerLogicArr={},this._hasEmailPicker=!1,this._hasBooleanInput=!1,this._hasRadioBtnGroup=!1,this._hasSelectAllCheckBox=!1,this._hasClearAllCheckBox=!1,this._hasOtherTextBox=!1,this._internalFields=[],this._visibleOn=[],this._multiFiles=[],this._buttonClipboards=[],this._buttonDecision=[],this._ajaxDataCall=[],this._javaUpload=[],this._elementData={},this._ajaxSubmit=!0,this._radioFieldName=[],this._lookupValues={},this._listSchema={},this._getValueFrom={},this._visibleonEventAttached={},this._stepDiv=0,this._currentStep=1,this._stepValidated=[],this._timeInputs={},this._modelBinder=new d,this.options.formSchema.validation=this.options.formSchema.validation||{},this.model=new l(e.extend(this.options.formSchema,{is_internal:this.options.internal,render_mode:this.options.mode,status:"update"===this.options.mode&&this.options.formData&&this.options.formData.status?this.options.formData.status:null})),this.options.formData&&!e.isEmpty(this.options.formData)&&this.model.multiFilesDefaultValue&&!e.isEmpty(this.model.multiFilesDefaultValue)&&(this.model.multiFilesDefaultValue=e.reduce(this.model.multiFilesDefaultValue,function(t,e,o){var i=o.replace(/[\[\]]/gi,"");return a.options.formData&&a.options.formData.fields&&a.options.formData.fields[i]&&(t[o]=a.options.formData.fields[i]),t},{})),t.isEmptyObject(this.options.formData)||e.each(this.model.attributes,function(t,e){if("object"==typeof t);else{var o={};o[e]=a.options.formData.fields[e],a.model.set(o)}}),this.prefixedName={list:"subform_",listdisplayid:"_form_content",collectiondisplayid:"_form_collection"},this.notRenderLabel=["html","list","button","submit","clear","fieldset","fieldsetstart","fieldsetend","step","check","checkbox","timestamp","hidden"],this.notRenderLabelRead=["html","list","button","submit","clear","fieldset","fieldsetstart","fieldsetend","step","check","checkbox"],this.inputTemplate={html:e.template(v),label:e.template(_),text:e.template(g),password:e.template(y),telephone:e.template(w),socialsecurity:e.template(D),hidden:e.template(x),timestamp:e.template(k),useraccount:e.template(S),fraction:e.template(V),booleaninput:e.template(C),radio:e.template(F),file:e.template(O),multifiles:e.template(L),filerepository:e.template(E),"read-filerepository":e.template(N),state:e.template(T),county:e.template(I),zipcode:e.template(A),country:e.template(j),fullname:e.template(B),address:e.template(M),textarea:e.template(U),number:e.template($),email:e.template(R),date:e.template(J),select:e.template(z),check:e.template(P),birthdate:e.template(q),button:e.template(H),buttongroup:e.template(Y),list:e.template(G),uneditableinput:e.template(K),uneditablecheck:e.template(Q),uneditabletag:e.template(W),uneditabletel:e.template(X),uneditablefile:e.template(Z),uneditableimage:e.template(tt),buttonclipboard:e.template(et),"subform-table":e.template(at),"subform-card":e.template(ot)};var o={submitbutton:"Submit",resetbutton:"Cancel"};this.options.formSchema.formoptions=e.extend(o,this.options.formSchema.formoptions)||o},getFormValidationData:function(t){return this.options.formSchema.validation=this.options.formSchema.validation||{},void 0===this.options.formSchema.validation[t]?{}:this.options.formSchema.validation[t]},closeOpenDiv:function(t){t=t||"_div";for(var e="",a=0,o=this[t];a<o;++a)e+="</div>";return this._div=0,e},render:function(a,o){var i=this,l="",r=[a.name],d=a.type.toLowerCase(),m="",p=t.parseJSON(b);if(a.lang=this.options.lang,a.attributes=a.attributes||{},a.attributes.autocomplete||(a.attributes.autocomplete="off"),a.options=a.options||{},this.options.formSchema.validation=this.options.formSchema.validation||{},this.options.formData=this.options.formData||{},!this.options.internal&&a.options.internal)return"";if(("button"===d||"submit"===d)&&!a.options.internal&&this.options.internal)return"";if(a.options.renderas){switch(d){case"date":this.options.formData&&this.options.formData.fields&&this.options.formData.fields[a.name]&&this.options.formData.fields[a.name].$date&&(this.options.formData.fields[a.name]=n.formatDateAsString(this.options.formData.fields[a.name].$date));break;case"number":break;default:throw'Not Implement Options.RenderAs for "'+d+'" yet!'}d=a.options.renderas.toLowerCase()}switch(d){case"calculate":if(d="hidden",!a.options||!a.options.logic)throw new Error("In order to use "+d+", please set up the Options.Logic");a.attributes["data-logic"]=a.options.logic,a.options.type&&(a.attributes["data-type"]=a.options.type);break;case"booleaninput":this._hasBooleanInput=!0;break;case"radio":this._radioFieldName.push(a.name),!this._hasRadioBtnGroup&&a.options.render&&(this._hasRadioBtnGroup=!0),this.options.formData.fields&&this.options.formData.fields[a.name]&&("read"===this.options.mode&&a.values&&e.isObject(a.values)&&(this._lookupValues[a.name]={value:this.options.formData.fields[a.name],text:a.values[this.options.formData.fields[a.name]]},e.isArray(a.values)||(this.options.formData.fields[a.name]=a.values[this.options.formData.fields[a.name]])),a._data=this.options.formData.fields[a.name]),a.options.orderby&&this.sortOrderBy(a);break;case"multifiles":this.options.internal&&void 0!==a.options.internalcanupdate&&!a.options.internalcanupdate||t("form"+this.el).attr("enctype","multipart/form-data"),this._multiFiles.push(a);var v=this.getFormValidationData(a.name+"[]");void 0===this._stepValidated[this._currentStep-2]||t.isEmptyObject(v)||this._stepValidated[this._currentStep-2].push(a.name+"[]"),"read"===this.options.mode&&(d="file");break;case"filerepository":if(!a.options.url)throw'Expected Url parameter in Options Key for "'+a.name+'".';break;case"image":a.attributes.accept="image/*";case"file":this.options.internal&&void 0!==a.options.internalcanupdate&&!a.options.internalcanupdate||"string"==typeof this.el&&t("form"+this.el).attr("enctype","multipart/form-data");var _=a.options&&"usewebcam"in a.options&&!e.isEmpty(a.options.usewebcam),g=_&&a.options.usewebcam.url?a.options.usewebcam.url:null,v=this.getFormValidationData(a.name);if(v.accept&&(a.attributes.accept=v.accept),a.options.javaupload){var y={name:a.name,id:a.name,code:"com.elementit.JavaPowUpload.Manager",archive:"//public.southernnevadahealthdistrict.org/assets/jar/jupload/JavaPowUpload.jar, //public.southernnevadahealthdistrict.org/assets/jar/jupload/skinlf.jar, //public.southernnevadahealthdistrict.org/assets/jar/jupload/commons-httpclient.jar, //public.southernnevadahealthdistrict.org/assets/jar/jupload/commons-compress.jar",width:500,height:350,mayscript:"true",alt:"JavaPowUpload by www.element-it.com"};this._javaUpload.push(y)}if(a.attributes||(a.attributes={}),a.attributes.class=a.attributes.class?a.attributes.class:"",_&&(a.attributes.class+=" form-render-has-webcam "),g&&(a.attributes["data-webcam-url"]=g),a.options.markdownloaddatetimeof&&this.options.mode&&"read"===this.options.mode){var w=this.options.internal?"internal":"external",D=a.options.markdownloaddatetimeof.toLowerCase();"*"!==D&&D!==w||(a.attributes.class=(a.attributes.class?a.attributes.class:"")+" btn-auto-refresh ",a.attributes["data-refresh-delay"]||(a.attributes["data-refresh-delay"]="2000"))}break;case"userid":this._hasUserId=!0,a.options&&a.options.lookup&&a.options.lookup.url&&(a.options.url=a.options.lookup.url),a.options.url&&(a.attributes["data-url"]=a.options.url),a.options.data&&(a.attributes["data-url-data"]=JSON.stringify(a.options.data)),a.attributes.placeholder=a.attributes.placeholder||"Valid E-mail as Username",a.attributes.class=(a.attributes.class||"")+" userid-lookup",d=a.options.render?a.options.render.toLowerCase():"text","select"===d&&(a.values=[]),a.attributes.class=n.setupClassAttr(a.attributes.class,"span12");break;case"fraction":break;case"textbox":d="text";case"selectsingle":"selectsingle"===d&&(d="select");case"select":if("update"===this.options.mode&&this.options.formData.fields[a.name]&&(a.attributes["data-select-value"]=this.options.formData.fields[a.name]),a.options&&a.options.lookup&&a.options.lookup.url)a.options.url=a.options.lookup.url,a.options.lookup.value&&(a.attributes["data-select-key-value"]=a.options.lookup.value),a.options.lookup.text&&(a.attributes["data-select-key-text"]=a.options.lookup.text);else if(a.options){if(a.options.tags)a.attributes.class=(a.attributes.class?a.attributes.class:"")+" selecttwo-render tags value-as-array";else if(a.options.render){var x=a.options.render.toLowerCase();switch(x){case"select2":a.attributes.class=(a.attributes.class?a.attributes.class:"")+" selecttwo-render"}}a.options.events&&this.addDataToElementData(a.name,"events",a.options.events),a.options.orderby&&this.sortOrderBy(a),a.options.getvaluefrom&&a.name&&(this._getValueFrom[a.options.getvaluefrom]||(this._getValueFrom[a.name]=a.options.getvaluefrom))}a.options.url&&(a.attributes["data-url"]=a.options.url.replace(/'/gi,"&#39;")),a.options.data&&(a.attributes["data-url-data"]=JSON.stringify(a.options.data)),a.attributes.class=n.setupClassAttr(a.attributes.class,"span12"),this.options.formData&&this.options.formData.fields&&this.options.formData.fields[a.name]&&(e.isArray(this.options.formData.fields[a.name])&&this.options.formData.fields[a.name].sort(function(t,e){return t-e}),"read"===this.options.mode&&a.values&&e.isObject(a.values)&&(a._data=a.values[this.options.formData.fields[a.name]]),this.addDataToElementData(a.name,"value",this.options.formData.fields[a.name]));break;case"country":var k="selecttwo-render";a.attributes.class?a.attributes.class.indexOf(k)<0&&(a.attributes.class+=" "+k):a.attributes.class=k,a._optionsValue=e.extend({},p),a.options.excludecountry&&e.each(a.options.excludecountry,function(t){delete a._optionsValue[t]});break;case"county":"string"==typeof h&&(h=t.parseJSON(h)),a._options=h,a.attributes.id||(a.attributes.id=a.name);var k="select2-county";a.options.filterbyid&&(k="select2-county-lookup"),a.attributes.class?a.attributes.class+=" "+k:a.attributes.class=k,this.options.formData&&this.options.formData.fields&&this.options.formData.fields[a.name]&&(a.attributes["data-countyvalue"]=this.options.formData.fields[a.name]);break;case"checkbox":case"check":if(a.options.numcolumns){if(!e.isNumber(a.options.numcolumns))throw"NumColumns must be a valid number for "+a.name;a.options.numcolumns>4?a.options.numcolumns=4:a.options.numcolumns<1&&(a.options.numcolumns=1)}else a.options.numcolumns=1;if(!this._hasSelectAllCheckBox&&a.options.addselectall&&(this._hasSelectAllCheckBox=!0),!this._hasClearAllCheckBox&&a.options.addclearall&&(this._hasClearAllCheckBox=!0),a.options.orderby&&this.sortOrderBy(a),a.options.othertextbox&&(this._hasOtherTextBox=!0),"update"===this.options.mode&&this.options.formData.fields&&this.options.formData.fields[a.name]&&(a._data=this.options.formData.fields[a.name]),this.options.formData.fields&&this.options.formData.fields[a.name+"_other"]&&(a._otherValue=this.options.formData.fields[a.name+"_other"]),void 0!==this.options.formSchema.validation[a.name+"[]"]){a._required=!0,a.attributes||(a.attributes={}),a.attributes["data-check-required"]=!0;var v=this.getFormValidationData(a.name+"[]");void 0===this._stepValidated[this._currentStep-2]||t.isEmptyObject(v)||this._stepValidated[this._currentStep-2].push(a.name+"[]")}else a._required=!1;if(d="check",!a.values)throw"In order to use CheckBox, please set Values.";break;case"password":a.attributes.class=n.setupClassAttr(a.attributes.class,"span12");break;case"telephone":a.attributes.class=n.setupClassAttr(a.attributes.class,"integer telephone span12"),this.options.formData.fields&&this.options.formData.fields[a.name+"_provider"]&&(a._providerValue=this.options.formData.fields[a.name+"_provider"]);break;case"socialsecurity":a.attributes.class=n.setupClassAttr(a.attributes.class,"integer socialsecurity span12");break;case"textarea":a.attributes.class=n.setupClassAttr(a.attributes.class,"span12");break;case"action":return this._div++,'<div class="form-actions">';case"fieldsetstart":return"<fieldset><legend>"+a.description+"</legend>";case"fieldsetend":return"</fieldset>";case"hr":return"<hr>";case"time":this._hasTime=!0,d="text",a.attributes.class=n.setupClassAttr(a.attributes.class,"timepicker"),a.attributes&&!a.attributes.placeholder&&(a.attributes.placeholder="HH:MM AM/PM"),a.options||(a.options={});var S=a.options.configuration,V=a.options.timeoptions;if(a.name in this._timeInputs||(this._timeInputs[a.name]={}),S&&!e.isEmpty(S)&&e.isObject(S)&&(a.attributes["data-timepicker-options"]=JSON.stringify(S),this._timeInputs[a.name].dataTimepickerOptions=S),V&&!e.isEmpty(V)&&e.isObject(V)&&(a.attributes["data-time-options"]=JSON.stringify(V),this._timeInputs[a.name].dataTimeOptions=V),this.options.formData&&this.options.formData.fields){var C=this.options.formData.fields[a.name];C&&(a.attributes["default-time-value"]=C)}break;case"dateinput":d="date";case"date":;if(this.options.formData&&this.options.formData.fields){var C=this.options.formData.fields[a.name];if(C&&"object"==typeof C&&C.$date){var F=new Date(C.$date),O=F.getMonth()+1;O<10&&(O="0"+O),O+="/";var L=F.getDate();if(L<10&&(L="0"+L),L+="/",this.options.formData.fields[a.name]=O+L+F.getFullYear(),a.options.render&&"read"===this.options.mode)switch(a.options.render.toLowerCase()){case"datetime":this.options.formData.fields[a.name]+=" "+n.formatAMPM(F)}a.attributes.value=this.options.formData.fields[a.name]}else"create"===this.options.mode&&void 0===this.options.formData.fields[a.name]&&(a._noDefaultValue=!0)}if(a.attributes&&!a.attributes.placeholder&&(a.attributes.placeholder="mm/dd/yyyy"),a.options.render&&"select"===a.options.render.toLowerCase()){d="birthdate",this._hasBDate=!0,a.attributes.class=n.setupClassAttr(a.attributes.class,"birthdaypicker");var v=this.getFormValidationData(a.name),E={id:a.name};"en"!==a.lang&&(E.lang=a.lang),void 0!==this.options.formData.fields&&(E.defaultdate=this.options.formData.fields[a.name]),a._noDefaultValue&&(E.nodefaultvalue=!0),a.attributes["data-options"]=JSON.stringify(e.extend(E,v)),void 0===this._stepValidated[this._currentStep-2]||t.isEmptyObject(v)||(this._stepValidated[this._currentStep-2].push(a.name+"_birth[month]"),this._stepValidated[this._currentStep-2].push(a.name+"_birth[day]"),this._stepValidated[this._currentStep-2].push(a.name+"_birth[year]"))}else{this._hasDate=!0,a.attributes.class=n.setupClassAttr(a.attributes.class,"datepicker");var v=this.getFormValidationData(a.name);e.each(v,function(t,e){delete v[e],v[e.toLowerCase()]=t}),v.maxdate&&(a.attributes["data-maxdate"]=v.maxdate),v.mindate&&(a.attributes["data-mindate"]=v.mindate),a.options&&a.options.datepickeroptions&&(this._DatePickerLogicArr[a.name]=a.options.datepickeroptions,a.attributes["data-has-datepicker-options"]=!0,a.options.datepickeroptions.comparison&&(a.attributes.class=n.setupClassAttr(a.attributes.class,"date-picker-not-allow-typing"))),a.options.render&&"read"!==this.options.mode&&(a.attributes["data-options-render"]=a.options.render.toLowerCase())}break;case"email":a.attributes.class=n.setupClassAttr(a.attributes.class,"tolowercase tolowercase_email span12"),void 0!==a.options.autocomplete&&a.options.autocomplete&&(this._hasEmailPicker=!0,a.attributes={},a.attributes["data-provide"]="typeahead",a.attributes.autocomplete="off",a.attributes.style="width:45%;",a.attributes.class="not_sending emailpicker_server tolowercase tolowercase_email",a.attributes["data-source"]=u.replace(/\n/g,"").replace(/'/g,"&#39"),void 0!==a.options.default&&(a.attributes["data-value"]=a.options.default),r.push(a.name+"_username"),r.push(a.name+"_server"));break;case"address":if(delete a.attributes.class,delete a.attributes.placeholder,r=[],r.push(a.name+"_address_street"),r.push(a.name+"_address_city"),r.push(a.name+"_address_state"),r.push(a.name+"_address_zip"),r.push(a.name+"_address_country"),a.options.showstreetnumber&&r.push(a.name+"_address_street_number"),a.options.showunitnumber&&r.push(a.name+"_address_unit_number"),void 0!==o&&void 0!==this.options.formData){var N=this.options.formData.fields;N[a.name+"_address_country"]=N[a.name+"_address_country"]?s.getCountry(N[a.name+"_address_country"]):null,N[a.name+"_address_street"]&&"."!==N[a.name+"_address_street"].charAt(N[a.name+"_address_street"].length-1)&&(N[a.name+"_address_street"]+="."),N[a.name+"_address_street"]&&(N[a.name+"_address_street"]+="<br>"),N[a.name+"_address_city"]&&(N[a.name+"_address_city"]+=","),N[a.name+"_address_state"]&&(N[a.name+"_address_state"]+="<br>"),N[a.name+"_address_zip"]&&(N[a.name+"_address_zip"]+="<br>")}else if("update"===this.options.mode&&"US"!==this.options.formData.fields[a.name+"_address_country"]){var N=this.options.formData.fields;a.default_value_state=N[a.name+"_address_state"]}else"create"===this.options.mode&&(this.model.set(a.name+"_address_state","NV"),this.model.set(a.name+"_address_country","US"));if(a.options.zipcodeformat){switch(a.options.zipcodeformat.toLowerCase()){case"zip+4":a._zipmax=10}}break;case"number":var T;if(!a.options.numbertype||a.options.decimals)T=a.options.decimals?"number":"natural",a.options.decimals&&(a.attributes["data-decimal"]=a.options.decimals);else if(a.options.numbertype&&!a.options.limitinputvalue)switch(a.options.numbertype.toLowerCase()){case"currency":T="number";break;case"double":T="rational";break;default:T="natural"}else T="natural";if(a.options.limitinputvalue&&(T=a.options.limitinputvalue),!T||"string"!=typeof T)throw new Error('Could not be able to find matching class name for "'+a.name+'" for a number input type.');if(a.attributes.class=n.setupClassAttr(a.attributes.class,T+" span12"),a.options.decimals&&this.options.formData.fields&&this.options.formData.fields[a.name]){var I=parseFloat(this.options.formData.fields[a.name]/Math.pow(10,parseInt(a.options.decimals,10)));isNaN(I)||(this.options.formData.fields[a.name]=I.toFixed(a.options.decimals),a.attributes.value=this.options.formData.fields[a.name],this.model.has(a.name)&&this.model.set(a.name,this.options.formData.fields[a.name]))}void 0!==a.options.spinner&&a.options.spinner&&(a.attributes.class=a.attributes.class.replace(/ span12/,"","gi"),a.attributes.class=n.setupClassAttr(a.attributes.class,"spinner-input"),"update"===this.options.mode&&this.options.formData.fields[a.name]&&(a.attributes["data-value"]=this.options.formData.fields[a.name]));break;case"fullname":if(delete a.attributes.class,delete a.attributes.placeholder,r=[],r.push(a.name+"_fullname_first_name"),(void 0===a.options.middlename||a.options.middlename)&&r.push(a.name+"_fullname_middle_name"),r.push(a.name+"_fullname_last_name"),a.options.url&&this._ajaxDataCall.push(a),"read"===this.options.mode&&a.options&&a.options.highlight){var A=a.options.highlight.toLowerCase().split(",");e.each(A,function(t){var e=a.name+"_fullname_"+t;i.options.formData.fields[e]&&(i.options.formData.fields[e]="<u>"+i.options.formData.fields[e]+"</u>")})}break;case"clear":d="button",a.attributes.class=n.setupClassAttr(a.attributes.class,"btn btn-clear-form");break;case"submit":a.attributes.class=n.setupClassAttr(a.attributes.class,"btn"),d="button",a._submit=!0,void 0===a.url&&(a.url=""),a.options.appendid&&this.options.formData._id&&this.options.formData._id.$oid&&(a.url=(a.url?a.url:"")+(a.url.indexOf("?")>-1?"&id=":"/")+this.options.formData._id.$oid),t(this.el).attr("action",a.url),void 0!==a.options.ajaxsubmit&&(this._ajaxSubmit=a.options.ajaxsubmit);break;case"buttonclipboard":a.attributes.class=n.setupClassAttr(a.attributes.class,"btn btn-primary"),this._buttonClipboards.push({name:a.name,values:a.values});break;case"buttondecision":o||(a.attributes.class=n.setupClassAttr(a.attributes.class,"btn btn-primary"),d="button",this._buttonDecision.push(a));break;case"button":if(!n.shouldRenderShowOnUser(a))return"";if(a.attributes.class=n.setupClassAttr(a.attributes.class,"btn"),this.options&&this.options.formData&&this.options.formData._id&&this.options.formData._id.$oid&&(a.options.appendid?a.url=(a.url?a.url:"")+(a.url.indexOf("?")>-1?"&id=":"/")+this.options.formData._id.$oid:a.url&&a.url.search(/{\w+}/gi)>-1&&(a.url=n.formatUriSegment(a.url,this.options.formData))),a.url&&(a.url=n.changeURLGetTemplateString(a.url,this.options.formData)),this.options.internal&&"read"===this.options.mode&&"BtnMarkAsUnacceptable"===a.name&&t.fn.remodal){var j=e.find(this.options.formSchema.fields,function(t){if(t&&t.name&&t.type)return"UnacceptableReason"===t.name?t:void 0});if(j){var B=this.options.formData&&this.options.formData.fields&&this.options.formData.fields.UnacceptableReason?this.options.formData.fields.UnacceptableReason:null;B&&B.replace&&(B=B.replace(/'/gi,"\\'"));var M=(new Date).getTime();switch(a.options["data-remodal-target"]="btnmarkasunacceptable_"+M,a.options["data-remodal-current-value"]=B,a.options["data-current-form-id"]=this.options.formData._id.$oid,a.options["data-url-mark-as-unacceptable"]=a.url,j.type.toLowerCase()){case"radio":if(!j.values)throw new Error("Expected a values key!");a._customHtml=e.reduce(j.values,function(t,a,o,i){var s="UnacceptableReason_"+o,n=e.isArray(i)?a:o,l=B&&B===n?'checked="true"':"";return n&&n.replace&&(n=n.replace(/"/gi,"&quot;")),t+'<label class="radio"><input '+l+' name="UnacceptableReason" id="'+s+'" value="'+n+'" type="radio">'+a+"</label>"},"");break;case"textarea":a._customHtml='<textarea autocomplete="off" name="UnacceptableReason" id="UnacceptableReason"></textarea>';break;default:throw new Error("Not implement "+j.type+" yet!")}a.options.confirmed=null}}if(a.options.confirmed){var U=a.options.confirmedtext?a.options.confirmedtext:"Please confirm your selection.",$={html:!0,placement:"top",title:'<span class="text-info">'+U+"</span>",content:'<a class="btn btn-success btn-confirmed" data-href="'+a.url+'">Yes</button><a class="btn btn-danger btn-confirmed">No</button>'};a.attributes["data-popover-confirm"]=JSON.stringify($)}else if(a.options.subbuttons)a.name||(a.name="subbuttons_"+a.description.replace(/ /g,"").toLowerCase(),a.attributes.id||(a.attributes.id=a.name)),require(["views/subform-layouts/subbuttons"],function(e){var o=a.attributes.id?a.attributes.id:a.name;s.create(this,o,e,{subbuttons:a.options.subbuttons,internal:!!i.options.internal&&i.options.internal,mode:i.options.mode,status:i.options.formData&&i.options.formData.status?i.options.formData.status:null,_id:o,button:t(".form-render #"+o),_oid:i.options.formData&&i.options.formData._id&&i.options.formData._id.$oid?i.options.formData._id.$oid:null})});else if(a.options.subform){if("read"!==this.options.mode)return"";if(!a.name)throw"Expected a valid Name for SubForm Button.";var R=this.options.formData&&this.options.formData._id&&this.options.formData._id.$oid?this.options.formData._id.$oid:null;if(!R)throw"Expected a valid ID for SubForm Button.";var J=a.options.subform;if(!J.url||"string"!=typeof J.url)throw"Please pass in URL key as a string in SubForm options.";if(!J.fields||!e.isArray(J.fields))throw"Please pass in URL key as an array in SubForm options.";var z="",P=a.options.subform.validation;e.each(J.fields,function(t){z+=rt(t,i.inputTemplate)}),z='<div class="subform-button-wrapper">'+z+'<div class="text-center"><a class="btn btn-primary subform-btn-submit" data-button-name="'+a.name+'">Submit</a></div></div>',t("div#app").on(this.options.formSchema.name+".renderCompleted",function(o,i){var s=t(this).find("button#"+a.name);if(1!==s.length)throw"Invalid SubForm Button, please make sure that the name is unique.";s.popover({html:!0,placement:"top",trigger:"manual",title:'<span class="text-info">Please complete this form.</span>',content:z}),s.on("click",function(t){if(s.hasClass("submitted"))return!1;s.hasClass("shown")?s.removeClass("shown").popover("hide"):s.addClass("shown").popover("show")}),s.parent().on("click",".subform-btn-submit",function(o){o.preventDefault(),o.stopPropagation();var i=t(o.target).attr("data-button-name");if(i!==s.attr("data-button-name")&&s.next(".popover").find(".subform-btn-submit").attr("data-button-name")!==i)return!1;var n=s.next(".popover").find(".subform-button-wrapper"),l=n.find(":input"),r={},d=!1;if(l.each(function(){var e=t(this),a=e.attr("name"),o=e.val();if(!a||""===a)throw"expect valid input name!";P&&P[a]&&(P[a].required&&""===o?(e.addClass("invalid"),d=!0):e.removeClass("invalid")),r[a]=o}),!d){var m="subform-btn-"+(new Date).getTime().toString(),p="",u=e.extend({},J.get);e.each(r,function(t,e){var a=e.toLowerCase();u.hasOwnProperty(a)?(delete u[a],u[e]=t):p+='<input type="hidden" name="'+e+'" value="'+t+'"/>'}),"/"!==a.options.subform.url[a.options.subform.url.length-1]&&(a.options.subform.url+="/");var c=a.options.subform.url+R;u&&(c+="?"+t.param(u)),t("body").append('<form id="'+m+'" action="'+c+'" method="POST">'+p+"</form>"),s.removeClass("shown").popover("destroy"),s.popover({html:!0,placement:"top",trigger:"manual",title:'<span class="text-info">Sending Information</span>',content:'<div class="text-center subform-button-wrapper"><i class="icon-spinner icon-spin icon-large"></i> Sending</div>'}).addClass("submitted").popover("show"),s.closest(".form-actions").find(":button").attr("disabled",!0),window.setTimeout(function(){t("body").find("#"+m).submit()},1e3)}return!1})})}break;case"schooles":case"schoolclarkcounty":var q=d;d="text",a.attributes.class=n.setupClassAttr(a.attributes.class,"span12"),a.attributes["data-provide"]="typeahead",a.attributes.autocomplete="off";var H;switch(q){case"schooles":H=c;break;case"schoolclarkcounty":H=f;break;default:throw new Error('Not mapped school data for "'+q+'" yet!')}a.attributes["data-source"]=H.replace(/\r\n/g,"").replace(/\n/g,"").replace(/'/g,"&#39").replace(/,/g,"&#44");break;case"step":if(!("view"in this.options.formSchema&&"wizard"===this.options.formSchema.view))return"";0!==this._stepDiv&&(l+="</div>",this._stepDiv--),void 0===this._stepValidated[this._currentStep-1]&&(this._stepValidated[this._currentStep-1]=[]);var Y="step-pane"+(1===this._currentStep?" active":"");l+='<div class="'+Y+'" id="wizard_step'+this._currentStep+'">',this._stepDiv++,this._currentStep++;break;case"useraccount":a.data_value="",a.options.getvaluefromid&&(a.data_value=t("#"+a.options.getvaluefromid).text());break;case"list":a.attributes.id=this.prefixedName.list+(void 0!==a.attributes.id?a.attributes.id:a.name),a.attributes.class=n.setupClassAttr(a.attributes.class,"subform-container");var G=void 0!==this.options.formSchema.validation[a.name]?this.options.formSchema.validation[a.name]:{};this.attachSubFormEvent(a.attributes.id,a,G),this._listSchema[a.name]=a;break;case"hidden":var K=["update","create"];e.indexOf(K,this.options.mode)>-1&&this.options.formData&&this.options.formData.fields&&this.options.formData.fields[a.name]&&(a.attributes||(a.attributes={}),a.attributes.value=this.options.formData.fields[a.name])}if("button"===d&&a.options.visibleon){var Q=function(e){
"change"===e.type&&a.options.visibleon.values.indexOf(t(this).val())>-1?t("#"+a.name,i.el).show("slow"):t("#"+a.name,i.el).hide("slow")};t(this.el).on("change",':input[name="'+a.options.visibleon.name+'"]',Q).on("removeVisibleOn",':input[name="'+a.options.visibleon.name+'"]',Q)}if(void 0!==this._stepValidated[this._currentStep-2]&&"step"!==d&&"list"!==d&&n.checkRequireFields(a,this.options.formSchema.validation)&&e.each(r,function(t){i._stepValidated[i._currentStep-2].push(t)}),void 0!==o&&o&&void 0!==r[0]&&"button"!==d&&"buttonclipboard"!==d){var W="",X="";if(e.each(r,function(t){var a=i.options.formData.fields[t];"object"!=typeof a?W+=(void 0!==a?a:"")+" ":e.isArray(a)||"object"==typeof a?W=a:void 0!==a&&null!==a&&(W+=a)}),"string"==typeof W&&(W=t.trim(W)),"file"===d||"image"===d){if("image"===d)"deleted"===i.options.formData.fields[a.name]?X=null:(a.attributes.src=(void 0!==a.attributes.src?a.attributes.src:"/form/getFile/")+i.options.formData.fields[a.name],X=a.attributes.src);else if(a.attributes.target="_blank",a.attributes.class=n.setupClassAttr(a.attributes.class,"btn btn-primary"),a.attributes.href=(void 0!==a.attributes.href?a.attributes.href:"/form/getFile/")+i.options.formData.fields[a.name],a.attributes.id||(a.attributes.id=a.name),a.options.markdownloaddatetimeof&&this.options.formData._id&&this.options.formData._id.$oid){var Z=a.options.markdownloaddatetimeof.toLowerCase();("*"===Z||this.options.internal&&"internal"===Z||!this.options.internal&&"external"===Z)&&(a.attributes.href+="?formid="+this.options.formData._id.$oid)}else a.options.appendid&&this.options.formData._id&&this.options.formData._id.$oid&&(a.attributes.href+="?formid="+this.options.formData._id.$oid);delete a.attributes.accept,e.each(a.attributes,function(t,e){t.search("'")&&(t=t.replace(/\'/gi,'"')),m+=" "+e+"='"+t+"'"}),l+=i.inputTemplate["uneditable"+d]({name:a.name,value:W,text:a.description,_attr:m,id:a.name,href:X,css_class:a.attributes.class?a.attributes.class:"",internal:a.options.internal?'data-internal="true"':"",mongo_id:this.options.formData&&this.options.formData._id&&this.options.formData._id.$oid?this.options.formData._id.$oid:null,data_webcam:"data-webcam-url"in a.attributes&&a.attributes["data-webcam-url"]?' data-webcam-url="'+a.attributes["data-webcam-url"]+'" ':null})}else if("list"===d)if(void 0!==this.options.formData.fields[a.name]&&(this.options.formData.fields[a.name].length>0||e.size(this.options.formData.fields[a.name])>0)){var tt=[],et=[],at=[],ot={},it=0,st=new Array(this.options.formData.fields[a.name].length||e.size(this.options.formData.fields[a.name]));e.each(a.fields,function(o,s){if(o.options=o.options||{},!(!1===o.options.showontable)){var l;o.options.tabletitle?(l=o.options.tabletitle,l='<a data-content="'+t("<p>"+o.description+"</p>").text()+'" data-original-title="'+l+'" data-placement="top" data-toggle="popover" data-trigger="hover" data-html="true">'+l+"</a>"):l=o.description,tt.push(l),o.options.sortby&&"date"===o.options.sortby.toLowerCase()?et.push('data-sort="int"'):et.push(o.options.sortby?'data-sort="'+o.options.sortby+'"':'data-sort="string"');var r=n.getModelValueForViewModel(i.options.formData,a.name);e.each(r,function(t,a){var i;if(e.isNumber(a)||(ot[o.name]?(it++,a=it):(it=0,ot[o.name]=!0,a=it)),void 0===st[a]&&(st[a]=[],at[a]=[]),o.options.sortby&&"date"===o.options.sortby.toLowerCase()){var s=Date.parseString(t[o.name],"M/d/yyyy h:mm:ss a");at[a].push('data-sort-value="'+s.getTime()+'"')}else at[a].push(null);switch(o.type.toLowerCase()){case"timestamp":var l;l=o.options&&o.options.tabletitle?o.options.tabletitle:"Timestamps",tt[tt.length-1]=l,st[a].push(n.getHumanTime(t[o.name]));break;case"useraccount":tt[tt.length-1]="User",st[a].push(t[o.name]);break;case"fullname":i=t[o.name+"_fullname_first_name"],void 0!==t[o.name+"_fullname_middle_name"]&&(i+=" "+t[o.name+"_fullname_middle_name"]),i+=" "+t[o.name+"_fullname_last_name"],st[a].push(i);break;case"booleaninput":st[a].push(t[o.name]?"Yes":"No");break;case"date":var r=t[o.name];if(r&&r.$date){if(r=moment(r.$date),!r.isValid())throw new Error('Invalid Date Value for "'+o.name+'" with "'+t[o.name]+'"');r=r.format("MM/DD/YYYY")}st[a].push(r);break;case"file":st[a].push({value:t[o.name],valueObj:JSON.parse(t[o.name]),valueBase64:n.Base64.encode(t[o.name]),renderAs:"downloadFromJS"});break;case"number":o.options&&o.options.decimals&&t[o.name]&&(t[o.name]=(t[o.name]/Math.pow(10,o.options.decimals)).toFixed(o.options.decimals));default:if(void 0===t[o.name])return void delete tt[tt.length-1];st[a].push(t[o.name])}})}});var nt="subform-table";n.isMobileDevice()&&(nt="subform-card"),l+=i.inputTemplate[nt]({labels:tt,values:st,mode:o,sortBy:et,sortByVal:at,heading:void 0===a.options.readmodedescription?a.description:a.options.readmodedescription})}else l+="";else if("telephone"===d&&a._providerValue)l+=i.inputTemplate.uneditabletel({value:W,label:a.description,id:a.name,providerValue:a._providerValue,css_class:a.attributes.class});else if("check"===d)l+=i.inputTemplate.uneditablecheck({value:W,label:a.description,id:a.name,otherValue:a._otherValue?a._otherValue:"",css_class:a.attributes.class});else if("select"===d&&a.options&&a.options.tags)e.isArray(W)&&W.sort(function(t,e){return t-e}),l+=i.inputTemplate.uneditabletag({value:W,id:a.name,css_class:a.attributes.class});else if("filerepository"===d)l+=i.inputTemplate["read-filerepository"](e.extend({data:this.options.formData.fields[a.name],formId:this.options.formData._id.$oid,Utils:n,css_class:a.attributes.class},a));else{var lt="";switch(d){case"textarea":case"address":lt=" uneditable-input-textarea";break;case"timestamp":W=n.getHumanTime(W);break;case"select":a._data&&(W=a._data);break;case"booleaninput":W="true"===W||!0===W?"Yes":"No"}var dt=["ParentFormId","FormRecordId"];if(a.name&&this.options.internal&&e.indexOf(dt,a.name)>-1){var pt=n.config.internalViewUrl,ut=[];i.options.formData.fields.MultipleFormRecordId?ut=i.options.formData.fields.MultipleFormRecordId.split(","):ut.push(W),e.each(ut,function(t){l+='<a class="btn btn-primary" title="View FormId = '+t+'" href="'+pt+"/"+t+'" style="margin-right:20px;">View</a>'})}else l+="html"===d?a.description:i.inputTemplate.uneditableinput({value:W,css_class:lt,id:a.name})}}else if("image"===d&&void 0!==a.options.internalcanupdate&&this.options.internal&&!1===a.options.internalcanupdate){var W="",X="";try{var ct=i.options.formData&&i.options.formData.fields&&i.options.formData.fields[a.name]}catch(t){throw console.log("Error: when trying to set hasFileFieldValue!"),t}ct&&e.each(r,function(t){"object"!=typeof i.options.formData.fields[t]?W+=(void 0!==i.options.formData.fields[t]?i.options.formData.fields[t]:"")+" ":W=i.options.formData.fields[t]}),"string"==typeof W&&(W=t.trim(W)),ct&&"deleted"===i.options.formData.fields[a.name]?X=null:ct&&(a.attributes.src=(void 0!==a.attributes.src?a.attributes.src:"/form/getFile/")+i.options.formData.fields[a.name],X=a.attributes.src),delete a.attributes.accept,e.each(a.attributes,function(t,e){t.search("'")&&(t=t.replace(/\'/gi,'"')),m+=" "+e+"='"+t+"'"}),l+=i.inputTemplate["uneditable"+d]({mongo_id:this.options.formData&&this.options.formData._id&&this.options.formData._id.$oid?this.options.formData._id.$oid:null,value:W,text:a.description,_attr:m,id:a.name,href:X,css_class:a.attributes.class,data_webcam:"data-webcam-url"in a.attributes&&a.attributes["data-webcam-url"]?' data-webcam-url="'+a.attributes["data-webcam-url"]+'" ':null})}else{if(this.options.internal&&void 0!==a.options.internalcanupdate&&!a.options.internalcanupdate?d="hidden":e.each(a.attributes,function(t,e){m+=" "+e+"='"+t+"'"}),"image"===d&&(d="file"),mt&&(console.log(""),console.log("[*] Render HTML Field"),console.log(a),console.log(m)),mt&&void 0===this.inputTemplate[d])throw'Template of "'+d+'" not found!';l+=void 0!==this.inputTemplate[d]?this.inputTemplate[d](e.extend({_attr:m,_lang:this.options.lang,_renderMode:this.options.mode,css_class:a.attributes.class},a)):""}if(a.options.visibleon){if(!a.options.visibleon.name||!t.isArray(a.options.visibleon.values))throw a.name+".Options.VisibleOn need Name and Values!";this._visibleOn.push(a)}return a&&a.type&&!this.inputTemplate[d]&&console&&console.warn&&console.warn('[x] Template for "'+a.type+'" does not existed.'),a.options.updateonreadmode&&(l='<div class="update-on-read-mode" data-field-name="'+a.name+'">'+l+this.generateMarkUpForUpdateOnReadMode(a)+"</div>"),l},renderLabel:function(a,o,i){o=o||!1,a.attributes=a.attributes||{},a.options=a.options||{};var s=a.type.toLowerCase(),n=void 0!==i&&i?i:"";switch(a.options.renderas&&(s=a.options.renderas.toLowerCase()),s){case"calculate":return"";case"hidden":if("create"===this.options.mode)return"";break;case"buttondecision":return""}a.name?a.name:Date.now();return n+=" label-for-"+a.name,n=t.trim(n),n&&n.match&&!n.match(/class.*=.*("|').+/gi)&&(n='class="'+n+'"'),this.inputTemplate.label(e.extend({_cssClass:n,_required:o},a))},renderButton:function(t){var e="";return(t.submitbutton||t.resetbutton)&&(e+='<div class="form-actions">'),t.submitbutton&&!t.subForm?e+='<button type="submit" class="btn btn-primary btn-submit">'+t.submitbutton+"</button>":e+='<button type="button" class="btn btn-primary btn-submit">'+t.submitbutton+"</button>",t.resetbutton&&(e+='<button type="button" class="btn btn-cancel">'+t.resetbutton+"</button>"),e.length>0&&(e+="</div>"),e},checkShowOnMode:function(a,o,i){var s=a.type.toLowerCase();if(void 0!=a.options.internal&&a.options.internal!==this.options.internal)return!1;if(!0===a.options.internal&&a.name&&"buttonclipboard"!==s){var n;switch(s){case"check":case"checkbox":n=a.name+"[]";break;default:n=a.name}this._internalFields.push(n)}if(this.options.hideButtons&&("button"===s||"submit"===s||"reset"===s||"action"===s))return!1;if("read"===this.options.mode&&!t.isEmptyObject(a.options.visibleon)&&void 0===this.options.formData.fields[a.name]&&"fullname"!==s&&"address"!==s&&"buttonclipboard"!==s&&"html"!==s)return!1;if(o=o||!1,i=i||!1,"read"!==o&&"buttonclipboard"===a.type.toLowerCase())return!1;if("read"===o&&!this.options.internal&&a.options.hideonexternalread)return!1;if(void 0!==a.options.showonmode&&-1===a.options.showonmode.indexOf(o))return!1;if(void 0!==a.options.showonstatus){var l=e.map(a.options.showonstatus,function(t){return t.toLowerCase()});if("create"!==this.options.mode&&(!1===i||-1===l.indexOf(i.toLowerCase())))return!1}else if(this.options.internal&&"update"===o&&void 0!==a.options.internalcanupdate&&!a.options.internalcanupdate&&"image"!==s)return!1;return!0},attachSubFormEvent:function(o,i,s){i=e.extend(i,{validation:s});var l=this,r={el:"#"+o+this.prefixedName.listdisplayid,formSchema:i,formId:o,options:this.options},d=e.extend({},a.Events),m=i.options||{},p=this.options.mode||"create",u=t(this.el);(u.on("click","#"+o+"_add_btn",r,this.displaySubForm).on(o+".close",this.closeSubForm).on(o+".add",e.extend({formId:o},this),this.addSubformData),(m.enabledaddevent||!1)&&"read"!==p&&u.on(o+".addDataToList",e.extend({formId:o},this),function(e,a,s){s=s||!1;var n="SubFormViewsubform_"+i.name,r=ut[n];if(!r)throw console.log("[x] Could not find ",n,"in subFormViewLUT!",ut),new Error('Could not find "'+n+'"');if(!s){var d=l.model&&l.model.has(i.name)?l.model.get(i.name):null;d&&d.reset&&d.reset()}t(l.el).trigger(o+".add",[r,a])}),"update"===this.options.mode&&void 0!==this.options.formData.fields[i.name]&&this.options.formData.fields[i.name].length>0)?d.on(r.formId+".listViewCreated",function(e){var a=n.getModelValueForViewModel(l.options.formData,i.name);t(l.el).trigger(o+".add",[e,a]),d.off()}):d.on(r.formId+".listViewCreated",function(e){var a=t("#"+r.formId,l.el),i=function(s,n){t(l.el).trigger(o+".add",[e,n,!0]),a.one(r.formId+".ajaxUpdate",i)};a.one(r.formId+".ajaxUpdate",i),d.off()});d.on(r.formId+".listViewCreated",function(t){e.isEmpty(l._listSchema)||e.each(l._listSchema,function(e,a){l.setupSubFormListenValueEvent(l,e,a,r,d,o,t)})}),this.displaySubForm({data:r},{},!0,d)},displaySubForm:function(a,o,i,s,n){if(n=n||!1,a.data){o=o||{},i=i||!1,s=s||!1;var l,r=e.clone(a.data);t.isEmptyObject(o)?l="SubFormView"+a.data.formId:(r.model=o,l="SubFormViewEdit"+a.data.formId);var d=this;t(this).parents("div.actions").fadeOut(),dt(a,d,l,r,s,n,i)}},setupSubFormListenValueEvent:function(o,i,s,n,l,r,d){if(i.options&&i.options.copyvaluesfrom){var m=i.options.copyvaluesfrom;if(m&&m.length){mt&&(console.log("- Set Up setupSubFormListenValueEvent"),console.log(i),console.log(m));var p=t("div#app");e.each(m,function(i,n){mt&&console.log(" - ",arguments),e.each(i,function(e,i){var l=':input[name="'+e+'"]';mt&&console.log("- attached event _name:",l," listKey:",i),p.on("change",l,function(e){var m=t(e.target),p=m.val();if(p&&(p=t.trim(p)),mt&&(console.log("[baseField] setupSubFormListenValueEvent on change"),console.log("- on change fired! "+l)),o.model.has(s)){var u=o.model.get(s);mt&&console.log("  - currentListModel.length:",u.length);var c,f=a.Model.extend({});if(u.length){if(!(c=u.at(n)))throw new Error("Please look at List CopyValuesFrom logic!");if(c.get(i)===p)return;c.set(i,p)}else c=new f,c.set(i,p),u.push(c);mt&&(console.log("  - currentListModel.length:",u.length),console.log("  - Fired: add event!")),t(o.el).trigger(r+".add",[d,u.toJSON(),!0])}})})})}}},closeSubForm:function(e,a){mt&&console.log("[baseField] closeSubForm <-------"),a.$el.fadeOut(),t.mask.close(),t(".actions",a.$el.parent(".subform-container")).fadeIn("slow"),s.remove("SubFormView"+a.options.formId,!0),s.remove("SubFormViewEdit"+a.options.formId,!0)},addSubformData:function(o,i,l,r){r=r||!1,l=l||!1;var d=i.options.formSchema.view?i.options.formSchema.view:"table",m=i.options.formSchema.name,p=o.data.model.get(m);if("object"!=typeof p&&o.data.model._listFieldType[m]&&(o.data.model.set(m,o.data.model._listFieldType[m]),p=o.data.model.get(m)),r&&p.reset(),l){var u=a.Model.extend({});e.each(l,function(t){var e=new u;e.set(t),p.add(e)})}else p.add(i.model);var c=i.options.formSchema.options||{};if(c.copyvaluesfrom&&!l){var f=i.model.cid;if(e.isArray(c.copyvaluesfrom)){for(var h,b,v=0;v<p.length;v++){var _=p.at(v);if(_.cid===f){h=v,b=_;break}}if(void 0!==h&&"null"!=typeof h&&c.copyvaluesfrom[h]&&!e.isEmpty(c.copyvaluesfrom[h])){var g=t("#"+i.options.options.formSchema.name);e.each(c.copyvaluesfrom[h],function(e,a){var o,i=g.find(':input[name="'+e+'"]'),s=b.get(a);i.length>1?t(i).each(function(e){var a=t(this);if(a.val()===s){if(!a.is(":radio"))throw new Error("Not implement Radio in List - CopyValuesFrom yet!");a.attr("checked",!0)}else if(!a.is(":radio"))throw new Error("Not implement Radio in List - CopyValuesFrom yet!")}):(o=i.val(),s!==o&&i.val(s).trigger("change"))})}}}require(["views/subform-layouts/"+d],function(e){var a={el:"#"+i.options.formId+o.data.prefixedName.collectiondisplayid,formSchema:i.options.formSchema,collection:p,options:i.options.options},l=s.create(this,"CollectionView"+o.data.formId,e,a);if(l.render(),o.data.closeSubForm(o,i),i.options.formSchema.options&&i.options.formSchema.options.permission){var r=n.getUserIdFormHtml().replace("\\","\\\\"),d=new RegExp(r,"ig");switch(i.options.formSchema.options.permission.toLowerCase()){case"readwriteselfcreated":l.$el.find("table tr").each(function(){var e=t(this),a=!1;e.find("td").each(function(){t(this).text().match(d)&&(a=!0)}),a||e.find("td.subform-actions button.btn").remove()});break;default:throw i.options.formSchema.options.permission+" not implement yet!"}}})},setupVisibleOn:function(a,o,i,s,l){l=l||{},i=i||!1;var r=this,d=a.type.toLowerCase();if(!a.name)throw"In order to use VisibleOn option, we need to pass in the Name";switch(i||(a.options.visibleon.parentcontainer?i=a.options.visibleon.parentcontainer:"booleaninput"===d?i=".form-render_booleaninput_wrapper":a.options.visibleon&&a.options.visibleon.name&&e.indexOf(this._radioFieldName,a.options.visibleon.name)>-1&&(i=".radio-container")),i&&a.options&&a.options.visibleon&&a.options.visibleon.parentcontainer&&a.options.visibleon.parentcontainer!==i&&(i=a.options.visibleon.parentcontainer),d){case"fullname":delete this.model.validation[a.name+"_fullname_first_name"],delete this.model.validation[a.name+"_fullname_last_name"];break;case"address":delete this.model.validation[a.name+"_address_street"],delete this.model.validation[a.name+"_address_city"],delete this.model.validation[a.name+"_address_state"],delete this.model.validation[a.name+"_address_zip"],delete this.model.validation[a.name+"_address_country"],delete this.model.validation[a.name+"_address_street_number"],delete this.model.validation[a.name+"_address_unit_number"];break;case"multifiles":delete this.model.validation[a.name+"[]"];break;default:delete this.model.validation[a.name]}var m=a.options.visibleon.name,p=this.options.mode&&"read"===this.options.mode?'span[id="':':input[name="',u=s&&s[m]&&"checkbox"===s[m]?p+m+'[]"]':p+m+'"]',c=u+a.name+r.cid,f=t(this.el);this._isListFieldType&&this._hasVisibleOn&&(c in this._visibleOnEvents?(this._visibleOnEvents[c].off("change."+c,u),delete this._visibleOnEvents[c]):this._visibleOnEvents[c]=f);var h=this._isListFieldType&&this._hasVisibleOn?"."+c:"";if(f.on("change"+h,u,function(s){var l=!1,m=[],p=a.options.visibleon.name;m&&e.indexOf(m,p)>=0&&(l=!0);l&&console.log("*** Input ["+p+"] changed ***");var u,c,f=t(s.currentTarget),h=i?f.parents(i):f,b=[],v=f.val(),_=["","[]"];h.length||i!==a.options.visibleon.parentcontainer||(h=f.parents(".form-render").find(i));var g=f.attr("name");g||(l&&(console.log('[x] No attribute by "Name", get by "ID"'),console.log("- _visibleVal:",v,typeof v)),g=f.attr("id"),v||(l&&console.log("[x] There is no value to get, try get as html"),(v=f.text())||(v=f.html()))),l&&console.log("- _currentInputName:",g);var y=g.match(/\w+\[\]$/gi),w=a.options.visibleon.values===v;if(e.isArray(a.options.visibleon.values)&&(w=e.find(a.options.visibleon.values,function(t){return l&&console.log("- value:",t,", _visibleVal:",v,", result = ",t===v),t===v})),y&&y.length&&(y=!0),l&&(console.log(""),console.log("- _visibleOnName:",p),console.log("- $currentTarget:",f),console.log("- _currentInputName:",g),console.log("- _hasBracket:",y),console.log("- _visibleVal:",v),console.log("- field.options.visibleon.values:",a.options.visibleon.values),console.log("- _visibleValInArray:",w),console.log("")),y){var D=f.is(":checked");f.closest(".checkbox-container").find(":checkbox:checked").each(function(o){var i=t(this).val();if(l&&console.log("- _checkedVal:",i),!D&&v===i)return v=null,void(l&&console.log("- Set _visibleVal to :",v));v!==i&&e.indexOf(a.options.visibleon.values,i)>-1&&(v=i)}),D||v!==f.val()||(v=null),l&&console.log("- _visibleVal:",v)}else p.match(/\[\]$/gi)?(h.length||(h=f.closest(".checkbox-container")),p=p.substr(0,p.length-2),h=h.closest(".checkbox-container"),l&&console.log("- this is checkbox?",f.is(":checkbox")),f.is(":checkbox")&&(v="",h.find(":checkbox:checked").each(function(){var o=t(this).val();e.indexOf(a.options.visibleon.values,o)>-1&&(v=o)}))):f.is(":radio")&&!i&&(h=f.closest(".radio-container"));l&&(console.log("- $container:",h),console.log("- field.options.visibleon:",a.options.visibleon),console.log("- _visibleVal:",v));var x=!0;if(a&&a.options&&a.options.visibleon)if(a.options.visibleon.steps){if(!e.isArray(a.options.visibleon.steps)||!a.options.visibleon.steps.length)throw new Error(a.name+" must not contain an empty VisibleOn.Steps");for(var k=a.options.visibleon.steps,S=0;S<k.length;S++){var V=k[S],C=V.values;if(!C||!e.isArray(C)){var F="undefined"!=typeof JSON&&JSON&&JSON.stringify?JSON.stringify(V):null;throw new Error('Expects an array for "Values" in "'+F+'"')}var O=t(':input[name="'+V.name+'"]'),L=t.trim(O.val()),E=e.indexOf(C,L),N=V.notin?E<0:E>-1;if(!N){x=!1;break}}}else if(a.options.visibleon.notin&&a.options.visibleon.values){var O=t(':input[name="'+a.options.visibleon.name+'"]'),L=t.trim(O.val()),E=e.indexOf(a.options.visibleon.values,L),N=a.options.visibleon.notin?E<0:E>-1;N||(x=!1)}if(l&&(console.log("- field.options.visibleon.values:",a.options.visibleon.values),console.log("- _visibleVal:",v),console.log("- isValidSteps:",x)),!a.options.visibleon.notin&&e.indexOf(a.options.visibleon.values,v)>-1&&x||a.options.visibleon.notin&&x){if(l&&(console.log("[x] Match Value with VisibleOn, will render ["+a.name+"]."),console.log(f),console.log("- htmlTmpl"),console.log(o),console.log("- length:",t(".options-visible-on-"+a.name,r.el).length)),t(".options-visible-on-"+a.name,r.el).length<1){if(l&&console.log("- $container:",h),h.after(o),l&&console.log(h),u=h.next(".options-visible-on-"+a.name).fadeIn("slow",function(){var o=t(this).addClass("visible-parent-"+p).attr("data-parent",p);n.setupSelect2(o);var i=t(".options-visible-on-"+p,r.el);if(t('[class*="visible-parent-'+p+'"]',r.el).not(".visible-parent-"+p+",.options-visible-on-"+p+",.visible-parent-"+i.attr("data-parent")).remove(),"multifiles"===d?t("#"+a.name+"_multifiles_wrapper",this).trigger("visibleOnRenderComplete"):t(':input[name="'+a.name+'"]',this).trigger("visibleOnRenderComplete"),!r.model.bindings[a.name]&&e.indexOf(r.model.notBinding,a.name)<0){var s=a.name;e.each(_,function(e){s===a.name&&t(':input[name="'+s+e+'"]').length&&(s=a.name+e)});t(':input[name="'+s+'"]').length&&"checkbox"!==d&&(r.model.bindModelBinder(s,a.type),r._modelBinder.bind(r.model,r.el,r.model.bindings))}}),c=h.next("div"),0===c.length&&(c=h.parent()),c.find(":input").not('input[type="hidden"]').placeholder(),l&&(console.log("***** "+a.name+" *****"),console.log("- _typeLowerCase:",d),console.log("- that.model.validation:",r.model.validation)),"fullname"===d){var T=a.name+"_fullname_first_name";r.options.formSchema.validation[T]&&(r.model.validation[T]=r.options.formSchema.validation[T]),b.push(T),T=a.name+"_fullname_last_name",r.options.formSchema.validation[T]&&(r.model.validation[T]=r.options.formSchema.validation[T]),b.push(T)}else if("address"===d){var I=a.name+"_address_street";r.options.formSchema.validation[I]&&(r.model.validation[I]=r.options.formSchema.validation[I]),b.push(I),I=a.name+"_address_city",r.options.formSchema.validation[I]&&(r.model.validation[I]=r.options.formSchema.validation[I]),b.push(I),I=a.name+"_address_state",r.options.formSchema.validation[I]&&(r.model.validation[I]=r.options.formSchema.validation[I]),b.push(I),I=a.name+"_address_zip",r.options.formSchema.validation[I]&&(r.model.validation[I]=r.options.formSchema.validation[I]),b.push(I),I=a.name+"_address_country",r.options.formSchema.validation[I]&&(r.model.validation[I]=r.options.formSchema.validation[I]),b.push(I),I=a.name+"_address_street_number",r.options.formSchema.validation[I]&&(r.model.validation[I]=r.options.formSchema.validation[I]),b.push(I),I=a.name+"_address_unit_number",r.options.formSchema.validation[I]&&(r.model.validation[I]=r.options.formSchema.validation[I]),b.push(I),a.options.hidecountry&&r.model.set(I,"US")}else r.options.formSchema.validation[a.name]&&"html"!==d?(r.model.validation[a.name]=r.options.formSchema.validation[a.name],b.push(a.name)):r.options.formSchema.validation[a.name+"[]"]&&(r.model.validation[a.name+"[]"]=r.options.formSchema.validation[a.name+"[]"],b.push(a.name+"[]"));if(l&&(console.log("that.model.validation:",r.model.validation),console.log("that.options.mode:",r.options.mode)),"update"===r.options.mode&&b.length>0)e.each(b,function(e){if(r.options.formData.fields[e]){r.model.set(e,r.options.formData.fields[e]);var a=t(':input[name="'+e+'"]',u);switch(d){case"radio":case"check":case"checkbox":a.filter('[value="'+r.options.formData.fields[e]+'"]').prop("checked",!0);break;default:a.is(":radio")||a.is(":checkbox")||a.val(r.options.formData.fields[e])}}});else if("update"===r.options.mode)switch(d){case"fullname":e.each(["_fullname_first_name","_fullname_middle_name","_fullname_last_name"],function(e){var o=a.name+e,i=t(':input[name="'+o+'"]',u);i.length&&r.options.formData.fields[o]&&i.val(r.options.formData.fields[o])});break;default:if(r.options.formData.fields[a.name]){var A=t(':input[name="'+a.name+'"]',u);A.is(":radio")||A.is(":checkbox")||(A.val(r.options.formData.fields[a.name]),r.model.set(a.name,r.options.formData.fields[a.name]))}}if("userid"===d&&(n.setupUserIdAjaxCall(t("form.form-render")),r.model.validation[a.name].pattern||a.options.render&&"select"===a.options.render.toLowerCase()||(r.model.validation[a.name].pattern="email")),n.setupUrlAjaxCall(t("form.form-render"),t("#"+a.name)),r._hasDate&&(l&&(console.log("[*] baseField.setupVisibleOn - _hasDate"),console.log(r.el),console.log(r.$el)),n.setupDateInput(r.el,r,l)),r._hasTime&&(l&&(console.log("[*] baseField.setupVisibleOn - _hasTime"),console.log(r.el),console.log(r.$el)),n.setupTimeInput(r.el,r)),r._hasBDate&&a&&a.type&&a.options&&a.options.render&&"date"===a.type.toLowerCase()){var j=a.options.render;try{j=j.toLowerCase();var B=".options-visible-on-"+a.name;switch("string"==typeof r.el&&(B=r.el+" "+B),j){case"select":n.setupBDateInput(B,r.model)}}catch(t){console&&console.error&&console.error(t)}}r._isListFieldType&&r._hasVisibleOn}}else{var M=t("#"+a.name,r.el);if(M&&M.length&&M.val()&&M.val("").trigger("change"),M.trigger("removeVisibleOn"),t(".options-visible-on-"+a.name,r.el).remove(),t(".visible-parent-"+a.name,r.el).remove(),"date"===d&&a.options&&a.options.render){var U=a.options.render;try{switch(U=U.toLowerCase()){case"select":var $=a.name+"_birth";void 0!==e&&e?(e.map(["day","month","year"],function(t){var e=$+"["+t+"]";r.model.validation[e]&&delete r.model.validation[e]}),r.model.validation[a.name]&&delete r.model.validation[a.name]):console&&console.error&&console.error('Could not be able to locate "_".');break;default:throw new Error('Not implement delete for "'+U+'"')}}catch(t){console&&console.error&&console.error(t)}}else if("fullname"===d)e.map(["_fullname_first_name","_fullname_last_name"],function(t){var e=a.name+t;r.model.validation[e]&&delete r.model.validation[e]});else if("address"===d){var I=a.name+"_address_street";r.model.set(I,""),r.options.formSchema.validation[I]&&(r.model.validation[I]=r.options.formSchema.validation[I],delete r.model.validation[I]),I=a.name+"_address_city",r.model.set(I,""),r.options.formSchema.validation[I]&&(r.model.validation[I]=r.options.formSchema.validation[I],delete r.model.validation[I]),I=a.name+"_address_state",r.model.set(I,""),r.options.formSchema.validation[I]&&(r.model.validation[I]=r.options.formSchema.validation[I],delete r.model.validation[I]),I=a.name+"_address_zip",r.model.set(I,""),r.options.formSchema.validation[I]&&(r.model.validation[I]=r.options.formSchema.validation[I],delete r.model.validation[I]),I=a.name+"_address_country",r.model.set(I,""),r.options.formSchema.validation[I]&&(r.model.validation[I]=r.options.formSchema.validation[I],delete r.model.validation[I]),I=a.name+"_address_street_number",r.model.set(I,""),r.options.formSchema.validation[I]&&(r.model.validation[I]=r.options.formSchema.validation[I],delete r.model.validation[I]),I=a.name+"_address_unit_number",r.model.set(I,""),r.options.formSchema.validation[I]&&(r.model.validation[I]=r.options.formSchema.validation[I],delete r.model.validation[I])}else if("html"!==d){r.model.set(a.name,""),r.model.validation[a.name]?delete r.model.validation[a.name]:r.model.validation[a.name+"[]"]&&delete r.model.validation[a.name+"[]"];var R=a.name;e.each(_,function(t){if(r.model.bindings[R+t]){r.model.unbindModelBinder(R+t,a.type);for(var o=!0;o;)try{r._modelBinder.bind(r.model,r.el,r.model.bindings),o=!1}catch(t){o=!1;var i=t.match(/name="(\w+)"/i);if(i||console&&console.error&&console.error(t),2===i.length){var s=i[1];e.each(_,function(t){r.model.bindings[s+t]&&(r.model.unbindModelBinder(s+t,a.type),r.model.validation[s+t]&&delete r.model.validation[s+t],o=!0)})}}if(!f.is(":checkbox")){var n=f.attr("name");f.is(":radio")||f.val(v),r.model.get(n)!==v&&r.model.set(n,v)}}}),f.is(":radio")&&f.prop("checked",!0)}r._isListFieldType&&r._hasVisibleOn}}),this&&this.options&&this.options.mode){var b=t("#"+this.options.formSchema.name),v=null;switch(this.options.mode){case"update":v=function(){a&&a.options&&a.options.visibleon&&e.forEach(a.options.visibleon.values,function(e){t(u).filter(":checkbox:checked").each(function(){var a=t(this),o=a.val();e===o&&a.trigger("change")})})};break;case"read":v=function(){var e=t(u);e.trigger("change")}}v&&"function"==typeof v&&b.on(this.options.formSchema.name+".renderCompleted",v)}},setupCopyValuesFrom:function(a){if("list"!==a.type.toLowerCase()){if(!a.options.copyvaluesfrom.name||!a.options.copyvaluesfrom.description)throw"In order to use CopyValuesFrom options, need to have Name and Description";var o=this,i="";return i+='<div class="copy-values-from '+a.options.copyvaluesfrom.name+'">'+this.inputTemplate.buttongroup({description:a.options.copyvaluesfrom.description})+"</div>",t(this.el).on("click",".copy-values-from."+a.options.copyvaluesfrom.name+" .btn-group button",function(i){var s,l,r=t(i.currentTarget),d=[];r.hasClass("btn-yes")&&(s=n.getSpecialFieldsName(a.options.copyvaluesfrom.name,a.type),e.each(s,function(e){d.push(t(':input[name="'+e+'"]',o.el).val())}),l=n.getSpecialFieldsName(a.name,a.type),n.setFieldsValues(o.el,o.model,l,d))}),i}},sortOrderBy:function(t){var e,a=t.options.orderby;(a||t.values)&&(a=a.toLowerCase(),e=function(t,e){return t.localeCompare(e)},t.values.sort&&t.values.sort(e))},addDataToElementData:function(t,e,a){this._elementData[t]||(this._elementData[t]={}),this._elementData[t][e]=a},generateMarkUpForUpdateOnReadMode:function(t){if(!t.type)return console&&console.warn&&console.warn('[x] generateMarkUpForUpdateOnReadMode for "'+t.name+'" could not be able to find "Type".'),"";var a,o,i=t.type.trim().toLowerCase(),s=this.options.formData.fields[t.name];switch(i){case"file":throw"Not yet support!";default:o="text"}switch(i){case"radio":a=pt["default-input-radio"](e.extend({data:s},t));break;case"textarea":a=pt["default-input-textarea"](e.extend({data:s},t));break;case"date":a=pt["default-input-date"](e.extend({data:s},t));break;default:a=pt["default-input"](e.extend({inputType:o,data:s},t))}return a}})});