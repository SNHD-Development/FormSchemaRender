define(["jquery","lodash","backbone","models/model","modelbinder","validation","vm","utils","events","text!templates/subform-layouts/default.html","jquery.expose","bootstrap"],function(e,o,t,i,n,l,s,a,r,d){function c(e){o.each(e.options.formSchema.fields,function(o){if(o.name&&o.type){var t=o.type.toLowerCase(),i=e.model.get(o.name);switch(t){case"number":i=parseFloat(i),isNaN(i)||(o.options&&o.options.decimals&&(i*=Math.pow(10,o.options.decimals)),e.model.set(o.name,i))}}})}function m(e){p&&(console.log("[*] list.reFormatModel - start"),e.model&&e.model.toJSON&&console.log(e.model.toJSON())),o.each(e.options.formSchema.fields,function(o){if(o.name&&o.type){var t=o.type.toLowerCase(),i=e.model.get(o.name);switch(t){case"number":i=parseFloat(i),isNaN(i)||(o.options&&o.options.decimals&&(i/=Math.pow(10,o.options.decimals)),e.model.set(o.name,i))}}}),p&&(console.log("[*] list.reFormatModel - end"),e.model&&e.model.toJSON&&console.log(e.model.toJSON()))}var p=!1;return t.View.extend({_modelBinder:void 0,clean:function(){t.Validation.unbind(this),void 0!==this._modelBinder&&this._modelBinder.unbind(),a.destroyPopover(this.$el)},removeContent:function(){this.$el.html("").removeAttr("class").fadeIn()},initialize:function(e){e=e||{},this._modelBinder=new n;var t;this.options||(this.options={}),this.options._id=e.formId,this.options.options||(this.options.options={});var l=this.options.options.lang;if(void 0===this.options.model)switch(p&&console.log("[*] list.initialize: Insert"),this.model=new i(o.extend(this.options.formSchema,{is_internal:this.options.internal,render_mode:this.options.mode})),l){case"sp":this._btn_title="Agregar";break;default:this._btn_title="Add"}else switch(p&&(console.log("[*] list.initialize: Edit"),console.log(this.options.model.toJSON()),console.log(this.model)),l){case"sp":this._btn_title="Hecho";break;default:this._btn_title="Done"}this.options.formSchema.view=this.options.formSchema.view||"",this.options.formSchema.view.toLowerCase(),t=d,this.template=o.template(t),this._isListFieldType=!0},render:function(i,n){var l=this,r="";this.options||(this.options={}),this.options.options||(this.options.options={}),require(["views/baseField"],function(d){var c,h=l.options._id,u="",f=s.create(l,"BaseField",d,{formSchema:l.options.formSchema,lang:l.options.options.lang}),g=l.options;p&&(console.log("[*] list.render"),console.log(l.options),l.model&&l.model.toJSON&&console.log(l.model.toJSON()),l.options&&l.options.model&&l.options.model.toJSON&&console.log(l.options.model.toJSON())),o.each(l.options.formSchema.fields,function(e,t,i){var n=l.model.get(e.name);if(!(e&&e.type&&"file"===e.type.toLowerCase()&&n)){if(!d.prototype.checkShowOnMode.call(l,e,g.options.mode,g.options.formData.status)){l.model.bindings&&l.model.bindings[e.name]&&delete l.model.bindings[e.name];var s=e.name+"[]";return l.model.bindings&&l.model.bindings[s]&&delete l.model.bindings[s],""}if(void 0!==e.description&&-1===o.indexOf(f.notRenderLabel,e.type.toLowerCase())&&(c=a.checkRequireFields(e,l.options.formSchema.validation),u+=f.renderLabel(e,c)),"email"===e.type.toLowerCase()&&e.options.autocomplete&&""!==n){var m=n.split("@");l.model.set(e.name+"_username",m[0]),l.model.set(e.name+"_server",m[1]),e.options.default?(r=e.options.default,e.options.default=m[1]):r=""}p&&(console.log("    - Loop: "+t),console.log(e),e.name&&console.log(n)),u+=f.render(e),""!==r&&(e.options.default=r)}});var v=o.clone(l.options.formSchema.formoptions);switch(v.submitbutton=l._btn_title,v.subForm=!0,l.options.options.lang){case"sp":v.resetbutton="Cancelar"}u+=f.renderButton(v),l.el&&e(l.el).html(l.template(o.extend({html:u},l.options.formSchema))),f._radioFieldName.length&&a.setupRadioButtonsValueWithModel(l,f._radioFieldName),l.$(':input[value!=""]').not(":button").each(function(){var o=e(this),t=o.attr("name"),i=o.val();if(l.model.has(o.attr("name"))||(p&&console.log("- set:",o.attr("name")),l.model.set(o.attr("name"))),p&&(console.log("    $inputs.each - start"),console.log(o),console.log("Name: "+t),console.log("Value: "+i),console.log("Model Current Value: "+l.model.get(o.attr("name")))),!o.is(":radio")){i&&l.model.set(t,i);var n=l.model.get(t),s=o.attr("data-field-type");if(s&&n)switch(p&&console.log('    data-field-type = "'+s+'"'),s){case"is-buttons-radio":var a=o.closest(".btn-group");if(a.length){var r=a.find(':button[value="'+n+'"]');r.length&&(r.click(),p&&(console.log(r),console.log('    Click Button with Value = "'+n+'"')))}break;default:console&&console.warn&&console.warn('[!] list.render not implement "data-field-type" = "'+s+'" yet')}p&&(console.log(o),console.log("Model After Set Value: "+n))}}),l.options.model&&m(l);try{if(l.el){p&&(console.log("    Binding Model in List.js ["+l.options.formSchema.name+"]"),console.log(l),console.log(l.model.toJSON()),console.log(l.model.bindings)),l._modelBinder.bind(l.model,l.el,l.model.bindings);var b=l.model&&l.model.toJSON?l.model.toJSON():null;o.isEmpty(b)||o.each(b,function(e,o){p&&console.log("    Model."+o+" = "+e);var t=l.$el.find(':input[name="'+o+'"]');if(!t.is(":radio")&&t.length){var i=t.val();p&&console.log(i),(e&&!i||""===i)&&p&&console.log('    Set :input[name="'+o+'"] = '+e)}})}}catch(e){window.console&&window.console.log&&window.console.log('Warning in list.js: "'+e+'" continue running.')}t.Validation.bind(l,{forceUpdate:!0}),f._hasEmailPicker&&l.setupEmailInput(),a.setupPlaceHolder(l.el),a.setupPopover(l.$el),f._hasBooleanInput&&a.setupBooleanInput(l.$el,f),f._hasRadioBtnGroup&&(a.setupRadioBtnGroup(l.$el,l.model),a.setupRadioBtnGroupValue(l.$el)),p&&(console.log("[*] Check for BirthDayPicker"),console.log(l),console.log(l.options),console.log(f)),f._hasBDate&&a.setupBDateInput(l.$el,l.model,!0),f._hasDate&&a.setupDateInput(l.$el,f),f._hasTime&&a.setupTimeInput(l.$el,f),i&&l.$(".form-actions button.btn-cancel").click(),o.each(l.model.toJSON(),function(t,i){if(""!==t){var n=l.$el.find(':input[name="'+i+'"]'),s=n.val(),a=l.model.get(i);p&&(console.log("    - "+i),console.log(s),console.log(a),console.log(n)),n.is(":radio")||(""===s||o.isNull(s))&&(n.is("select")?n.attr("data-url")?n.one("dataloaded",function(){n.find("option").filter(function(){return e(this).text()===t}).attr("selected",!0).trigger("change")}):a&&n.attr("data-select-value",a):n.val(t))}}),a.setupUrlAjaxCall(l.$el,null,l.model);try{a.setupSelect2(f,"#"+h)}catch(e){console&&console.error&&console.error(e)}if(l.$(":input").not(":hidden").first().focus().length&&l.$el.length&&e("html, body").animate({scrollTop:l.$el.offset().top-30},1e3),n){l.$(":input").not(":button.btn-cancel").each(function(){e(this).attr("disabled",!0)});var w=l.$(":button.btn-submit"),S=l.$(":button.btn-cancel");w.hide(),S.text("Close")}f.trigger(h+".listViewShowed",f)})},events:{"keypress div.sub_form_render :input":"preventEnterPressed","click div.form-actions .btn-submit":"sendForm","click div.form-actions .btn-cancel":"clickCancel","blur :input:not(:button)":"preValidate"},preventEnterPressed:function(o){if(13===o.keyCode&&e(o.currentTarget).is("input"))return o.stopPropagation(),!1},preValidate:function(e){e.stopPropagation(),p&&(console.log("[*] list.preValidate"),console.log(this.model.toJSON())),a.preValidate(e,this.model)},sendForm:function(o){o.preventDefault();var t=this,i=e(".form-actions .btn-submit",this.$el);if(!i.hasClass("submitted")){i.addClass("submitted"),a.setHiddenField(this.el);var n=this.$(".birthdaypicker");n&&n.length&&(p&&(console.log("    BdatePicker: "+n.length),console.log(n)),n.each(function(){var o=e(this),t=o.find(".birth-month");p&&console.log(t),t.trigger("change");var i=o.find(':input[type="hidden"]');p&&console.log(i),i.val().match(/nan/i)&&i.val("")}));if(t.$(':input[value!=""]').not(":button").each(function(){var o=e(this);if(!o.is(":radio")){if(o.is(":file")){if(!("FileReader"in window))throw new Error("No FileReader, please use modern browser like Chrome!");var i=o[0].files[0];if(!i)return void t.model.set(o.attr("name"),"");var n=new FileReader;return n.onload=function(){var e=a.Base64.encode(n.result),l={fileName:i.name,fileSize:i.size,fileType:i.type,base64Data:e},s=JSON.stringify(l);t.model.set(o.attr("name"),s)},void n.readAsText(i)}t.model.set(o.attr("name"),o.val())}}),t.$(":input.tags").each(function(){var o=e(this),i=o.val(),n=o.attr("name");""===i&&(i=null),t.model.set(n,i)}),a.setModelRadioValues(this.$el,this,!1),a.performCalculateLogic(this.$el,this),c(this),this.model.isValid(!0)){e(".not_sending",this.el).trigger("change").attr("disabled",!0).each(function(){t.model.unset(e(this).attr("name"))}),this.removeAttachedEvents(),i.removeClass("submitted"),p&&console.log("- this.model:",JSON.stringify(this.model.toJSON())),this.$el.trigger(this.options.formId+".add",this)}else{this.model.triggerError(this);var l={html:!0,placement:"top",trigger:"manual",title:'<i class="icon-edit"></i> Validation Error',content:"Please complete the required fields"};i.popover(l).popover("show"),window.setTimeout(function(){i.removeClass("submitted").popover("destroy"),i.next(".popover").remove()},2e3)}}},clickCancel:function(e){this.removeAttachedEvents(),e.preventDefault(),this.options.model&&c(this),s.remove("SubFormView"+this.options.formId,!0),s.remove("SubFormViewEdit"+this.options.formId,!0),this.$el.trigger(this.options.formId+".close",this)},setupEmailInput:function(){a.setupEmailInput(this.el)},removeAttachedEvents:function(){var e=this.$el;p&&(console.log("[*] removeAttachedEvents"),console.log(e.hasClass("attached-e-radio-container")),console.log(e)),e.hasClass("attached-e-radio-container")&&(e.off("click",".radio-container button"),e.removeClass("attached-e-radio-container")),p&&console.log(e.hasClass("attached-e-radio-container"))}})});