define(["jquery","lodash","backbone","models/model","modelbinder","validation","vm","utils","events","text!templates/subform-layouts/default.html","jquery.expose","bootstrap"],function(e,t,n,r,i,s,o,u,a,f){function c(e){t.each(e.options.formSchema.fields,function(t){if(!t.name||!t.type)return;var n=t.type.toLowerCase(),r=e.model.get(t.name);switch(n){case"number":r=parseFloat(r),isNaN(r)||(t.options&&t.options.decimals&&(r*=Math.pow(10,t.options.decimals)),e.model.set(t.name,r))}})}function h(e){l&&(console.log("[*] list.reFormatModel - start"),e.model&&e.model.toJSON&&console.log(e.model.toJSON())),t.each(e.options.formSchema.fields,function(t){if(!t.name||!t.type)return;var n=t.type.toLowerCase(),r=e.model.get(t.name);switch(n){case"number":r=parseFloat(r),isNaN(r)||(t.options&&t.options.decimals&&(r/=Math.pow(10,t.options.decimals)),e.model.set(t.name,r))}}),l&&(console.log("[*] list.reFormatModel - end"),e.model&&e.model.toJSON&&console.log(e.model.toJSON()))}var l=!1;return n.View.extend({_modelBinder:undefined,clean:function(){n.Validation.unbind(this),typeof this._modelBinder!="undefined"&&this._modelBinder.unbind(),u.destroyPopover(this.$el)},removeContent:function(){this.$el.html("").removeAttr("class").fadeIn()},initialize:function(){this._modelBinder=new i;var e;typeof this.options.model=="undefined"?(l&&console.log("[*] list.initialize: Insert"),this.model=new r(t.extend(this.options.formSchema,{is_internal:this.options.internal,render_mode:this.options.mode})),this._btn_title="Add"):(l&&(console.log("[*] list.initialize: Edit"),console.log(this.options.model.toJSON()),console.log(this.model)),this._btn_title="Done"),this.options.formSchema.view=this.options.formSchema.view||"";switch(this.options.formSchema.view.toLowerCase()){default:e=f}this.template=t.template(e),this._isListFieldType=!0},render:function(r,i){var s=this,a="";require(["views/baseField"],function(f){var c="",p,d=o.create(s,"BaseField",f,{formSchema:s.options.formSchema}),v=s.options;l&&(console.log("[*] list.render"),console.log(s.options),s.model&&s.model.toJSON&&console.log(s.model.toJSON()),s.options&&s.options.model&&s.options.model.toJSON&&console.log(s.options.model.toJSON())),t.each(s.options.formSchema.fields,function(e,n,r){if(!f.prototype.checkShowOnMode.call(s,e,v.options.mode,v.options.formData.status)){s.model.bindings[e.name]&&delete s.model.bindings[e.name];var i=e.name+"[]";return s.model.bindings[i]&&delete s.model.bindings[i],""}typeof e.description!="undefined"&&t.indexOf(d.notRenderLabel,e.type.toLowerCase())===-1&&(p=u.checkRequireFields(e,s.options.formSchema.validation),c+=d.renderLabel(e,p));if(e.type.toLowerCase()==="email"&&e.options.autocomplete&&s.model.get(e.name)!==""){var o=s.model.get(e.name).split("@");s.model.set(e.name+"_username",o[0]),s.model.set(e.name+"_server",o[1]),e.options["default"]?(a=e.options["default"],e.options["default"]=o[1]):a=""}l&&(console.log("    - Loop: "+n),console.log(e),e.name&&console.log(s.model.get(e.name))),c+=d.render(e),a!==""&&(e.options["default"]=a)});var m=t.clone(s.options.formSchema.formoptions);m.submitbutton=s._btn_title,m.subForm=!0,c+=d.renderButton(m),s.el&&e(s.el).html(s.template(t.extend({html:c},s.options.formSchema)));var g=s.$(':input[value!=""]').not(":button");g.each(function(){var t=e(this),n=t.attr("name"),r=t.val();l&&(console.log("    $inputs.each - start"),console.log(t),console.log("Name: "+n),console.log("Value: "+r),console.log("Model Current Value: "+s.model.get(t.attr("name")))),r&&s.model.set(n,r);var i=s.model.get(n),o=t.attr("data-field-type");if(o&&!!i){l&&console.log('    data-field-type = "'+o+'"');switch(o){case"is-buttons-radio":var u=t.closest(".btn-group");if(u.length){var a=u.find(':button[value="'+i+'"]');a.length&&(a.click(),l&&(console.log(a),console.log('    Click Button with Value = "'+i+'"')))}break;default:console&&console.warn&&console.warn('[!] list.render not implement "data-field-type" = "'+o+'" yet')}}l&&(console.log(t),console.log("Model After Set Value: "+i))}),s.options.model&&h(s);try{if(s.el){l&&(console.log("    Binding Model in List.js ["+s.options.formSchema.name+"]"),console.log(s),console.log(s.model.toJSON()),console.log(s.model.bindings)),s._modelBinder.bind(s.model,s.el,s.model.bindings);var y=s.model&&s.model.toJSON?s.model.toJSON():null;t.isEmpty(y)||t.each(y,function(e,t){l&&console.log("    Model."+t+" = "+e);var n=s.$el.find(':input[name="'+t+'"]');if(n.length){var r=n.val();l&&console.log(r),(e&&!r||r==="")&&l&&console.log('    Set :input[name="'+t+'"] = '+e)}})}}catch(b){window.console&&window.console.log&&window.console.log('Warning in list.js: "'+b+'" continue running.')}n.Validation.bind(s,{forceUpdate:!0}),d._hasEmailPicker&&s.setupEmailInput(),u.setupPlaceHolder(s.el),u.setupPopover(s.$el),d._hasBooleanInput&&u.setupBooleanInput(s.$el,d),d._hasRadioBtnGroup&&(u.setupRadioBtnGroup(s.$el),u.setupRadioBtnGroupValue(s.$el)),l&&(console.log("[*] Check for BirthDayPicker"),console.log(s),console.log(s.options),console.log(d)),d._hasBDate&&u.setupBDateInput(s.$el,s.model,!0),d._hasDate&&u.setupDateInput(s.$el,s),r&&s.$(".form-actions button.btn-cancel").click(),t.each(s.model.toJSON(),function(n,r){if(n==="")return;var i=s.$el.find(':input[name="'+r+'"]'),o=i.val(),u=s.model.get(r);l&&(console.log("    - "+r),console.log(o),console.log(u),console.log(i));if(o===""||t.isNull(o))i.is("select")?i.attr("data-url")?i.one("dataloaded",function(){i.find("option").filter(function(){return e(this).text()===n}).attr("selected",!0).trigger("change")}):u&&i.attr("data-select-value",u):i.val(n)}),u.setupUrlAjaxCall(s.$el,null,s.model);try{u.setupSelect2(s)}catch(b){console&&console.error&&console.error(b)}var w=s.$(":input").not(":hidden").first().focus();w.length&&s.$el.length&&e("html, body").animate({scrollTop:s.$el.offset().top-30},1e3);if(i){var E=s.$(":input").not(":button.btn-cancel");E.each(function(){e(this).attr("disabled",!0)});var S=s.$(":button.btn-submit"),x=s.$(":button.btn-cancel");S.hide(),x.text("Close")}})},events:{"keypress div.sub_form_render :input":"preventEnterPressed","click div.form-actions .btn-submit":"sendForm","click div.form-actions .btn-cancel":"clickCancel","blur :input:not(:button)":"preValidate"},preventEnterPressed:function(t){if(t.keyCode===13&&e(t.currentTarget).is("input"))return t.stopPropagation(),!1},preValidate:function(e){e.stopPropagation(),l&&(console.log("[*] list.preValidate"),console.log(this.model.toJSON())),u.preValidate(e,this.model)},sendForm:function(t){t.preventDefault();var n=this,r=e(".form-actions .btn-submit",this.$el);if(r.hasClass("submitted"))return;r.addClass("submitted"),u.setHiddenField(this.el);var i=this.$(".birthdaypicker");i&&i.length&&(l&&(console.log("    BdatePicker: "+i.length),console.log(i)),i.each(function(){var t=e(this),n=t.find(".birth-month");l&&console.log(n),n.trigger("change");var r=t.find(':input[type="hidden"]');l&&console.log(r),r.val().match(/nan/i)&&r.val("")}));var s=n.$(':input[value!=""]').not(":button");s.each(function(){var t=e(this);n.model.set(t.attr("name"),t.val())}),n.$(":input.tags").each(function(){var t=e(this),r=t.val(),i=t.attr("name");r===""&&(r=null),n.model.set(i,r)}),c(this);if(this.model.isValid(!0)){var o=e(".not_sending",this.el).trigger("change").attr("disabled",!0);o.each(function(){n.model.unset(e(this).attr("name"))}),r.removeClass("submitted"),this.$el.trigger(this.options.formId+".add",this)}else{this.model.triggerError(this);var a={html:!0,placement:"top",trigger:"manual",title:'<i class="icon-edit"></i> Validation Error',content:"Please correct the form"};r.popover(a).popover("show"),window.setTimeout(function(){r.removeClass("submitted").popover("destroy"),r.next(".popover").remove()},2e3)}},clickCancel:function(e){e.preventDefault(),this.options.model&&c(this),o.remove("SubFormView"+this.options.formId,!0),o.remove("SubFormViewEdit"+this.options.formId,!0),this.$el.trigger(this.options.formId+".close",this)},setupEmailInput:function(){u.setupEmailInput(this.el)}})});