define(["jquery","lodash","backbone","models/model","modelbinder","validation","vm","events","text!templates/subform-layouts/default.html"],function(e,t,n,r,i,s,o,u,a){return n.View.extend({_modelBinder:undefined,clean:function(){n.Validation.unbind(this),typeof this._modelBinder!="undefined"&&this._modelBinder.unbind()},removeContent:function(){this.$el.html("").removeAttr("class").fadeIn()},initialize:function(){this._modelBinder=new i;var e;typeof this.options.model=="undefined"?(this.model=new r(this.options.formSchema),this._btn_title="Add"):this._btn_title="Edit",this.options.formSchema.view=this.options.formSchema.view||"";switch(this.options.formSchema.view.toLowerCase()){default:e=a}this.template=t.template(e)},render:function(){var r=this;require(["views/baseField"],function(i){var s="",u=o.create(r,"BaseField",i,{formSchema:r.options.formSchema});t.each(r.options.formSchema.fields,function(e,n,i){typeof e.description!="undefined"&&t.indexOf(r.notRenderLabel,e.type.toLowerCase())===-1&&(s+=u.renderLabel(e)),s+=u.render(e)});var a=t.clone(r.options.formSchema.formoptions);a.submitbutton=r._btn_title,a.subForm=!0,s+=u.renderButton(a),e(r.el).html(r.template(t.extend({html:s},r.options.formSchema))),r._modelBinder.bind(r.model,r.el),n.Validation.bind(r,{forceUpdate:!0})})},events:{"click div.form-actions .btn-submit":"sendForm","click div.form-actions .btn-cancel":"clickCancel","blur :input:not(:button)":"preValidate"},preValidate:function(t){t.stopPropagation();var n=e(t.currentTarget),r=n.attr("name"),i=e.trim(n.val());n.val(i).trigger("change"),this.model.isValid(r,i)?n.removeClass("invalid"):n.addClass("invalid")},sendForm:function(t){t.preventDefault();var n=e(".form-actions .btn-submit",this.$el);if(n.hasClass("submitted"))return;n.addClass("submitted");if(this.model.isValid(!0))n.removeClass("submitted"),this.$el.trigger(this.options.formId+".add",this);else{var r={html:!0,placement:"top",trigger:"manual",title:'<i class="icon-edit"></i> Validation Error',content:"Please correct the form"};n.popover(r).popover("show"),window.setTimeout(function(){n.removeClass("submitted").popover("destroy"),n.next(".popover").remove()},2e3)}},clickCancel:function(e){e.preventDefault(),this.$el.trigger(this.options.formId+".close",this)}})});