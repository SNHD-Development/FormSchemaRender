define(["jquery","lodash","backbone","models/model","modelbinder","validation","vm","utils","events","text!templates/subform-layouts/default.html","jquery.expose","bootstrap"],function(e,o,t,n,i,l,s,a,r,d){function c(e){o.each(e.options.formSchema.fields,function(o){if(o.name&&o.type){var t=o.type.toLowerCase(),n=e.model.get(o.name);switch(t){case"number":n=parseFloat(n),isNaN(n)||(o.options&&o.options.decimals&&(n*=Math.pow(10,o.options.decimals)),e.model.set(o.name,n))}}})}function m(e){p&&(console.log("[*] list.reFormatModel - start"),e.model&&e.model.toJSON&&console.log(e.model.toJSON())),o.each(e.options.formSchema.fields,function(o){if(o.name&&o.type){var t=o.type.toLowerCase(),n=e.model.get(o.name);switch(t){case"number":n=parseFloat(n),isNaN(n)||(o.options&&o.options.decimals&&(n/=Math.pow(10,o.options.decimals)),e.model.set(o.name,n))}}}),p&&(console.log("[*] list.reFormatModel - end"),e.model&&e.model.toJSON&&console.log(e.model.toJSON()))}var p=!1;return t.View.extend({_modelBinder:void 0,clean:function(){t.Validation.unbind(this),"undefined"!=typeof this._modelBinder&&this._modelBinder.unbind(),a.destroyPopover(this.$el)},removeContent:function(){this.$el.html("").removeAttr("class").fadeIn()},initialize:function(){this._modelBinder=new i;var e;this.options||(this.options={}),this.options.options||(this.options.options={});var t=this.options.options.lang;if("undefined"==typeof this.options.model)switch(p&&console.log("[*] list.initialize: Insert"),this.model=new n(o.extend(this.options.formSchema,{is_internal:this.options.internal,render_mode:this.options.mode})),t){case"sp":this._btn_title="Agregar";break;default:this._btn_title="Add"}else switch(p&&(console.log("[*] list.initialize: Edit"),console.log(this.options.model.toJSON()),console.log(this.model)),t){case"sp":this._btn_title="Hecho";break;default:this._btn_title="Done"}switch(this.options.formSchema.view=this.options.formSchema.view||"",this.options.formSchema.view.toLowerCase()){default:e=d}this.template=o.template(e),this._isListFieldType=!0},render:function(n,i){var l=this,r="";this.options||(this.options={}),this.options.options||(this.options.options={}),require(["views/baseField"],function(d){var c,h="",u=s.create(l,"BaseField",d,{formSchema:l.options.formSchema,lang:l.options.options.lang}),f=l.options;p&&(console.log("[*] list.render"),console.log(l.options),l.model&&l.model.toJSON&&console.log(l.model.toJSON()),l.options&&l.options.model&&l.options.model.toJSON&&console.log(l.options.model.toJSON())),o.each(l.options.formSchema.fields,function(e,t,n){if(!d.prototype.checkShowOnMode.call(l,e,f.options.mode,f.options.formData.status)){l.model.bindings&&l.model.bindings[e.name]&&delete l.model.bindings[e.name];var i=e.name+"[]";return l.model.bindings&&l.model.bindings[i]&&delete l.model.bindings[i],""}if("undefined"!=typeof e.description&&o.indexOf(u.notRenderLabel,e.type.toLowerCase())===-1&&(c=a.checkRequireFields(e,l.options.formSchema.validation),h+=u.renderLabel(e,c)),"email"===e.type.toLowerCase()&&e.options.autocomplete&&""!==l.model.get(e.name)){var s=l.model.get(e.name).split("@");l.model.set(e.name+"_username",s[0]),l.model.set(e.name+"_server",s[1]),e.options.default?(r=e.options.default,e.options.default=s[1]):r=""}p&&(console.log("    - Loop: "+t),console.log(e),e.name&&console.log(l.model.get(e.name))),h+=u.render(e),""!==r&&(e.options.default=r)});var g=o.clone(l.options.formSchema.formoptions);switch(g.submitbutton=l._btn_title,g.subForm=!0,l.options.options.lang){case"sp":g.resetbutton="Cancelar"}h+=u.renderButton(g),l.el&&e(l.el).html(l.template(o.extend({html:h},l.options.formSchema))),u._radioFieldName.length&&a.setupRadioButtonsValueWithModel(l,u._radioFieldName);var v=l.$(':input[value!=""]').not(":button");v.each(function(){var o=e(this),t=o.attr("name"),n=o.val();if(l.model.has(o.attr("name"))||(p&&console.log("- set:",o.attr("name")),l.model.set(o.attr("name"))),p&&(console.log("    $inputs.each - start"),console.log(o),console.log("Name: "+t),console.log("Value: "+n),console.log("Model Current Value: "+l.model.get(o.attr("name")))),!o.is(":radio")){n&&l.model.set(t,n);var i=l.model.get(t),s=o.attr("data-field-type");if(s&&i)switch(p&&console.log('    data-field-type = "'+s+'"'),s){case"is-buttons-radio":var a=o.closest(".btn-group");if(a.length){var r=a.find(':button[value="'+i+'"]');r.length&&(r.click(),p&&(console.log(r),console.log('    Click Button with Value = "'+i+'"')))}break;default:console&&console.warn&&console.warn('[!] list.render not implement "data-field-type" = "'+s+'" yet')}p&&(console.log(o),console.log("Model After Set Value: "+i))}}),l.options.model&&m(l);try{if(l.el){p&&(console.log("    Binding Model in List.js ["+l.options.formSchema.name+"]"),console.log(l),console.log(l.model.toJSON()),console.log(l.model.bindings)),l._modelBinder.bind(l.model,l.el,l.model.bindings);var b=l.model&&l.model.toJSON?l.model.toJSON():null;o.isEmpty(b)||o.each(b,function(e,o){p&&console.log("    Model."+o+" = "+e);var t=l.$el.find(':input[name="'+o+'"]');if(!t.is(":radio")&&t.length){var n=t.val();p&&console.log(n),(e&&!n||""===n)&&p&&console.log('    Set :input[name="'+o+'"] = '+e)}})}}catch(e){window.console&&window.console.log&&window.console.log('Warning in list.js: "'+e+'" continue running.')}t.Validation.bind(l,{forceUpdate:!0}),u._hasEmailPicker&&l.setupEmailInput(),a.setupPlaceHolder(l.el),a.setupPopover(l.$el),u._hasBooleanInput&&a.setupBooleanInput(l.$el,u),u._hasRadioBtnGroup&&(a.setupRadioBtnGroup(l.$el,l.model),a.setupRadioBtnGroupValue(l.$el)),p&&(console.log("[*] Check for BirthDayPicker"),console.log(l),console.log(l.options),console.log(u)),u._hasBDate&&a.setupBDateInput(l.$el,l.model,!0),u._hasDate&&a.setupDateInput(l.$el,l),n&&l.$(".form-actions button.btn-cancel").click(),o.each(l.model.toJSON(),function(t,n){if(""!==t){var i=l.$el.find(':input[name="'+n+'"]'),s=i.val(),a=l.model.get(n);p&&(console.log("    - "+n),console.log(s),console.log(a),console.log(i)),i.is(":radio")||(""===s||o.isNull(s))&&(i.is("select")?i.attr("data-url")?i.one("dataloaded",function(){i.find("option").filter(function(){return e(this).text()===t}).attr("selected",!0).trigger("change")}):a&&i.attr("data-select-value",a):i.val(t))}}),a.setupUrlAjaxCall(l.$el,null,l.model);try{a.setupSelect2(l)}catch(e){console&&console.error&&console.error(e)}var w=l.$(":input").not(":hidden").first().focus();if(w.length&&l.$el.length&&e("html, body").animate({scrollTop:l.$el.offset().top-30},1e3),i){var S=l.$(":input").not(":button.btn-cancel");S.each(function(){e(this).attr("disabled",!0)});var y=l.$(":button.btn-submit"),_=l.$(":button.btn-cancel");y.hide(),_.text("Close")}})},events:{"keypress div.sub_form_render :input":"preventEnterPressed","click div.form-actions .btn-submit":"sendForm","click div.form-actions .btn-cancel":"clickCancel","blur :input:not(:button)":"preValidate"},preventEnterPressed:function(o){if(13===o.keyCode&&e(o.currentTarget).is("input"))return o.stopPropagation(),!1},preValidate:function(e){e.stopPropagation(),p&&(console.log("[*] list.preValidate"),console.log(this.model.toJSON())),a.preValidate(e,this.model)},sendForm:function(o){o.preventDefault();var t=this,n=e(".form-actions .btn-submit",this.$el);if(!n.hasClass("submitted")){n.addClass("submitted"),a.setHiddenField(this.el);var i=this.$(".birthdaypicker");i&&i.length&&(p&&(console.log("    BdatePicker: "+i.length),console.log(i)),i.each(function(){var o=e(this),t=o.find(".birth-month");p&&console.log(t),t.trigger("change");var n=o.find(':input[type="hidden"]');p&&console.log(n),n.val().match(/nan/i)&&n.val("")}));var l=t.$(':input[value!=""]').not(":button");if(l.each(function(){var o=e(this);o.is(":radio")||t.model.set(o.attr("name"),o.val())}),t.$(":input.tags").each(function(){var o=e(this),n=o.val(),i=o.attr("name");""===n&&(n=null),t.model.set(i,n)}),a.setModelRadioValues(this.$el,this,!1),c(this),this.model.isValid(!0)){var s=e(".not_sending",this.el).trigger("change").attr("disabled",!0);s.each(function(){t.model.unset(e(this).attr("name"))}),this.removeAttachedEvents(),n.removeClass("submitted"),p&&console.log("- this.model:",JSON.stringify(this.model.toJSON())),this.$el.trigger(this.options.formId+".add",this)}else{this.model.triggerError(this);var r={html:!0,placement:"top",trigger:"manual",title:'<i class="icon-edit"></i> Validation Error',content:"Please complete the required fields"};n.popover(r).popover("show"),window.setTimeout(function(){n.removeClass("submitted").popover("destroy"),n.next(".popover").remove()},2e3)}}},clickCancel:function(e){this.removeAttachedEvents(),e.preventDefault(),this.options.model&&c(this),s.remove("SubFormView"+this.options.formId,!0),s.remove("SubFormViewEdit"+this.options.formId,!0),this.$el.trigger(this.options.formId+".close",this)},setupEmailInput:function(){a.setupEmailInput(this.el)},removeAttachedEvents:function(){var e=this.$el;p&&(console.log("[*] removeAttachedEvents"),console.log(e.hasClass("attached-e-radio-container")),console.log(e)),e.hasClass("attached-e-radio-container")&&(e.off("click",".radio-container button"),e.removeClass("attached-e-radio-container")),p&&console.log(e.hasClass("attached-e-radio-container"))}})});