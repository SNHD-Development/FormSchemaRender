define(["jquery","lodash","backbone","models/model","modelbinder","validation","vm","utils","events","text!templates/subform-layouts/default.html","jquery.expose","bootstrap"],function(e,o,t,i,n,s,l,a,r,d){function c(e){o.each(e.options.formSchema.fields,function(o){if(o.name&&o.type){var t=o.type.toLowerCase(),i=e.model.get(o.name);switch(t){case"number":i=parseFloat(i),isNaN(i)||(o.options&&o.options.decimals&&(i*=Math.pow(10,o.options.decimals)),e.model.set(o.name,i))}}})}function m(e){p&&(console.log("[*] list.reFormatModel - start"),e.model&&e.model.toJSON&&console.log(e.model.toJSON())),o.each(e.options.formSchema.fields,function(o){if(o.name&&o.type){var t=o.type.toLowerCase(),i=e.model.get(o.name);switch(t){case"number":i=parseFloat(i),isNaN(i)||(o.options&&o.options.decimals&&(i/=Math.pow(10,o.options.decimals)),e.model.set(o.name,i))}}}),p&&(console.log("[*] list.reFormatModel - end"),e.model&&e.model.toJSON&&console.log(e.model.toJSON()))}var p=!1;return t.View.extend({_modelBinder:void 0,clean:function(){var e=this;if(t.Validation.unbind(this),void 0!==this._modelBinder&&this._modelBinder.unbind(),this._hasVisibleOn){var i=o.keys(this._visibleOnEvents);i&&i.length&&o.each(i,function(o){e._visibleOnEvents[o].unbind()})}a.destroyPopover(this.$el)},removeContent:function(){this.$el.html("").removeAttr("class").fadeIn()},initialize:function(e){e=e||{},this._modelBinder=new n;var t;this.options||(this.options={}),this.options._id=e.formId,this.options.options||(this.options.options={});var s=this.options.options.lang;if(void 0===this.options.model)switch(p&&console.log("[*] list.initialize: Insert"),this.model=new i(o.extend(this.options.formSchema,{is_internal:this.options.internal,render_mode:this.options.mode,is_list_field:!0})),s){case"sp":this._btn_title="Agregar";break;default:this._btn_title="Add"}else switch(p&&(console.log("[*] list.initialize: Edit"),console.log(this.options.model.toJSON()),console.log(this.model)),s){case"sp":this._btn_title="Hecho";break;default:this._btn_title="Done"}this.options.formSchema.view=this.options.formSchema.view||"",this.options.formSchema.view.toLowerCase(),t=d,this.template=o.template(t),this._isListFieldType=!0,this._hasVisibleOn=!1,this._visibleOnEvents={}},render:function(i,n){var s=[],r={},d=this,c="";this.options||(this.options={}),this.options.options||(this.options.options={}),require(["views/baseField"],function(h){var u,f=d.options._id,g="",v=l.create(d,"BaseField",h,{formSchema:d.options.formSchema,lang:d.options.options.lang}),b=d.options;p&&(console.log("[*] list.render"),console.log(d.options),d.model&&d.model.toJSON&&(console.log(d.model.toJSON()),console.log("- that.model.validation:",JSON.stringify(o.keys(d.model.validation)))),d.options&&d.options.model&&d.options.model.toJSON&&console.log(d.options.model.toJSON())),o.each(d.options.formSchema.fields,function(t,i,n){var l="",m=t.type?t.type.toLowerCase():null,f=d.model.get(t.name);if(!(t&&t.type&&"file"===t.type.toLowerCase()&&f)){if(!h.prototype.checkShowOnMode.call(d,t,b.options.mode,b.options.formData.status)){d.model.bindings&&d.model.bindings[t.name]&&delete d.model.bindings[t.name];var w=t.name+"[]";return d.model.bindings&&d.model.bindings[w]&&delete d.model.bindings[w],""}if(void 0!==t.description&&-1===o.indexOf(v.notRenderLabel,t.type.toLowerCase())&&(u=a.checkRequireFields(t,d.options.formSchema.validation),l+=v.renderLabel(t,u)),"email"===t.type.toLowerCase()&&t.options.autocomplete&&""!==f){var _=f.split("@");d.model.set(t.name+"_username",_[0]),d.model.set(t.name+"_server",_[1]),t.options.default?(c=t.options.default,t.options.default=_[1]):c=""}p&&(console.log("    - Loop: "+i),console.log(t),t.name&&console.log(f)),l+=v.render(t),""!==c&&(t.options.default=c),t.options.visibleon&&"button"!==m&&"submit"!==m?(l='<div class="options-visible-on-'+t.name+'" style="display:none">'+l+"</div>",s.unshift({value:t,html:l})):g+=l,t&&t.name&&t.type&&(r[t.name]=e.trim(t.type.toLowerCase()))}});var w=o.clone(d.options.formSchema.formoptions);switch(w.submitbutton=d._btn_title,w.subForm=!0,d.options.options.lang){case"sp":w.resetbutton="Cancelar"}g+=v.renderButton(w),d.el&&e(d.el).html(d.template(o.extend({html:g},d.options.formSchema))),v._radioFieldName.length&&a.setupRadioButtonsValueWithModel(d,v._radioFieldName),d.$(':input[value!=""]').not(":button").each(function(){var o=e(this),t=o.attr("name"),i=o.val();if(d.model.has(o.attr("name"))||(p&&console.log("- set:",o.attr("name")),d.model.set(o.attr("name"))),p&&(console.log("    $inputs.each - start"),console.log(o),console.log("Name: "+t),console.log("Value: "+i),console.log("Model Current Value: "+d.model.get(o.attr("name")))),!o.is(":radio")){i&&d.model.set(t,i);var n=d.model.get(t),s=o.attr("data-field-type");if(s&&n)switch(p&&console.log('    data-field-type = "'+s+'"'),s){case"is-buttons-radio":var l=o.closest(".btn-group");if(l.length){var a=l.find(':button[value="'+n+'"]');a.length&&(a.click(),p&&(console.log(a),console.log('    Click Button with Value = "'+n+'"')))}break;default:console&&console.warn&&console.warn('[!] list.render not implement "data-field-type" = "'+s+'" yet')}p&&(console.log(o),console.log("Model After Set Value: "+n))}}),d.options.model&&m(d);try{if(d.el){p&&(console.log("    Binding Model in List.js ["+d.options.formSchema.name+"]"),console.log(d),console.log(d.model.toJSON()),console.log(d.model.bindings));var _=d.model&&d.model.toJSON?d.model.toJSON():null;s&&s.length&&(d._hasVisibleOn=!0,o.each(s,function(e){h.prototype.setupVisibleOn.call(d,e.value,e.html,null,r,v)}),_&&o.each(_,function(o,t){if(o){var i=e(':input[name="'+t+'"]',d.$el);i.is(":radio")&&(i=e(':input[name="'+t+'"]:checked',d.$el)),i.trigger("change")}})),d._modelBinder.bind(d.model,d.el,d.model.bindings),o.isEmpty(_)||o.each(_,function(e,o){p&&console.log("    Model."+o+" = "+e);var t=d.$el.find(':input[name="'+o+'"]');if(!t.is(":radio")&&t.length){var i=t.val();p&&console.log(i),(e&&!i||""===i)&&p&&console.log('    Set :input[name="'+o+'"] = '+e)}})}}catch(e){window.console&&window.console.log&&window.console.log('Warning in list.js: "'+e+'" continue running.')}t.Validation.bind(d,{forceUpdate:!0}),v._hasEmailPicker&&d.setupEmailInput(),a.setupPlaceHolder(d.el),a.setupPopover(d.$el),v._hasBooleanInput&&a.setupBooleanInput(d.$el,v),v._hasRadioBtnGroup&&(a.setupRadioBtnGroup(d.$el,d.model),a.setupRadioBtnGroupValue(d.$el)),p&&(console.log("[*] Check for BirthDayPicker"),console.log(d),console.log(d.options),console.log(v)),v._hasBDate&&a.setupBDateInput(d.$el,d.model,!0),v._hasDate&&a.setupDateInput(d.$el,v,!1),v._hasTime&&(a.setupTimeInput(d.$el,v),a.setupTimeInputEvents(v._timeInputs,v)),i&&d.$(".form-actions button.btn-cancel").click(),o.each(d.model.toJSON(),function(t,i){if(""!==t){var n=d.$el.find(':input[name="'+i+'"]'),s=n.val(),l=d.model.get(i);if(!n.is(":radio")){if(n.hasClass("timepicker"))return void(s!==l&&n.val(l));if(n.hasClass("datepicker")&&s!==l){if(l&&l.$date){var a=moment(l.$date);a&&a.isValid()&&(l=a.format("MM/DD/YYYY"))}n.val(l)}(""===s||o.isNull(s))&&(n.is("select")?n.attr("data-url")?n.one("dataloaded",function(){n.find("option").filter(function(){return e(this).text()===t}).attr("selected",!0).trigger("change")}):l&&n.attr("data-select-value",l):n.val(t))}}}),a.setupUrlAjaxCall(d.$el,null,d.model);try{a.setupSelect2(v,"#"+f)}catch(e){console&&console.error&&console.error(e)}if(n){d.$(":input").not(":button.btn-cancel").each(function(){e(this).attr("disabled",!0)});var y=d.$(":button.btn-submit"),S=d.$(":button.btn-cancel");y.hide(),S.text("Close")}v.trigger(f+".listViewShowed",v),setTimeout(function(){a.focusOnFirstInput(d,!0)},300)})},events:{"keypress div.sub_form_render :input":"preventEnterPressed","click div.form-actions .btn-submit":"sendForm","click div.form-actions .btn-cancel":"clickCancel","blur :input:not(:button)":"preValidate"},preventEnterPressed:function(o){if(13===o.keyCode&&e(o.currentTarget).is("input"))return o.stopPropagation(),!1},preValidate:function(e){e.stopPropagation();a.preValidate(e,this.model)},sendForm:function(o){o.preventDefault();var t=this,i=e(".form-actions .btn-submit",this.$el);if(!i.hasClass("submitted")){i.addClass("submitted"),a.setHiddenField(this.el);var n=this.$(".birthdaypicker");n&&n.length&&(p&&(console.log("    BdatePicker: "+n.length),console.log(n)),n.each(function(){var o=e(this),t=o.find(".birth-month");p&&console.log(t),t.trigger("change");var i=o.find(':input[type="hidden"]');p&&console.log(i),i.val().match(/nan/i)&&i.val("")}));if(t.$(':input[value!=""]').not(":button").each(function(){var o=e(this);if(!o.is(":radio")){if(o.is(":file")){if(!("FileReader"in window))throw new Error("No FileReader, please use modern browser like Chrome!");var i=o[0].files[0];if(!i)return void t.model.set(o.attr("name"),"");var n=new FileReader;return n.onload=function(){var e=n.result,s={fileName:i.name,fileSize:i.size,fileType:i.type,base64Data:e},l=JSON.stringify(s);t.model.set(o.attr("name"),l)},void n.readAsDataURL(i)}t.model.set(o.attr("name"),o.val())}}),t.$(":input.tags").each(function(){var o=e(this),i=o.val(),n=o.attr("name");""===i&&(i=null),t.model.set(n,i)}),a.setModelButtonRadioValues(this.$el,this,!1),a.setModelRadioValues(this.$el,this,!1),a.performCalculateLogic(this.$el,this),c(this),this.model.isValid(!0)){e(".not_sending",this.el).trigger("change").attr("disabled",!0).each(function(){t.model.unset(e(this).attr("name"))}),this.removeAttachedEvents(),i.removeClass("submitted"),p&&console.log("- this.model:",JSON.stringify(this.model.toJSON())),this.$el.trigger(this.options.formId+".add",this)}else{this.model.triggerError(this);var s={html:!0,placement:"top",trigger:"manual",title:'<i class="icon-edit"></i> Validation Error',content:"Please complete the required fields"};i.popover(s).popover("show"),window.setTimeout(function(){i.removeClass("submitted").popover("destroy"),i.next(".popover").remove()},2e3)}}},clickCancel:function(e){this.removeAttachedEvents(),e.preventDefault(),this.options.model&&c(this),l.remove("SubFormView"+this.options.formId,!0),l.remove("SubFormViewEdit"+this.options.formId,!0),this.$el.trigger(this.options.formId+".close",this)},setupEmailInput:function(){a.setupEmailInput(this.el)},removeAttachedEvents:function(){var e=this.$el;p&&(console.log("[*] removeAttachedEvents"),console.log(e.hasClass("attached-e-radio-container")),console.log(e)),e.hasClass("attached-e-radio-container")&&(e.off("click",".radio-container button"),e.removeClass("attached-e-radio-container")),p&&(console.log(e.hasClass("attached-e-radio-container")),console.log("[*] removeAttachedEvents <--------"),console.log(this)),a.removeTimeInput(this.el,this,!1)}})});