define(["jquery","lodash","backbone","models/model","modelbinder","validation","vm","utils","events","text!templates/subform-layouts/default.html","jquery.expose","bootstrap"],function(e,t,n,r,i,s,o,u,a,f){function c(e){t.each(e.options.formSchema.fields,function(t){if(!t.name||!t.type)return;var n=t.type.toLowerCase(),r=e.model.get(t.name);switch(n){case"number":r=parseFloat(r),isNaN(r)||(t.options&&t.options.decimals&&(r*=Math.pow(10,t.options.decimals)),e.model.set(t.name,r))}})}function h(e){l&&(console.log("[*] list.reFormatModel - start"),e.model&&e.model.toJSON&&console.log(e.model.toJSON())),t.each(e.options.formSchema.fields,function(t){if(!t.name||!t.type)return;var n=t.type.toLowerCase(),r=e.model.get(t.name);switch(n){case"number":r=parseFloat(r),isNaN(r)||(t.options&&t.options.decimals&&(r/=Math.pow(10,t.options.decimals)),e.model.set(t.name,r))}}),l&&(console.log("[*] list.reFormatModel - end"),e.model&&e.model.toJSON&&console.log(e.model.toJSON()))}var l=!1;return n.View.extend({_modelBinder:undefined,clean:function(){n.Validation.unbind(this),typeof this._modelBinder!="undefined"&&this._modelBinder.unbind(),u.destroyPopover(this.$el)},removeContent:function(){this.$el.html("").removeAttr("class").fadeIn()},initialize:function(){this._modelBinder=new i;var e;typeof this.options.model=="undefined"?(l&&console.log("[*] list.initialize: Insert"),this.model=new r(t.extend(this.options.formSchema,{is_internal:this.options.internal,render_mode:this.options.mode})),this._btn_title="Add"):(l&&(console.log("[*] list.initialize: Edit"),console.log(this.options.model.toJSON()),console.log(this.model)),this._btn_title="Done"),this.options.formSchema.view=this.options.formSchema.view||"";switch(this.options.formSchema.view.toLowerCase()){default:e=f}this.template=t.template(e)},render:function(r){var i=this,s="";require(["views/baseField"],function(a){var f="",c,p=o.create(i,"BaseField",a,{formSchema:i.options.formSchema}),d=i.options;l&&(console.log("[*] list.render"),console.log(i.options),i.model&&i.model.toJSON&&console.log(i.model.toJSON()),i.options&&i.options.model&&i.options.model.toJSON&&console.log(i.options.model.toJSON())),t.each(i.options.formSchema.fields,function(e,n,r){if(!a.prototype.checkShowOnMode.call(i,e,d.options.mode,d.options.formData.status)){i.model.bindings[e.name]&&delete i.model.bindings[e.name];var o=e.name+"[]";return i.model.bindings[o]&&delete i.model.bindings[o],""}typeof e.description!="undefined"&&t.indexOf(p.notRenderLabel,e.type.toLowerCase())===-1&&(c=u.checkRequireFields(e,i.options.formSchema.validation),f+=p.renderLabel(e,c));if(e.type.toLowerCase()==="email"&&e.options.autocomplete&&i.model.get(e.name)!==""){var l=i.model.get(e.name).split("@");i.model.set(e.name+"_username",l[0]),i.model.set(e.name+"_server",l[1]),e.options["default"]?(s=e.options["default"],e.options["default"]=l[1]):s=""}f+=p.render(e),s!==""&&(e.options["default"]=s)});var v=t.clone(i.options.formSchema.formoptions);v.submitbutton=i._btn_title,v.subForm=!0,f+=p.renderButton(v),i.el&&e(i.el).html(i.template(t.extend({html:f},i.options.formSchema)));var m=i.$(':input[value!=""]').not(":button");m.each(function(){var t=e(this),n=t.attr("name"),r=t.val();l&&(console.log("    $inputs.each - start"),console.log(t),console.log("Name: "+n),console.log("Value: "+r),console.log("Model Current Value: "+i.model.get(t.attr("name")))),r&&i.model.set(n,r);var s=i.model.get(n);if(t.has("data-field-type")&&!!s){var o=t.attr("data-field-type");l&&console.log('    data-field-type = "'+o+'"');switch(o){case"is-buttons-radio":var u=t.closest(".btn-group");if(u.length){var a=u.find(':button[value="'+s+'"]');a.length&&(a.click(),l&&(console.log(a),console.log('    Click Button with Value = "'+s+'"')))}break;default:console&&console.warn&&console.warn('[!] list.render not implement "data-field-type" = "'+o+'" yet')}}l&&(console.log(t),console.log("Model After Set Value: "+s))}),i.options.model&&h(i);try{if(i.el){l&&(console.log("    Binding Model in List.js ["+i.options.formSchema.name+"]"),console.log(i),console.log(i.model.toJSON()),console.log(i.model.bindings)),i._modelBinder.bind(i.model,i.el,i.model.bindings);var g=i.model&&i.model.toJSON?i.model.toJSON():null;t.isEmpty(g)||t.each(g,function(e,t){l&&console.log("    Model."+t+" = "+e);var n=i.$el.find(':input[name="'+t+'"]');if(n.length){var r=n.val();l&&console.log(r),(e&&!r||r==="")&&l&&console.log('    Set :input[name="'+t+'"] = '+e)}})}}catch(y){window.console&&window.console.log&&window.console.log('Warning in list.js: "'+y+'" continue running.')}n.Validation.bind(i,{forceUpdate:!0}),p._hasEmailPicker&&i.setupEmailInput(),u.setupPlaceHolder(i.el),u.setupPopover(i.$el),p._hasBooleanInput&&u.setupBooleanInput(i.$el,p),p._hasRadioBtnGroup&&(u.setupRadioBtnGroup(i.$el),u.setupRadioBtnGroupValue(i.$el)),p._hasDate&&u.setupDateInput(i.$el,i),r&&i.$(".form-actions button.btn-cancel").click(),t.each(i.model.toJSON(),function(t,n){if(t==="")return;var r=i.$el.find(':input[name="'+n+'"]'),s=r.val();s===""&&(r.is("select")&&r.attr("data-url")?r.one("dataloaded",function(){r.find("option").filter(function(){return e(this).text()===t}).attr("selected",!0).trigger("change")}):r.val(t))}),u.setupUrlAjaxCall(i.$el,null,i.model);var b=i.$(":input").not(":hidden").first().focus();b.length&&i.$el.length&&e("html, body").animate({scrollTop:i.$el.offset().top-30},1e3)})},events:{"keypress div.sub_form_render :input":"preventEnterPressed","click div.form-actions .btn-submit":"sendForm","click div.form-actions .btn-cancel":"clickCancel","blur :input:not(:button)":"preValidate"},preventEnterPressed:function(t){if(t.keyCode===13&&e(t.currentTarget).is("input"))return t.stopPropagation(),!1},preValidate:function(e){e.stopPropagation(),u.preValidate(e,this.model)},sendForm:function(t){t.preventDefault();var n=this,r=e(".form-actions .btn-submit",this.$el);if(r.hasClass("submitted"))return;r.addClass("submitted"),u.setHiddenField(this.el);var i=n.$(':input[value!=""]').not(":button");i.each(function(){var t=e(this);n.model.set(t.attr("name"),t.val())}),c(this);if(this.model.isValid(!0)){var s=e(".not_sending",this.el).trigger("change").attr("disabled",!0);s.each(function(){n.model.unset(e(this).attr("name"))}),r.removeClass("submitted"),this.$el.trigger(this.options.formId+".add",this)}else{this.model.triggerError(this);var o={html:!0,placement:"top",trigger:"manual",title:'<i class="icon-edit"></i> Validation Error',content:"Please correct the form"};r.popover(o).popover("show"),window.setTimeout(function(){r.removeClass("submitted").popover("destroy"),r.next(".popover").remove()},2e3)}},clickCancel:function(e){e.preventDefault(),this.options.model&&c(this),o.remove("SubFormView"+this.options.formId,!0),o.remove("SubFormViewEdit"+this.options.formId,!0),this.$el.trigger(this.options.formId+".close",this)},setupEmailInput:function(){u.setupEmailInput(this.el)}})});