define(["jquery","lodash","backbone","models/model","modelbinder","validation","vm","utils","events","text!templates/subform-layouts/default.html","jquery.expose","bootstrap"],function(e,t,n,r,i,s,o,u,a,f){function l(e){t.each(e.options.formSchema.fields,function(t){if(!t.name||!t.type)return;var n=t.type.toLowerCase(),r=e.model.get(t.name);switch(n){case"number":r=parseFloat(r),isNaN(r)||(t.options&&t.options.decimals&&(r*=Math.pow(10,t.options.decimals)),e.model.set(t.name,r))}})}function c(e){t.each(e.options.formSchema.fields,function(t){if(!t.name||!t.type)return;var n=t.type.toLowerCase(),r=e.model.get(t.name);switch(n){case"number":r=parseFloat(r),isNaN(r)||(t.options&&t.options.decimals&&(r/=Math.pow(10,t.options.decimals)),e.model.set(t.name,r))}})}return n.View.extend({_modelBinder:undefined,clean:function(){n.Validation.unbind(this),typeof this._modelBinder!="undefined"&&this._modelBinder.unbind(),u.destroyPopover(this.$el)},removeContent:function(){this.$el.html("").removeAttr("class").fadeIn()},initialize:function(){this._modelBinder=new i;var e;typeof this.options.model=="undefined"?(this.model=new r(t.extend(this.options.formSchema,{is_internal:this.options.internal,render_mode:this.options.mode})),this._btn_title="Add"):this._btn_title="Done",this.options.formSchema.view=this.options.formSchema.view||"";switch(this.options.formSchema.view.toLowerCase()){default:e=f}this.template=t.template(e)},render:function(r){var i=this,s="";require(["views/baseField"],function(a){var f="",l,h=o.create(i,"BaseField",a,{formSchema:i.options.formSchema}),p=i.options;t.each(i.options.formSchema.fields,function(e,n,r){if(!a.prototype.checkShowOnMode.call(i,e,p.options.mode,p.options.formData.status)){i.model.bindings[e.name]&&delete i.model.bindings[e.name];var o=e.name+"[]";return i.model.bindings[o]&&delete i.model.bindings[o],""}typeof e.description!="undefined"&&t.indexOf(h.notRenderLabel,e.type.toLowerCase())===-1&&(l=u.checkRequireFields(e,i.options.formSchema.validation),f+=h.renderLabel(e,l));if(e.type.toLowerCase()==="email"&&e.options.autocomplete&&i.model.get(e.name)!==""){var c=i.model.get(e.name).split("@");i.model.set(e.name+"_username",c[0]),i.model.set(e.name+"_server",c[1]),e.options["default"]?(s=e.options["default"],e.options["default"]=c[1]):s=""}f+=h.render(e),s!==""&&(e.options["default"]=s)});var d=t.clone(i.options.formSchema.formoptions);d.submitbutton=i._btn_title,d.subForm=!0,f+=h.renderButton(d),i.el&&e(i.el).html(i.template(t.extend({html:f},i.options.formSchema)));var v=i.$(':input[value!=""]').not(":button");v.each(function(){var t=e(this);i.model.set(t.attr("name"),t.val())}),i.options.model&&c(i);try{i.el&&i._modelBinder.bind(i.model,i.el,i.model.bindings)}catch(m){window.console&&window.console.log&&window.console.log('Warning in list.js: "'+m+'" continue running.')}n.Validation.bind(i,{forceUpdate:!0}),h._hasEmailPicker&&i.setupEmailInput(),u.setupPlaceHolder(i.el),u.setupPopover(i.$el),h._hasBooleanInput&&u.setupBooleanInput(i.$el,h),h._hasRadioBtnGroup&&(u.setupRadioBtnGroup(i.$el),u.setupRadioBtnGroupValue(i.$el)),h._hasDate&&u.setupDateInput(i.$el,i),r&&i.$(".form-actions button.btn-cancel").click(),t.each(i.model.toJSON(),function(t,n){if(t==="")return;var r=i.$el.find(':input[name="'+n+'"]'),s=r.val();s===""&&(r.is("select")&&r.attr("data-url")?r.one("dataloaded",function(){r.find("option").filter(function(){return e(this).text()===t}).attr("selected",!0).trigger("change")}):r.val(t))}),u.setupUrlAjaxCall(i.$el,null,i.model);var g=i.$(":input").not(":hidden").first().focus();g.length&&i.$el.length&&e("html, body").animate({scrollTop:i.$el.offset().top-30},1e3)})},events:{"keypress div.sub_form_render :input":"preventEnterPressed","click div.form-actions .btn-submit":"sendForm","click div.form-actions .btn-cancel":"clickCancel","blur :input:not(:button)":"preValidate"},preventEnterPressed:function(t){if(t.keyCode===13&&e(t.currentTarget).is("input"))return t.stopPropagation(),!1},preValidate:function(e){e.stopPropagation(),u.preValidate(e,this.model)},sendForm:function(t){t.preventDefault();var n=this,r=e(".form-actions .btn-submit",this.$el);if(r.hasClass("submitted"))return;r.addClass("submitted"),u.setHiddenField(this.el);var i=n.$(':input[value!=""]').not(":button");i.each(function(){var t=e(this);n.model.set(t.attr("name"),t.val())}),l(this);if(this.model.isValid(!0)){var s=e(".not_sending",this.el).trigger("change").attr("disabled",!0);s.each(function(){n.model.unset(e(this).attr("name"))}),r.removeClass("submitted"),this.$el.trigger(this.options.formId+".add",this)}else{this.model.triggerError(this);var o={html:!0,placement:"top",trigger:"manual",title:'<i class="icon-edit"></i> Validation Error',content:"Please correct the form"};r.popover(o).popover("show"),window.setTimeout(function(){r.removeClass("submitted").popover("destroy"),r.next(".popover").remove()},2e3)}},clickCancel:function(e){e.preventDefault(),this.options.model&&l(this),o.remove("SubFormView"+this.options.formId,!0),o.remove("SubFormViewEdit"+this.options.formId,!0),this.$el.trigger(this.options.formId+".close",this)},setupEmailInput:function(){u.setupEmailInput(this.el)}})});