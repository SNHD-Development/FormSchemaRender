define(["jquery","lodash","backbone","vm","utils","events","views/baseField","text!templates/subform-layouts/table.html","text!templates/notice/confirmation.html","bootstrap"],function(e,t,o,i,a,n,s,r,l){return o.View.extend({template:t.template(r),popTemplate:t.template(l),clean:function(){a.destroyPopover(this.$el)},initialize:function(){this.collection.on("reset",this.resetCollection,this)},render:function(){this.options||(this.options={}),this.options.options||(this.options.options={});var o,n=this,r=[],l=new Array(this.collection.length),m=new Array(this.collection.length),p=this.options.options.lang,c=this.options.formSchema,h=c.name;this.options&&this.options.formSchema&&!this.options.formSchema.options&&(this.options.formSchema.options={});var d={};c&&t.each(c.fields,function(e){if(e&&e.name&&e.type&&e.values){var t="values-"+p;d[e.name]=e[t]?e[t]:e.values}});var u,f=this.options,v=!1;if(t.each(this.options.formSchema.fields,function(p){switch(p&&(p.options||(p.options={})),p.type.toLowerCase()){case"fieldsetstart":case"fieldsetend":return}s.prototype.checkShowOnMode.call(n,p,f.options.mode,f.options.formData.status)&&(p.options&&!1===p.options.showontable||(p.options&&p.options.tabletitle?(o=p.options.tabletitle,o='<a data-content="'+e("<p>"+p.description+"</p>").text()+'" data-original-title="'+p.options.tabletitle+'" data-placement="top" data-toggle="popover" data-trigger="hover" data-html="true">'+o+"</a>"):o=p.description,r.push(o),t.each(n.collection.models,function(e,t){var o,s=e.toJSON();switch(void 0===l[t]&&(l[t]=[],m[t]=e.cid),p.type.toLowerCase()){case"country":var c=i.getCountry(s[p.name]);c||(c=s[p.name]),l[t].push({value:c});break;case"timestamp":r[r.length-1]="Timestamps",l[t].push({value:a.getHumanTime(s[p.name])});break;case"useraccount":u=r.length-1,r[u]="User",l[t].push({value:s[p.name]});break;case"fullname":o=s[p.name+"_fullname_first_name"]?s[p.name+"_fullname_first_name"]:"",void 0!==s[p.name+"_fullname_middle_name"]&&(o+=" "+s[p.name+"_fullname_middle_name"]),o&&(o+=" "),o+=s[p.name+"_fullname_last_name"]?s[p.name+"_fullname_last_name"]:"",l[t].push({value:o});break;case"booleaninput":var h=!0===s[p.name]?"Yes":!1===s[p.name]?"No":"";l[t].push({value:h});break;case"number":var f;f=p.options&&p.options.decimals&&s[p.name]?(s[p.name]/Math.pow(10,p.options.decimals)).toFixed(p.options.decimals):s[p.name],l[t].push({value:f});break;case"date":var g=s[p.name];if(g&&g.$date){if(g=moment(g.$date),!g.isValid())throw new Error('Invalid Date in "'+p.name+'" with "'+JSON.stringify(s[p.name])+'"');g=g.format("MM/DD/YYYY")}l[t].push({value:g});break;case"file":v=!0;var b=s[p.name];if(b){if("string"==typeof b)try{b=JSON.parse(b);var w=b.fileName;b.fileSize&&(w=w+" ("+a.humanFileSize(b.fileSize)+")"),l[t].push({value:w})}catch(e){l[t].push({value:b}),window.setTimeout(function(){n.render()},2e3)}}else l[t].push({value:""});break;default:var y=s[p.name];d&&d[p.name]&&void 0!==d[p.name][y]&&(y=d[p.name][y]),l[t].push({value:y})}})))}),(v||this.options.formSchema.options.addonlywitheditoncreate)&&(l&&l[0]&&1===l[0].length||this.options.formSchema.options.addonlywitheditoncreate&&"update"===f.options.mode)&&(l=t.map(l,function(e){return e.hideEdit=!0,e})),this.options.formSchema.options.addonlywitheditoncreate&&"update"===f.options.mode){var g=a.getModelValueForViewModel(f.options.formData,h),b=g.length;l=t.map(l,function(e,t){return t<b?e.hideDelete=!0:e.hideEdit=!1,e})}e(this.el).html(this.template({labels:r,values:l,modelId:m,heading:void 0!==this.options.formSchema.options.readmodedescription?this.options.formSchema.options.readmodedescription:this.options.formSchema.name,showViewBtn:this.options.formSchema.options.showviewbtn,addOnly:this.options.formSchema.options.addonly,addOnlyWithEditOnCreate:this.options.formSchema.options.addonlywitheditoncreate,selfOnly:!this.options.formSchema.options.addonly&&this.options.formSchema.options.selfonly,currentUser:a.getUserIdFormHtml(),userIndex:u,viewMode:f.options.mode})),a.setupPopover(this.$el)},events:{"click .subform-read-model":"readModel","click .subform-edit-model":"editModel","click .subform-remove-model":"popoverConfirm","click .popover-action .popover-submit":"removeModel","click .popover-action .popover-cancel":"removePopover"},readModel:function(t){t.preventDefault();var o=e(t.currentTarget,this.el).attr("data-id");e(".actions .form-view",this.$el.parent(".subform-container")).trigger("click",[this.collection.get(o),void 0,void 0,!0])},editModel:function(t){t.preventDefault();var o=e(t.currentTarget,this.el).attr("data-id");e(".actions .form-view",this.$el.parent(".subform-container")).trigger("click",this.collection.get(o))},popoverConfirm:function(t){t.preventDefault();var o={html:!0,placement:"top",trigger:"manual",title:"Do you want to remove this data?",content:this.popTemplate({id:e(t.currentTarget,this.el).attr("data-id")})};e(t.currentTarget,this.el).popover(o).popover("show")},removeModel:function(t){t.preventDefault();var o=e(t.currentTarget,this.el).attr("data-id");this.collection.remove(this.collection.get(o)),this.collection.length>0?this.render():this.$el.html("")},removePopover:function(t){e(".subform-remove-model",e(t.currentTarget,this.el).parents(".subform-actions")).popover("destroy").next(".popover").remove()},resetCollection:function(e){this.$el.html("")}})});