define(["jquery","underscore","backbone","text!templates/modules/formreloadwhenstatuschange.html","jquery.purl"],function(e,t,n,r){function i(n){setTimeout(function(){e.ajax({url:n.ajaxUrl,success:function(r,s){t.isString(r)&&(r=JSON.parse(r));if(!t.isObject(r))throw"FormReloadWhenStatusChange Module expected data to be an object. (got "+typeof r+")";var o=e.trim(r.Status);n.tmpData.from=e.trim(n.tmpData.from);if(o===n.tmpData.from){i(n);return}n.tmpData.to=o,n.render(!0)},error:function(e,t,n){throw"FormReloadWhenStatusChange Module Ajax Error: "+n}})},n.timer)}return n.View.extend({template:t.template(r),shouldRenderModules:function(){var e=this.options.options;return e.internal&&e.formData&&e.formData._id},initialize:function(){if(!this.shouldRenderModules())return;if(!e.url)throw"Could not be able to load $.url plugin.";var t=e.url(),n=this.options.options;this.baseUrl=t.attr("protocol")+"://"+t.attr("host"),this.ajaxUrl=this.baseUrl+"/formproxy",n.formData._id&&n.formData._id.$oid&&(this.ajaxUrl+="?id="+e.trim(n.formData._id.$oid)),this.timer=3e3,this.refreshTimer=5e3,this.tmpData={from:n.formData.status,to:null,seconds:this.refreshTimer/1e3},this.modalOptions={keyboard:!1,show:!0,backdrop:"static"}},render:function(e){var t=this;e=e||!1;if(!this.shouldRenderModules())return;if(e){this.$el.append(this.template(this.tmpData));var n=this.$("#formreloadwhenstatuschange");n.on("shown",function(){var e=n.find("#formreloadwhenstatuschange-cnt");t._countDown=setInterval(function(){var n=parseInt(e.text(),10);n--,n>0?e.text(n):(clearInterval(t._countDown),delete t._countDown,location.reload())},1e3)}).modal(this.modalOptions)}else i(this)},events:{"click #formreloadwhenstatuschange button.btn-danger":function(e){this._countDown&&(clearInterval(this._countDown),delete this._countDown)},"click #formreloadwhenstatuschange button.btn-primary":function(e){location.reload()}}})});