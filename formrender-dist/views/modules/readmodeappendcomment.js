define(["jquery","underscore","backbone","text!templates/modules/readmodeappendcomment.html","jquery.mask","jquery.purl"],function(e,n,t,o){function r(e){i&&i.error?i.error(e):alert(e)}function a(e){s?s.log(e):alert(e)}var i,s,d={GET_FORM:"/formproxy",PUT_FORM:"/FormActions/putform"};return"undefined"!=typeof humane&&(i=humane.create({baseCls:"humane-bigbox",timeout:3e3}),i.error=i.spawn({addnCls:"humane-bigbox-error"}),s=humane.create({baseCls:"humane-jackedup",addnCls:"humane-jackedup-success"})),t.View.extend({template:n.template(o),shouldRenderModules:function(){var e=this.options.options;if(!e.formData||!e.formData._id||"read"!==e.mode)return!1;var n=this.options&&this.options._params?this.options._params:null;return n.internal===e.internal},initialize:function(){if(this.shouldRenderModules()){var t=this.options.options,o=this;this.currentUser=e("#snhd_user_network_login"),this.currentUser.length?this.currentUser=this.currentUser.text():this.currentUser=null,this.endPoint=n.extend({},d);var r=t.formData._id;n.each(this.endPoint,function(e,n){o.endPoint[n]=e+"?id="+r.$oid})}},render:function(n){if(this.shouldRenderModules()){var t=e(this.options.el);if(t.length){var o=t.find(".form-actions");if(o.length){var r=o.find("#module-append-comment-btn");if(r.length||(o.append(this.template()),r=o.find("#module-append-comment-btn"),this._modal=o.find("#module-append-comment-modal").modal({backdrop:"static",show:!1,keyboard:!1})),!r.length)throw new Error('Could not be able to find the "#module-append-comment-btn" button.')}}}},events:{"blur #append-comment":function(n){var t=e(n.currentTarget);t.val()?t.removeClass("invalid"):t.addClass("invalid")},"click #module-append-comment-btn":function(e){return e.preventDefault(),this._modal.modal("toggle"),!1},"click #module-append-comment-modal .btn-danger":function(n){return n.preventDefault(),this._modal.modal("hide"),e(this.options.el).find("#module-append-comment-modal").find("#append-comment").removeClass("invalid"),!1},"click #module-append-comment-modal .btn-success":function(t){var o=this,i=this.options._params.internal;t.preventDefault();var s=e(this.options.el).find("#module-append-comment-modal"),d=s.find("#append-comment"),l=d.val();if(!l)return void d.trigger("blur");if(!this._ajax){this._ajax=!0;var m=s.find(".btn");m.attr("disabled",!0),s.mask();var u=function(){o._ajax=!1,m.removeAttr("disabled"),s.unmask()};return e.ajax({url:this.endPoint.GET_FORM,type:"GET",cache:!1,success:function(t,s,d){if(console&&console.log&&console.log(arguments),!t)return r("Could not be able to find the form!"),void u();var m;try{if(m=JSON.parse(t),!n.isObject(m))throw new Error("Invalid Data Type!")}catch(e){return console&&console.error&&console.error(e),r("Could not be able to parse JSON file!"),void u()}var c=i?m.InternalFields:m.Fields;!c&&i&&(c={});var p=i?"Comments_internal":"Comments";c.Comments&&n.isArray(c.Comments)||(c.Comments=[]);var h=(new Date).getTime();c.Comments.push({TimeComment:Math.floor(h/1e3),UserAccount:o.currentUser,Comment:l});var t={};t[p]=JSON.stringify(c.Comments),e.ajax({url:o.endPoint.PUT_FORM,type:"PUT",data:t,cache:!1,success:function(e,n,t){a("Comment added!"),setTimeout(function(){location.reload(!0)},1e3)},error:function(e,n,t){console&&console.error&&console.error(arguments),r("Error: Could not be able to insert new comment!"),u()}})},error:function(e,n,t){console&&console.error&&console.error(arguments),r("Error: Please try again!"),u()}}),!1}}}})});