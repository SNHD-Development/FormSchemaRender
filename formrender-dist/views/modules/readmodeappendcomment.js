define(["jquery","underscore","backbone","text!templates/modules/readmodeappendcomment.html","jquery.mask","jquery.purl"],function(e,o,n,t){function r(e){l&&l.error?l.error(e):alert(e)}function a(e){s?s.log(e):alert(e)}var l,s,d=!1,m={GET_FORM:"/formproxy",PUT_FORM:"/FormActions/putform"};return"undefined"!=typeof humane&&(l=humane.create({baseCls:"humane-bigbox",timeout:3e3}),l.error=l.spawn({addnCls:"humane-bigbox-error"}),s=humane.create({baseCls:"humane-jackedup",addnCls:"humane-jackedup-success"})),n.View.extend({template:o.template(t),shouldRenderModules:function(){var e=this.options.options;if(d&&(console.log("[*] readmodeappendcomment.shouldRenderModules"),console.log(this)),!e.formData||!e.formData._id||"read"!==e.mode)return d&&console.log("[x] Not render reason 1"),!1;var o=this.options&&this.options._params?this.options._params:null;return d&&console.log(o),o.internal===e.internal},initialize:function(){if(this.shouldRenderModules()){d&&(console.log("[*] readmodeappendcomment.initialize"),console.log(this));var n=this.options.options,t=this;this.currentUser=e("#snhd_user_network_login"),this.currentUser.length?this.currentUser=this.currentUser.text():this.currentUser=null,this.endPoint=o.extend({},m);var r=n.formData._id;o.each(this.endPoint,function(e,o){t.endPoint[o]=e+"?id="+r.$oid})}},render:function(o){if(this.shouldRenderModules()){d&&(console.log("[*] readmodeappendcomment.render"),console.log(this));var n=e(this.options.el);if(d&&console.log(n),n.length){var t=n.find(".form-actions");if(d&&console.log(t),t.length){var r=t.find("#module-append-comment-btn");if(r.length||(t.append(this.template()),r=t.find("#module-append-comment-btn"),this._modal=t.find("#module-append-comment-modal").modal({backdrop:"static",show:!1,keyboard:!1})),!r.length)throw new Error('Could not be able to find the "#module-append-comment-btn" button.');d&&console.log(r)}}}},events:{"blur #append-comment":function(o){d&&console.log("[*] readmodeappendcomment.blur on #module-append-comment-modal #append-comment");var n=e(o.currentTarget);d&&console.log(n);var t=n.val();t?n.removeClass("invalid"):n.addClass("invalid")},"click #module-append-comment-btn":function(e){return e.preventDefault(),d&&console.log("[*] readmodeappendcomment.click on #module-append-comment-btn"),this._modal.modal("toggle"),!1},"click #module-append-comment-modal .btn-danger":function(o){o.preventDefault(),d&&console.log("[*] readmodeappendcomment.click on #module-append-comment-modal .btn-danger"),this._modal.modal("hide");var n=e(this.options.el).find("#module-append-comment-modal");return n.find("#append-comment").removeClass("invalid"),!1},"click #module-append-comment-modal .btn-success":function(n){var t=this,l=this.options._params.internal;n.preventDefault(),d&&console.log("[*] readmodeappendcomment.click on #module-append-comment-modal .btn-success");var s=e(this.options.el).find("#module-append-comment-modal");d&&console.log(s);var m=s.find("#append-comment"),i=m.val();if(!i)return void m.trigger("blur");if(d&&(console.log("- Text Area Value"),console.log(i)),!this._ajax){this._ajax=!0;var c=s.find(".btn");c.attr("disabled",!0),s.mask();var u=function(){t._ajax=!1,c.removeAttr("disabled"),s.unmask()};return e.ajax({url:this.endPoint.GET_FORM,type:"GET",cache:!1,success:function(n,s,m){if(console&&console.log&&console.log(arguments),!n)return r("Could not be able to find the form!"),void u();var c;try{if(c=JSON.parse(n),!o.isObject(c))throw new Error("Invalid Data Type!")}catch(e){return console&&console.error&&console.error(e),r("Could not be able to parse JSON file!"),void u()}var p=l?c.InternalFields:c.Fields;!p&&l&&(p={});var h=l?"Comments_internal":"Comments";p.Comments&&o.isArray(p.Comments)||(p.Comments=[]);var f=(new Date).getTime();p.Comments.push({TimeComment:Math.floor(f/1e3),UserAccount:t.currentUser,Comment:i}),d&&console.log(p.Comments);var n={};n[h]=JSON.stringify(p.Comments),d&&console.log(n),e.ajax({url:t.endPoint.PUT_FORM,type:"PUT",data:n,cache:!1,success:function(e,o,n){a("Comment added!"),setTimeout(function(){location.reload(!0)},1e3)},error:function(e,o,n){console&&console.error&&console.error(arguments),r("Error: Could not be able to insert new comment!"),u()}})},error:function(e,o,n){console&&console.error&&console.error(arguments),r("Error: Please try again!"),u()}}),!1}}}})});