define(["jquery","underscore","backbone","utils","text!templates/modules/formapprovalprocess.html"],function(e,t,n,r,i){function u(t,n){var r=new Date,i="_internal",s='<form method="post" action="/form/edit?id='+t+'" novalidate id="module-form-update-approval"><input type="hidden" name="UserPermissions'+i+'" id="UserPermissions"/></form>',o=e("body").append(s),u=o.find("#module-form-update-approval");u.find("#UserPermissions").val(JSON.stringify(n)),u.submit()}function a(e,n){if(!t.isString(n))throw a+" expected action to be a string.";e._modal.find(".modal-body #module-approval-loader").show();var r=e.options.options.formData;r.InternalFields||(r.InternalFields={}),r.InternalFields.UserPermissions||(r.InternalFields.UserPermissions=[]),r.fields.UserPermissions&&(r.InternalFields.UserPermissions=r.fields.UserPermissions);var i=e.$("#approval-comment"),s=i.val();i.attr("disabled",!0);var o=r.InternalFields.UserPermissions,f={Username:e.username,Status:null,Comment:!s||s===""?null:s,DecisionTime:(new Date).getTime()/1e3};switch(n){case"deny":f.Status="Deny";break;default:f.Status="Approve"}o.push(f),u(r._id.$oid,o)}var s=!1,o="frame";return n.View.extend({template:t.template(i),initialize:function(){var e=this.options.options.formData,n=this.options.options.mode;if(n!=="read"||typeof e=="undefined"||!t.isObject(e)||!e.fields)return;this.username=null,this.userId=r.getUserIdFormHtml(),this._btn=null,this._modal=null,this._submitted=!1;if(!this.userId||!this.userId.length)throw this.userId=null,"Could not be able to find userId in FormApprovalProcess module";var i=this.userId.split("\\");this.username=i.pop();if(!this.username.length||this.username==="")return;s&&(this.username=o);if(this.username===e.createduser){this.username=null;return}if(e.fields&&e.fields.UserPermissions){var u=t.pluck(e.fields.UserPermissions,"Username");if(t.indexOf(u,this.username)>-1){this.username=null;return}}},render:function(){if(!this.username)return;var t=e(this.options.el),n=t.find(".form-actions");n.append(this.template()),this._btn=n.find("#module-approval-btn"),this._modal=n.find("#module-approval-modal").modal({backdrop:"static",show:!1,keyboard:!0})},events:{"click #module-approval-btn":function(e){return e.preventDefault(),this._modal.modal("toggle"),!1},"click .modal-footer .btn-danger":function(e){return e.preventDefault(),this._submitted?!1:(this._submitted=!0,a(this,"deny"),!1)},"click .modal-footer .btn-success":function(e){return e.preventDefault(),this._submitted?!1:(this._submitted=!0,a(this,"approve"),!1)}}})});