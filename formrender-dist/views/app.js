define(["jquery","lodash","backbone","vm","events","jquery.ajaxsubmit","text!templates/layout.html","jquery.datepicker"],function(e,t,n,r,i,s,o){var u=n.View.extend({template:t.template(o),el:"#app",initialize:function(){if(typeof this.options.formSchema=="undefined")throw"formSchema is not in the options parameters"},render:function(){var t=this,n="view"in this.options.formSchema?this.options.formSchema.view:"default",i={formSchema:t.options.formSchema,formData:t.options.formData,mode:t.options.mode};this.$el.html(this.template(this.options.formSchema)),typeof this.options.mode!="undefined"&&this.options.mode==="read"?require(["views/readonly/"+n],function(e){var n=r.create(t,"ReadView",e,i);n.render()}):require(["views/form-layouts/"+n],function(n){t.formView=r.create(t,"FormView",n,i),t.formView.render(),t.formView._hasDate&&t.setupDateInput(),t.formView._hasBDate&&t.setupBDateInput(),e("#"+t.options.formSchema.name,this.el).trigger(t.options.formSchema.name+".renderCompleted",t)})},setupBDateInput:function(){e(".birthdaypicker",this.el).each(function(){e(this).birthdaypicker(e(this).attr("data-options"))})},getBDateinput:function(){e("fieldset.birthday-picker").each(function(){e(".not_sending",this).trigger("change");var t=/NaN/i;e(":hidden",this).val().match(t)&&e(":hidden",this).val("")})},setupDateInput:function(){e(".datepicker",this.el).each(function(){var t={},n,r;if(e(this).attr("data-maxdate"))switch(e(this).attr("data-maxdate").toLowerCase()){case"today":r=new Date,n=new Date(r.getFullYear(),r.getMonth(),r.getDate(),0,0,0,0),t.onRender=function(e){return e.valueOf()>n.valueOf()?"disabled":""}}e(this).datepicker(t).on("changeDate",function(t){var n=e(t.currentTarget).removeClass("invalid").trigger("change");n.datepicker("hide")}).on("click",function(t){e("div.datepicker.dropdown-menu").css("display","none"),e(t.currentTarget).datepicker("show")})})},events:{"submit form.form-render":"submitForm","click .form-actions .btn-clear-form":"clearForm","blur :input:not(:button)":"preValidate"},submitForm:function(t){var n=e("#"+this.options.formSchema.name,this.el),r=e('.form-actions button[type="submit"]',this.el),i,s;t.preventDefault();if(n.hasClass("form_submitted"))return;n.addClass("form_submitted").removeClass("validation_pass validation_error"),this.getBDateinput(),e(".not_sending",n).attr("disabled",!0),this.formView.model.isValid(!0)?(n.addClass("validation_pass"),e("input.subform_before_submit",this.el).remove(),this.formView.model.appendSubFormInput(this.options.formSchema.name),s={beforeSubmit:this.showRequest,success:this.showResponse},n.ajaxSubmit(s),this.formView.options.formSchema.view!=="wizard"&&(i={html:!0,placement:"top",trigger:"manual",title:"Submitting Form, Please wait",content:'<i class="icon-spinner icon-spin icon-large"></i> Sending data...'},r.attr("disabled",!0).popover(i).popover("show").next(".popover").addClass("success"))):(n.addClass("validation_error"),n.removeClass("form_submitted"),e(".not_sending",n).attr("disabled",!1),this.formView.options.formSchema.view!=="wizard"&&(i={html:!0,placement:"top",trigger:"manual",title:'<i class="icon-edit"></i> Validation Error',content:"Please correct the form"},r.attr("disabled",!0).popover(i).popover("show"),window.setTimeout(function(){e(".invalid:first",n).focus(),r.attr("disabled",!1).popover("destroy"),r.next(".popover").remove()},2e3))),n.trigger(this.options.formSchema.name+".validated")},showRequest:function(e,t,n){t.trigger(t.attr("id")+".preSubmit",[e,t,n]);if(t.attr("data-stopSubmit"))return t.removeAttr("data-stopSubmit"),!1},showResponse:function(t,n,r,i){i.removeClass("form_submitted"),e(".not_sending",i).attr("disabled",!1),i.trigger(i.attr("id")+".postSubmit",[t,n,r,i]),window.setTimeout(function(){e('.form-actions button[type="submit"]',i).attr("disabled",!1).popover("destroy").next(".popover").removeClass("success").remove()},3e3)},preValidate:function(t){var n=e(t.currentTarget),r=n.attr("name"),i=e.trim(n.val());n.val(i).trigger("change"),this.formView.model.isValid(r,i)?n.removeClass("invalid"):n.addClass("invalid")},clearForm:function(){var n=this;t.each(this.formView.model.attributes,function(t,r){typeof t.reset=="function"?n.formView.model.get(r).reset():e(':input[name="'+r+'"]',n.el).val("").trigger("change")})}});return u});