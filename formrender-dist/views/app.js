define(["jquery","lodash","backbone","vm","utils","events","text!templates/layout.html","jquery.ajaxsubmit","jquery.datepicker","jquery.placeholder","jquery.lightbox","jquery.expose","bootstrap","jquery.select2","jloader","jquery.timepicker"],function(e,o,t,a,r,i,n){function s(e){e.attr("disabled",!1).popover("destroy").next(".popover").removeClass("success").remove()}return t.View.extend({template:o.template(n),el:"#app",initialize:function(){if(void 0===this.options.formSchema)throw"formSchema is not in the options parameters"},render:function(){var o=this,i="view"in this.options.formSchema?this.options.formSchema.view:"default",n={formSchema:o.options.formSchema,formData:o.options.formData,mode:o.options.mode,internal:o.options.internal,hideButtons:o.options.hideButtons,lang:o.options.lang,formEvents:this.options.formEvents};this.$el.html(this.template(this.options.formSchema));var s=e("#"+this.options.formSchema.name,this.el);s.on(this.options.formSchema.name+".renderCompleted",function(){r.genericSetup(o);var e=n.formSchema;if(e&&e.allowenterkeytosubmit){var t=['input[type="text"]','input[type="password"]'];for(var a in t)s.on("keyup",t[a],function(e){13===e.keyCode&&s.submit()})}}),void 0!==this.options.mode&&"read"===this.options.mode?(e("#"+o.options.formSchema.name,o.el).addClass("read-mode"),require(["views/readonly/"+i],function(t){try{var i=a.create(o,"ReadView",t,n);i.render(),r.finalReadSetup(i),e(i.el).on("click",".btn-js-download",function(){var o=e(this),t=o.attr("data-file");if(t){if(!o.hasClass("downloading-file")){var a=r.Base64.decode(t);if(a){"string"==typeof a&&(a=JSON.parse(a));var i=a.base64Data;if(i){var n=(a.fileType,a.fileName);o.addClass("downloading-file");var s,l;navigator&&navigator.msSaveBlob?(l=r.convertDataURIToBlob(i,n),navigator.msSaveBlob(l)):(s=document.createElement("a"),s.setAttribute("href",i),s.setAttribute("download",n),s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s)),o.removeClass("downloading-file")}}}}}),e("#"+o.options.formSchema.name,o.el).trigger(o.options.formSchema.name+".renderCompleted",o),r.finalSetupAllMode(i)}catch(o){console&&console.error&&(console.error("[x] Rendering Read Mode Error"),console.error(o)),r.renderError(e(i.el),o)}r.scrollToTop()})):require(["views/form-layouts/"+i],function(i){try{o.formView=a.create(o,"FormView",i,n),o.formView.render()}catch(e){return console&&console.log&&(console.log("Exception: in app.js"),console.log(e)),void r.renderError(o.$el,e)}try{o.formView._hasDate&&o.setupDateInput(null,o),o.formView._hasTime&&o.setupTimeInput(null,o),o.formView._hasBDate&&o.setupBDateInput(),o.formView._hasEmailPicker&&o.setupEmailInput(),r.setupAddressEvent(o.el,o),r.setupSpinner(o.el,o.formView.options.mode),r.setupPlaceHolder(o.el),r.setupFileInput(o.el),r.setupPopover(o.el),r.finalSetup(o.formView),e("#"+o.options.formSchema.name,o.el).trigger(o.options.formSchema.name+".renderCompleted",o),r.finalSetupAllMode(o.formView);var s=e(o.el).find("form.form-render");o.options.formActionUrl&&s.attr("action",o.options.formActionUrl);e("div.form-actions",s);o.formView._javaUpload.length>0&&o.setupJavaUpload(o.formView._javaUpload),r.setupUrlAjaxCall(e("form.form-render")),r.setupSelect2(o.formView),o.formView._modelBinder.bind(o.formView.model,o.formView.el,o.formView.model.bindings),t.Validation.bind(o.formView,{forceUpdate:!0})}catch(t){console&&console.error&&(console.error("[x] Rendering "+o.options.mode+" Mode Error"),console.error(t)),r.renderError(e(o.formView.el),t)}r.focusOnFirstInput(o),r.scrollToTop()})},setupBDateInput:function(){r.setupBDateInput(this.el,this.formView.model)},getBDateinput:function(e,o){r.getBDateinput(e,o)},setupEmailInput:function(){r.setupEmailInput(this.el)},setupDateInput:function(){r.setupDateInput(this.el,this)},setupTimeInput:function(){r.setupTimeInput(this.el,this)},preventSpace:function(e){r.preventSpace(e)},allowNumber:function(e){r.allowNumber(e)},allowRational:function(e){r.allowRational(e)},allowNaturalNumber:function(e){r.allowNaturalNumber(e)},allowWholeNumber:function(e){r.allowWholeNumber(e)},allowZipCode:function(e){r.allowZipCode(e)},formatTelephoneNumber:function(e){r.allowPhoneNumber(e)},formatSocialSecurity:function(e){r.allowSocialSecurity(e)},formatZipCodePlusFour:function(e){r.allowZipCodePlusFour(e)},events:{"submit form.form-render":"submitForm","click .form-actions .btn-clear-form":"clearForm","click .form-actions .btn-render-form":"setupForm","blur :input:not(:button)":"preValidate","change :file":"preValidate",'keydown :input[type="email"]':"preventSpace","keydown :input.number":"allowNumber","keydown :input.rational":"allowRational","keydown :input.natural":"allowNaturalNumber","keydown :input.whole":"allowWholeNumber","keydown :input.allowzipcode, :input.integer":"allowZipCode","keydown :input.telephone":"formatTelephoneNumber","blur :input.telephone":"formatTelephoneNumber","keydown :input.socialsecurity":"formatSocialSecurity","blur :input.socialsecurity":"formatSocialSecurity","keydown :input.allowzipcodeplusfour":"formatZipCodePlusFour","blur :input.allowzipcodeplusfour":"formatZipCodePlusFour","keypress :input":"preventEnterPressed","keyup :input.field-keyboard-command":"ajaxCommandByKeyBoard","click .update-cancel":"clickUpdateCancelBtn","click .update-submit":"clickUpdateSubmitBtn"},submitForm:function(t){var a,i,n=e("#"+this.options.formSchema.name,this.el),s=e('.form-actions button[type="submit"]',this.el),l=this;if(n.find(".datepicker").each(function(){var o=e(this),t=o.val();t&&""!==t&&l.formView.model.set(o.attr("name"),t)}),n.removeClass("invalid_prevalidation").trigger(n.attr("id")+".preValidation",[t,n,this]),n.hasClass("invalid_prevalidation"))return t.preventDefault(),!1;if(n.hasClass("form_submitted"))return t.preventDefault(),!1;n.addClass("form_submitted").removeClass("validation_pass validation_error not_sending_data_yet"),this.getBDateinput(this.el,this.formView.model),r.getUserId(this.el,this.formView.model),e(".not_sending",n).attr("disabled",!0),this.formView.model.appendSubFormInput(this.options.formSchema.name,this.formView._internalFields,this.formView._listSchema),r.getDefaultValues(this.formView.el,l.formView.model),n.find(":input.has-select2-dynamic").each(function(){var o=e(this);l.formView.model.set(o.attr("name"),o.val())}),r.setDefaultMultiFile(n,this.formView),r.setModelRadioValues(n,this.formView),r.setModelCheckValues(n,this.formView);var d=r.validateCheckBox(n),m=this.$(":selected");r.resetSelectsOption(m);var p=this.$("select");if(p.length&&p.each(function(){var t=e(this),a=t.val();o.isNull(a)&&t.val("")}),this.formView.model.isValid(!0)&&this.formView.model.isSubformValid()&&d){n.find(":input:hidden[data-value]").each(function(){var o=e(this);""===o.val()&&o.val(o.attr("data-value"))}),n.addClass("validation_pass"),""!==this.options.token&&n.prepend('<input type="hidden" name="token" value="'+this.options.token+'"/>');var u=n.attr("action");if("create"===this.options.mode&&-1===u.search(/name=\w/gi)&&n.prepend('<input type="hidden" name="form_name" value="'+this.options.formSchema.name+'"/>'),i={beforeSubmit:this.showRequest,success:this.showResponse,error:this.processError},r.resetPlaceHolderValue(this.el),r.convertDataToArrayString(n),r.convertNumberToDecimal(n),this.formView._javaUpload.length){var c=!1,f=!1;if(o.each(this.formView._javaUpload,function(o){var t=e("#"+o.id+"_java-upload");if(t.hasClass("in")){c=!0;var a=document.getElementById(o.id);if(e("#"+o.id+"_java-upload-applet",t).hasClass("required")&&!a.getFiles().size())return void(f=!0);e(':input[name="'+o.id+'"]').remove(),a.startUpload()}}),c)return f&&(n.addClass("validation_error").removeClass("validation_pass"),n.removeClass("form_submitted"),e(".not_sending",n).attr("disabled",!1),e(':input[name="form_name"]',n).remove(),e(':input[name="token"]',n).remove()),void t.preventDefault()}if(r.parseInternalFieldsBeforeSubmit(n,this.formView._internalFields),this.formView._ajaxSubmit)t.preventDefault(),n.ajaxSubmit(i);else{n.trigger(n.attr("id")+".preSubmit",[t,n,this]);var h=n.attr("data-stopSubmit")||n.attr("data-stopsubmit");if(h&&""!==h)return n.removeAttr("data-stopSubmit"),n.removeAttr("data-stopsubmit"),t.preventDefault(),n.removeClass("form_submitted"),void e(".not_sending",n).attr("disabled",!1)}if("wizard"!==this.formView.options.formSchema.view&&!n.hasClass("not_sending_data_yet")){var v,w;switch(this.formView.options.lang){case"sp":v="Enviando la forma; por favor espere",w="Cargando Informaci&oacute;n";break;default:v="Submitting form; please wait.",w="Sending data"}a={html:!0,placement:"top",trigger:"manual",title:v,content:'<i class="icon-spinner icon-spin icon-large"></i> '+w+" ..."},s.attr("disabled",!0).popover(a).popover("show").next(".popover").addClass("success")}}else console.log("************* Model Invalid *************"),console.log("Is model valid?",this.formView.model.isValid(!0)),console.log("Is sub-form model valid?",this.formView.model.isSubformValid()),console.log("Model, value before submitted",this.formView.model.toJSON()),console.log("_isCheckBoxGood",d),console.log(""),t.preventDefault(),n.addClass("validation_error"),n.removeClass("form_submitted"),e(".not_sending",n).attr("disabled",!1),"wizard"!==this.formView.options.formSchema.view&&(a={html:!0,placement:"top",trigger:"manual",title:'<i class="icon-edit"></i> Validation Error',content:"Please complete the required fields"},s.attr("disabled",!0).popover(a).popover("show"),window.setTimeout(function(){var o=e(".invalid:first",n);o.is(":checkbox")||o.is(":radio")||o.focus(),s.attr("disabled",!1).popover("destroy"),s.next(".popover").remove(),r.validateBooleanInput(n)},2e3));n.trigger(this.options.formSchema.name+".validated")},showRequest:function(e,o,t){return o.trigger(o.attr("id")+".preSubmit",[e,o,t]),o.attr("data-stopSubmit")?(o.removeAttr("data-stopSubmit"),!1):o.attr("data-stopsubmit")?(o.removeAttr("data-stopsubmit"),!1):void 0},showResponse:function(t,r,i,n){console&&console.info&&(console.info("[*] showResponse"),console.info(arguments));var l,d=e('.form-actions.wizard-actions button[type="button"].btn_next');d.length||(d=e('.form-actions button[type="submit"]'));try{l=o.isString(t)?e.parseJSON(t):t}catch(e){try{var m=t.search(/<pre>/gi);if(m>-1&&(t=t.replace(/<pre>|<\/pre>/gi,"")),l=JSON.parse(t),l.html)for(var p=5;p&&(p--,l.html.search(/&\w+;/gi)>-1);)l.html=o.unescape(l.html)}catch(e){return console&&console.log&&console.log(e),void alert("Response is invalid. Please try again.")}}if(console&&console.info&&console.info(l),l.html)return void require(["views/hiddenForm"],function(e){a.create({},"FormView",e).render(l)});if(o.each(l,function(e,t){"string"==typeof e&&(l[t]=o.unescape(e))}),l.status&&"error"===l.status){s(d);var u=l.error_message||l.message||l.response||"Please try again.",c={html:!0,placement:"top",trigger:"manual",title:"Application Error",content:"<b>Error Message:</b> <br>"+u+'<br> <hr> Please fill all the required fields completely. We will reload this form in <span id="count_time">20</span> seconds.'};return d.attr("disabled",!0).popover(c).popover("show").next(".popover"),void window.setTimeout(function(){var o=e("#count_time");setTimeout(function(){location.reload()},1e3*parseInt(o.text(),10)),setInterval(function(){var e=parseInt(o.text(),10);--e<1||o.text(e)},1e3)},2e3)}e(':hidden[name="token"], :hidden[name="form_name"]',n).remove(),n.removeClass("form_submitted"),e(".not_sending",n).attr("disabled",!1);var f=n.attr("id")+".postSubmit";n.trigger(f,[t,l,r,i,n]),window.setTimeout(function(){d.attr("disabled",!1).popover("destroy").next(".popover").removeClass("success").remove()},3e3)},processError:function(o,t,a,r){console&&console.error&&(console.error("[*] showResponse"),console.error(arguments));var i=e(".form-actions.wizard-actions button.btn_next"),n=a;if(i.length||(i=e('.form-actions button[type="submit"]')),i.length){if(s(i),o.responseText){try{n=JSON.parse(o.responseText),n.message&&console&&console.log&&(console.log("*** Error ***"),console.log(n.message))}catch(e){console.log("*** Error (Exception) ***"),console.log(e)}n=a+", please try again later."}var l={html:!0,placement:"top",trigger:"manual",title:"Application Error",content:n};i.attr("disabled",!0).popover(l).popover("show").next(".popover")}else alert(n+", please try again later."),console&&console.log&&o.responseText&&console.log(o.responseText)},preValidate:function(e){this.formView&&r.preValidate(e,this.formView.model)},clearForm:function(){var t=this;o.each(this.formView.model.attributes,function(o,a){if("function"==typeof o.reset)t.formView.model.get(a).reset();else{var r=e(':input[name="'+a+'"]',t.el);if(r.is(":checked"))r.attr("checked",!1);else if(r.is(":radio"))return;r.val(""),r.trigger("change"),t.formView.model.set(a,"")}})},preventEnterPressed:function(o){if(13===o.keyCode&&e(o.currentTarget).is("input"))return o.stopPropagation(),!1},setupForm:function(o){var t=this,r=e(o.currentTarget);return o.preventDefault(),e.getJSON(r.attr("href"),{},function(e,o){"success"===o?require(["views/hiddenForm"],function(o){a.create(t,"FormView",o).render(e)}):location.refresh()}),!1},setupJavaUpload:function(t){var a=e(this).get(0);if(void 0==(this.formView.options.formSchema.jserialnumber?this.formView.options.formSchema.jserialnumber:window.jSerialNumber))throw"Please set jSerialNumber to match with your purchase number.";var r={progressbar:"true",boxmessage:"Loading File Uploader Applet ...","Common.SerialNumber":window.jSerialNumber,"Common.UploadMode":"true","Common.UseLiveConnect":"true","Common.ProgressArea.DownloadButton.Visible":"false","Common.SkinLF.ThemepackURL":"//public.southernnevadahealthdistrict.org/assets/assets/jar/jupload/themepack.zip","Common.Language.AutoDetect":"true","Upload.UploadUrl":e(this.formView.el).attr("action"),"Upload.Compress.Enabled":"true","Upload.Compress.ArchiveFileName":"#UNIQUEID#","Upload.Compress.Format":"ZIP","Upload.Compress.Level":"DEFAULT","Upload.HttpUpload.FieldName.FilePath":"SelectedPath_#COUNTER#","Upload.HttpUpload.FormName":this.formView.el.replace("#",""),"Upload.HttpUpload.AddFormValuesToPostFields":"true","Upload.HttpUpload.AddFormValuesToHeaders":"false","Upload.HttpUpload.AddFormValuesToQueryString":"false","Upload.HttpUpload.FieldName.FileBody":"FileBody_#COUNTER#","Upload.HttpUpload.SendBrowserCookie":"true"},i=document.write,n="";document.write=function(e){n+=e},o.each(t,function(o){n="",r["Upload.HttpUpload.FieldName.FileBody"]=o.id,deployJava.runApplet(o,r,"1.5.1");var t=e("#"+o.id+"_java-upload-applet").html(n);a.options.formSchema&&a.options.formSchema.validation&&a.options.formSchema.validation[o.id]&&(a.formView.model.validation[o.id].required&&t.addClass("required"),a.formView.model.validation[o.id]={}),e("#"+o.id+"_accordion").on("click",".accordion-heading",function(){var t=e(this),r=t.next(),i=t.closest(".accordion-group");r.find("applet").length?(a.formView.model.validation[o.id]={},i.next().find("input").attr("disabled",!0)):(r.find("input").attr("disabled",!1),a.options.formSchema&&a.options.formSchema.validation&&a.options.formSchema.validation[o.id]&&(a.formView.model.validation[o.id]=a.options.formSchema.validation[o.id]))})}),document.write=i,window.JavaPowUpload_onUploadFinish=function(){window.jRedirect?location.replace(window.jRedirect):location.reload(!0)}},ajaxCommandByKeyBoard:function(o){var t=o.keyCode,a=this.options.internal,i=a?"/form/edit?id="+this.options.formData._id.$oid:null,n=e(o.target),s=function(e){var o=n.closest(".update-on-read-mode");n.fadeOut("slow",function(){var t=o.find(".uneditable-input");if(e){var a=e[t.attr("id")];a?t.html(a):(console&&console.error&&(console.error("[x] Error: Update New Value"),console.error(a),console.log(e)),r.showHumaneErrorBox("Error, could not update new value!"))}t.fadeIn("slow",function(){n.addClass("force-hide"),o.removeClass("ajax")})})};switch(t){case 13:if(!i)throw"Not implement outside internal yet.";var l={};l[n.attr("name")]=e.trim(n.val()),function(o,t){if(n.hasClass("ajax-submitted"))return!1;n.addClass("ajax-submitted"),r.showHumaneSuccessBox("Updating"),e.ajax({url:o,type:"POST",data:t,cache:!1,success:function(e,o,a){n.removeClass("ajax-submitted"),r.showHumaneSuccessBox("Success"),s(t)},error:function(e,a,i){n.removeClass("ajax-submitted"),console&&console.error&&(console.error('[x] Error: Sending Data to POST "'+o+'"'),console.error(t),console.error(arguments)),r.showHumaneErrorBox("Error, please try again!")}})}(i,l);break;case 27:s()}},clickUpdateCancelBtn:function(o){if("read"===this.options.mode){var t=e(o.target),a=t.closest(".update-on-read-mode");if(a.length){var r=a.find(".field-container");r.fadeOut("slow",function(){a.find(".uneditable-input").fadeIn("slow",function(){a.removeClass("ajax"),r.addClass("force-hide")})})}}},clickUpdateSubmitBtn:function(o){if("read"===this.options.mode){var t=e(o.target);if(t.hasClass("ajax-submitted"))return!1;t.addClass("ajax-submitted");var a,i,n,s=this,l={},d=this.options.internal,m=d?"/form/edit?id="+this.options.formData._id.$oid:null,p=function(i,n,l){t.addClass("ajax-submitted"),r.showHumaneSuccessBox("Updating"),e.ajax({url:i,type:"POST",data:n,cache:!1,success:function(e,i,n){t.removeClass("ajax-submitted"),r.showHumaneSuccessBox("Success"),l&&a.closest(".update-on-read-mode").find(".uneditable-input").html(l),s.clickUpdateCancelBtn(o)},error:function(e,o,a){t.removeClass("ajax-submitted"),console&&console.error&&(console.error('[x] Error: Sending Data to POST "'+i+'"'),console.error(n),console.error(arguments)),r.showHumaneErrorBox("Error, please try again!")}})},u=t.closest(".field-container");u.hasClass("radio-container")?(a=u.find(":radio:checked"),i=e.trim(a.val()),n=a.attr("data-radio-value"),l[a.attr("name")]=i,p(m,l,n)):(a=u.find(":input"),i=e.trim(a.val()),l[a.attr("name")]=i,p(m,l,i))}}})});