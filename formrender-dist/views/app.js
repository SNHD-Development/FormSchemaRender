define(["jquery","lodash","backbone","vm","utils","events","text!templates/layout.html","jquery.ajaxsubmit","jquery.datepicker","jquery.placeholder","jquery.lightbox","jquery.expose","bootstrap","jquery.select2","jloader"],function(e,o,t,r,a,i,n){function s(e){e.attr("disabled",!1).popover("destroy").next(".popover").removeClass("success").remove()}var l=t.View.extend({template:o.template(n),el:"#app",initialize:function(){if("undefined"==typeof this.options.formSchema)throw"formSchema is not in the options parameters"},render:function(){var o=this,i="view"in this.options.formSchema?this.options.formSchema.view:"default",n={formSchema:o.options.formSchema,formData:o.options.formData,mode:o.options.mode,internal:o.options.internal,hideButtons:o.options.hideButtons,lang:o.options.lang};this.$el.html(this.template(this.options.formSchema)),e("#"+this.options.formSchema.name,this.el).on(this.options.formSchema.name+".renderCompleted",function(){a.genericSetup(o)}),"undefined"!=typeof this.options.mode&&"read"===this.options.mode?(e("#"+o.options.formSchema.name,o.el).addClass("read-mode"),require(["views/readonly/"+i],function(t){try{var i=r.create(o,"ReadView",t,n);i.render(),a.finalReadSetup(i),e("#"+o.options.formSchema.name,o.el).trigger(o.options.formSchema.name+".renderCompleted",o),a.finalSetupAllMode(i)}catch(o){console&&console.error&&(console.error("[x] Rendering Read Mode Error"),console.error(o)),a.renderError(e(i.el),o)}a.scrollToTop()})):require(["views/form-layouts/"+i],function(i){try{o.formView=r.create(o,"FormView",i,n),o.formView.render()}catch(e){return console&&console.log&&(console.log("Exception: in app.js"),console.log(e)),void a.renderError(o.$el,e)}try{o.formView._hasDate&&o.setupDateInput(null,o),o.formView._hasBDate&&o.setupBDateInput(),o.formView._hasEmailPicker&&o.setupEmailInput(),a.setupAddressEvent(o.el,o),a.setupSpinner(o.el,o.formView.options.mode),a.setupPlaceHolder(o.el),a.setupFileInput(o.el),a.setupPopover(o.el),a.finalSetup(o.formView),e("#"+o.options.formSchema.name,o.el).trigger(o.options.formSchema.name+".renderCompleted",o),a.finalSetupAllMode(o.formView);var s=e(o.el).find("form.form-render");o.options.formActionUrl&&s.attr("action",o.options.formActionUrl);e("div.form-actions",s);o.formView._javaUpload.length>0&&o.setupJavaUpload(o.formView._javaUpload),a.setupUrlAjaxCall(e("form.form-render")),a.setupSelect2(o.formView),o.formView._modelBinder.bind(o.formView.model,o.formView.el,o.formView.model.bindings),t.Validation.bind(o.formView,{forceUpdate:!0})}catch(t){console&&console.error&&(console.error("[x] Rendering "+o.options.mode+" Mode Error"),console.error(t)),a.renderError(e(o.formView.el),t)}a.focusOnFirstInput(o),a.scrollToTop()})},setupBDateInput:function(){a.setupBDateInput(this.el,this.formView.model)},getBDateinput:function(e,o){a.getBDateinput(e,o)},setupEmailInput:function(){a.setupEmailInput(this.el)},setupDateInput:function(){a.setupDateInput(this.el,this)},preventSpace:function(e){a.preventSpace(e)},allowNumber:function(e){a.allowNumber(e)},allowRational:function(e){a.allowRational(e)},allowNaturalNumber:function(e){a.allowNaturalNumber(e)},allowWholeNumber:function(e){a.allowWholeNumber(e)},allowZipCode:function(e){a.allowZipCode(e)},formatTelephoneNumber:function(e){a.allowPhoneNumber(e)},formatSocialSecurity:function(e){a.allowSocialSecurity(e)},formatZipCodePlusFour:function(e){a.allowZipCodePlusFour(e)},events:{"submit form.form-render":"submitForm","click .form-actions .btn-clear-form":"clearForm","click .form-actions .btn-render-form":"setupForm","blur :input:not(:button)":"preValidate","change :file":"preValidate",'keydown :input[type="email"]':"preventSpace","keydown :input.number":"allowNumber","keydown :input.rational":"allowRational","keydown :input.natural":"allowNaturalNumber","keydown :input.whole":"allowWholeNumber","keydown :input.allowzipcode, :input.integer":"allowZipCode","keydown :input.telephone":"formatTelephoneNumber","blur :input.telephone":"formatTelephoneNumber","keydown :input.socialsecurity":"formatSocialSecurity","blur :input.socialsecurity":"formatSocialSecurity","keydown :input.allowzipcodeplusfour":"formatZipCodePlusFour","blur :input.allowzipcodeplusfour":"formatZipCodePlusFour","keypress :input":"preventEnterPressed","keyup :input.field-keyboard-command":"ajaxCommandByKeyBoard","click .update-cancel":"clickUpdateCancelBtn","click .update-submit":"clickUpdateSubmitBtn"},submitForm:function(t){var r,i,n=e("#"+this.options.formSchema.name,this.el),s=e('.form-actions button[type="submit"]',this.el),l=this,d=n.find(".datepicker");if(d.each(function(){var o=e(this),t=o.val();t&&""!==t&&l.formView.model.set(o.attr("name"),t)}),n.removeClass("invalid_prevalidation").trigger(n.attr("id")+".preValidation",[t,n,this]),n.hasClass("invalid_prevalidation"))return t.preventDefault(),!1;if(n.hasClass("form_submitted"))return t.preventDefault(),!1;n.addClass("form_submitted").removeClass("validation_pass validation_error not_sending_data_yet"),this.getBDateinput(this.el,this.formView.model),a.getUserId(this.el,this.formView.model),e(".not_sending",n).attr("disabled",!0),this.formView.model.appendSubFormInput(this.options.formSchema.name,this.formView._internalFields,this.formView._listSchema),a.getDefaultValues(this.formView.el,l.formView.model),n.find(":input.has-select2-dynamic").each(function(){var o=e(this);l.formView.model.set(o.attr("name"),o.val())}),a.setDefaultMultiFile(n,this.formView),a.setModelRadioValues(n,this.formView),a.setModelCheckValues(n,this.formView);var m=a.validateCheckBox(n),p=this.$(":selected");a.resetSelectsOption(p);var c=this.$("select");if(c.length&&c.each(function(){var t=e(this),r=t.val();o.isNull(r)&&t.val("")}),this.formView.model.isValid(!0)&&this.formView.model.isSubformValid()&&m){n.find(":input:hidden[data-value]").each(function(){var o=e(this);""===o.val()&&o.val(o.attr("data-value"))}),n.addClass("validation_pass"),""!==this.options.token&&n.prepend('<input type="hidden" name="token" value="'+this.options.token+'"/>');var u=n.attr("action");if("create"===this.options.mode&&u.search(/name=\w/gi)===-1&&n.prepend('<input type="hidden" name="form_name" value="'+this.options.formSchema.name+'"/>'),i={beforeSubmit:this.showRequest,success:this.showResponse,error:this.processError},a.resetPlaceHolderValue(this.el),a.convertDataToArrayString(n),a.convertNumberToDecimal(n),this.formView._javaUpload.length){var f=!1,h=!1;if(o.each(this.formView._javaUpload,function(o){var t=e("#"+o.id+"_java-upload");if(t.hasClass("in")){f=!0;var r=document.getElementById(o.id);if(e("#"+o.id+"_java-upload-applet",t).hasClass("required")&&!r.getFiles().size())return void(h=!0);e(':input[name="'+o.id+'"]').remove(),r.startUpload()}}),f)return h&&(n.addClass("validation_error").removeClass("validation_pass"),n.removeClass("form_submitted"),e(".not_sending",n).attr("disabled",!1),e(':input[name="form_name"]',n).remove(),e(':input[name="token"]',n).remove()),void t.preventDefault()}if(a.parseInternalFieldsBeforeSubmit(n,this.formView._internalFields),this.formView._ajaxSubmit?(t.preventDefault(),n.ajaxSubmit(i)):n.trigger(n.attr("id")+".preSubmit",[t,n,this]),"wizard"!==this.formView.options.formSchema.view&&!n.hasClass("not_sending_data_yet")){var v,w;switch(this.formView.options.lang){case"sp":v="Enviando la forma; por favor espere",w="Cargando Informaci&oacute;n";break;default:v="Submitting form; please wait.",w="Sending data"}r={html:!0,placement:"top",trigger:"manual",title:v,content:'<i class="icon-spinner icon-spin icon-large"></i> '+w+" ..."},s.attr("disabled",!0).popover(r).popover("show").next(".popover").addClass("success")}}else t.preventDefault(),n.addClass("validation_error"),n.removeClass("form_submitted"),e(".not_sending",n).attr("disabled",!1),"wizard"!==this.formView.options.formSchema.view&&(r={html:!0,placement:"top",trigger:"manual",title:'<i class="icon-edit"></i> Validation Error',content:"Please correct the form"},s.attr("disabled",!0).popover(r).popover("show"),window.setTimeout(function(){var o=e(".invalid:first",n);o.is(":checkbox")||o.is(":radio")||o.focus(),s.attr("disabled",!1).popover("destroy"),s.next(".popover").remove()},2e3));n.trigger(this.options.formSchema.name+".validated")},showRequest:function(e,o,t){if(o.trigger(o.attr("id")+".preSubmit",[e,o,t]),o.attr("data-stopSubmit"))return o.removeAttr("data-stopSubmit"),!1},showResponse:function(t,a,i,n){console&&console.info&&(console.info("[*] showResponse"),console.info(arguments));var l,d=e('.form-actions.wizard-actions button[type="button"].btn_next');d.length||(d=e('.form-actions button[type="submit"]'));try{l=o.isString(t)?e.parseJSON(t):t}catch(e){try{var m=t.search(/<pre>/gi);if(m>-1&&(t=t.replace(/<pre>|<\/pre>/gi,"")),l=JSON.parse(t),l.html)for(var p=5;p&&(p--,l.html.search(/&\w+;/gi)>-1);)l.html=o.unescape(l.html)}catch(e){return console&&console.log&&console.log(e),void alert("Response is invalid. Please try again.")}}if(console&&console.info&&console.info(l),l.html)return void require(["views/hiddenForm"],function(e){var o=r.create({},"FormView",e);o.render(l)});if(o.each(l,function(e,t){"string"==typeof e&&(l[t]=o.unescape(e))}),l.status&&"error"===l.status){s(d);var c=l.error_message||l.message||l.response||"Please try again.",u={html:!0,placement:"top",trigger:"manual",title:"Application Error",content:"<b>Error Message:</b> <br>"+c+'<br> <hr> Please fill all the required fields completely. We will reload this form in <span id="count_time">20</span> seconds.'};return d.attr("disabled",!0).popover(u).popover("show").next(".popover"),void window.setTimeout(function(){var o=e("#count_time");setTimeout(function(){location.reload()},1e3*parseInt(o.text(),10)),setInterval(function(){var e=parseInt(o.text(),10);e--,e<1||o.text(e)},1e3)},2e3)}e(':hidden[name="token"], :hidden[name="form_name"]',n).remove(),n.removeClass("form_submitted"),e(".not_sending",n).attr("disabled",!1),n.trigger(n.attr("id")+".postSubmit",[t,l,a,i,n]),window.setTimeout(function(){d.attr("disabled",!1).popover("destroy").next(".popover").removeClass("success").remove()},3e3)},processError:function(o,t,r,a){console&&console.error&&(console.error("[*] showResponse"),console.error(arguments));var i=e(".form-actions.wizard-actions button.btn_next"),n=r;if(i.length||(i=e('.form-actions button[type="submit"]')),i.length){if(s(i),o.responseText){try{n=JSON.parse(o.responseText),n.message&&console&&console.log&&(console.log("*** Error ***"),console.log(n.message))}catch(e){console.log("*** Error (Exception) ***"),console.log(e)}n=r+", please try again later."}var l={html:!0,placement:"top",trigger:"manual",title:"Application Error",content:n};i.attr("disabled",!0).popover(l).popover("show").next(".popover")}else alert(n+", please try again later."),console&&console.log&&o.responseText&&console.log(o.responseText)},preValidate:function(e){this.formView&&a.preValidate(e,this.formView.model)},clearForm:function(){var t=this;o.each(this.formView.model.attributes,function(o,r){if("function"==typeof o.reset)t.formView.model.get(r).reset();else{var a=e(':input[name="'+r+'"]',t.el);if(a.is(":checked"))a.attr("checked",!1);else if(a.is(":radio"))return;a.val(""),a.trigger("change"),t.formView.model.set(r,"")}})},preventEnterPressed:function(o){if(13===o.keyCode&&e(o.currentTarget).is("input"))return o.stopPropagation(),!1},setupForm:function(o){var t=this,a=e(o.currentTarget);return o.preventDefault(),e.getJSON(a.attr("href"),{},function(e,o){"success"===o?require(["views/hiddenForm"],function(o){var a=r.create(t,"FormView",o);a.render(e)}):location.refresh()}),!1},setupJavaUpload:function(t){var r=e(this).get(0),a=this.formView.options.formSchema.jserialnumber?this.formView.options.formSchema.jserialnumber:window.jSerialNumber;if(void 0==a)throw"Please set jSerialNumber to match with your purchase number.";var i={progressbar:"true",boxmessage:"Loading File Uploader Applet ...","Common.SerialNumber":window.jSerialNumber,"Common.UploadMode":"true","Common.UseLiveConnect":"true","Common.ProgressArea.DownloadButton.Visible":"false","Common.SkinLF.ThemepackURL":"//public.southernnevadahealthdistrict.org/assets/assets/jar/jupload/themepack.zip","Common.Language.AutoDetect":"true","Upload.UploadUrl":e(this.formView.el).attr("action"),"Upload.Compress.Enabled":"true","Upload.Compress.ArchiveFileName":"#UNIQUEID#","Upload.Compress.Format":"ZIP","Upload.Compress.Level":"DEFAULT","Upload.HttpUpload.FieldName.FilePath":"SelectedPath_#COUNTER#","Upload.HttpUpload.FormName":this.formView.el.replace("#",""),"Upload.HttpUpload.AddFormValuesToPostFields":"true","Upload.HttpUpload.AddFormValuesToHeaders":"false","Upload.HttpUpload.AddFormValuesToQueryString":"false","Upload.HttpUpload.FieldName.FileBody":"FileBody_#COUNTER#","Upload.HttpUpload.SendBrowserCookie":"true"},n="1.5.1",s=document.write,l="";document.write=function(e){l+=e},o.each(t,function(o){l="",i["Upload.HttpUpload.FieldName.FileBody"]=o.id,deployJava.runApplet(o,i,n);var t=e("#"+o.id+"_java-upload-applet").html(l);r.options.formSchema&&r.options.formSchema.validation&&r.options.formSchema.validation[o.id]&&(r.formView.model.validation[o.id].required&&t.addClass("required"),r.formView.model.validation[o.id]={}),e("#"+o.id+"_accordion").on("click",".accordion-heading",function(){var t=e(this),a=t.next(),i=t.closest(".accordion-group");a.find("applet").length?(r.formView.model.validation[o.id]={},i.next().find("input").attr("disabled",!0)):(a.find("input").attr("disabled",!1),r.options.formSchema&&r.options.formSchema.validation&&r.options.formSchema.validation[o.id]&&(r.formView.model.validation[o.id]=r.options.formSchema.validation[o.id]))})}),document.write=s,window.JavaPowUpload_onUploadFinish=function(){window.jRedirect?location.replace(window.jRedirect):location.reload(!0)}},ajaxCommandByKeyBoard:function(o){var t=!1,r=o.keyCode,i=this.options.internal,n=i?"/form/edit?id="+this.options.formData._id.$oid:null,s=e(o.target),l=function(e){var o=s.closest(".update-on-read-mode");s.fadeOut("slow",function(){var t=o.find(".uneditable-input");if(e){var r=e[t.attr("id")];r?t.html(r):(console&&console.error&&(console.error("[x] Error: Update New Value"),console.error(r),console.log(e)),a.showHumaneErrorBox("Error, could not update new value!"))}t.fadeIn("slow",function(){s.addClass("force-hide"),o.removeClass("ajax")})})},d=function(o,t){return!s.hasClass("ajax-submitted")&&(s.addClass("ajax-submitted"),a.showHumaneSuccessBox("Updating"),void e.ajax({url:o,type:"POST",data:t,cache:!1,success:function(e,o,r){s.removeClass("ajax-submitted"),a.showHumaneSuccessBox("Success"),l(t)},error:function(e,r,i){s.removeClass("ajax-submitted"),console&&console.error&&(console.error('[x] Error: Sending Data to POST "'+o+'"'),console.error(t),console.error(arguments)),a.showHumaneErrorBox("Error, please try again!")}}))};switch(t&&(console.log("[*] ajaxCommandByKeyBoard: Key="+r),console.log(arguments),console.log(this)),r){case 13:if(t&&console.log("Enter Pressed!"),!n)throw"Not implement outside internal yet.";var m={};m[s.attr("name")]=e.trim(s.val()),d(n,m);break;case 27:t&&console.log("ESC Pressed!"),l()}},clickUpdateCancelBtn:function(o){if("read"===this.options.mode){var t=e(o.target),r=t.closest(".update-on-read-mode");if(r.length){var a=r.find(".field-container");a.fadeOut("slow",function(){var e=r.find(".uneditable-input");e.fadeIn("slow",function(){r.removeClass("ajax"),a.addClass("force-hide")})})}}},clickUpdateSubmitBtn:function(o){if("read"===this.options.mode){var t=e(o.target);if(t.hasClass("ajax-submitted"))return!1;t.addClass("ajax-submitted");var r,i,n,s=this,l={},d=this.options.internal,m=d?"/form/edit?id="+this.options.formData._id.$oid:null,p=function(i,n,l){t.addClass("ajax-submitted"),a.showHumaneSuccessBox("Updating"),e.ajax({url:i,type:"POST",data:n,cache:!1,success:function(e,i,n){t.removeClass("ajax-submitted"),a.showHumaneSuccessBox("Success"),l&&r.closest(".update-on-read-mode").find(".uneditable-input").html(l),s.clickUpdateCancelBtn(o)},error:function(e,o,r){t.removeClass("ajax-submitted"),console&&console.error&&(console.error('[x] Error: Sending Data to POST "'+i+'"'),console.error(n),console.error(arguments)),a.showHumaneErrorBox("Error, please try again!")}})},c=t.closest(".field-container");c.hasClass("radio-container")?(r=c.find(":radio:checked"),i=e.trim(r.val()),n=r.attr("data-radio-value"),l[r.attr("name")]=i,p(m,l,n)):(r=c.find(":input"),i=e.trim(r.val()),l[r.attr("name")]=i,p(m,l,i))}}});return l});