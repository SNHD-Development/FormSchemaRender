define(["jquery","underscore","backbone","vm","select2helper","bootstrap","jquery.select2","jquery.spinner","jquery.birthdaypicker","jquery.placeholder","jquery.expose","jquery.zclip","jquery.stupidtable","xdr"],function($,_,Backbone,Vm,Select2Helper){function setValueDependOn(e,t,n){_.each(t,function(t){n.fields[t.name]&&($(e).on("visibleOnRenderComplete",':input[name="'+t.name+'"]',function(){var e=$(this);!e.is(":radio")&&!e.is(":checkbox")?e.val(n.fields[t.name]).trigger("change"):e.val()===n.fields[t.name]&&e.prop("checked",!0)}),$(':input[name="'+t.options.visibleon.name+'"]').trigger("change"))})}return{renderError:function(e,t){e.html('<div class="alert alert-danger"><i class="icon-wrench"></i> <strong>Error: Please refresh this page and try again.</strong> <br> '+t+"</div>")},checkBrowser:function(){if(/MSIE (\d+\.\d+);/.test(navigator.userAgent)){var e=parseInt(RegExp.$1);e<7&&(e=7),$("body").addClass("ie"+e)}},setupOldBrowser:function(){Object.keys=Object.keys||function(e){var t=[],n;for(n in e)e.hasOwnProperty(n)&&t.push(n);return t},Array.prototype.indexOf||(Array.prototype.indexOf=function(e,t){for(var n=t||0,r=this.length;n<r;n++)if(this[n]===e)return n;return-1}),Array.prototype.forEach||(Array.prototype.forEach=function(e,t){for(var n=0,r=this.length;n<r;n++)n in this&&e.call(t,this[n],n,this)})},ucwords:function(e){return(e+"").replace(/^([a-z\u00E0-\u00FC])|\s+([a-z\u00E0-\u00FC])/g,function(e){return e.toUpperCase()})},parseTemplateString:function(e){var t=/\w+=\{\{(\w|\.)+\}\}/ig;return e.match(t)},parseTemplateStringGet:function(e){var t=/\w+=(\w|\.)+/ig;return e.match(t)},checkRequireFields:function(e,t){var n;switch(e.type.toLowerCase()){case"multifiles":n=e.name+"[]";if(typeof t[n]!="undefined"&&t[n].required)return!0;return!1;case"address":n=e.name+"_address_street";if(typeof t[n]!="undefined"&&t[n].required)return!0;n=e.name+"_address_city";if(typeof t[n]!="undefined"&&t[n].required)return!0;n=e.name+"_address_state";if(typeof t[n]!="undefined"&&t[n].required)return!0;n=e.name+"_address_zip";if(typeof t[n]!="undefined"&&t[n].required)return!0;n=e.name+"_address_country";if(typeof t[n]!="undefined"&&t[n].required)return!0;return!1;case"fullname":n=e.name+"_fullname_middle_name";if(typeof t[n]!="undefined"&&t[n].required)return!0;n=e.name+"_fullname_first_name";if(typeof t[n]!="undefined"&&t[n].required)return!0;n=e.name+"_fullname_last_name";if(typeof t[n]!="undefined"&&t[n].required)return!0;return!1}return typeof t[e.name]!="undefined"&&t[e.name].required?!0:!1},preValidate:function(e,t){var n=$(e.currentTarget),r=n.attr("name"),i=n.is(":file"),s;s=i?n.val():$.trim(n.val()),i||(n.hasClass("tolowercase")&&(s=s.toLowerCase(),s=s.replace(/^([0-9]\w+)|\s+([0-9]\w+)/g,function(e){return e.toUpperCase()}),s=s.replace(/^(us\s)|\s+(us)\s/gi,function(e){return e.toUpperCase()})),n.hasClass("toucwords")?s=this.ucwords(s):n.hasClass("touppercase")&&s.toUpperCase&&(s=s.toUpperCase()),n.hasClass("allowedonespace")&&s.replace&&(s=s.replace(/ +(?= )/g,"")),n.val(s).trigger("change")),t.set(r,s),t.isValid(r,s)?n.removeClass("invalid"):n.addClass("invalid")},setupPlaceHolder:function(e){$("input, textarea",e).placeholder()},setupFileInput:function(e){$(":file",e).trigger("change")},setupEmailInput:function(e){$(".emailpicker",e).each(function(){var e=$(".emailpicker_server",this),t=$(".emailpicker_username",this),n=$(':input[type="hidden"]',this),r=$(".not_sending",this);typeof e.attr("data-value")!="undefined"&&e.attr("data-value")&&e.val(e.attr("data-value")).trigger("change");if(n.val()!==""){var i=n.val().split("@");i.length===2&&(t.val(i[0]).trigger("change"),e.val(i[1]).trigger("change"))}$(".emailpicker_server, .emailpicker_username",this).on("change",this,function(r){t.val()!==""&&e.val()!==""?n.val($.trim(t.val()+"@"+e.val())).trigger("change"):n.val("").trigger("change")}).on("keydown",function(e){if(e.keyCode===32)return e.preventDefault(),!1})})},setupBDateInput:function(e,t){$(".birthdaypicker",e).each(function(){$(this).birthdaypicker($(this).attr("data-options"));var e=$(':input[type="hidden"]',this),n,r,i,s,o=e.val();o!==""&&t.get(e.attr("name"))!==""&&(n=o.split("/"),n.length===3&&(n[0][0]==="0"&&(n[0]=n[0].substr(1)),n[1][0]==="0"&&(n[1]=n[1].substr(1)),r=$(".birth-month",this).val(n[0]),i=$(".birth-day",this).val(n[1]),s=$(".birth-year",this).val(n[2]),t.set(r.attr("name"),n[0]),t.set(i.attr("name"),n[1]),t.set(s.attr("name"),n[2])))})},setHiddenField:function(e){$(':hidden[data-value!=""]',e).each(function(){var e=$(this);typeof e.attr("data-value")!="undefined"&&e.attr("data-value")&&e.val(e.attr("data-value")).trigger("change")})},getBDateinput:function(e,t){$("fieldset.birthday-picker",e).each(function(){var e=/NaN/i,n=$(':input[type="hidden"]',this),r=$(".not_sending.birth-day",this),i=$(".not_sending.birth-month",this),s=$(".not_sending.birth-year",this),o=parseInt(r.val()),u=parseInt(i.val()),a=parseInt(s.val()),f=!1,l;String(o).match(e)&&(r.val(""),f=!0),String(u).match(e)&&(i.val(""),f=!0),String(a).match(e)&&(s.val(""),f=!0),f?n.val(""):(u<10&&(u+=0+u),o<10&&(o+=0+o),l=u+"/"+o+"/"+a,n.val()),t.set(n.attr("name"),n.val())})},getUserId:function(e,t){var n=$(".select2-offscreen",e);n.each(function(){var e=$(this);t.set(e.attr("name"),e.val()).trigger("change")})},getDefaultValues:function(e){$(".has-default-val",e).each(function(){var e=$(this);if(e.is(":disabled"))return;e.val()===""?e.trigger("change"):e.hasClass("data-clean")&&e.trigger("change").removeClass("data-clean")})},setupDateInput:function(el,view){var fViewArr;view&&view.formView&&view.formView._DatePickerLogicArr&&(fViewArr=view.formView._DatePickerLogicArr),$(".datepicker",el).each(function(){var _options={},maxDate,nowTemp,$this=$(this),_id=$(this).attr("name");if(fViewArr&&fViewArr[_id]){var logicOpts=fViewArr[_id];if(!logicOpts.getvaluefrom)throw'In order to use setupDateInput with "DatepickerOptions". Required to have "GetValueFrom" key!';if(!logicOpts.comparison)throw'In order to use setupDateInput with "DatepickerOptions". Required to have "Comparison" key!';_options.onRender=function(date){var targetDate=logicOpts.getvaluefrom;if(!fViewArr[targetDate]||!fViewArr[targetDate].element)throw'Could not be able to find Datepicker Object with "'+targetDate+'"!';var _cmd;if($this.attr("data-maxdate")){var _today=new Date;_cmd=fViewArr[targetDate].element.date.valueOf()+" "+logicOpts.comparison+"  "+date.valueOf()+" || "+date.valueOf()+"  > "+_today.getTime()+" ? 'disabled' : ''"}else if($this.attr("data-mindate")){var _today=new Date;_cmd=fViewArr[targetDate].element.date.valueOf()+" "+logicOpts.comparison+"  "+date.valueOf()+" || "+date.valueOf()+"  < "+_today.getTime()+" ? 'disabled' : ''"}else _cmd=fViewArr[targetDate].element.date.valueOf()+" "+logicOpts.comparison+" "+date.valueOf()+" ? 'disabled' : ''";return eval(_cmd)},fViewArr[logicOpts.getvaluefrom]||(fViewArr[logicOpts.getvaluefrom]={}),fViewArr[logicOpts.getvaluefrom].changeDate=function(ev){var targetDate=_id,tmpComp=logicOpts.comparison.substr(0,1),newDate=new Date(ev.date),logic=ev.date.valueOf()+" "+tmpComp+" "+fViewArr[targetDate].element.date.valueOf();eval(logic)?$("#"+targetDate).datepicker("setValue",newDate):$this.val()===""?$this.attr("logic-date",newDate.getTime()):(newDate=new Date($this.val()),$this.datepicker("setValue",newDate),$this.removeClass("invalid").trigger("change"))}}else{if($this.attr("data-maxdate"))switch($this.attr("data-maxdate").toLowerCase()){case"today":nowTemp=new Date,maxDate=new Date(nowTemp.getFullYear(),nowTemp.getMonth(),nowTemp.getDate(),0,0,0,0),_options.onRender=function(e){return e.valueOf()>maxDate.valueOf()?"disabled":""}}if($this.attr("data-mindate"))switch($this.attr("data-mindate").toLowerCase()){case"today":nowTemp=new Date,maxDate=new Date(nowTemp.getFullYear(),nowTemp.getMonth(),nowTemp.getDate(),0,0,0,0),_options.onRender=function(e){return e.valueOf()<maxDate.valueOf()?"disabled":""}}}var $dpicker=$this.datepicker(_options).on("changeDate",function(e){var t=$(e.currentTarget),n=t.attr("id");fViewArr&&fViewArr[n]&&fViewArr[n].changeDate&&typeof fViewArr[n].changeDate=="function"&&fViewArr[n].changeDate(e),t.removeClass("invalid").trigger("change"),t.datepicker("hide")}).on("click",function(e){var t=$this.attr("logic-date"),n=$this.val(),r=$(e.currentTarget);t&&t!==""&&!n&&n===""&&r.datepicker("setValue",t),$("div.datepicker.dropdown-menu").css("display","none"),r.datepicker("show")});$dpicker=$dpicker.data("datepicker"),fViewArr&&(fViewArr[_id]||(fViewArr[_id]={element:null}),fViewArr[_id].element=$dpicker)})},setupSpinner:function(e,t){t=t||null,$(".spinner",e).each(function(){var e=$(":input.spinner-input",this),n=e.attr("data-default-value")!==undefined?e.attr("data-default-value"):1,r=e.val()!==""?e.val():n;t&&t==="create"&&r==="0"&&(r="1");var i={value:parseInt(r,10),min:n};$(this).spinner(i)})},preventSpace:function(e){if(e.keyCode===32)return e.preventDefault(),!1},allowNumber:function(e){var t=$(e.currentTarget).val();if(e.keyCode===8||e.keyCode===37||e.keyCode===39||e.keyCode===46||e.keyCode===9)return!0;(e.shiftKey||(e.keyCode!==46&&e.keyCode!==190&&e.keyCode!==110||t.indexOf(".")!==-1)&&(e.keyCode<48||e.keyCode>57&&e.keyCode<96||e.keyCode>105))&&e.preventDefault()},allowRational:function(e){var t=$(e.currentTarget).val();if(e.keyCode===8||e.keyCode===37||e.keyCode===39||e.keyCode===46||e.keyCode===9)return!0;(e.keyCode!==45&&e.keyCode!==109&&e.keyCode!==189||t!=="")&&(e.shiftKey||(e.keyCode!==46&&e.keyCode!==190&&e.keyCode!==110||t.indexOf(".")!==-1)&&(e.keyCode<48||e.keyCode>57&&e.keyCode<96||e.keyCode>105))&&e.preventDefault()},allowNaturalNumber:function(e){if(e.keyCode===8||e.keyCode===37||e.keyCode===39||e.keyCode===46||e.keyCode===9)return!0;(e.shiftKey||e.keyCode!==46&&e.keyCode!==110&&(e.keyCode<48||e.keyCode>57&&e.keyCode<96||e.keyCode>105)||e.keyCode===48&&$(e.currentTarget).val().length===0)&&e.preventDefault()},allowZipCode:function(e){if(e.keyCode===8||e.keyCode===37||e.keyCode===39||e.keyCode===46||e.keyCode===9)return!0;(e.shiftKey||e.keyCode<48||e.keyCode>57&&e.keyCode<96||e.keyCode>105)&&e.preventDefault()},allowZipCodePlusFour:function(e){var t=$(e.target),n=t.val(),r="";if(e.type==="keydown"&&e.keyCode>=48&&e.keyCode<=57||e.keyCode>=96&&e.keyCode<=105){switch(n.length){case 0:if(e.keyCode===48||e.keyCode===105){e.preventDefault();return}break;case 5:t.val(n+"-")}e.update&&t.val(t.val()+String.fromCharCode(e.keyCode))}else{for(var i=0,s=n.length;i<s;i++)isNaN(parseInt(n[i]))||(r+=n[i]);n="";for(var i=0,s=r.length;i<s;i++){switch(i){case 5:s>6&&(n+="-")}n+=r[i]}t.val(n)}},getHumanTime:function(e){var t=typeof e!="object"?new Date(e*1e3):new Date(e.$date),n=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],r=t.getFullYear(),i=n[t.getMonth()],s=t.getDate(),o=t.getHours(),u=t.getMinutes(),a=t.getSeconds(),f="AM";return o>=12&&(o-=12,o===0&&(o=12),f="PM"),o<10&&(o="0"+o),u<10&&(u="0"+u),a<10&&(a="0"+a),i+" "+s+", "+r+" "+o+":"+u+":"+a+" "+f},getSpecialFieldsName:function(e,t){var n=[];switch(t.toLowerCase()){case"fullname":n.push(e+"_fullname_first_name"),n.push(e+"_fullname_middle_name"),n.push(e+"_fullname_last_name");break;case"address":n.push(e+"_address_street"),n.push(e+"_address_city"),n.push(e+"_address_state"),n.push(e+"_address_zip"),n.push(e+"_address_country");break;default:n.push(e)}return n},setFieldsValues:function(e,t,n,r){r=r||!1,_.each(n,function(n,i){var s=r&&r[i]?r[i]:"",o=$(':input[name="'+n+'"]',e).val(s).trigger("change");t.set(n,s),t.isValid(n)&&o.removeClass("invalid")})},setupClassAttr:function(e,t){e=e||!1,t=t||"",t.toLowerCase();if(e){e=e.toLowerCase();var n=new RegExp(t,"i");return n.test(e)?e:e+" "+t}return t},finalSetup:function(e){var t=this,n=$("select.has-default-val",e.el),r=$(e.el);e.options.mode==="update"&&e._visibleOn.length>0&&e.options.formData&&setValueDependOn(e.el,e._visibleOn,e.options.formData),e.options.mode==="create"&&n.length>0&&n.each(function(){var e=$('option[selected=""],option[selected="selected"]',this);e.length>0&&e.val()!==""?$(this).val(e.val()):$(this).hasClass("us-state")?$(this).val("NV"):$(this).hasClass("us-country")&&$(this).val("US")}),e._multiFiles.length>0&&_.each(e._multiFiles,function(n){require(["views/file-upload/multifiles"],function(r){var i=Vm.create(t,"MultiFilesView"+n.name,r,{field:n,name:e.el,model:e.model,validation:e.options.formSchema.validation});i.render()})}),$("a[rel^=lightbox], area[rel^=lightbox], a[data-lightbox], area[data-lightbox]").each(function(){var e=$(this);$("<img>",{src:e.attr("href"),error:function(){e.hide(),e.next(".btn").show()}})}),e._ajaxDataCall.length>0&&this.setupAjaxCall(e,r),e._hasUserId&&this.setupUserIdAjaxCall(r),e._hasBooleanInput&&this.setupBooleanInput(r,e),e._hasRadioBtnGroup&&(this.setupRadioBtnGroup(r),this.setupRadioBtnGroupValue(r)),(e._hasSelectAllCheckBox||e._hasClearAllCheckBox)&&this.setupCheckBoxSelectAndClear(r),e._hasOtherTextBox&&this.setupCheckBoxOtherTextBox(r),e._radioFieldName.length&&this.setupRadioButtonsValue(e),e._buttonDecision.length>0&&_.each(e._buttonDecision,function(n){var i=$("a#"+n.name,e.el),s='<input type="hidden" name="'+n.name+'" id="'+n.name+'_btn_condition"/>';if(!n.url||!n.data)throw"ButtonDecision require Url and Data options!";e.options.mode==="update"&&(i.after(s),e.options.formData.fields[n.name]&&i.next('input[type="hidden"]').val(e.options.formData.fields[n.name]).trigger("change"));if(e.options.internal===!0){var o=i.parents(".control-group");return o.length>0?o.hide():i.hide(),!0}i.click(function(i){i.preventDefault();var o=$(i.currentTarget);if(o.attr("disabled"))return!1;var u=n.url+"?",a={},f=!1,l,c=[],h=n.options.datacanempty?n.options.datacanempty:[],p=n.options.events||function(i){var u=$("#"+n.name+"_btn_condition",r);if(i.status&&i.status==="error")return o.attr("disabled",!1).popover("destroy"),o.next(".popover").remove(),l={html:!0,placement:"top",trigger:"manual",title:'<i class="icon-edit"></i> Error',content:i.error_message},o.attr("disabled",!0).popover(l).popover("show"),window.setTimeout(function(){o.attr("disabled",!1).popover("destroy"),o.next(".popover").remove()},3e3),!1;if(!i.value)throw'Result JSON must have "value" key';u.length===0&&o.after(s),n.options.renderresult&&i.data?(e.model.set(n.name,""),require(["views/subform-layouts/buttondecision"],function(r){var s=Vm.create(t,n.name+"View",r,{model:e.model,el:o,name:n.name});s.render(i.data)})):(o.parent().find("div.btn-decision-data-wrapper").remove(),e.model.set(n.name,i.value)),window.setTimeout(function(){o.attr("disabled",!1).popover("destroy"),o.next(".popover").remove()},1e3)};_.each(n.data,function(n,r){if(typeof n!="string"){typeof f=="boolean"&&(f=[]);var i;_.each(n,function(n,r){i=t.setUpButtonDecision(n,r,a,e.el,h,c)}),f.push(i)}else f=t.setUpButtonDecision(n,r,a,e.el,h)}),typeof f!="boolean"&&f.indexOf(!1)>-1&&(f=!1);if(f)return l={html:!0,placement:"top",trigger:"manual",title:'<i class="icon-edit"></i> Error',content:"Please correct the form"},o.attr("disabled",!0).popover(l).popover("show"),window.setTimeout(function(){o.attr("disabled",!1).popover("destroy"),o.next(".popover").remove()},2e3),!1;_.each(c,function(e){e.removeClass("invalid")}),u+=$.param(a);var d,v;switch(e.options.lang){case"sp":d="Por Favor Espere",v="Bajando Informaci&oacute;n";break;default:d="Please wait",v="Loading data"}l={html:!0,placement:"top",trigger:"manual",title:'<i class="icon-time"></i> '+d+".",content:'<i class="icon-spinner icon-spin icon-large"></i> '+v+" ..."},o.attr("disabled",!0).popover(l).popover("show"),$.getJSON(u,p)})})},isRenderVisibleOn:function(e,t,n){if(t.options.visibleon&&n!=="html"){var r=t.options.visibleon.name;r.match(/\[\]$/gi)&&(r=r.substr(0,r.length-2));if(_.isArray(e.options.formData.fields[r])){var i=!1;_.each(e.options.formData.fields[r],function(e){if(i)return;i=t.options.visibleon.values.indexOf(e)!==-1});if(!i)return!1}else{var s;e._lookupValues&&e._lookupValues[r]?s=e._lookupValues[r].value:s=e.options.formData.fields[r];if(t.options.visibleon.values.indexOf(s)===-1)return!1}}return!0},finalReadSetup:function(e){var t=$(e.el);e._buttonClipboards.length>0&&_.each(e._buttonClipboards,function(e){$("button#"+e.name).zclip({path:"//public.southernnevadahealthdistrict.org/assets/js/apps/formrender/libs/copy/ZeroClipboard.swf",copy:function(){var t="";return _.each(e.values,function(e){t+=$("#"+e).text()+"\r\n"}),t}})}),$("a[rel^=lightbox], area[rel^=lightbox], a[data-lightbox], area[data-lightbox]").each(function(){var e=$(this);$("<img>",{src:e.attr("href"),error:function(){e.hide(),e.next(".btn").show()}})});var n=$('[data-popover-confirm^="{"]',e.el);n.length&&(t.on("click",".btn-confirmed",function(e){e.preventDefault();var t=$(this);_yes=t.attr("data-href")||!1;if(!_yes){n.each(function(e){$(this).popover("hide")});return}n.each(function(e){$(this).popover("destroy")}),window.location=_yes}),n.each(function(e){var t=$(this),r=$.parseJSON(t.attr("data-popover-confirm"));t.popover(r).click(function(t){t.preventDefault(),n.each(function(t){if(t===e)return;$(this).popover("hide")})})})),t.on("click",".btn-auto-refresh",function(e){var t=$(e.target).attr("data-refresh-delay");e.stopPropagation(),setTimeout(function(){location.reload()},t)});var r=$("table.stupidtable").stupidtable();r.length&&r.on("aftertablesort",function(e,t){var n=$(this).find("th");n.find(".dir-icon").remove();var r=t.direction==="asc"?"icon-arrow-up":"icon-arrow-down";n.eq(t.column).append('<i class="dir-icon '+r+'" style="position:relative; left: 10px; top: -3px;"></i>')}),$(".select-tags").each(function(){var e=$(this),t=0;e.find("li").each(function(){var e=$(this),n=e.width();n>t&&(t=n)}).width(t)})},isRenderReadMode:function(e,t){var n=t.type.toLowerCase();if(t.options.internal&&t.options.internal!==e.options.internal)return!1;if(n==="buttonclipboard")return!0;if(e.options.formData.fields[t.name]==="")return!1;if(n==="fullname"){var r=this.getSpecialFieldsName(t.name,t.type),i=!1;return _.each(r,function(t){!i&&e.options.formData.fields[t]&&e.options.formData.fields[t]!==""&&(i=!0)}),i}if(typeof e.options.formData.fields[t.name]=="undefined")switch(n){case"fieldsetstart":case"fieldsetend":case"html":case"action":case"submit":case"clear":case"address":break;case"button":var s=t.description.toLowerCase();if(e.options.internal&&e.options.mode==="read"&&s==="delete"&&e.options.formSchema.deleteenabled){if(!e.options.formData.createddate.$date)throw'In order to used "DeleteEnabled", form data must have "CreatedDate".';if(e.options.formSchema.deleteenabled.fieldexists){var o=e.options.formSchema.deleteenabled.fieldexists;if(!e.options.formData.fields[o])return!1}if(e.options.formSchema.deleteenabled.afterxdays){var u=new Date,a=new Date(e.options.formData.createddate.$date),f=this.calculateDateDiffByDays(u,a);if(f<e.options.formSchema.deleteenabled.afterxdays)return!1}}break;default:return!1}return!0},resetPlaceHolderValue:function(e){_isSetting=$(":input.placeholder",e),_isSetting.each(function(){var e=$(this);e.attr("placeholder")===e.val()&&e.val("")})},createHiddenForm:function(e){require(["views/hiddenForm"],function(t){var n=Vm.create({},"FormView",t);n.render(e)})},setupAjaxCall:function(e,t){_.each(e._ajaxDataCall,function(e){var n=e.type.toLowerCase(),r=[],i={};if(typeof e.options.data=="undefined")throw"In order to use ajax call, we need Options.Data.";_.each(e.options.data,function(e){_.each(e,function(e){i[e]=""})});switch(n){case"fullname":r.push(e.name+"_fullname_first_name"),r.push(e.name+"_fullname_middle_name"),r.push(e.name+"_fullname_last_name");break;default:r.push(e.name)}_.each(r,function(n){t.on("change",':input[name="'+n+'"]',function(t){var r=$(this),s=r.val(),o=!1;s!==""&&(i[n]=s),_.each(i,function(e,t){e===""&&(o=!0)});if(!o){var u={},a=e.options.url+"?";_.each(e.options.data,function(e){_.each(e,function(e,t){u[t]=i[e]})}),$.getJSON(a+$.param(u),function(e){e.data&&_.each(e.data,function(e,t){if(typeof i[t]=="undefined"){var n=$(':input[name="'+t+'"]').val(e).trigger("change"),r;if(n.attr("type")==="hidden"){r=n.parent(".emailpicker");if(r.length>0){var s=e.split("@");$(":input.not_sending",r).each(function(e,t){$(t).val(s[e])})}}}})})}})})})},setUpButtonDecision:function(e,t,n,r,i,s){i=i||[],s=s||!1;var o=$("#"+e),u=o.parent(".birthday-picker"),a,f=!1,l;u.length>0&&(a=$(".not_sending",u).trigger("change"));var c=o.val();if(c!==""&&c.search(/NaN/)===-1||i.indexOf(t)>-1)n[t]=c;else{f=!0,l=$(':input[name="'+e+'"]',r).addClass("invalid"),s&&s.push(l);if(u.length>0){var h=c.split("/");_.each(h,function(e,t){e==="NaN"&&(l=$(a[t]).addClass("invalid"),s&&s.push(l))})}}return f},setupUrlAjaxCall:function(e,t,n){t=t||null,n=n||null;var r=t?t:$(":input[data-url]"),i=this;if(r.length===0||!r.attr("data-url"))return;r.each(function(){var t=$(this),s=t.attr("data-url"),o=i.parseTemplateString(s);if(o){var u=i.parseTemplateStringGet(s);if(u){var a={};_.each(u,function(e){var t=e.split("=");if(t.length!==2)return;a[t[0]]=t[1]})}if(!t.select2)throw'Error: select2 is not yet loaded. Please refresh this page again! (Setup "'+t.attr("id")+'"")';if(n){var f=n.get(t.attr("name"));f&&f!==""&&t.attr("data-select-value",f)}var l='<input type="hidden" name="'+t.attr("name")+'" id="'+t.attr("id")+'" class="'+t.attr("class")+' has-select2-dynamic" />',c=t.attr("data-select-key-value"),h=t.attr("data-select-key-text"),p=t.attr("data-select-value");t.replaceWith(l),t=$(':input[name="'+t.attr("name")+'"]'),p&&t.val(p);var d={url:s.match(/^(\w|\.|\/|:)+\(?/ig).shift(),data:function(e,t){var n=a||{};return _.each(o,function(t){var r=t.split("="),i=r.pop().replace(/(\{\{|\}\})/ig,""),s;switch(i){case"this":s=e;break;default:var o=$(':input[name="'+i+'"]');s=o.val()}n[r]=s}),n},results:function(e,n){if(c||h){var r=[];_.each(e,function(e){var n={};c&&h?(n.id=e[c],n.text=e[h]):c?(n.id=e[c],n.text=e.text):h&&(n.id=e.id,n.text=e[h]),_.isEmpty(n)||(t.hasClass("tolowercase")&&n.id&&n.text&&n.id.toLowerCase&&n.text.toLowerCase&&(n.id=n.id.toLowerCase()),r.push(n))}),e=r}return{more:!1,results:e}}},v={placeholder:"--- Please Select ---",minimumInputLength:3,initSelection:function(e,t){p&&$.ajax({url:d.url,data:d.data(p),success:function(e,n,r){if(e.length===1){var i=e.pop(),s={};c&&h?(s.id=i[c],s.text=i[h]):c?(s.id=i[c],s.text=i.text):h&&(s.id=i.id,s.text=i[h]),t(s)}else t({id:p,text:p})},error:function(e,n,r){t({id:p,text:p})}})},ajax:d};t.select2(v)}else if(!t.hasClass("send-ajax-request")){t.addClass("send-ajax-request");var m=t.find("option").html();t.find("option").remove(),t.append('<option value="">--- Loading Data ---</option>'),$.ajax({url:s,dataType:"json",success:function(n,s){if(s==="success"){var o='<option value="">'+m+"</option>",u=r.prop("type"),a=[],f=t.attr("data-select-value");switch(u){case"select-one":t.find("option").remove()}_.each(n,function(e){var n;switch(u){case"select-one":_.isObject(e)&&e.id&&e.text?(n=f&&f===e.id?" selected ":"",o+='<option value="'+e.id+'" '+n+">"+e.text+"</option>"):(n=f&&f===e?" selected ":"",o+='<option value="'+e+'" '+n+">"+e+"</option>");break;default:a.push(e[t.attr("id")])}});if(a.length){t.attr({autocomplete:"off"}),t.typeahead({minLength:3,source:a});var l=function(r){t.removeClass("attached-change");var s=t.val(),o=_.find(n,function(e){if(s===e[t.attr("id")])return!0}),u=!0;o&&_.each(o,function(n,r){if(n==="")return;if(typeof n=="object"){if(n.length){var s;_.some(n[0],function(e,t){return s=t.split("_").shift(),!0}),$("#subform_"+s,e).trigger("subform_"+s+".ajaxUpdate",[n])}else if(n.data&&n.view&&n.title){var s;_.some(n.data[0],function(e,t){return s=t.split("_").shift(),!0}),u=!1,require(["views/"+n.view+"AjaxView"],function(o){var u={$form:e,collection:new Backbone.Collection(n.data),id:r+"_AjaxView",$input:t,input_callback:l,title:n.title,listName:s},a=Vm.create(i,"AjaxView",o,u);a.render()})}}else{var o=$(':input[name="'+r+'"]',e);o&&o.val(n).trigger("change")}}),u&&!t.hasClass("attached-change")&&(t.addClass("attached-change"),t.one("change",l))};t.hasClass("attached-change")||(t.addClass("attached-change"),t.one("change",l))}else t.append(o),t.select2({containerCssClass:"span12"}),$("#s2id_"+t.attr("id")+" .select2-drop",e).hide();t.trigger("dataloaded")}},error:function(e,n,r){alert('Error: when trying to request AJAX data to "'+s+'" for "'+t.attr("id")+'". Please try again.')}})}})},setupSelect2:function(e){function t(e,t){e.hasClass("tags")?Select2Helper.renderTags(e,t):Select2Helper.render(e,t)}if(e.el)$(e.el+" .selecttwo-render").each(function(){var n=$(this);t(n,e)});else{var n=e.find(".selecttwo-render");n.length&&t(n,e)}},setupCheckBoxSelectAndClear:function(e){e.on("click",".checkbox-container button",function(e){e.preventDefault();var t=$(e.target),n=t.closest(".checkbox-container"),r=n.find("input:checkbox");t.hasClass("btn-primary")?(r.prop("checked",!0),r.filter(".checkbox-other").click().prop("checked",!0)):(r.prop("checked",!1),r.filter(".checkbox-other").click().prop("checked",!1))})},setupCheckBoxOtherTextBox:function(e){e.on("click",'.checkbox-container input[type="checkbox"].checkbox-other',function(e){var t=$(e.target),n=t.parent().next(".other-textbox");t.is(":checked")?n.removeClass("not_sending").show("slow"):n.addClass("not_sending").hide("slow")})},setupBooleanInput:function(e,t){e.on("click",".form-render_booleaninput button",function(e){var t=$(this),n=t.attr("data-value"),r=t.attr("data-id"),i;$("#"+r,t.parent()).removeClass("invalid").val(n).trigger("change"),i='<span class="text-'+(n==="true"?"success":"error")+'">'+t.html()+"<span>",t.parent().next().html(i).show("slow")});var n=$('.form-render_booleaninput input[type="hidden"]',e);n.each(function(){var e=$(this),t=e.val();if(t==="")return;switch(t){case"true":e.parent().find("button.btn-yes").click();break;case"false":e.parent().find("button.btn-no").click()}})},setupRadioBtnGroup:function(e){e.on("click",".radio-container button",function(e){e.preventDefault();var t=$(e.target),n=t.attr("value"),r=t.closest(".radio-container"),i=r.find('input[type="hidden"]');i.val(n).trigger("change"),r.find(".radio-value-render").html(n).show("slow")});var t=e.find(".radio-container");t.each(function(){var e=$(this),t=e.find('input[type="hidden"]'),n=$.trim(t.val());if(n==="")return;e.find('button[value="'+n+'"]').trigger("click")})},setupRadioBtnGroupValue:function(e){var t=$(".radio-container input.has-default-val",e);t.each(function(){var e=$(this),t=e.closest(".radio-container").find('button[value="'+e.val()+'"]');t?t.addClass("active"):e.val(""),e.removeClass("has-default-val")})},setupUserIdAjaxCall:function(e){var t="/user?$filter=Username eq ",n=$(":input.userid-lookup",e),r=this;n.each(function(){var e=$(this);e.is("select")?e.is("[data-url]")?$.getJSON(e.attr("data-url"),function(t,n){if(n==="success"){var i="";_.each(t,function(e){i+='<option value="'+e.Id+'">'+e.Username+"</option>"}),e.append(i),e.select2({containerCssClass:"span12"}).on("change",function(t){t.val&&t.val!==""&&e.removeClass("invalid")})}else r.setUpErrorNotice(e,"Please refresh this page!",1e4)}):e.select2({containerCssClass:"span12"}):$(this).change(function(e){var n=$(this),i=n.val(),s=n.attr("data-url")||t,o={dataType:"json",complete:function(e,t){n.removeAttr("data-send");if(n.hasClass("invalid"))return;if(t==="success"){var i=$.parseJSON(e.responseText);switch(typeof i){case"boolean":i&&(n.addClass("invalid").val(""),r.setUpErrorNotice(n,'Username "'+n.val()+'" is already existed!'))}}else r.setUpErrorNotice(n,"Could not get information!")}};if(i==="")return;s.search(/\?/)===-1&&(s+="?"),typeof username!="undefined"&&(o.username=username,o.password=password);if(n.is("[data-url-data]")){var u="",a=$.parseJSON(n.attr("data-url-data"));_.each(a,function(e,t){u+=t+"="+$(':input[name="'+e+'"]').val()+"&"}),u=encodeURI(u.substr(0,u.length-1)),s+=u}o.url=s,n.is("[data-send]")||(n.attr("data-send",!0),$.ajax(o))})})},setupAddressEvent:function(e,t){var n=$("form",e);n.on("change",".country",function(e){e.preventDefault();var t=$(this),n=t.parentsUntil("form","div.address-fieldset"),r=n.find("select.us-state"),i=n.find("input.us-state"),s=n.find("input.postal-code");_val=t.val();if(_val===t.attr("data-value"))return;t.attr("data-value",_val);switch(_val){case"":case"US":r.is(":hidden")&&i.attr("disabled",!0).hide("slow",function(){r.attr("disabled",!1).show("slow")}),s.hasClass("allowzipcodeplusfour")||s.addClass("allowzipcode").attr("maxlength",5);break;default:i.is(":hidden")&&r.attr("disabled",!0).hide("slow",function(){i.attr("disabled",!1).val("").show("slow"),i.is("[data-default-value]")&&i.val(i.attr("data-default-value")).removeAttr("data-default-value")}),s.removeClass("allowzipcode").removeAttr("maxlength")}});if(t.options.mode==="update"){var r=$("div.address-fieldset",n);r.each(function(){var e=$(this);$(".country",this).trigger("change")})}},setUpErrorNotice:function(e,t,n,r){r=r||"en",n=n||3e3,t=t||"";var i,s;switch(r){case"sp":i="Error",s="Por favor, vuelve a intentarlo";break;default:i="Error",s="Please try again."}_opt={html:!0,placement:"top",trigger:"manual",title:'<i class="icon-edit"></i> '+i+".",content:'<i class="icon-spinner icon-spin icon-large"></i> '+s+" ..."+(t!==""?"<br>"+t:"")},e.attr("disabled",!0).popover(_opt).popover("show"),window.setTimeout(function(){e.attr("disabled",!1).popover("destroy"),e.next(".popover").remove()},n)},parseInternalFieldsBeforeSubmit:function(e,t){var n;if(!t.length)return;_.each(t,function(t){var r=$(':input[name="'+t+'"]',e);if(!r.length)return;n=t.match(/\[\]$/gi),n?n=t.substr(0,t.length-2)+"_internal[]":n=t+"_internal",r.attr("name",n)})},setupPopover:function(e){var t=$('[data-toggle="popover"]',e);t.popover()},destroyPopover:function(e){var t=$('[data-toggle="popover"]',e);t.popover("destroy")},calculateDateDiffByDays:function(e,t){var n=864e5,r=e.getTime(),i=t.getTime(),s=Math.abs(r-i);return Math.round(s/n)},convertDataToArrayString:function(e){var t=["value-as-array"];_.each(t,function(t){var n=$(":input."+t,e);n.each(function(){var e=$(this),t=n.val();t&&t!==""?t=t.split(","):t=[],e.val(JSON.stringify(t))})})},convertNumberToDecimal:function(e){e.find(":input[data-decimal]").each(function(){var e=$(this),t=e.val(),n=parseInt(e.attr("data-decimal"),10);t*=Math.pow(10,n),e.val(parseInt(t,10))})},setupRadioButtonsValue:function(e){if(!e.options.formData||!e.options.formData.fields)return;_.each(e._radioFieldName,function(t){if(!e.options.formData.fields[t])return;$(':radio[value="'+e.options.formData.fields[t]+'"]').attr("checked",!0).trigger("change")})},setModelRadioValues:function(e,t){t=t||null;var n=e.find(":radio:checked");if(!n.length)return;n.each(function(){var e=$(this);e.attr("checked",!0).trigger("change");if(t.model){var n=e.attr("name"),r=e.val();t.model.set(n,r)}})},setModelCheckValues:function(e,t){t=t||null;var n=e.find(":checkbox:checked");if(!n.length)return;n.each(function(){var e=$(this);e.attr("checked",!0).trigger("change");if(t.model){var n=e.attr("name"),r=e.val();t.model.set(n,r)}})},formatAMPM:function(e){var t=e.getHours(),n=e.getMinutes(),r=t>=12?"PM":"AM";t%=12,t=t?t:12,n=n<10?"0"+n:n;var i=t+":"+n+" "+r;return i},addFormSubmittedData:function(e,t){if(e.name&&e.name==="LogEntries"&&t.options.formData.fields){var n={LogMessage:"Form submitted",LogTime:t.options.formData.createddate.$date/1e3,LogUser:t.options.formData.createduser};t.options.formData.fields[e.name]||(t.options.formData.fields[e.name]=[]),t.options.formData.fields[e.name].unshift(n)}},getUserIdFormHtml:function(e){e=e||null;if(!e)return $("#snhd_user_network_login").text().toLowerCase()},shouldRenderWithShowOnStatusOrShowOnMode:function(e,t,n){return e.options.showonstatus&&_.indexOf(e.options.showonstatus,t)<0?!1:e.options.showonmode&&_.indexOf(e.options.showonmode,n)<0?!1:!0},shouldRenderShowOnUser:function(e){if(!e.options||!e.options.showonuser)return!0;if(!_.isArray(e.options.showonuser))throw"In order to use Options.ShowOnUser for "+e.type+' with "'+e.name+'" required an array!';var t=this.getUserIdFormHtml();if(t&&t!==""){var n=/(\w+)$/i,r=t.match(n);if(r&&_.indexOf(e.options.showonuser,r.pop())>-1)return!0}return!1},validateCheckBox:function(e){var t=!0;try{e.find('.checkbox-container[data-check-required="true"]').each(function(){var e=$(this),n=e.find("label.checkbox");e.find(":checked").length?n.removeClass("invalid"):(n.addClass("invalid"),t=!1)})}catch(n){console&&console.log&&(console.log("[x] Error: validateCheckBox"),console.log(n)),t=!1}return t}}});