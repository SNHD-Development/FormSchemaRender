define(["jquery","underscore","backbone","collections/collections","../utils"],function(e,n,a,t,i){var o=!1,s=function(a,i,o){var s,u,d,m=!1,r={},c={},F=!!i.is_internal,f=i.render_mode||!1;return n.each(i.fields,function(p){if(d=!0,p.options=p.options||{},(F||!p.options.internal)&&(!f||!p.options.showonmode||p.options.showonmode.indexOf(f)!==-1)&&(!F||"undefined"==typeof p.options.internalcanupdate||p.options.internalcanupdate)&&!(a.attributes.status&&p.options.showonstatus&&n.indexOf(p.options.showonstatus,a.attributes.status)<0)){switch("undefined"!=typeof i.validation[p.name]&&n.each(i.validation[p.name],function(e,a){var t=["required","length","range","pattern","acceptance","min","max","length"];n.contains(t,a.toLowerCase())&&(delete i.validation[p.name][a],i.validation[p.name][a.toLowerCase()]=e)}),"undefined"!=typeof p.options.internal&&p.options.internal!==o&&(d=!1),u=p.type.toLowerCase()){case"filerepository":case"radio":d=!1}switch(u){case"textarea":a.escapeHtmlInputs.push(p.name)}switch(u){case"booleaninput":r[p.name]="",l(p.name,i,c,""),d&&(a.bindings[p.name]='[name="'+p.name+'"]'),a.on("change:"+p.name,function(e,n){var a={};a[p.name]="true"===n||n===!0||"false"!==n&&n!==!1&&"",e.set(a,{silent:!0})}),a.hasBooleanInput=!0;break;case"multifiles":s=p.name+"[]",r[s]="",m&&console.log("model.parseFields setting ",u,"name",s),"undefined"!=typeof i.validation[p.name]&&(i.validation[s]=n.clone(i.validation[p.name]),delete i.validation[p.name]),l(s,i,c,""),m&&console.log("- multiFilesDefaultValue",a.multiFilesDefaultValue),a.multiFilesDefaultValue[s]||(a.multiFilesDefaultValue[s]=!0);break;case"fraction":s=p.name+"_numerator",r[s]="",l(s,i,c,""),d&&(a.bindings[s]='[name="'+s+'"]'),s=p.name+"_denominator",r[s]="",l(s,i,c,""),d&&(a.bindings[s]='[name="'+s+'"]');break;case"address":var b=p.options.showstreetnumber?"Street Name":"Street";s=p.name+"_address_street",r[s]="",l(s,i,c," ("+b+")"),d&&!p.options.visibleon&&(a.bindings[s]='[name="'+s+'"]'),s=p.name+"_address_city",r[s]="",l(s,i,c," (City)"),d&&!p.options.visibleon&&(a.bindings[s]='[name="'+s+'"]'),s=p.name+"_address_state",r[s]="",l(s,i,c," (State)"),d&&!p.options.visibleon&&(a.bindings[s]='[name="'+s+'"]'),s=p.name+"_address_zip",r[s]="",l(s,i,c," (ZIP)"),d&&!p.options.visibleon&&(a.bindings[s]='[name="'+s+'"]'),s=p.name+"_address_country",r[s]="",l(s,i,c," (Country)"),d&&!p.options.visibleon&&(a.bindings[s]='[name="'+s+'"]'),p.options.showstreetnumber&&(s=p.name+"_address_street_number",r[s]="",l(s,i,c," (Street Number)"),d&&!p.options.visibleon&&(a.bindings[s]='[name="'+s+'"]')),p.options.showunitnumber&&(s=p.name+"_address_unit_number",r[s]="",l(s,i,c," (Unit Number)"),d&&!p.options.visibleon&&(a.bindings[s]='[name="'+s+'"]'));break;case"fullname":("undefined"==typeof p.options.middlename||p.options.middlename)&&(s=p.name+"_fullname_middle_name",r[s]="",l(s,i,c," (Middle Name)"),d&&!p.options.visibleon&&(a.bindings[s]='[name="'+s+'"]')),s=p.name+"_fullname_first_name",r[s]="",l(s,i,c," (First Name)"),d&&!p.options.visibleon&&(a.bindings[s]='[name="'+s+'"]'),s=p.name+"_fullname_last_name",r[s]="",l(s,i,c," (Last Name)"),d&&!p.options.visibleon&&(a.bindings[s]='[name="'+s+'"]');break;case"list":r[p.name]=new t,l(p.name,i,c,""),a.subFormLists.push(p.name);break;case"check":case"checkbox":s=p.name+"[]",r[s]="","undefined"!=typeof i.validation[p.name]&&(i.validation[s]=n.clone(i.validation[p.name]),delete i.validation[p.name]),l(s,i,c,"");break;case"hidden":case"buttonclipboard":case"fieldsetstart":case"fieldsetend":case"fieldset":case"clear":case"action":case"button":case"submit":case"hr":case"html":case"step":a.notBinding.push(p.name);break;case"date":if(p.options.render&&"select"===p.options.render.toLowerCase()){if(r[p.name]="",r[p.name+"_birth[month]"]="",r[p.name+"_birth[day]"]="",r[p.name+"_birth[year]"]="","undefined"!=typeof i.validation[p.name]){c[p.name]=n.clone(i.validation[p.name]);var h=n.clone(i.validation[p.name]);h.mindate&&delete h.mindate,h.maxdate&&delete h.maxdate,c[p.name+"_birth[month]"]=n.clone(h),c[p.name+"_birth[day]"]=n.clone(h),c[p.name+"_birth[year]"]=n.clone(h)}}else r[p.name]="",l(p.name,i,c,"");break;case"email":if(r[p.name]="","undefined"!=typeof i.validation[p.name]&&(c[p.name]=n.clone(i.validation[p.name]),p.options.autocomplete)){var v=n.clone(i.validation[p.name]),g=n.clone(i.validation[p.name]);v.pattern&&"email"===v.pattern&&(v.pattern=/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))$/i,g.pattern=/^((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))$/i),s=p.name+"_username",c[s]=v,s=p.name+"_server",c[s]=g}d&&(a.bindings[p.name]='[name="'+p.name+'"]',p.options.autocomplete&&(s=p.name+"_username",a.bindings[s]='[name="'+s+'"]',s=p.name+"_server",a.bindings[s]='[name="'+s+'"]'));break;case"telephone":r[p.name]="","undefined"!=typeof i.validation[p.name]&&(c[p.name]=n.clone(i.validation[p.name]),c[p.name].required&&(c[p.name].pattern=/^\(\d{3}\) \d{3}-\d{4}$/i)),d&&(a.bindings[p.name]='[name="'+p.name+'"]');break;case"socialsecurity":r[p.name]="","undefined"!=typeof i.validation[p.name]&&(c[p.name]=n.clone(i.validation[p.name]),c[p.name].required&&(c[p.name].pattern=/^\d{3}\-\d{2}-\d{4}$/i)),c[p.name]||(c[p.name]={}),c&&!c[p.name].pattern&&("undefined"==typeof c[p.name].required&&(c[p.name].required=!1),c[p.name].pattern=/(^$|^\d{3}\-\d{2}-\d{4}$)/i),d&&(a.bindings[p.name]='[name="'+p.name+'"]');break;case"userid":r[p.name]="","undefined"!=typeof i.validation[p.name]&&(c[p.name]=n.clone(i.validation[p.name]),c[p.name].pattern||p.options.render&&"select"===p.options.render.toLowerCase()||(c[p.name].pattern="email"));break;case"buttondecision":a.on("change:"+p.name,function(n,a){e("#"+p.name+"_btn_condition").val(a).trigger("change")});default:p.attributes&&p.attributes.value?r[p.name]=p.attributes.value:r[p.name]="",l(p.name,i,c,""),"buttondecision"!==u&&d&&(a.bindings[p.name]='[name="'+p.name+'"]'),"select"===u&&p.options.tags&&(a.bindings[p.name]="#"+p.name)}if(p.options&&p.options.visibleon&&a.bindings[p.name]&&delete a.bindings[p.name],a.bindings[p.name]&&p.options&&p.options.showonstatus)if(a.attributes.status){var _=n.indexOf(p.options.showonstatus,a.attributes.status);_<0&&(delete a.bindings[p.name],c[p.name]&&delete c[p.name])}else delete a.bindings[p.name],c[p.name]&&delete c[p.name]}}),a.validation=c,r},l=function(e,a,t,i){"undefined"!=typeof a.validation[e]&&(t[e]=n.clone(a.validation[e]),a.validation[e].msg&&(t[e].msg=a.validation[e].msg+i))};return a.Model.extend({initialize:function(){var a=this;this.multiFilesDefaultValue={},this.subFormLists=[],this.bindings={},this.notBinding=[],this.escapeHtmlInputs=[],this._listFieldType={};var t=s(this,this.attributes,this.attributes.is_internal);if(this.clear(),this.set(t),this.on("validated:invalid",function(a,t){var i=!1;console&&console.log&&console.log("Invalid Fields",t),i&&(console.log("Check Model Values",a.toJSON()),console.log("Check Model Validation",a.validation),console.log("Check Model MultiFilesDefaultValue",a.multiFilesDefaultValue)),n.each(t,function(n,t){e(':input[name="'+t+'"]').addClass("invalid"),i&&(console.log("- Invalid Value for ",t),console.log(a.get(t)),console.log("- Validation",a.validation[t]),console.log("- MultiFilesDefaultValue",a.multiFilesDefaultValue[t]))})}),o&&this.on("change",function(){var e=!0;e&&(console.log("=== Check Model Change ==="),console.log("[x] Values"),console.log(this.toJSON()),console.log("[x] Binding"),console.log(this.bindings),console.log("[x] MultiFilesDefaultValue"),console.log(this.multiFilesDefaultValue))}),this.escapeHtmlInputs.length){var l={silent:!0};n.each(this.escapeHtmlInputs,function(e){var n="change:"+e;a.on(n,function(){if(a.has(e)){var n=i.htmlspecialchars(a.get(e)),t={};t[e]=n,a.set(t,l)}})})}n.each(this.subFormLists,function(e){if(a&&a.has&&a.has(e)){var n=a.get(e);n&&n.add&&(a._listFieldType[e]=n)}})},setTrim:function(t,i,o){var s;i=e.trim(i),n.isObject(t)||null==t?(s=t,o=i):(s={},s[t]=i),o=o||{},o.trim&&(s[t]=e.trim(s[t])),a.Model.prototype.set.call(this,s,o)},appendSubFormInput:function(a,t,o){o=o||null;var s,l=n.clone(this.toJSON()),u=e("#"+a);e("input.subform_before_submit",u).remove(),n.each(l,function(a,l){if(s=t.indexOf(l)>-1?"_internal":"","undefined"!=typeof a&&a&&"function"==typeof a.toJSON){o&&o[l].fields&&n.each(o[l].fields,function(t){if(t&&t.name&&t.type){t&&(t.options||(t.options={}),t.attributes||(t.attributes={}));var o=t.type.toLowerCase();n.each(a.models,function(a){var s;switch(o){case"number":var l=parseFloat(a.get(t.name));isNaN(l)||a.set(t.name,l);break;case"select":s=e.trim(a.get(t.name)),(t.options&&t.options.tags||t.attributes&&t.attributes.multiple)&&(n.isString(s)&&(s=s.split(",")),s&&s.length&&""===s[0]&&(s=[]),s.sort&&(s=s.sort(i.sortNumber)),a.set(t.name,s));break;case"date":if(s=a.get(t.name),s=n.isString(s)?e.trim(s):s,""===s)s=null;else if(n.isNull(s));else if(s=s&&s.$date?moment(s.$date):moment(s,"MM/DD/YYYY"),!s.isValid())throw alert('Could not be able to parse this date value for "'+t.name+'" with "'+e.trim(a.get(t.name))+'"'),new Error;a.set(t.name,s)}})}});var d=JSON.stringify(a.toJSON());u.prepend('<input type="hidden" name="'+l+s+'" value="" class="subform_before_submit">'),u.find(':input[name="'+l+s+'"]').val(d)}})},triggerError:function(n){if(this.hasBooleanInput){var a=e('.form-render_booleaninput input[type="hidden"].invalid',n.el);a.each(function(){var n=e(this),a='<span class="text-error">Please answer this question.</span>';n.closest(".form-render_booleaninput").next().html(a).show("slow")})}},isSubformValid:function(){var a=this,t=!0;return n.each(this.subFormLists,function(i){a.validation[i]&&n.each(a.validation[i],function(a,o){if(!n.isObject(a)&&t){var s=e('input.subform_before_submit[name="'+i+'"]').val();switch(o){case"required":"[]"!==s&&s||(t=!1)}}})}),t},bindModelBinder:function(e,n){switch(n.toLowerCase()){default:this.bindings[e]='[name="'+e+'"]'}},unbindModelBinder:function(e,n){switch(n.toLowerCase()){default:delete this.bindings[e]}}})});