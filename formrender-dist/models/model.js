define(["jquery","underscore","backbone","collections/collections","../utils"],function(e,t,n,r,i){var s=!1,o=function(n,i,s){var o=!1,a={},f={},l,c=i.is_internal?!0:!1,h=i.render_mode||!1,p,d;return t.each(i.fields,function(v){d=!0,v.options=v.options||{};if(!c&&v.options.internal)return;if(h&&v.options.showonmode&&v.options.showonmode.indexOf(h)===-1)return;if(c&&typeof v.options.internalcanupdate!="undefined"&&!v.options.internalcanupdate)return;if(n.attributes.status&&v.options.showonstatus&&t.indexOf(v.options.showonstatus,n.attributes.status)<0)return;typeof i.validation[v.name]!="undefined"&&t.each(i.validation[v.name],function(e,n){var r=["required","length","range","pattern","acceptance","min","max","length"];if(!t.contains(r,n.toLowerCase()))return;delete i.validation[v.name][n],i.validation[v.name][n.toLowerCase()]=e}),typeof v.options.internal!="undefined"&&v.options.internal!==s&&(d=!1),p=v.type.toLowerCase();switch(p){case"filerepository":case"radio":d=!1}switch(p){case"textarea":n.escapeHtmlInputs.push(v.name)}switch(p){case"booleaninput":a[v.name]="",u(v.name,i,f,""),d&&(n.bindings[v.name]='[name="'+v.name+'"]'),n.on("change:"+v.name,function(e,t){var n={};n[v.name]=t==="true"||t===!0?!0:t==="false"||t===!1?!1:"",e.set(n,{silent:!0})}),n.hasBooleanInput=!0;break;case"multifiles":l=v.name+"[]",a[l]="",o&&console.log("model.parseFields setting ",p,"name",l),typeof i.validation[v.name]!="undefined"&&(i.validation[l]=t.clone(i.validation[v.name]),delete i.validation[v.name]),u(l,i,f,""),o&&console.log("- multiFilesDefaultValue",n.multiFilesDefaultValue),n.multiFilesDefaultValue[l]||(n.multiFilesDefaultValue[l]=!0);break;case"fraction":l=v.name+"_numerator",a[l]="",u(l,i,f,""),d&&(n.bindings[l]='[name="'+l+'"]'),l=v.name+"_denominator",a[l]="",u(l,i,f,""),d&&(n.bindings[l]='[name="'+l+'"]');break;case"address":var m=v.options.showstreetnumber?"Street Name":"Street";l=v.name+"_address_street",a[l]="",u(l,i,f," ("+m+")"),d&&!v.options.visibleon&&(n.bindings[l]='[name="'+l+'"]'),l=v.name+"_address_city",a[l]="",u(l,i,f," (City)"),d&&!v.options.visibleon&&(n.bindings[l]='[name="'+l+'"]'),l=v.name+"_address_state",a[l]="",u(l,i,f," (State)"),d&&!v.options.visibleon&&(n.bindings[l]='[name="'+l+'"]'),l=v.name+"_address_zip",a[l]="",u(l,i,f," (ZIP)"),d&&!v.options.visibleon&&(n.bindings[l]='[name="'+l+'"]'),l=v.name+"_address_country",a[l]="",u(l,i,f," (Country)"),d&&!v.options.visibleon&&(n.bindings[l]='[name="'+l+'"]'),v.options.showstreetnumber&&(l=v.name+"_address_street_number",a[l]="",u(l,i,f," (Street Number)"),d&&!v.options.visibleon&&(n.bindings[l]='[name="'+l+'"]')),v.options.showunitnumber&&(l=v.name+"_address_unit_number",a[l]="",u(l,i,f," (Unit Number)"),d&&!v.options.visibleon&&(n.bindings[l]='[name="'+l+'"]'));break;case"fullname":if(typeof v.options.middlename=="undefined"||v.options.middlename)l=v.name+"_fullname_middle_name",a[l]="",u(l,i,f," (Middle Name)"),d&&!v.options.visibleon&&(n.bindings[l]='[name="'+l+'"]');l=v.name+"_fullname_first_name",a[l]="",u(l,i,f," (First Name)"),d&&!v.options.visibleon&&(n.bindings[l]='[name="'+l+'"]'),l=v.name+"_fullname_last_name",a[l]="",u(l,i,f," (Last Name)"),d&&!v.options.visibleon&&(n.bindings[l]='[name="'+l+'"]');break;case"list":a[v.name]=new r,u(v.name,i,f,""),n.subFormLists.push(v.name);break;case"check":case"checkbox":l=v.name+"[]",a[l]="",typeof i.validation[v.name]!="undefined"&&(i.validation[l]=t.clone(i.validation[v.name]),delete i.validation[v.name]),u(l,i,f,"");break;case"hidden":case"buttonclipboard":case"fieldsetstart":case"fieldsetend":case"fieldset":case"clear":case"action":case"button":case"submit":case"hr":case"html":case"step":n.notBinding.push(v.name);break;case"date":if(v.options.render&&v.options.render.toLowerCase()==="select"){a[v.name]="",a[v.name+"_birth[month]"]="",a[v.name+"_birth[day]"]="",a[v.name+"_birth[year]"]="";if(typeof i.validation[v.name]!="undefined"){f[v.name]=t.clone(i.validation[v.name]);var g=t.clone(i.validation[v.name]);g.mindate&&delete g.mindate,g.maxdate&&delete g.maxdate,f[v.name+"_birth[month]"]=t.clone(g),f[v.name+"_birth[day]"]=t.clone(g),f[v.name+"_birth[year]"]=t.clone(g)}}else a[v.name]="",u(v.name,i,f,"");break;case"email":a[v.name]="";if(typeof i.validation[v.name]!="undefined"){f[v.name]=t.clone(i.validation[v.name]);if(v.options.autocomplete){var y=t.clone(i.validation[v.name]),b=t.clone(i.validation[v.name]);y.pattern&&y.pattern==="email"&&(y.pattern=/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))$/i,b.pattern=/^((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))$/i),l=v.name+"_username",f[l]=y,l=v.name+"_server",f[l]=b}}d&&(n.bindings[v.name]='[name="'+v.name+'"]',v.options.autocomplete&&(l=v.name+"_username",n.bindings[l]='[name="'+l+'"]',l=v.name+"_server",n.bindings[l]='[name="'+l+'"]'));break;case"telephone":a[v.name]="",typeof i.validation[v.name]!="undefined"&&(f[v.name]=t.clone(i.validation[v.name]),f[v.name].required&&(f[v.name].pattern=/^\(\d{3}\) \d{3}-\d{4}$/i)),d&&(n.bindings[v.name]='[name="'+v.name+'"]');break;case"socialsecurity":a[v.name]="",typeof i.validation[v.name]!="undefined"&&(f[v.name]=t.clone(i.validation[v.name]),f[v.name].required&&(f[v.name].pattern=/^\d{3}\-\d{2}-\d{4}$/i)),f[v.name]||(f[v.name]={}),f&&!f[v.name].pattern&&(typeof f[v.name].required=="undefined"&&(f[v.name].required=!1),f[v.name].pattern=/(^$|^\d{3}\-\d{2}-\d{4}$)/i),d&&(n.bindings[v.name]='[name="'+v.name+'"]');break;case"userid":a[v.name]="",typeof i.validation[v.name]!="undefined"&&(f[v.name]=t.clone(i.validation[v.name]),!f[v.name].pattern&&(!v.options.render||v.options.render.toLowerCase()!=="select")&&(f[v.name].pattern="email"));break;case"buttondecision":n.on("change:"+v.name,function(t,n){e("#"+v.name+"_btn_condition").val(n).trigger("change")});default:v.attributes&&v.attributes.value?a[v.name]=v.attributes.value:a[v.name]="",u(v.name,i,f,""),p!=="buttondecision"&&d&&(n.bindings[v.name]='[name="'+v.name+'"]'),p==="select"&&v.options.tags&&(n.bindings[v.name]="#"+v.name)}v.options&&v.options.visibleon&&n.bindings[v.name]&&delete n.bindings[v.name];if(n.bindings[v.name]&&v.options&&v.options.showonstatus)if(n.attributes.status){var w=t.indexOf(v.options.showonstatus,n.attributes.status);w<0&&(delete n.bindings[v.name],f[v.name]&&delete f[v.name])}else delete n.bindings[v.name],f[v.name]&&delete f[v.name]}),n.validation=f,a},u=function(e,n,r,i){typeof n.validation[e]!="undefined"&&(r[e]=t.clone(n.validation[e]),n.validation[e].msg&&(r[e].msg=n.validation[e].msg+i))};return n.Model.extend({initialize:function(){var n=this;this.multiFilesDefaultValue={},this.subFormLists=[],this.bindings={},this.notBinding=[],this.escapeHtmlInputs=[],this._listFieldType={};var r=o(this,this.attributes,this.attributes.is_internal);this.clear(),this.set(r),this.on("validated:invalid",function(n,r){console&&console.log&&console.log("Invalid Fields",r),s&&(console.log("Check Model Values",n.toJSON()),console.log("Check Model Validation",n.validation),console.log("Check Model MultiFilesDefaultValue",n.multiFilesDefaultValue)),t.each(r,function(t,r){e(':input[name="'+r+'"]').addClass("invalid"),s&&(console.log("- Invalid Value for ",r),console.log(n.get(r)),console.log("- Validation",n.validation[r]),console.log("- MultiFilesDefaultValue",n.multiFilesDefaultValue[r]))})});if(this.escapeHtmlInputs.length){var u={silent:!0};t.each(this.escapeHtmlInputs,function(e){var t="change:"+e;n.on(t,function(){if(n.has(e)){var t=i.htmlspecialchars(n.get(e)),r={};r[e]=t,n.set(r,u)}})})}t.each(this.subFormLists,function(e){if(n&&n.has&&n.has(e)){var t=n.get(e);t&&t.add&&(n._listFieldType[e]=t)}})},setTrim:function(r,i,s){var o;i=e.trim(i),t.isObject(r)||r==null?(o=r,s=i):(o={},o[r]=i),s=s||{},s.trim&&(o[r]=e.trim(o[r])),n.Model.prototype.set.call(this,o,s)},appendSubFormInput:function(n,r,s){s=s||null;var o=t.clone(this.toJSON()),u,a=e("#"+n);e("input.subform_before_submit",a).remove(),t.each(o,function(n,o){u=r.indexOf(o)>-1?"_internal":"";if(typeof n!="undefined"&&n&&typeof n.toJSON=="function"){s&&s[o].fields&&t.each(s[o].fields,function(r){if(!r||!r.name||!r.type)return;r&&(r.options||(r.options={}),r.attributes||(r.attributes={}));var s=r.type.toLowerCase();t.each(n.models,function(n){var o;switch(s){case"number":var u=parseFloat(n.get(r.name));isNaN(u)||n.set(r.name,u);break;case"select":o=e.trim(n.get(r.name));if(r.options&&r.options.tags||r.attributes&&r.attributes.multiple)t.isString(o)&&(o=o.split(",")),o&&o.length&&o[0]===""&&(o=[]),o.sort&&(o=o.sort(i.sortNumber)),n.set(r.name,o);break;case"date":o=n.get(r.name),o=t.isString(o)?e.trim(o):o;if(o==="")o=null;else if(!t.isNull(o)){o&&o.$date?o=moment(o.$date):o=moment(o,"MM/DD/YYYY");if(!o.isValid())throw alert('Could not be able to parse this date value for "'+r.name+'" with "'+e.trim(n.get(r.name))+'"'),new Error}n.set(r.name,o)}})});var f=JSON.stringify(n.toJSON());a.prepend('<input type="hidden" name="'+o+u+'" value="" class="subform_before_submit">'),a.find(':input[name="'+o+u+'"]').val(f)}})},triggerError:function(t){if(this.hasBooleanInput){var n=e('.form-render_booleaninput input[type="hidden"].invalid',t.el);n.each(function(){var t=e(this),n='<span class="text-error">Please answer this question.</span>';t.closest(".form-render_booleaninput").next().html(n).show("slow")})}},isSubformValid:function(){var n=this,r=!0;return t.each(this.subFormLists,function(i){if(!n.validation[i])return;t.each(n.validation[i],function(n,s){if(t.isObject(n)||!r)return;var o=e('input.subform_before_submit[name="'+i+'"]').val();switch(s){case"required":if(o==="[]"||!o)r=!1}})}),r},bindModelBinder:function(e,t){switch(t.toLowerCase()){default:this.bindings[e]='[name="'+e+'"]'}},unbindModelBinder:function(e,t){switch(t.toLowerCase()){default:delete this.bindings[e]}}})});