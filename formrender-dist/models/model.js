define(["jquery","underscore","backbone","collections/collections","../utils"],function(e,n,a,i,t){var s=function(a,t,s){var m,r,d,u={},l={},c=!!t.is_internal,F=t.render_mode||!1;return n.each(t.fields,function(b){if(d=!0,b.options=b.options||{},(c||!b.options.internal)&&(!F||!b.options.showonmode||-1!==b.options.showonmode.indexOf(F))&&(!c||void 0===b.options.internalcanupdate||b.options.internalcanupdate)&&!(a.attributes.status&&b.options.showonstatus&&n.indexOf(b.options.showonstatus,a.attributes.status)<0)){switch(void 0!==t.validation[b.name]&&n.each(t.validation[b.name],function(e,a){var i=["required","length","range","pattern","acceptance","min","max","length"];n.contains(i,a.toLowerCase())&&(delete t.validation[b.name][a],t.validation[b.name][a.toLowerCase()]=e)}),void 0!==b.options.internal&&b.options.internal!==s&&(d=!1),r=b.type.toLowerCase()){case"filerepository":case"radio":d=!1}switch(r){case"textarea":a.escapeHtmlInputs.push(b.name)}switch(r){case"booleaninput":u[b.name]="",o(b.name,t,l,""),d&&(a.bindings[b.name]='[name="'+b.name+'"]'),a.on("change:"+b.name,function(e,n){var a={};a[b.name]="true"===n||!0===n||"false"!==n&&!1!==n&&"",e.set(a,{silent:!0})}),a.hasBooleanInput=!0;break;case"multifiles":m=b.name+"[]",u[m]="",void 0!==t.validation[b.name]&&(t.validation[m]=n.clone(t.validation[b.name]),delete t.validation[b.name]),o(m,t,l,""),a.multiFilesDefaultValue[m]||(a.multiFilesDefaultValue[m]=!0);break;case"fraction":m=b.name+"_numerator",u[m]="",o(m,t,l,""),d&&(a.bindings[m]='[name="'+m+'"]'),m=b.name+"_denominator",u[m]="",o(m,t,l,""),d&&(a.bindings[m]='[name="'+m+'"]');break;case"address":var p=b.options.showstreetnumber?"Street Name":"Street";m=b.name+"_address_street",u[m]="",o(m,t,l," ("+p+")"),d&&!b.options.visibleon&&(a.bindings[m]='[name="'+m+'"]'),m=b.name+"_address_city",u[m]="",o(m,t,l," (City)"),d&&!b.options.visibleon&&(a.bindings[m]='[name="'+m+'"]'),m=b.name+"_address_state",u[m]="",o(m,t,l," (State)"),d&&!b.options.visibleon&&(a.bindings[m]='[name="'+m+'"]'),m=b.name+"_address_zip",u[m]="",o(m,t,l," (ZIP)"),d&&!b.options.visibleon&&(a.bindings[m]='[name="'+m+'"]'),m=b.name+"_address_country",u[m]="",o(m,t,l," (Country)"),d&&!b.options.visibleon&&(a.bindings[m]='[name="'+m+'"]'),b.options.showstreetnumber&&(m=b.name+"_address_street_number",u[m]="",o(m,t,l," (Street Number)"),d&&!b.options.visibleon&&(a.bindings[m]='[name="'+m+'"]')),b.options.showunitnumber&&(m=b.name+"_address_unit_number",u[m]="",o(m,t,l," (Unit Number)"),d&&!b.options.visibleon&&(a.bindings[m]='[name="'+m+'"]'));break;case"fullname":(void 0===b.options.middlename||b.options.middlename)&&(m=b.name+"_fullname_middle_name",u[m]="",o(m,t,l," (Middle Name)"),d&&!b.options.visibleon&&(a.bindings[m]='[name="'+m+'"]')),m=b.name+"_fullname_first_name",u[m]="",o(m,t,l," (First Name)"),d&&!b.options.visibleon&&(a.bindings[m]='[name="'+m+'"]'),m=b.name+"_fullname_last_name",u[m]="",o(m,t,l," (Last Name)"),d&&!b.options.visibleon&&(a.bindings[m]='[name="'+m+'"]');break;case"list":u[b.name]=new i,o(b.name,t,l,""),a.subFormLists.push(b.name);break;case"check":case"checkbox":m=b.name+"[]",u[m]="",void 0!==t.validation[b.name]&&(t.validation[m]=n.clone(t.validation[b.name]),delete t.validation[b.name]),o(m,t,l,"");break;case"hidden":case"buttonclipboard":case"fieldsetstart":case"fieldsetend":case"fieldset":case"clear":case"action":case"button":case"submit":case"hr":case"html":case"step":a.notBinding.push(b.name);break;case"date":if(b.options.render&&"select"===b.options.render.toLowerCase()){if(u[b.name]="",u[b.name+"_birth[month]"]="",u[b.name+"_birth[day]"]="",u[b.name+"_birth[year]"]="",void 0!==t.validation[b.name]){l[b.name]=n.clone(t.validation[b.name]);var v=n.clone(t.validation[b.name]);v.mindate&&delete v.mindate,v.maxdate&&delete v.maxdate,l[b.name+"_birth[month]"]=n.clone(v),l[b.name+"_birth[day]"]=n.clone(v),l[b.name+"_birth[year]"]=n.clone(v)}}else u[b.name]="",o(b.name,t,l,"");break;case"email":if(u[b.name]="",void 0!==t.validation[b.name]&&(l[b.name]=n.clone(t.validation[b.name]),b.options.autocomplete)){var h=n.clone(t.validation[b.name]),f=n.clone(t.validation[b.name]);h.pattern&&"email"===h.pattern&&(h.pattern=/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))$/i,f.pattern=/^((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))$/i),m=b.name+"_username",l[m]=h,m=b.name+"_server",l[m]=f}d&&(a.bindings[b.name]='[name="'+b.name+'"]',b.options.autocomplete&&(m=b.name+"_username",a.bindings[m]='[name="'+m+'"]',m=b.name+"_server",a.bindings[m]='[name="'+m+'"]'));break;case"telephone":u[b.name]="",void 0!==t.validation[b.name]&&(l[b.name]=n.clone(t.validation[b.name]),l[b.name].required&&(l[b.name].pattern=/^\(\d{3}\) \d{3}-\d{4}$/i)),d&&(a.bindings[b.name]='[name="'+b.name+'"]');break;case"socialsecurity":u[b.name]="",void 0!==t.validation[b.name]&&(l[b.name]=n.clone(t.validation[b.name]),l[b.name].required&&(l[b.name].pattern=/^\d{3}\-\d{2}-\d{4}$/i)),l[b.name]||(l[b.name]={}),l&&!l[b.name].pattern&&(void 0===l[b.name].required&&(l[b.name].required=!1),l[b.name].pattern=/(^$|^\d{3}\-\d{2}-\d{4}$)/i),d&&(a.bindings[b.name]='[name="'+b.name+'"]');break;case"userid":u[b.name]="",void 0!==t.validation[b.name]&&(l[b.name]=n.clone(t.validation[b.name]),l[b.name].pattern||b.options.render&&"select"===b.options.render.toLowerCase()||(l[b.name].pattern="email"));break;case"buttondecision":a.on("change:"+b.name,function(n,a){e("#"+b.name+"_btn_condition").val(a).trigger("change")});default:b.attributes&&b.attributes.value?u[b.name]=b.attributes.value:u[b.name]="",o(b.name,t,l,""),"buttondecision"!==r&&d&&(a.bindings[b.name]='[name="'+b.name+'"]'),"select"===r&&b.options.tags&&(a.bindings[b.name]="#"+b.name)}if(b.options&&b.options.visibleon&&a.bindings[b.name]&&delete a.bindings[b.name],a.bindings[b.name]&&b.options&&b.options.showonstatus)if(a.attributes.status){var g=n.indexOf(b.options.showonstatus,a.attributes.status);g<0&&(delete a.bindings[b.name],l[b.name]&&delete l[b.name])}else delete a.bindings[b.name],l[b.name]&&delete l[b.name]}}),a.validation=l,u},o=function(e,a,i,t){void 0!==a.validation[e]&&(i[e]=n.clone(a.validation[e]),a.validation[e].msg&&(i[e].msg=a.validation[e].msg+t))};return a.Model.extend({initialize:function(){var a=this;this.multiFilesDefaultValue={},this.subFormLists=[],this.bindings={},this.notBinding=[],this.escapeHtmlInputs=[],this._listFieldType={};var i=s(this,this.attributes,this.attributes.is_internal);if(this.clear(),this.set(i),this.on("validated:invalid",function(a,i){"console"in window&&console&&console.log&&console.log("Invalid Fields",i),n.each(i,function(n,a){e(':input[name="'+a+'"]').addClass("invalid")})}),this.escapeHtmlInputs.length){var o={silent:!0};n.each(this.escapeHtmlInputs,function(e){var n="change:"+e;a.on(n,function(){if(a.has(e)){var n=t.htmlspecialchars(a.get(e)),i={};i[e]=n,a.set(i,o)}})})}n.each(this.subFormLists,function(e){if(a&&a.has&&a.has(e)){var n=a.get(e);n&&n.add&&(a._listFieldType[e]=n)}})},setTrim:function(i,t,s){var o;t=e.trim(t),n.isObject(i)||null==i?(o=i,s=t):(o={},o[i]=t),s=s||{},s.trim&&(o[i]=e.trim(o[i])),a.Model.prototype.set.call(this,o,s)},appendSubFormInput:function(a,i,s){s=s||null;var o,m=n.clone(this.toJSON()),r=e("#"+a);e("input.subform_before_submit",r).remove(),n.each(m,function(a,m){if(o=i.indexOf(m)>-1?"_internal":"",void 0!==a&&a&&"function"==typeof a.toJSON){s&&s[m].fields&&n.each(s[m].fields,function(i){if(i&&i.name&&i.type){i&&(i.options||(i.options={}),i.attributes||(i.attributes={}));var s=i.type.toLowerCase();n.each(a.models,function(a){var o;switch(s){case"number":var m=parseFloat(a.get(i.name));isNaN(m)||a.set(i.name,m);break;case"select":o=e.trim(a.get(i.name)),(i.options&&i.options.tags||i.attributes&&i.attributes.multiple)&&(n.isString(o)&&(o=o.split(",")),o&&o.length&&""===o[0]&&(o=[]),o.sort&&(o=o.sort(t.sortNumber)),a.set(i.name,o));break;case"date":if(o=a.get(i.name),""===(o=n.isString(o)?e.trim(o):o))o=null;else if(n.isNull(o));else if(o=o&&o.$date?moment(o.$date):moment(o,"MM/DD/YYYY"),!o.isValid())throw alert('Could not be able to parse this date value for "'+i.name+'" with "'+e.trim(a.get(i.name))+'"'),new Error;a.set(i.name,o)}})}});var d=JSON.stringify(a.toJSON());r.prepend('<input type="hidden" name="'+m+o+'" value="" class="subform_before_submit">'),r.find(':input[name="'+m+o+'"]').val(d)}})},triggerError:function(n){if(this.hasBooleanInput){e('.form-render_booleaninput input[type="hidden"].invalid',n.el).each(function(){e(this).closest(".form-render_booleaninput").next().html('<span class="text-error">Please answer this question.</span>').show("slow")})}},isSubformValid:function(){var a=this,i=!0;return n.each(this.subFormLists,function(t){a.validation[t]&&n.each(a.validation[t],function(a,s){if(!n.isObject(a)&&i){var o=e('input.subform_before_submit[name="'+t+'"]').val();switch(s){case"required":"[]"!==o&&o||(i=!1)}}})}),i},bindModelBinder:function(e,n){n.toLowerCase(),this.bindings[e]='[name="'+e+'"]'},unbindModelBinder:function(e,n){n.toLowerCase(),delete this.bindings[e]}})});